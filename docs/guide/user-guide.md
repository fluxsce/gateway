# 用户实用手册

本手册聚焦于 Gateway API 网关的实际使用场景、常见问题、易错点和用户关心的操作指引，避免与其它文档重复，帮助你高效、安全地使用网关。

---

## 📋 目录
- [常见操作场景](#常见操作场景)
- [常见问题与FAQ](#常见问题与faq)
- [易错点与排查建议](#易错点与排查建议)
- [典型业务实操](#典型业务实操)
- [用户视角最佳实践](#用户视角最佳实践)
- [更多帮助](#更多帮助)

---

## 常见操作场景

### 1. 如何动态热更新配置？
- 直接修改 `configs/gateway.yaml` 后，网关会自动检测并热加载，无需重启。
- 也可通过 Web 管理界面或管理 API 进行在线配置变更。

### 2. 如何查看实时监控和日志？
- 访问 Web 管理界面（默认 http://localhost:8090）查看实时流量、健康状态、错误率等。
- 日志文件默认在 `logs/` 目录，可用 `tail -f logs/gateway.log` 实时查看。
- Docker 部署可用 `docker logs gateway`。

### 3. 如何排查路由不通/服务不可达？
- 检查路由配置是否正确（路径、方法、目标服务ID）。
- 用 `curl` 直接访问后端服务，排除网络或服务本身问题。
- 查看管理界面“服务健康”状态。
- 检查日志中是否有路由匹配失败、后端超时等报错。

### 4. 如何安全上线/灰度发布？
- 推荐先在测试环境全量验证。
- 利用路由优先级、权重、条件断言等实现流量分流。
- 逐步调整权重或切换路由，观察监控和错误率。
- 支持回滚：保留旧路由配置，随时切换。

### 5. 如何快速定位性能瓶颈？
- 通过 `/metrics` 接口或 Web 界面查看 QPS、延迟、错误率等。
- 启用 pprof 性能分析，定位慢请求或高CPU消耗。
- 检查后端服务、数据库、缓存等依赖的健康和响应。

---

## 常见问题与FAQ

**Q1：网关启动报“配置文件找不到/格式错误”？**
- 检查 `--config` 参数是否为目录，目录下需有 `gateway.yaml`、`database.yaml` 等。
- 用 `yamllint` 检查 YAML 格式。

**Q2：路由规则修改后不生效？**
- 确认已保存配置文件，且无语法错误。
- 检查是否有高优先级路由覆盖。
- 查看日志有无“路由未命中”提示。

**Q3：JWT 认证总是失败？**
- 检查密钥、算法配置与发令端一致。
- 检查 `excluded_paths` 是否正确配置。
- 用 JWT 在线工具验证 token 格式。

**Q4：限流/熔断误伤正常流量？**
- 检查限流/熔断参数是否过于严格。
- 结合监控数据调整阈值。
- 临时放宽策略，观察效果。

**Q5：Web 管理界面打不开？**
- 检查 8090 端口是否被占用。
- 检查 `web.yaml` 配置和日志。
- Docker 部署需映射 8090 端口。

---

## 易错点与排查建议

- **配置目录与文件名**：`--config` 必须为目录，目录下需有标准文件名。
- **YAML 缩进/格式**：缩进错误极易导致加载失败，建议用编辑器高亮或 `yamllint` 检查。
- **路由优先级**：多个路由匹配时，优先级高的先生效。
- **服务健康检查**：后端服务健康检查失败会导致流量切断，注意配置健康检查路径和返回码。
- **环境变量引用**：如 `${JWT_SECRET}`，需确保环境变量已设置。
- **日志权限**：生产环境建议单独日志目录并赋予写权限。
- **Docker 挂载目录**：挂载配置、日志目录时需加 `:ro` 或 `:rw` 权限。

---

## 典型业务实操

- **灰度发布**：通过调整路由权重、条件断言实现流量分批切换。
- **限流策略切换**：动态调整 `rate_limit` 参数，观察效果，避免误伤。
- **服务健康自愈**：利用健康检查+熔断，自动摘除异常节点，恢复后自动加入。
- **日志定位**：通过 request_id 关联请求全链路日志，快速定位问题。
- **API 安全加固**：开启全局认证、IP 白名单、CORS、User-Agent 过滤等多重防护。

---

## 用户视角最佳实践

- **上线前本地全量校验**：用 `gateway validate --config ./configs` 检查所有配置。
- **分环境配置管理**：开发、测试、生产环境分开管理，避免误操作。
- **监控与告警**：接入 Prometheus、Grafana，设置关键指标告警。
- **定期备份配置**：配置变更前后做好备份，支持一键回滚。
- **最小权限原则**：只开放必要端口和接口，敏感操作加认证。
- **自动化运维**：结合 CI/CD、脚本自动化部署和回滚。

---

## 更多帮助
- [安装指南](installation.md)
- [配置手册](configuration.md)
- [常见问题排查](troubleshooting.md)
- [社区讨论](https://github.com/your-org/gateway/discussions)
- [提交 Issue](https://github.com/your-org/gateway/issues)

---

**本手册持续优化，欢迎反馈实际使用中的新问题和建议！** 