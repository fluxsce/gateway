# FLUX Gateway - é”™è¯¯å¤„ç†

æœ¬æ–‡æ¡£ä»‹ç» FLUX Gateway çš„é”™è¯¯å¤„ç†æœºåˆ¶å’Œæœ€ä½³å®è·µï¼Œå¸®åŠ©å¼€å‘è€…ç¼–å†™å¥å£®çš„ä»£ç ã€‚

---

## ğŸ“‹ ç›®å½•

- [é”™è¯¯å¤„ç†æœºåˆ¶](#-é”™è¯¯å¤„ç†æœºåˆ¶)
- [HubError ä½¿ç”¨](#-huberror-ä½¿ç”¨)
- [HTTP é”™è¯¯å“åº”](#-http-é”™è¯¯å“åº”)
- [æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)
- [å¸¸è§é”™è¯¯åœºæ™¯](#-å¸¸è§é”™è¯¯åœºæ™¯)

---

## ğŸ”§ é”™è¯¯å¤„ç†æœºåˆ¶

### æ ‡å‡†é”™è¯¯å¤„ç†

Gateway ä½¿ç”¨ Go æ ‡å‡†çš„é”™è¯¯å¤„ç†æ–¹å¼ï¼š

```go
import (
    "errors"
    "fmt"
)

// åˆ›å»ºç®€å•é”™è¯¯
err := errors.New("é…ç½®æ–‡ä»¶ä¸å­˜åœ¨")

// æ ¼å¼åŒ–é”™è¯¯
err := fmt.Errorf("æ— æ³•è¿æ¥åˆ°æ•°æ®åº“: %s", dbHost)

// åŒ…è£…é”™è¯¯
if err != nil {
    return fmt.Errorf("åˆå§‹åŒ–å¤±è´¥: %w", err)
}
```

### é”™è¯¯æ£€æŸ¥

```go
import "errors"

// æ£€æŸ¥é”™è¯¯ç±»å‹
if errors.Is(err, os.ErrNotExist) {
    // æ–‡ä»¶ä¸å­˜åœ¨
}

// æ£€æŸ¥é”™è¯¯å€¼
var pathError *os.PathError
if errors.As(err, &pathError) {
    // å¤„ç†è·¯å¾„é”™è¯¯
}
```

---

## ğŸ¯ HubError ä½¿ç”¨

Gateway æä¾›äº†å¢å¼ºçš„é”™è¯¯å¤„ç†æœºåˆ¶ `huberrors`ï¼Œå¯ä»¥åˆ›å»ºå¸¦æœ‰ç²¾ç¡®ä½ç½®ä¿¡æ¯çš„é”™è¯¯ã€‚

### åŠŸèƒ½ç‰¹ç‚¹

1. âœ… è‡ªåŠ¨æ•è·é”™è¯¯å‘ç”Ÿçš„**ç²¾ç¡®æ–‡ä»¶åã€è¡Œå·å’Œå‡½æ•°å**
2. âœ… ä¸æ—¥å¿—ç³»ç»Ÿæ·±åº¦é›†æˆï¼Œæä¾›å®Œæ•´çš„é”™è¯¯æ ˆä¿¡æ¯
3. âœ… æ”¯æŒåŸå§‹é”™è¯¯çš„åŒ…è£…ï¼Œä¿ç•™å®Œæ•´çš„é”™è¯¯é“¾
4. âœ… é”™è¯¯ä¿¡æ¯æ ¼å¼åŒ–æ”¯æŒï¼Œä¸ `fmt.Errorf` å…¼å®¹

### å¯¼å…¥åŒ…

```go
import (
    "github.com/fluxsce/gateway/pkg/utils/huberrors"
)
```

### åˆ›å»ºæ–°é”™è¯¯

```go
// åˆ›å»ºå¸¦ä½ç½®ä¿¡æ¯çš„é”™è¯¯ï¼ˆç±»ä¼¼ errors.Newï¼‰
err := huberrors.NewError("å‘ç”Ÿäº†é”™è¯¯")

// æ”¯æŒæ ¼å¼åŒ–ï¼ˆç±»ä¼¼ fmt.Errorfï¼‰
err := huberrors.NewError("æ— æ³•è§£æé…ç½®: %s", configName)

// é”™è¯¯è¾“å‡ºç¤ºä¾‹ï¼š
// æ— æ³•è§£æé…ç½®: database.yaml (at /path/to/file.go:25 in package.function)
```

### åŒ…è£…å·²æœ‰é”™è¯¯

```go
// åŒ…è£…å·²æœ‰é”™è¯¯ï¼Œæ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯
originalErr := someFunction()
wrappedErr := huberrors.WrapError(originalErr, "æ“ä½œå¤±è´¥")

// æ”¯æŒæ ¼å¼åŒ–
wrappedErr := huberrors.WrapError(originalErr, "å¤„ç† %s æ—¶å¤±è´¥", resourceName)

// é”™è¯¯è¾“å‡ºç¤ºä¾‹ï¼š
// å¤„ç† users æ—¶å¤±è´¥ (at /path/to/file.go:42 in package.function): åŸå§‹é”™è¯¯ä¿¡æ¯
```

### ä¸æ—¥å¿—ç³»ç»Ÿé›†æˆ

```go
err := huberrors.NewError("æ•°æ®åº“è¿æ¥å¤±è´¥")
logger.Error("ç³»ç»Ÿå¯åŠ¨å¤±è´¥", err)
```

**æ—¥å¿—è¾“å‡ºå°†åŒ…å«ï¼š**
- é”™è¯¯æ¶ˆæ¯
- é”™è¯¯ç±»å‹
- å®Œæ•´çš„æ–‡ä»¶è·¯å¾„ã€è¡Œå·å’Œå‡½æ•°å
- å †æ ˆè·Ÿè¸ª

---

## ğŸŒ HTTP é”™è¯¯å“åº”

### æ ‡å‡†é”™è¯¯å“åº”æ ¼å¼

```go
type ErrorResponse struct {
    Code    int    `json:"code"`    // ä¸šåŠ¡é”™è¯¯ç 
    Message string `json:"message"` // é”™è¯¯æè¿°
    Details string `json:"details"` // è¯¦ç»†ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
}
```

### å¸¸ç”¨ HTTP çŠ¶æ€ç 

| çŠ¶æ€ç  | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|--------|------|----------|
| **400** | Bad Request | è¯·æ±‚å‚æ•°é”™è¯¯ |
| **401** | Unauthorized | æœªè®¤è¯ |
| **403** | Forbidden | æ— æƒé™ |
| **404** | Not Found | èµ„æºä¸å­˜åœ¨ |
| **409** | Conflict | èµ„æºå†²çª |
| **429** | Too Many Requests | è¯·æ±‚è¿‡äºé¢‘ç¹ |
| **500** | Internal Server Error | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |
| **502** | Bad Gateway | åç«¯æœåŠ¡é”™è¯¯ |
| **503** | Service Unavailable | æœåŠ¡ä¸å¯ç”¨ |
| **504** | Gateway Timeout | ç½‘å…³è¶…æ—¶ |

### é”™è¯¯å“åº”ç¤ºä¾‹

```go
// å‚æ•°é”™è¯¯
c.JSON(http.StatusBadRequest, ErrorResponse{
    Code:    40001,
    Message: "å‚æ•°é”™è¯¯",
    Details: "userId ä¸èƒ½ä¸ºç©º",
})

// æœªè®¤è¯
c.JSON(http.StatusUnauthorized, ErrorResponse{
    Code:    40101,
    Message: "æœªè®¤è¯",
    Details: "Token å·²è¿‡æœŸ",
})

// èµ„æºä¸å­˜åœ¨
c.JSON(http.StatusNotFound, ErrorResponse{
    Code:    40401,
    Message: "èµ„æºä¸å­˜åœ¨",
    Details: "ç”¨æˆ· ID 123 ä¸å­˜åœ¨",
})

// æœåŠ¡å™¨é”™è¯¯
c.JSON(http.StatusInternalServerError, ErrorResponse{
    Code:    50001,
    Message: "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯",
    Details: "æ•°æ®åº“è¿æ¥å¤±è´¥",
})
```

---

## âœ… æœ€ä½³å®è·µ

### 1. åœ¨é”™è¯¯æºå¤´ä½¿ç”¨ NewError

åœ¨é”™è¯¯æœ€åˆå‘ç”Ÿçš„åœ°æ–¹ä½¿ç”¨ `NewError`ï¼Œç¡®ä¿æ•è·æœ€ç²¾ç¡®çš„ä½ç½®ä¿¡æ¯ã€‚

```go
func readConfig(path string) (Config, error) {
    data, err := os.ReadFile(path)
    if err != nil {
        // âœ… åœ¨æºå¤´åŒ…è£…é”™è¯¯
        return nil, huberrors.WrapError(err, "è¯»å–é…ç½®æ–‡ä»¶å¤±è´¥: %s", path)
    }
    
    var config Config
    if err := json.Unmarshal(data, &config); err != nil {
        // âœ… åœ¨æºå¤´åŒ…è£…é”™è¯¯
        return nil, huberrors.WrapError(err, "è§£æé…ç½®æ–‡ä»¶å¤±è´¥: %s", path)
    }
    
    if !config.IsValid() {
        // âœ… åˆ›å»ºæ–°é”™è¯¯
        return nil, huberrors.NewError("é…ç½®æ— æ•ˆ: %s", path)
    }
    
    return config, nil
}
```

### 2. åœ¨ä¸­é—´å±‚ä½¿ç”¨ WrapError

å‘ä¸Šä¼ é€’é”™è¯¯æ—¶ï¼Œä½¿ç”¨ `WrapError` æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚

```go
func initDatabase() error {
    config, err := readConfig("database.yaml")
    if err != nil {
        // âœ… åŒ…è£…é”™è¯¯ï¼Œæ·»åŠ ä¸Šä¸‹æ–‡
        return huberrors.WrapError(err, "åˆå§‹åŒ–æ•°æ®åº“å¤±è´¥")
    }
    
    db, err := connectDB(config)
    if err != nil {
        // âœ… åŒ…è£…é”™è¯¯ï¼Œæ·»åŠ ä¸Šä¸‹æ–‡
        return huberrors.WrapError(err, "è¿æ¥æ•°æ®åº“å¤±è´¥")
    }
    
    return nil
}
```

### 3. ä¿æŒé”™è¯¯æ¶ˆæ¯ç®€æ´æ˜äº†

é”™è¯¯æ¶ˆæ¯åº”è¯¥æ¸…æ™°æè¿°å‘ç”Ÿäº†ä»€ä¹ˆï¼Œä¸è¦åŒ…å«è¿‡å¤šçš„æŠ€æœ¯ç»†èŠ‚ã€‚

```go
// âœ… å¥½çš„é”™è¯¯æ¶ˆæ¯
err := huberrors.NewError("é…ç½®æ–‡ä»¶ä¸å­˜åœ¨")
err := huberrors.NewError("æ•°æ®åº“è¿æ¥å¤±è´¥")
err := huberrors.NewError("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯")

// âŒ ä¸å¥½çš„é”™è¯¯æ¶ˆæ¯
err := huberrors.NewError("os.Open() returned error: file not found at line 42")
err := huberrors.NewError("SQL error 1045: Access denied for user 'root'@'localhost'")
```

### 4. é¿å…é‡å¤åˆ›å»ºé”™è¯¯

å¦‚æœå·²ç»æœ‰å¸¦ä½ç½®ä¿¡æ¯çš„ `HubError`ï¼Œä½¿ç”¨ `WrapError` è€Œä¸æ˜¯åˆ›å»ºæ–°é”™è¯¯ã€‚

```go
// âœ… æ­£ç¡®åšæ³•
func processUser(id string) error {
    user, err := getUser(id)
    if err != nil {
        return huberrors.WrapError(err, "å¤„ç†ç”¨æˆ·å¤±è´¥")
    }
    // ...
}

// âŒ é”™è¯¯åšæ³•
func processUser(id string) error {
    user, err := getUser(id)
    if err != nil {
        return huberrors.NewError("å¤„ç†ç”¨æˆ·å¤±è´¥: %v", err) // ä¸¢å¤±äº†åŸå§‹é”™è¯¯çš„ä½ç½®ä¿¡æ¯
    }
    // ...
}
```

### 5. è®°å½•é”™è¯¯æ—¥å¿—

åœ¨é€‚å½“çš„ä½ç½®è®°å½•é”™è¯¯æ—¥å¿—ï¼Œä½†é¿å…é‡å¤è®°å½•ã€‚

```go
// âœ… åœ¨æœ€å¤–å±‚è®°å½•é”™è¯¯
func main() {
    if err := initDatabase(); err != nil {
        logger.Error("åº”ç”¨å¯åŠ¨å¤±è´¥", err)
        os.Exit(1)
    }
}

// âŒ åœ¨æ¯ä¸€å±‚éƒ½è®°å½•é”™è¯¯ï¼ˆä¼šå¯¼è‡´æ—¥å¿—é‡å¤ï¼‰
func initDatabase() error {
    config, err := readConfig("database.yaml")
    if err != nil {
        logger.Error("è¯»å–é…ç½®å¤±è´¥", err) // âŒ ä¸è¦åœ¨è¿™é‡Œè®°å½•
        return err
    }
    // ...
}
```

---

## ğŸ› å¸¸è§é”™è¯¯åœºæ™¯

### 1. é…ç½®æ–‡ä»¶é”™è¯¯

```go
func loadConfig(path string) (*Config, error) {
    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if _, err := os.Stat(path); os.IsNotExist(err) {
        return nil, huberrors.NewError("é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: %s", path)
    }
    
    // è¯»å–æ–‡ä»¶
    data, err := os.ReadFile(path)
    if err != nil {
        return nil, huberrors.WrapError(err, "è¯»å–é…ç½®æ–‡ä»¶å¤±è´¥: %s", path)
    }
    
    // è§£æ YAML
    var config Config
    if err := yaml.Unmarshal(data, &config); err != nil {
        return nil, huberrors.WrapError(err, "è§£æé…ç½®æ–‡ä»¶å¤±è´¥: %s", path)
    }
    
    // éªŒè¯é…ç½®
    if err := config.Validate(); err != nil {
        return nil, huberrors.WrapError(err, "é…ç½®éªŒè¯å¤±è´¥: %s", path)
    }
    
    return &config, nil
}
```

### 2. æ•°æ®åº“é”™è¯¯

```go
func getUser(id string) (*User, error) {
    var user User
    
    // æŸ¥è¯¢æ•°æ®åº“
    err := db.QueryRow("SELECT * FROM users WHERE id = ?", id).Scan(&user)
    
    // å¤„ç†ä¸åŒç±»å‹çš„é”™è¯¯
    if err != nil {
        if errors.Is(err, sql.ErrNoRows) {
            return nil, huberrors.NewError("ç”¨æˆ·ä¸å­˜åœ¨: %s", id)
        }
        return nil, huberrors.WrapError(err, "æŸ¥è¯¢ç”¨æˆ·å¤±è´¥: %s", id)
    }
    
    return &user, nil
}
```

### 3. HTTP è¯·æ±‚é”™è¯¯

```go
func callExternalAPI(url string) ([]byte, error) {
    // å‘èµ·è¯·æ±‚
    resp, err := http.Get(url)
    if err != nil {
        return nil, huberrors.WrapError(err, "HTTP è¯·æ±‚å¤±è´¥: %s", url)
    }
    defer resp.Body.Close()
    
    // æ£€æŸ¥çŠ¶æ€ç 
    if resp.StatusCode != http.StatusOK {
        return nil, huberrors.NewError("HTTP è¯·æ±‚å¤±è´¥: %s, çŠ¶æ€ç : %d", url, resp.StatusCode)
    }
    
    // è¯»å–å“åº”
    body, err := io.ReadAll(resp.Body)
    if err != nil {
        return nil, huberrors.WrapError(err, "è¯»å–å“åº”å¤±è´¥: %s", url)
    }
    
    return body, nil
}
```

### 4. å‚æ•°éªŒè¯é”™è¯¯

```go
func createUser(req *CreateUserRequest) error {
    // éªŒè¯ç”¨æˆ·å
    if req.Username == "" {
        return huberrors.NewError("ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    }
    if len(req.Username) < 3 || len(req.Username) > 20 {
        return huberrors.NewError("ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨ 3-20 ä¹‹é—´")
    }
    
    // éªŒè¯å¯†ç 
    if req.Password == "" {
        return huberrors.NewError("å¯†ç ä¸èƒ½ä¸ºç©º")
    }
    if len(req.Password) < 6 {
        return huberrors.NewError("å¯†ç é•¿åº¦ä¸èƒ½å°‘äº 6 ä½")
    }
    
    // éªŒè¯é‚®ç®±
    if req.Email == "" {
        return huberrors.NewError("é‚®ç®±ä¸èƒ½ä¸ºç©º")
    }
    if !isValidEmail(req.Email) {
        return huberrors.NewError("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    }
    
    return nil
}
```

### 5. å¹¶å‘é”™è¯¯å¤„ç†

```go
func processItems(items []Item) error {
    var wg sync.WaitGroup
    errChan := make(chan error, len(items))
    
    for _, item := range items {
        wg.Add(1)
        go func(item Item) {
            defer wg.Done()
            if err := processItem(item); err != nil {
                errChan <- huberrors.WrapError(err, "å¤„ç†é¡¹ç›®å¤±è´¥: %s", item.ID)
            }
        }(item)
    }
    
    wg.Wait()
    close(errChan)
    
    // æ”¶é›†æ‰€æœ‰é”™è¯¯
    var errs []error
    for err := range errChan {
        errs = append(errs, err)
    }
    
    if len(errs) > 0 {
        return huberrors.NewError("æ‰¹é‡å¤„ç†å¤±è´¥ï¼Œå…± %d ä¸ªé”™è¯¯", len(errs))
    }
    
    return nil
}
```

---

## ğŸ“– ä¸‹ä¸€æ­¥

é”™è¯¯å¤„ç†æŒæ¡åï¼Œå»ºè®®ç»§ç»­é˜…è¯»ï¼š

- [é¡¹ç›®ä»‹ç»](./01-é¡¹ç›®ä»‹ç».md) - äº†è§£é¡¹ç›®æ¶æ„å’Œæ ¸å¿ƒèƒ½åŠ›
- [å¼€å‘æŒ‡å—](./02-å¿«é€Ÿå¼€å§‹.md) - å¼€å‘ç¯å¢ƒæ­å»ºå’Œé…ç½®è¯´æ˜
- [è°ƒè¯•æŒ‡å—](./06-è°ƒè¯•æŒ‡å—.md) - è°ƒè¯•æŠ€å·§å’Œæ–¹æ³•

---

## ğŸ¤ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°é”™è¯¯å¤„ç†ç›¸å…³é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–å¸®åŠ©ï¼š

- ğŸ“§ é‚®ç®±ï¼šfluxopensource@flux.com.cn
- ğŸ’¬ GitHub Issuesï¼š[æäº¤é—®é¢˜](https://github.com/fluxsce/gateway/issues)

---

**[è¿”å›ç›®å½•](./README.md) â€¢ [ä¸Šä¸€ç« ï¼šè°ƒè¯•æŒ‡å—](./06-è°ƒè¯•æŒ‡å—.md)**

---

<div align="center">

Made with â¤ï¸ by FLUX Gateway Team

</div>

