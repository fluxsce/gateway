# FLUX Gateway - å®¹å™¨åŒ–éƒ¨ç½²

æœ¬æ–‡æ¡£æä¾› FLUX Gateway çš„å®¹å™¨åŒ–éƒ¨ç½²æŒ‡å—ï¼ŒåŒ…æ‹¬ Docker å’Œ Kubernetes ä¸¤ç§æ–¹å¼ï¼Œé€‚åˆæ–°æ‰‹å¿«é€Ÿä¸Šæ‰‹ã€‚

---

## ğŸ“‹ ç›®å½•

- [Docker éƒ¨ç½²](#-docker-éƒ¨ç½²)
  - [å¿«é€Ÿä½“éªŒ](#1-å¿«é€Ÿä½“éªŒæ¨è)
  - [ç”Ÿäº§éƒ¨ç½²](#2-ç”Ÿäº§éƒ¨ç½²)
- [Kubernetes éƒ¨ç½²](#ï¸-kubernetes-éƒ¨ç½²)
  - [ä¸€é”®éƒ¨ç½²](#1-ä¸€é”®éƒ¨ç½²æ¨è)
  - [è®¿é—®æœåŠ¡](#2-è®¿é—®æœåŠ¡)
  - [ç®¡ç†æ“ä½œ](#3-ç®¡ç†æ“ä½œ)
- [é•œåƒè¯´æ˜](#-é•œåƒè¯´æ˜)
- [å¸¸è§é—®é¢˜](#-å¸¸è§é—®é¢˜)

---

## ğŸ³ Docker éƒ¨ç½²

### å‰ç½®è¦æ±‚

- å·²å®‰è£… Dockerï¼ˆç‰ˆæœ¬ 20.10+ï¼‰
- å·²å®‰è£… Docker Composeï¼ˆç‰ˆæœ¬ 2.0+ï¼‰

### 1. å¿«é€Ÿä½“éªŒï¼ˆæ¨èï¼‰

ä½¿ç”¨ Docker Compose ä¸€é”®å¯åŠ¨ MySQL + Redis + Gatewayï¼Œé€‚åˆå¿«é€Ÿä½“éªŒå’Œå¼€å‘æµ‹è¯•ã€‚

#### æ­¥éª¤ 1ï¼šå‡†å¤‡é…ç½®æ–‡ä»¶

ä»é¡¹ç›®çš„ `configs/` ç›®å½•æ‹·è´é…ç½®æ–‡ä»¶åˆ°æœ¬åœ°å¹¶ä¿®æ”¹ï¼š

**GitHub é…ç½®æ–‡ä»¶ç›®å½•ï¼š** [https://github.com/fluxsce/gateway/tree/main/configs](https://github.com/fluxsce/gateway/tree/main/configs)

**é…ç½®æ–‡ä»¶åˆ—è¡¨ï¼š**
- [app.yaml](https://github.com/fluxsce/gateway/blob/main/configs/app.yaml)
- [database.yaml](https://github.com/fluxsce/gateway/blob/main/configs/database.yaml)
- [gateway.yaml](https://github.com/fluxsce/gateway/blob/main/configs/gateway.yaml)
- [logger.yaml](https://github.com/fluxsce/gateway/blob/main/configs/logger.yaml)
- [web.yaml](https://github.com/fluxsce/gateway/blob/main/configs/web.yaml)

**ä¸»è¦ä¿®æ”¹ `database.yaml`ï¼š**
```yaml
database:
  type: mysql
  host: mysql  # Docker Compose ä¸­çš„ MySQL æœåŠ¡å
  port: 3306
  username: gateway
  password: gateway123
  database: gateway
```

#### æ­¥éª¤ 2ï¼šå¯åŠ¨æœåŠ¡

```bash
# è¿›å…¥ docker ç›®å½•
cd scripts/docker

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps
```

**é¢„æœŸè¾“å‡ºï¼š**
```
NAME              IMAGE                          STATUS         PORTS
gateway-mysql     mysql:8.0                      Up (healthy)   0.0.0.0:13306->3306/tcp
gateway-redis     redis:7-alpine                 Up (healthy)   0.0.0.0:16379->6379/tcp
gateway-app       datahub-images/gateway:3.0.4   Up (healthy)   0.0.0.0:18280->8080/tcp, ...
```

#### æ­¥éª¤ 3ï¼šè®¿é—®æœåŠ¡

æœåŠ¡å¯åŠ¨åï¼Œé€šè¿‡æµè§ˆå™¨è®¿é—®ï¼š

| æœåŠ¡ | åœ°å€ | è¯´æ˜ |
|------|------|------|
| **Web æ§åˆ¶å°** | http://localhost:12203/gatewayweb | ç®¡ç†ç•Œé¢ |
| **API Gateway** | http://localhost:18280 | API ç½‘å…³ |
| **éš§é“æ§åˆ¶** | localhost:17000 | FRP æ§åˆ¶ç«¯å£ |

**é»˜è®¤ç™»å½•ä¿¡æ¯ï¼š**
- ç”¨æˆ·åï¼š`admin`
- å¯†ç ï¼š`123456`

#### æ­¥éª¤ 4ï¼šæŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹ Gateway æ—¥å¿—
docker-compose logs -f gateway

# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose logs -f
```

#### æ­¥éª¤ 5ï¼šåœæ­¢æœåŠ¡

```bash
# åœæ­¢æœåŠ¡
docker-compose stop

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨ï¼ˆä¿ç•™æ•°æ®ï¼‰
docker-compose down

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨å’Œæ•°æ®ï¼ˆæ¸…ç©ºæ•°æ®åº“ï¼‰
docker-compose down -v
```

---

### 2. ç”Ÿäº§éƒ¨ç½²

å¦‚æœå·²æœ‰æ•°æ®åº“å’Œ Redisï¼Œåªéœ€éƒ¨ç½² Gateway å®¹å™¨ã€‚

#### æ­¥éª¤ 1ï¼šå‡†å¤‡é…ç½®æ–‡ä»¶

ä»é¡¹ç›®çš„ `configs/` ç›®å½•æ‹·è´é…ç½®æ–‡ä»¶åˆ°æœ¬åœ°å¹¶ä¿®æ”¹ã€‚

**GitHub é…ç½®æ–‡ä»¶ç›®å½•ï¼š** [https://github.com/fluxsce/gateway/tree/main/configs](https://github.com/fluxsce/gateway/tree/main/configs)

**é…ç½®æ–‡ä»¶åˆ—è¡¨ï¼š**
- [app.yaml](https://github.com/fluxsce/gateway/blob/main/configs/app.yaml)
- [database.yaml](https://github.com/fluxsce/gateway/blob/main/configs/database.yaml)
- [gateway.yaml](https://github.com/fluxsce/gateway/blob/main/configs/gateway.yaml)
- [logger.yaml](https://github.com/fluxsce/gateway/blob/main/configs/logger.yaml)
- [web.yaml](https://github.com/fluxsce/gateway/blob/main/configs/web.yaml)

**ä¸»è¦ä¿®æ”¹ `database.yaml`ï¼š**
```yaml
database:
  type: mysql
  host: 192.168.1.100      # æ•°æ®åº“ IP
  port: 3306
  username: gateway
  password: your-password  # ä¿®æ”¹ä¸ºå®é™…å¯†ç 
  database: gateway
```

#### æ­¥éª¤ 2ï¼šè¿è¡Œå®¹å™¨

```bash
# è¿è¡Œ Gateway å®¹å™¨
docker run -d \
  --name gateway \
  -p 8080:8080 \
  -p 12003:12003 \
  -p 7000:7000 \
  -v /opt/gateway/configs:/opt/gateway/configs:ro \
  -v /opt/gateway/logs:/opt/gateway/logs \
  -e TZ=Asia/Shanghai \
  -e GATEWAY_LOG_LEVEL=info \
  --restart=unless-stopped \
  crpi-25xt72cd1prwdj5s.cn-hangzhou.personal.cr.aliyuncs.com/datahub-images/gateway:3.0.4

# æŸ¥çœ‹æ—¥å¿—
docker logs -f gateway

# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker ps | grep gateway
```

**å‚æ•°è¯´æ˜ï¼š**
- `-p 8080:8080`ï¼šAPI Gateway ç«¯å£
- `-p 12003:12003`ï¼šWeb æ§åˆ¶å°ç«¯å£
- `-p 7000:7000`ï¼šéš§é“æ§åˆ¶ç«¯å£
- `-v /opt/gateway/configs:/opt/gateway/configs:ro`ï¼šæŒ‚è½½é…ç½®æ–‡ä»¶ï¼ˆåªè¯»ï¼‰
- `-v /opt/gateway/logs:/opt/gateway/logs`ï¼šæŒ‚è½½æ—¥å¿—ç›®å½•ï¼ˆå¯å†™ï¼‰
- `--restart=unless-stopped`ï¼šå®¹å™¨è‡ªåŠ¨é‡å¯

#### æ­¥éª¤ 3ï¼šè®¿é—®æœåŠ¡

```bash
# æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://localhost:12003/health

# è®¿é—® Web æ§åˆ¶å°
# http://localhost:12003/gatewayweb
# é»˜è®¤ç”¨æˆ·åï¼šadmin
# é»˜è®¤å¯†ç ï¼š123456
```

---

## â˜¸ï¸ Kubernetes éƒ¨ç½²

### å‰ç½®è¦æ±‚

- Kubernetes é›†ç¾¤ 1.19+
- kubectl å‘½ä»¤è¡Œå·¥å…·å·²å®‰è£…å¹¶é…ç½®
- é›†ç¾¤ä¸­å·²éƒ¨ç½² MySQL æ•°æ®åº“

### 1. ä¸€é”®éƒ¨ç½²ï¼ˆæ¨èï¼‰

#### æ­¥éª¤ 1ï¼šå‡†å¤‡é…ç½®æ–‡ä»¶

ä»é¡¹ç›®çš„ `configs/` ç›®å½•æ‹·è´é…ç½®æ–‡ä»¶åˆ°æœ¬åœ°å¹¶ä¿®æ”¹ã€‚

**GitHub é…ç½®æ–‡ä»¶ç›®å½•ï¼š** [https://github.com/fluxsce/gateway/tree/main/configs](https://github.com/fluxsce/gateway/tree/main/configs)

**é…ç½®æ–‡ä»¶åˆ—è¡¨ï¼š**
- [app.yaml](https://github.com/fluxsce/gateway/blob/main/configs/app.yaml)
- [database.yaml](https://github.com/fluxsce/gateway/blob/main/configs/database.yaml)
- [gateway.yaml](https://github.com/fluxsce/gateway/blob/main/configs/gateway.yaml)
- [logger.yaml](https://github.com/fluxsce/gateway/blob/main/configs/logger.yaml)
- [web.yaml](https://github.com/fluxsce/gateway/blob/main/configs/web.yaml)

**ä¸»è¦ä¿®æ”¹ `database.yaml`ï¼š**
```yaml
database:
  type: mysql
  host: mysql-service.default.svc.cluster.local  # K8S é›†ç¾¤å†…çš„ MySQL æœåŠ¡
  port: 3306
  username: gateway
  password: your-password  # ä¿®æ”¹ä¸ºå®é™…å¯†ç 
  database: gateway
```

#### æ­¥éª¤ 2ï¼šä¿®æ”¹ YAML æ–‡ä»¶ï¼ˆé‡è¦ï¼‰

åœ¨æ‰§è¡Œéƒ¨ç½²å‰ï¼Œéœ€è¦æ ¹æ®å®é™…ç¯å¢ƒä¿®æ”¹ K8S é…ç½®æ–‡ä»¶ï¼š

**1. ä¿®æ”¹å‘½åç©ºé—´ï¼ˆå¦‚éœ€è¦ï¼‰**

é»˜è®¤ä½¿ç”¨ `gateway` å‘½åç©ºé—´ï¼Œå¦‚éœ€ä¿®æ”¹ï¼Œç¼–è¾‘ä»¥ä¸‹æ–‡ä»¶ï¼š

```bash
# ä¿®æ”¹ deployment.yaml
vim scripts/k8s/deployment.yaml
# å°† namespace: gateway æ”¹ä¸ºä½ çš„å‘½åç©ºé—´

# ä¿®æ”¹ service.yaml
vim scripts/k8s/service.yaml
# å°† namespace: gateway æ”¹ä¸ºä½ çš„å‘½åç©ºé—´

# ä¿®æ”¹ ingress.yamlï¼ˆå¦‚æœä½¿ç”¨ï¼‰
vim scripts/k8s/ingress.yaml
# å°† namespace: gateway æ”¹ä¸ºä½ çš„å‘½åç©ºé—´
```

**2. ä¿®æ”¹é•œåƒåœ°å€ï¼ˆå¦‚éœ€è¦ï¼‰**

ç¼–è¾‘ `scripts/k8s/deployment.yaml`ï¼Œç¡®è®¤æˆ–ä¿®æ”¹é•œåƒåœ°å€ï¼š

```yaml
# é»˜è®¤ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒï¼ˆå›½å†…æ¨èï¼‰
image: crpi-25xt72cd1prwdj5s.cn-hangzhou.personal.cr.aliyuncs.com/datahub-images/gateway:3.0.4

# æˆ–ä½¿ç”¨ Docker Hub é•œåƒ
# image: datahub-images/gateway:3.0.4
```

**3. ä¿®æ”¹å‰¯æœ¬æ•°ï¼ˆå¦‚éœ€è¦ï¼‰**

ç¼–è¾‘ `scripts/k8s/deployment.yaml`ï¼š

```yaml
spec:
  replicas: 1  # æ ¹æ®å®é™…éœ€æ±‚ä¿®æ”¹å‰¯æœ¬æ•°
```

#### æ­¥éª¤ 3ï¼šæ‰§è¡Œéƒ¨ç½²

```bash
# ä¸€é”®å®‰è£…ï¼ˆé»˜è®¤ä½¿ç”¨ ../../configs é…ç½®ç›®å½•ï¼Œé»˜è®¤å‘½åç©ºé—´ gatewayï¼‰
bash deploy.sh install

# æŒ‡å®šé…ç½®ç›®å½•
bash deploy.sh install --config-dir /path/to/configs

# æŒ‡å®šå‘½åç©ºé—´
bash deploy.sh install --namespace my-namespace

# åŒæ—¶æŒ‡å®šé…ç½®ç›®å½•å’Œå‘½åç©ºé—´
bash deploy.sh install --config-dir /path/to/configs --namespace my-namespace
```

**å®‰è£…æˆåŠŸåä¼šæ˜¾ç¤ºè®¿é—®ä¿¡æ¯ï¼š**
```
[SUCCESS] FLUX Gateway å®‰è£…å®Œæˆï¼

[INFO] è®¿é—®ä¿¡æ¯:
[INFO]   API Gateway:  http://192.168.1.100:30001
[INFO]   Web æ§åˆ¶å°:   http://192.168.1.100:30002/gatewayweb
[INFO]   éš§é“æ§åˆ¶:     192.168.1.100:30003

[INFO] é»˜è®¤ç™»å½•ä¿¡æ¯:
[INFO]   ç”¨æˆ·å: admin
[INFO]   å¯†ç :   123456
```

#### æ­¥éª¤ 4ï¼šæŸ¥çœ‹éƒ¨ç½²çŠ¶æ€

```bash
# æŸ¥çœ‹è¯¦ç»†çŠ¶æ€ï¼ˆä½¿ç”¨é»˜è®¤å‘½åç©ºé—´ gatewayï¼‰
bash deploy.sh status

# æŸ¥çœ‹æŒ‡å®šå‘½åç©ºé—´çš„çŠ¶æ€
bash deploy.sh status --namespace my-namespace

# æˆ–ä½¿ç”¨ kubectl å‘½ä»¤
kubectl get pods -n gateway
kubectl get svc -n gateway
kubectl get ingress -n gateway
```

---

## ğŸ“¦ é•œåƒè¯´æ˜

### é•œåƒä»“åº“

| ä»“åº“ | åœ°å€ | è¯´æ˜ |
|------|------|------|
| **é˜¿é‡Œäº‘** | `crpi-25xt72cd1prwdj5s.cn-hangzhou.personal.cr.aliyuncs.com/datahub-images/gateway` | å›½å†…æ¨èï¼Œé€Ÿåº¦å¿« |
| **Docker Hub** | `datahub-images/gateway` | å›½é™…é•œåƒä»“åº“ |

### é•œåƒç‰ˆæœ¬

| ç‰ˆæœ¬ | æ ‡ç­¾ | è¯´æ˜ | å¤§å° |
|------|------|------|------|
| **æ ‡å‡†ç‰ˆ** | `3.0.4` | æ”¯æŒ MySQLã€SQLite | ~50MB |
| **Oracle ç‰ˆ** | `3.0.4-oracle` | æ”¯æŒ MySQLã€SQLiteã€Oracle | ~300MB |

---

## ğŸ“– ä¸‹ä¸€æ­¥

å®¹å™¨åŒ–éƒ¨ç½²å®Œæˆåï¼Œå»ºè®®ç»§ç»­é˜…è¯»ï¼š

- [é¡¹ç›®ä»‹ç»](./01-é¡¹ç›®ä»‹ç».md) - äº†è§£é¡¹ç›®æ¶æ„å’Œæ ¸å¿ƒèƒ½åŠ›
- [å¼€å‘æŒ‡å—](./02-å¿«é€Ÿå¼€å§‹.md) - å¼€å‘ç¯å¢ƒæ­å»ºå’Œé…ç½®è¯´æ˜
- [å®‰è£…éƒ¨ç½²](./03-å®‰è£…éƒ¨ç½².md) - ä¼ ç»Ÿéƒ¨ç½²æ–¹å¼

---

## ğŸ¤ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°éƒ¨ç½²é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–å¸®åŠ©ï¼š

- ğŸ“§ é‚®ç®±ï¼šfluxopensource@flux.com.cn
- ğŸ’¬ GitHub Issuesï¼š[æäº¤é—®é¢˜](https://github.com/fluxsce/gateway/issues)

---

**[è¿”å›ç›®å½•](./README.md) â€¢ [ä¸Šä¸€ç« ï¼šå®‰è£…éƒ¨ç½²](./03-å®‰è£…éƒ¨ç½².md) â€¢ [ä¸‹ä¸€ç« ï¼šæ•°æ®åº“è§„èŒƒ](./05-æ•°æ®åº“è§„èŒƒ.md)**

---

<div align="center">

Made with â¤ï¸ by FLUX Gateway Team

</div>
