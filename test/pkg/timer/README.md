# å®šæ—¶ä»»åŠ¡æ¨¡å—æµ‹è¯•æ–‡æ¡£

æœ¬ç›®å½•åŒ…å«äº†å®šæ—¶ä»»åŠ¡æ¨¡å—ï¼ˆ`pkg/timer`ï¼‰çš„å®Œæ•´æµ‹è¯•å¥—ä»¶ï¼ŒåŒ…æ‹¬å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•å’ŒåŸºå‡†æµ‹è¯•ã€‚

## ğŸ“ æ–‡ä»¶ç»“æ„

```
test/pkg/timer/
â”œâ”€â”€ README.md              # æœ¬è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ run_tests.sh          # æµ‹è¯•è¿è¡Œè„šæœ¬
â”œâ”€â”€ test_helper.go        # æµ‹è¯•è¾…åŠ©å·¥å…·å’ŒMockå¯¹è±¡
â”œâ”€â”€ timer_test.go         # timer.go çš„å•å…ƒæµ‹è¯•
â”œâ”€â”€ scheduler_test.go     # scheduler.go çš„å•å…ƒæµ‹è¯•
â”œâ”€â”€ storage_test.go       # å­˜å‚¨æ¥å£çš„æµ‹è¯•
â””â”€â”€ integration_test.go   # é›†æˆæµ‹è¯•
```

## ğŸ§ª æµ‹è¯•ç±»å‹è¯´æ˜

### 1. å•å…ƒæµ‹è¯•

#### timer_test.go
æµ‹è¯• `timer.go` ä¸­çš„åŸºç¡€ç±»å‹å’Œå‡½æ•°ï¼š
- âœ… ä»»åŠ¡çŠ¶æ€æšä¸¾æµ‹è¯•
- âœ… è°ƒåº¦ç±»å‹æšä¸¾æµ‹è¯•
- âœ… ä»»åŠ¡ä¼˜å…ˆçº§æšä¸¾æµ‹è¯•
- âœ… é»˜è®¤è°ƒåº¦å™¨é…ç½®æµ‹è¯•
- âœ… ä»»åŠ¡é…ç½®ç»“æ„æµ‹è¯•
- âœ… ä»»åŠ¡ä¿¡æ¯ç»“æ„æµ‹è¯•
- âœ… ä»»åŠ¡ç»“æœç»“æ„æµ‹è¯•
- âœ… è¾…åŠ©å‡½æ•°æµ‹è¯•

#### scheduler_test.go
æµ‹è¯• `scheduler.go` ä¸­çš„è°ƒåº¦å™¨åŠŸèƒ½ï¼š
- âœ… è°ƒåº¦å™¨åˆ›å»ºå’Œé…ç½®
- âœ… è°ƒåº¦å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆå¯åŠ¨/åœæ­¢ï¼‰
- âœ… ä»»åŠ¡ç®¡ç†ï¼ˆæ·»åŠ /ç§»é™¤/è·å–/åˆ—è¡¨ï¼‰
- âœ… ä»»åŠ¡æ§åˆ¶ï¼ˆå¯åŠ¨/åœæ­¢/è§¦å‘ï¼‰
- âœ… ä»»åŠ¡å†å²è®°å½•æŸ¥è¯¢
- âœ… è¿è¡Œä¸­ä»»åŠ¡æŸ¥è¯¢
- âœ… é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- âœ… å¹¶å‘å¤„ç†èƒ½åŠ›
- âœ… åŸºå‡†æ€§èƒ½æµ‹è¯•

#### storage_test.go
æµ‹è¯•å­˜å‚¨æ¥å£çš„å®ç°ï¼š
- âœ… å†…å­˜å­˜å‚¨å®Œæ•´åŠŸèƒ½
- âœ… ä»»åŠ¡é…ç½®å­˜å‚¨æ“ä½œ
- âœ… ä»»åŠ¡ä¿¡æ¯å­˜å‚¨æ“ä½œ
- âœ… ä»»åŠ¡ç»“æœå­˜å‚¨æ“ä½œ
- âœ… å­˜å‚¨æ¸…ç†åŠŸèƒ½
- âœ… å¹¶å‘å®‰å…¨æ€§æµ‹è¯•
- âœ… å­˜å‚¨æ€§èƒ½åŸºå‡†æµ‹è¯•

### 2. é›†æˆæµ‹è¯•

#### integration_test.go
æµ‹è¯•å®Œæ•´çš„å·¥ä½œæµç¨‹ï¼š
- âœ… ç«¯åˆ°ç«¯å·¥ä½œæµç¨‹æµ‹è¯•
- âœ… å¤šä»»åŠ¡å¹¶å‘æ‰§è¡Œæµ‹è¯•
- âœ… ä»»åŠ¡å¤±è´¥æ¢å¤æµ‹è¯•
- âœ… è°ƒåº¦å™¨ç”Ÿå‘½å‘¨æœŸæµ‹è¯•
- âœ… Cronä»»åŠ¡è°ƒåº¦æµ‹è¯•
- âœ… é«˜è´Ÿè½½æ€§èƒ½æµ‹è¯•

### 3. æµ‹è¯•è¾…åŠ©å·¥å…·

#### test_helper.go
æä¾›æµ‹è¯•æ‰€éœ€çš„è¾…åŠ©å·¥å…·ï¼š
- âœ… `TestTaskExecutor` - æµ‹è¯•ç”¨ä»»åŠ¡æ‰§è¡Œå™¨
- âœ… `MemoryTaskStorage` - å†…å­˜å­˜å‚¨å®ç°
- âœ… `CreateTestTaskConfig` - åˆ›å»ºæµ‹è¯•ä»»åŠ¡é…ç½®
- âœ… `WaitForCondition` - æ¡ä»¶ç­‰å¾…å·¥å…·
- âœ… å„ç§æµ‹è¯•è¾…åŠ©å‡½æ•°

## ğŸš€ è¿è¡Œæµ‹è¯•

### å¿«é€Ÿè¿è¡Œ

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
./test/pkg/timer/run_tests.sh

# ä»…è¿è¡Œå•å…ƒæµ‹è¯•
./test/pkg/timer/run_tests.sh --only-unit

# è·³è¿‡è€—æ—¶è¾ƒé•¿çš„æµ‹è¯•
./test/pkg/timer/run_tests.sh --short
```

### æ‰‹åŠ¨è¿è¡Œ

```bash
# è¿›å…¥é¡¹ç›®æ ¹ç›®å½•
cd /path/to/gohub

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
go test -v ./test/pkg/timer

# è¿è¡Œç‰¹å®šæµ‹è¯•
go test -v -run TestSchedulerStartStop ./test/pkg/timer

# è¿è¡Œé›†æˆæµ‹è¯•
go test -v -run Integration ./test/pkg/timer

# è¿è¡ŒåŸºå‡†æµ‹è¯•
go test -v -bench=. -benchmem ./test/pkg/timer

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
go test -v -cover -coverprofile=coverage.out ./test/pkg/timer
go tool cover -html=coverage.out -o coverage.html
```

### æµ‹è¯•è„šæœ¬é€‰é¡¹

| é€‰é¡¹ | è¯´æ˜ |
|------|------|
| `--skip-integration` | è·³è¿‡é›†æˆæµ‹è¯• |
| `--skip-benchmark` | è·³è¿‡åŸºå‡†æµ‹è¯• |
| `--skip-race` | è·³è¿‡ç«æ€æ£€æµ‹ |
| `--only-unit` | ä»…è¿è¡Œå•å…ƒæµ‹è¯• |
| `--short` | è¿è¡Œç®€çŸ­æµ‹è¯•ï¼ˆè·³è¿‡è€—æ—¶è¾ƒé•¿çš„æµ‹è¯•ï¼‰ |
| `-h, --help` | æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ |

## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡

æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ä¿æŒ **80%** ä»¥ä¸Šçš„æµ‹è¯•è¦†ç›–ç‡ã€‚å½“å‰æµ‹è¯•è¦†ç›–äº†ï¼š

- âœ… æ ¸å¿ƒåŠŸèƒ½çš„æ‰€æœ‰ä¸»è¦è·¯å¾„
- âœ… é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæ¡ä»¶
- âœ… å¹¶å‘åœºæ™¯å’Œç«æ€æ¡ä»¶
- âœ… æ€§èƒ½å…³é”®è·¯å¾„

### æŸ¥çœ‹è¦†ç›–ç‡æŠ¥å‘Š

```bash
# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
go test -cover -coverprofile=coverage.out ./test/pkg/timer

# æŸ¥çœ‹è¦†ç›–ç‡ç»Ÿè®¡
go tool cover -func=coverage.out

# ç”Ÿæˆ HTML è¦†ç›–ç‡æŠ¥å‘Š
go tool cover -html=coverage.out -o coverage.html
```

## ğŸ”§ æµ‹è¯•æœ€ä½³å®è·µ

### 1. æµ‹è¯•å‘½åè§„èŒƒ

```go
// åŠŸèƒ½æµ‹è¯•ï¼šTest + åŠŸèƒ½åç§°
func TestSchedulerStart(t *testing.T) { ... }

// é”™è¯¯åœºæ™¯æµ‹è¯•ï¼šTest + åŠŸèƒ½åç§° + Error/Failure
func TestSchedulerStartError(t *testing.T) { ... }

// åŸºå‡†æµ‹è¯•ï¼šBenchmark + åŠŸèƒ½åç§°
func BenchmarkSchedulerAddTask(b *testing.B) { ... }

// é›†æˆæµ‹è¯•ï¼šTest + æ¨¡å—åç§° + Integration
func TestTimerIntegration(t *testing.T) { ... }
```

### 2. æµ‹è¯•ç»“æ„

æ¯ä¸ªæµ‹è¯•å‡½æ•°éƒ½åº”è¯¥éµå¾ª **AAA** æ¨¡å¼ï¼š
- **Arrange** - å‡†å¤‡æµ‹è¯•æ•°æ®å’Œç¯å¢ƒ
- **Act** - æ‰§è¡Œè¢«æµ‹è¯•çš„æ“ä½œ
- **Assert** - éªŒè¯ç»“æœ

```go
func TestExample(t *testing.T) {
    // Arrange - å‡†å¤‡
    storage := NewMemoryTaskStorage()
    scheduler := timer.NewStandardScheduler(nil, storage)
    
    // Act - æ‰§è¡Œ
    err := scheduler.Start()
    
    // Assert - éªŒè¯
    if err != nil {
        t.Errorf("Start() failed: %v", err)
    }
    if !scheduler.IsRunning() {
        t.Error("Scheduler should be running")
    }
}
```

### 3. å¹¶å‘æµ‹è¯•

å¯¹äºå¹¶å‘ç›¸å…³çš„æµ‹è¯•ï¼Œä½¿ç”¨é€‚å½“çš„åŒæ­¥æœºåˆ¶ï¼š

```go
func TestConcurrency(t *testing.T) {
    var wg sync.WaitGroup
    var mu sync.Mutex
    var counter int
    
    // å¯åŠ¨å¤šä¸ª goroutine
    for i := 0; i < 10; i++ {
        wg.Add(1)
        go func() {
            defer wg.Done()
            mu.Lock()
            counter++
            mu.Unlock()
        }()
    }
    
    wg.Wait()
    // éªŒè¯ç»“æœ...
}
```

### 4. è¶…æ—¶å¤„ç†

å¯¹äºå¯èƒ½é•¿æ—¶é—´è¿è¡Œçš„æµ‹è¯•ï¼Œè®¾ç½®åˆç†çš„è¶…æ—¶ï¼š

```go
func TestLongRunning(t *testing.T) {
    ctx, cancel := context.WithTimeout(context.Background(), time.Second*5)
    defer cancel()
    
    // ä½¿ç”¨ ctx æ§åˆ¶æµ‹è¯•è¶…æ—¶...
}
```

## ğŸ› è°ƒè¯•æµ‹è¯•

### 1. è¿è¡Œç‰¹å®šæµ‹è¯•

```bash
# è¿è¡Œç‰¹å®šçš„æµ‹è¯•å‡½æ•°
go test -v -run TestSchedulerStart ./test/pkg/timer

# è¿è¡ŒåŒ¹é…æ¨¡å¼çš„æµ‹è¯•
go test -v -run "TestScheduler.*" ./test/pkg/timer
```

### 2. å¯ç”¨è¯¦ç»†è¾“å‡º

```bash
# å¯ç”¨è¯¦ç»†è¾“å‡º
go test -v ./test/pkg/timer

# å¯ç”¨ç«æ€æ£€æµ‹
go test -race ./test/pkg/timer

# å¯ç”¨å†…å­˜åˆ†é…è·Ÿè¸ª
go test -benchmem -bench=. ./test/pkg/timer
```

### 3. è°ƒè¯•æŠ€å·§

```go
func TestDebug(t *testing.T) {
    // ä½¿ç”¨ t.Logf è¾“å‡ºè°ƒè¯•ä¿¡æ¯
    t.Logf("Debug info: %v", someValue)
    
    // ä½¿ç”¨ t.Helper() æ ‡è®°è¾…åŠ©å‡½æ•°
    helper := func() {
        t.Helper()
        // è¾…åŠ©é€»è¾‘...
    }
    
    // ä½¿ç”¨ t.Skip è·³è¿‡æµ‹è¯•
    if testing.Short() {
        t.Skip("Skipping in short mode")
    }
}
```

## ğŸ“ˆ æ€§èƒ½æµ‹è¯•

### åŸºå‡†æµ‹è¯•è§„èŒƒ

```go
func BenchmarkFunction(b *testing.B) {
    // å‡†å¤‡æµ‹è¯•æ•°æ®
    setup()
    
    // é‡ç½®è®¡æ—¶å™¨
    b.ResetTimer()
    
    // è¿è¡ŒåŸºå‡†æµ‹è¯•
    for i := 0; i < b.N; i++ {
        // è¢«æµ‹è¯•çš„æ“ä½œ
        functionUnderTest()
    }
}
```

### è¿è¡ŒåŸºå‡†æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰åŸºå‡†æµ‹è¯•
go test -bench=. ./test/pkg/timer

# è¿è¡Œç‰¹å®šåŸºå‡†æµ‹è¯•
go test -bench=BenchmarkSchedulerAddTask ./test/pkg/timer

# å¯ç”¨å†…å­˜åˆ†é…ç»Ÿè®¡
go test -bench=. -benchmem ./test/pkg/timer

# è¿è¡Œå¤šæ¬¡è·å¾—æ›´å‡†ç¡®çš„ç»“æœ
go test -bench=. -count=5 ./test/pkg/timer
```

## ğŸ¤ è´¡çŒ®æŒ‡å—

### æ·»åŠ æ–°æµ‹è¯•

1. **ç¡®å®šæµ‹è¯•ç±»å‹**ï¼šå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•è¿˜æ˜¯åŸºå‡†æµ‹è¯•
2. **é€‰æ‹©åˆé€‚çš„æ–‡ä»¶**ï¼šæ ¹æ®æµ‹è¯•å†…å®¹é€‰æ‹©å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶
3. **éµå¾ªå‘½åè§„èŒƒ**ï¼šä½¿ç”¨æ¸…æ™°çš„æµ‹è¯•å‡½æ•°åç§°
4. **ç¼–å†™å®Œæ•´æµ‹è¯•**ï¼šåŒ…æ‹¬æ­£å¸¸æƒ…å†µå’Œé”™è¯¯æƒ…å†µ
5. **æ·»åŠ æ³¨é‡Š**ï¼šè¯´æ˜æµ‹è¯•çš„ç›®çš„å’ŒéªŒè¯çš„åŠŸèƒ½

### æµ‹è¯•ä»£ç å®¡æŸ¥æ¸…å•

- [ ] æµ‹è¯•åç§°æ¸…æ™°ä¸”æœ‰æ„ä¹‰
- [ ] æµ‹è¯•è¦†ç›–äº†æ­£å¸¸å’Œå¼‚å¸¸æƒ…å†µ
- [ ] ä½¿ç”¨äº†é€‚å½“çš„æ–­è¨€å’Œé”™è¯¯æ¶ˆæ¯
- [ ] å¹¶å‘æµ‹è¯•æœ‰æ­£ç¡®çš„åŒæ­¥æœºåˆ¶
- [ ] æ¸…ç†äº†æµ‹è¯•èµ„æºï¼ˆdefer è¯­å¥ï¼‰
- [ ] æµ‹è¯•æ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¾èµ–å…¶ä»–æµ‹è¯•çš„çŠ¶æ€
- [ ] åŸºå‡†æµ‹è¯•æ­£ç¡®ä½¿ç”¨äº† b.ResetTimer()

## ğŸ“ æ”¯æŒ

å¦‚æœåœ¨è¿è¡Œæµ‹è¯•æ—¶é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æ£€æŸ¥ Go ç‰ˆæœ¬æ˜¯å¦ç¬¦åˆè¦æ±‚
2. ç¡®ä¿é¡¹ç›®ä¾èµ–å·²æ­£ç¡®å®‰è£…ï¼ˆ`go mod tidy`ï¼‰
3. æŸ¥çœ‹æµ‹è¯•è¾“å‡ºä¸­çš„é”™è¯¯ä¿¡æ¯
4. å°è¯•è¿è¡Œå•ä¸ªæµ‹è¯•ä»¥å®šä½é—®é¢˜
5. æ£€æŸ¥æ˜¯å¦æœ‰èµ„æºç«äº‰æˆ–æ­»é”é—®é¢˜

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒé¡¹ç›®çš„ä¸»è¦æ–‡æ¡£æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚ 