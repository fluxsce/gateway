# 更新日志

本文件记录了本项目的所有重要变更。

格式参考 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，并遵循 [语义化版本](https://semver.org/lang/zh-CN/) 规范。

## [Unreleased]（未发布）

### 新增
- 🚀 **路由包问题断言功能**
  - 新增请求体内容断言器（BodyContentAsserter），支持对 HTTP 请求体进行断言
  - 支持多种比较操作符：等于、不等于、包含、不包含、以...开头、以...结尾、正则匹配、存在、不存在
  - 支持大小写敏感/不敏感的比较选项
  - 优先使用上下文中已缓存的请求体，避免重复读取，提升性能
  - 正确处理请求体资源管理，确保无资源泄露

### 修复
- 🐛 **修复断言比较操作符逻辑错误**
  - 修复 `Contains` 和 `NotContains` 操作符的参数顺序错误
  - 修复前：检查期望值是否包含实际值（逻辑错误）
  - 修复后：检查实际值是否包含期望值（逻辑正确）
  - 确保所有断言器（Header、QueryParam、Cookie、BodyContent 等）的比较逻辑一致

- 🐛 **修复多服务转发响应体乱码问题**
  - 修复多服务转发场景下，其中一个服务的响应体出现乱码的问题
  - 正确处理 Go `http.Client` 自动解压后的响应体，移除 `Content-Encoding` 头避免客户端二次解压
  - 确保日志记录中的响应体内容正确显示

- 🐛 **优化日志配置获取性能**
  - 在请求上下文中直接存储日志配置，避免重复获取
  - 根据日志配置（`RecordRequestBody`、`RecordResponseBody`）控制是否缓存和记录请求体/响应体
  - 仅在需要记录时才缓存请求体和响应体，减少内存占用
  - 使用 `MaxBodySizeBytes` 限制记录的大小，避免记录过大的内容

## [3.0.1] - 2026-01-05

### 新增
- 🚀 **前端样式统一**
  - 统一前端 UI 组件样式规范
  - 优化用户体验一致性
  - 路由名称和网关日志中的路由名称使用主题主色突出显示

- 🚀 **网关后端服务群发功能**
  - 支持向多个网关后端服务批量发送消息

- 🚀 **权限资源管理**
  - 完善权限资源管理功能
  - 优化权限资源结构

### 变更
- ⚡ **网络隧道 SSE 传输优化**
  - 使用 `io.CopyBuffer` 替代 `io.Copy`，避免 Linux `splice` 系统调用导致的连接超时问题

- 🔧 **网关安全设置支持列表配置**
  - 网关安全设置部分支持列表配置方式
  - 提升配置灵活性和可维护性

- 🔧 **构建脚本优化**
  - 统一 Windows 和 Linux 构建脚本的打包路径和目录结构
  - 修复构建标签使用问题（Oracle 支持使用 `!no_oracle` 标签，而非 `ora` 标签）
  - 增强 Oracle 环境检查，环境不完整时停止构建并提示
  - 优化可执行文件与目录冲突处理逻辑
  - 修复 Windows 构建脚本中的链接器参数问题

### 修复
- 🐛 **修复 WebSocket 连接 hijack 后的响应处理问题**
  - 修复 WebSocket 升级成功后连接被 hijack 时，后续错误处理尝试写入 HTTP 响应导致的错误

- 🐛 **修复高并发场景下数据连接建立超时问题**
  - 修复客户端频繁出现 `dial tcp ... i/o timeout` 错误的问题
  - 添加重试机制，提高临时网络问题下的连接成功率

- 🐛 **修复隧道客户端服务注册后代理未启动问题**
  - 修复服务注册成功后未调用 `StartProxy` 导致 "proxy for service not found" 错误的问题
  - 确保服务注册成功后自动启动代理，服务注销时自动停止代理

## [2.0.4] - 2025-11-28

### 修复
- 🐛 **修复指标采集服务器信息管理器初始化问题**
  - 修复服务器信息插入时的唯一约束冲突问题
  - 优化查询逻辑，优先使用唯一约束字段（tenantId, metricServerId）查询
  - 确保服务器信息存在时执行更新而非插入操作

- 🐛 **修复限流器IP策略的IP提取问题**
  - 修复 ExtractIPKey 函数从 RemoteAddr 提取IP时未去除端口号的问题
  - 正确处理 X-Forwarded-For 头部包含多个IP的情况（取第一个）
  - 使用 net.SplitHostPort 正确分离IP和端口号

- 🐛 **修复语句执行历史记录ID生成可能重复的问题**
  - 修复 generateStatementId 和 generateExecutionId 函数使用时间戳可能生成重复ID的问题
  - 改用 random.Generate32BitRandomString() 生成唯一ID，确保分布式环境下也不重复
  - 使用时间戳+进程标识+原子计数器+强随机数组合，避免唯一约束冲突

## [2.0.3] - 2025-11-20

### 修复
- 🐛 **[关键] 修复异步日志记录的并发安全问题**
  - 修复日志记录时的竞态条件
  - 增强并发安全性保护

- 🐛 **[关键] 修复隧道客户端自动重连机制**

- 🐛 **内网穿透隧道功能超时问题修复**
  - 修复网络延迟较高情况下客户端数据连接建立超时问题
  - 修复带宽较低情况下连接超时问题

- 🐛 **修复 TLS 端口绑定异常问题**

### 变更
- ⚡ **隧道重连机制性能优化**
## [2.0.2] - 2025-11-11

### 新增
- 🚀 **内网穿透（隧道）功能**
  - 基于 FRP 架构的企业级内网穿透解决方案
  - 支持 TCP、UDP、HTTP、HTTPS 等多种协议代理
  - 反向代理：将内网服务暴露到公网
  - 客户端-服务器架构，支持多客户端连接
  - 动态服务注册与端口分配
  - 静态端口映射与负载均衡
  - 连接池技术，显著提升性能
  - 双向数据连接池（客户端到本地服务、客户端到服务器）
  - 池化连接预建立机制，降低连接延迟
  - 连接有效性检查，自动清理失效连接
  - 支持长连接（SSH、数据库等）与短连接（HTTP）
  - TCP 半关闭机制，优雅处理连接终止
  - 服务注册持久化，应用重启自动恢复

- 📊 **隧道管理界面**
  - 隧道服务器管理（hub0060）
  - 服务器节点管理（hub0061）
  - 隧道客户端管理（hub0062）
  - 隧道服务管理（hub0063）

### 变更
- ⚡ **性能提升**
  - 双重连接池机制，大幅降低连接建立开销
  - 连接复用率提升 80%+
  - 高并发场景下性能提升 3-5 倍
  - 减少 TCP TIME_WAIT 状态堆积
  - 优化内存使用，避免连接泄漏

### 修复

## [2.0.1] - 2025-10-24

### 新增
- 🚀 **服务注册中心功能**
  - 支持内部服务注册与服务发现机制
  - 支持 Nacos、Consul、Eureka、ETCD、ZooKeeper 等外部注册中心代理模式
  - 服务分组与授权管理
  - 服务实例自动注册、注销与心跳检测
  - 服务事件日志记录与追踪
  - 完整的服务健康检查机制
  - 支持临时实例与永久实例

- 🚀 **JVM 监控系统**
  - JVM 资源全方位监控（内存、线程、GC、类加载）
  - 堆内存与非堆内存详细监控
  - 内存池监控（Eden、Survivor、Old Gen、Metaspace 等）
  - GC 快照采集（jstat -gc 风格）
  - 线程监控与线程状态分布统计
  - 死锁检测与告警
  - 类加载器统计与性能分析
  - 应用级监控数据采集（线程池、连接池、自定义指标等）
  - 健康状态评级与智能告警

- 📊 **数据库支持增强**
  - 新增服务注册中心数据库表（4 张表）
  - 新增 JVM 监控系统数据库表（9 张表）
  - 完善 MySQL、Oracle、SQLite 初始化脚本
  - 优化索引策略

### 修复
- 🐛 修复服务以 service 方式启动时日志文件不滚动的问题

## [2.0.0] - 2025-08-05

### 新增
- **核心网关功能**
  - 支持基于路径、方法、Header 的智能路由
  - 轮询、加权轮询、最少连接等多种负载均衡算法
  - 服务发现与健康检查
  - 高性能 HTTP/HTTPS 代理转发

- **安全特性**
  - JWT、OAuth2、API Key 认证
  - IP 白名单/黑名单、User-Agent 过滤
  - 完善的 CORS 支持
  - 自动注入安全响应头

- **性能优化**
  - 令牌桶、滑动窗口限流
  - 熔断器，自动故障检测与降级
  - 支持 Redis 与内存缓存
  - 连接池高效复用

- **监控与运维**
  - 实时系统指标与 API 调用统计
  - 多格式结构化日志
  - 服务健康监控
  - 集成 pprof 性能分析

- **管理界面**
  - 直观的 Web 管理控制台
  - 可视化配置管理与实时更新
  - 实时性能与流量监控面板
  - 在线日志查看与检索

- **数据库支持**
  - MySQL 8.0+ 支持
  - MongoDB 4.4+ 支持
  - ClickHouse 分析型数据库支持
  - Oracle 数据库支持
  - SQLite 轻量级部署支持
  - Redis 缓存集成

- **其他特性**
  - 多租户架构支持
  - 配置热加载，无需重启服务
  - 优雅的关闭与重启
  - SFTP、SSH 工具集成
  - 定时任务与 Cron 管理
  - 指标采集与系统监控
  - 插件架构，便于扩展

### 技术细节
- 基于 Go 1.24+ 开发
- 使用 Gin 框架处理 HTTP
- 实现现代微服务架构模式
- 云原生设计，支持 Kubernetes
- 完善的测试覆盖
- 支持 Docker 容器化部署

### 配置
- 基于 YAML 的配置系统
- 支持环境变量
- 配置校验与热加载
- 提供丰富的示例与模板

### 性能
- 支持 10,000+ 并发连接
- 支持 50,000+ QPS
- P99 延迟低于 1ms
- 内存占用低于 100MB
- 空闲时 CPU 占用低于 5%

## [1.x.x] - 历史版本

### 说明
1.x.x 版本为内部发布版本，未在本日志中详细记录。
2.0.0 为首个公开发布版本，包含完整文档与 Apache 2.0 协议。

## 版本对比

| 版本    | 发布时间    | 主要特性                                       |
|---------|-------------|------------------------------------------------|
| 3.0.1   | 2026-01-05  | 前端UI统一、权限资源结构优化、隧道客户端修复、构建脚本优化 |
| 2.0.4   | 2025-11-28  | 指标采集初始化修复、限流器IP提取修复           |
| 2.0.3   | 2025-11-20  | 自动重连修复、心跳机制增强、服务注册重试       |
| 2.0.2   | 2025-11-11  | 内网穿透、双向连接池、死锁修复、性能优化       |
| 2.0.1   | 2025-10-24  | 服务注册中心、JVM 监控、日志滚动修复           |
| 2.0.0   | 2025-08-05  | 全面重构，Apache 2.0，完整文档                 |
| 1.x.x   | 内部版本    | 旧版内部版本                                   |

## 升级指南

### 从 2.0.x 升级到 3.0.1

本次升级包含网关安全管理配置的不兼容变更，需要重新配置安全设置：

1. **网关安全设置配置变更**
   - 安全设置部分支持列表配置方式
   - 原有安全设置配置格式已变更
   - **重要**：需要重新配置网关的安全设置（IP 白名单/黑名单、User-Agent 过滤、CORS 等）

**迁移步骤：**
1. 备份现有配置与数据
2. 备份当前网关安全设置配置
3. 使用安装脚本重新安装服务
   - **Linux**: 执行 `scripts/deploy/install-service-linux.sh` 重新安装服务
   - **Windows**: 执行 `scripts/deploy/install-service.cmd` 重新安装服务
4. 重新配置网关安全设置（IP 白名单/黑名单、认证策略等）
5. 在开发环境测试新配置
6. 验证安全策略是否正常工作
7. 采用滚动升级策略部署到生产环境

**注意事项：**
- 升级前请务必备份安全设置配置
- 升级后需要手动重新配置所有安全设置
- 建议在升级前记录当前的安全策略，以便迁移时参考

### 从 1.x.x 升级到 2.0.0
本次为重大版本升级，存在不兼容变更：

1. **配置格式**：YAML 配置全新设计
2. **API 变更**：采用全新 RESTful API 结构
3. **数据库结构**：表结构与命名规范更新
4. **依赖升级**：升级至 Go 1.24+ 及现代依赖

**迁移步骤：**
1. 备份现有配置与数据
2. 参考 `/configs/gateway.yaml` 新配置格式
3. 使用迁移脚本更新数据库结构
4. 在开发环境测试新配置
5. 采用滚动升级策略部署到生产环境

### 版本兼容性承诺
自 2.0.0 起：
- **遵循语义化版本规范**
  - 主版本号 (X.0.0)：不兼容的 API 变更
  - 次版本号 (X.Y.0)：向下兼容的功能新增
  - 修订号 (X.Y.Z)：向下兼容的问题修复
- 次版本和修订版完全向后兼容，无需升级指南
- 重大变更将在主版本中进行，并提前公告

**注意：** 3.0.1 版本虽然为修订版本，但包含网关安全管理配置的不兼容变更，需要重新设置。这是由于权限系统优化的必要性，我们将在后续版本中保持更好的向后兼容性。

## 贡献日志说明

贡献代码时请：

1. 将变更添加到 `[Unreleased]` 部分
2. 使用如下分类：
   - `新增`：新特性
   - `变更`：已有功能变更
   - `弃用`：即将移除的功能
   - `移除`：已移除的功能
   - `修复`：Bug 修复
   - `安全`：安全漏洞修复

3. 格式示例：
   ```markdown
   - **类别**：简要描述 [#PR编号](PR链接)
   ```

4. 链接相关的 Pull Request 和 Issue

## 支持与反馈

如需了解特定版本详情或升级支持：
- 查阅[项目文档](docs/)
- 提交 [Issue](https://github.com/your-org/gateway/issues)
- 参与[社区讨论](https://github.com/your-org/gateway/discussions)

---

**图例：**
- 🚀 新特性
- 🔧 改进
- 🐛 修复

- ⚡ 性能
- 🛡️ 安全 