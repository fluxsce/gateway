import"./GPagination.vue_vue_type_style_index_0_scoped_2c35df38_lang-C1Vti-fj.js";import{u as Y}from"./useGDialog-B-gHIdxi.js";import{r as D,aa as x,T as A,af as B,m as z,z as g,A as G,B as u}from"./index-ESHYz3i9.js";import{c as E}from"./SearchForm-C8LTWaYg.js";import{D as H}from"./DocumentOutline-CzFXHj6K.js";import{K as F}from"./KeyOutline-mOR-j_95.js";import{A as W}from"./AddOutline-I2AMvI0I.js";import{C as J}from"./CreateOutline--XfT6bD4.js";import{T as q}from"./TrashOutline-BfDLtdZv.js";import{N as K}from"./DynamicTags-CAL5qUJa.js";import{W as U}from"./WarningOutline-sOXT_Ym-.js";function j(){const s="hub0040",n=D(!1),d=D([]),f=D(),o={fields:[{field:"instanceName",label:"实例名称",type:"input",placeholder:"请输入实例名称",span:6,clearable:!0},{field:"serverType",label:"服务器类型",type:"select",placeholder:"请选择类型",span:6,clearable:!0,options:[{label:"全部",value:""},{label:"gRPC",value:"GRPC"},{label:"HTTP",value:"HTTP"}]},{field:"instanceStatus",label:"实例状态",type:"select",placeholder:"请选择状态",span:6,clearable:!0,options:[{label:"全部",value:""},{label:"停止",value:"STOPPED"},{label:"启动中",value:"STARTING"},{label:"运行中",value:"RUNNING"},{label:"停止中",value:"STOPPING"},{label:"异常",value:"ERROR"}]},{field:"activeFlag",label:"活动状态",type:"select",placeholder:"请选择状态",span:6,clearable:!0,options:[{label:"全部",value:""},{label:"活动",value:"Y"},{label:"非活动",value:"N"}]}],toolbarButtons:[{key:"add",label:"新建实例",icon:W,type:"primary",tooltip:"新建服务中心实例"},{key:"edit",label:"编辑",icon:J,tooltip:"编辑选中的实例"},{key:"delete",label:"删除",icon:q,type:"error",tooltip:"删除选中的实例"}],showSearchButton:!0,showResetButton:!0},T={tabs:[{key:"basic",label:"基本信息"},{key:"grpc",label:"gRPC配置"},{key:"tls",label:"TLS配置"},{key:"performance",label:"性能配置"},{key:"health",label:"健康检查"},{key:"access",label:"访问控制"},{key:"other",label:"其它"}],fields:[{field:"tenantId",label:"租户ID",type:"input",span:12,tabKey:"basic",primary:!0,show:!1,disabled:!0},{field:"instanceName",label:"实例名称",type:"input",placeholder:"请输入实例名称",span:12,tabKey:"basic",primary:!0,required:!0},{field:"environment",label:"部署环境",type:"select",placeholder:"请选择部署环境",span:12,tabKey:"basic",primary:!0,required:!0,options:[{label:"开发环境",value:"DEVELOPMENT"},{label:"预发布环境",value:"STAGING"},{label:"生产环境",value:"PRODUCTION"}]},{field:"serverType",label:"服务器类型",type:"select",placeholder:"请选择服务器类型",span:12,tabKey:"basic",defaultValue:"GRPC",options:[{label:"gRPC",value:"GRPC"},{label:"HTTP",value:"HTTP"}]},{field:"listenAddress",label:"监听地址",type:"input",placeholder:"如: 0.0.0.0",span:12,tabKey:"basic",required:!0,defaultValue:"0.0.0.0",tips:"服务器绑定的网络地址，0.0.0.0表示监听所有网络接口"},{field:"listenPort",label:"监听端口",type:"number",placeholder:"如: 12004",span:12,tabKey:"basic",required:!0,defaultValue:12004,props:{min:1,max:65535}},{field:"activeFlag",label:"活动状态",type:"switch",span:12,tabKey:"basic",defaultValue:"Y",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"noteText",label:"备注",type:"textarea",placeholder:"请输入备注信息",span:24,tabKey:"basic",props:{rows:3}},{field:"grpc-config-group",label:"gRPC 消息大小配置",type:"fieldset",tabKey:"grpc",children:[{field:"maxRecvMsgSize",label:"最大接收消息大小(字节)",type:"number",placeholder:"16777216",span:12,defaultValue:16777216,tips:"单个 gRPC 消息的最大接收大小，默认16MB",props:{min:1024,max:104857600}},{field:"maxSendMsgSize",label:"最大发送消息大小(字节)",type:"number",placeholder:"16777216",span:12,defaultValue:16777216,tips:"单个 gRPC 消息的最大发送大小，默认16MB",props:{min:1024,max:104857600}}]},{field:"keepalive-config-group",label:"gRPC Keep-Alive 配置",type:"fieldset",tabKey:"grpc",children:[{field:"keepAliveTime",label:"Keep-alive 发送间隔(秒)",type:"number",placeholder:"30",span:12,defaultValue:30,tips:"服务器发送 Keep-alive ping 的间隔时间",props:{min:1,max:300}},{field:"keepAliveTimeout",label:"Keep-alive 超时时间(秒)",type:"number",placeholder:"10",span:12,defaultValue:10,tips:"Keep-alive ping 的超时时间",props:{min:1,max:60}},{field:"keepAliveMinTime",label:"客户端最小 Keep-alive 间隔(秒)",type:"number",placeholder:"15",span:12,defaultValue:15,tips:"客户端允许的最小 Keep-alive ping 间隔",props:{min:1,max:300}},{field:"permitWithoutStream",label:"允许无活跃流时发送 Keep-alive",type:"switch",span:12,defaultValue:"Y",tips:"是否允许在没有活跃流的情况下发送 Keep-alive ping",props:{checkedValue:"Y",uncheckedValue:"N"}}]},{field:"connection-config-group",label:"gRPC 连接管理配置",type:"fieldset",tabKey:"grpc",children:[{field:"maxConnectionIdle",label:"最大连接空闲时间(秒)",type:"number",placeholder:"0",span:12,defaultValue:0,tips:"连接的最大空闲时间，0表示无限制",props:{min:0}},{field:"maxConnectionAge",label:"最大连接存活时间(秒)",type:"number",placeholder:"0",span:12,defaultValue:0,tips:"连接的最大存活时间，0表示无限制",props:{min:0}},{field:"maxConnectionAgeGrace",label:"连接关闭宽限期(秒)",type:"number",placeholder:"20",span:12,defaultValue:20,tips:"连接关闭前的宽限期，允许正在处理的请求完成",props:{min:0,max:300}},{field:"enableReflection",label:"启用 gRPC 反射",type:"switch",span:12,defaultValue:"Y",tips:"启用 gRPC 反射服务，用于 grpcurl 等工具调试",props:{checkedValue:"Y",uncheckedValue:"N"}}]},{field:"tls-config-group",label:"TLS安全配置",type:"fieldset",tabKey:"tls",children:[{field:"certStorageType",label:"证书存储类型",type:"select",span:12,defaultValue:"DATABASE",show:!1,options:[{label:"文件存储",value:"FILE"},{label:"数据库存储",value:"DATABASE"}]},{field:"enableTLS",label:"启用TLS",type:"switch",span:12,defaultValue:"N",tips:"启用TLS加密传输，保护数据传输安全",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"enableMTLS",label:"启用双向TLS认证",type:"switch",span:12,defaultValue:"N",tips:"启用双向TLS认证（mTLS），要求客户端也提供证书",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"certPassword",label:"证书密码",type:"input",placeholder:"请输入证书密码(可选)",span:12,tips:"如果私钥文件已加密，需要提供密码进行解密",props:{type:"password",showPasswordOn:"click"}},{field:"certFileList",label:"证书文件",type:"file",span:24,props:{title:"证书文件",titleIcon:H,titleIconColor:"#18a058",showDownload:!0,config:{accept:".crt,.pem,.cer",max:1,maxSize:10*1024*1024,mode:"text",uploadText:"点击或拖拽上传证书",uploadDescription:"支持 .crt, .pem, .cer"}}},{field:"keyFileList",label:"私钥文件",type:"file",span:24,props:{title:"私钥文件",titleIcon:F,titleIconColor:"#f0a020",showDownload:!0,config:{accept:".key,.pem",max:1,maxSize:10*1024*1024,mode:"text",uploadText:"点击或拖拽上传私钥",uploadDescription:"支持 .key, .pem"}}}]},{field:"performance-config-group",label:"性能调优配置",type:"fieldset",tabKey:"performance",children:[{field:"maxConcurrentStreams",label:"最大并发流数量",type:"number",placeholder:"250",span:12,defaultValue:250,tips:"单个连接的最大并发流数量，0表示无限制",props:{min:0,max:1e4}},{field:"readBufferSize",label:"读缓冲区大小(字节)",type:"number",placeholder:"32768",span:12,defaultValue:32768,tips:"读取数据的缓冲区大小，默认32KB",props:{min:1024,max:1048576}},{field:"writeBufferSize",label:"写缓冲区大小(字节)",type:"number",placeholder:"32768",span:12,defaultValue:32768,tips:"写入数据的缓冲区大小，默认32KB",props:{min:1024,max:1048576}}]},{field:"health-config-group",label:"健康检查配置",type:"fieldset",tabKey:"health",children:[{field:"healthCheckInterval",label:"健康检查间隔(秒)",type:"number",placeholder:"60",span:12,defaultValue:60,tips:"健康检查的执行间隔，0表示禁用健康检查。注意：客户端的心跳时间应小于此间隔，建议心跳时间为间隔的1/2到2/3",props:{min:0,max:3600}},{field:"healthCheckTimeout",label:"健康检查超时时间(秒)",type:"number",placeholder:"5",span:12,defaultValue:5,tips:"健康检查的超时时间",props:{min:1,max:60}}]},{field:"access-config-group",label:"访问控制配置",type:"fieldset",tabKey:"access",children:[{field:"enableAuth",label:"启用认证",type:"switch",span:12,defaultValue:"N",tips:"启用认证后，客户端需要提供有效的认证信息才能访问",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"ipWhitelist",label:"IP 白名单",type:"custom",span:24,defaultValue:[],tips:"允许访问的IP地址或CIDR网段，留空表示不限制",render:e=>{let r=e.ipWhitelist||[];if(typeof r=="string")try{r=JSON.parse(r)}catch{r=r.split(",").map(c=>c.trim()).filter(Boolean)}return A(K,{value:Array.isArray(r)?r:[],"onUpdate:value":c=>{e.ipWhitelist=c.length>0?JSON.stringify(c):""},placeholder:"添加IP地址或CIDR网段，如: 192.168.1.0/24"})}},{field:"ipBlacklist",label:"IP 黑名单",type:"custom",span:24,defaultValue:[],tips:"禁止访问的IP地址或CIDR网段",render:e=>{let r=e.ipBlacklist||[];if(typeof r=="string")try{r=JSON.parse(r)}catch{r=r.split(",").map(c=>c.trim()).filter(Boolean)}return A(K,{value:Array.isArray(r)?r:[],"onUpdate:value":c=>{e.ipBlacklist=c.length>0?JSON.stringify(c):""},placeholder:"添加IP地址或CIDR网段，如: 192.168.1.100"})}}]},{field:"addTime",label:"创建时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"addWho",label:"创建人",type:"input",span:12,tabKey:"other",disabled:!0},{field:"editTime",label:"修改时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"editWho",label:"修改人",type:"input",span:12,tabKey:"other",disabled:!0}]},y={columns:[{field:"instanceName",title:"实例名称",sortable:!0,align:"center",showOverflow:!0},{field:"environment",title:"部署环境",sortable:!0,align:"center",showOverflow:!0,formatter:({cellValue:e})=>({DEVELOPMENT:"开发环境",STAGING:"预发布环境",PRODUCTION:"生产环境"})[e]||e},{field:"serverType",title:"服务器类型",align:"center",showOverflow:!0,formatter:({cellValue:e})=>e==="GRPC"?"gRPC":e},{field:"listenAddress",title:"监听地址",align:"center",showOverflow:!0},{field:"listenPort",title:"监听端口",align:"center"},{field:"instanceStatus",title:"实例状态",align:"center",slots:{default:"instanceStatus"}},{field:"isRunning",title:"运行状态",align:"center",slots:{default:"isRunning"},formatter:({row:e})=>e.instanceStatus==="RUNNING"?"运行中":"已停止"},{field:"enableTLS",title:"TLS",align:"center",slots:{default:"enableTLS"}},{field:"enableAuth",title:"认证",align:"center",slots:{default:"enableAuth"}},{field:"activeFlag",title:"活动状态",align:"center",slots:{default:"activeFlag"}},{field:"statusMessage",title:"状态消息",align:"left",showOverflow:!0,width:200,formatter:({cellValue:e})=>e||"-"},{field:"lastStatusTime",title:"最后状态变更时间",sortable:!0,align:"center",showOverflow:!0,formatter:({cellValue:e})=>e?x(e,"YYYY-MM-DD HH:mm:ss"):"-"},{field:"lastHealthCheckTime",title:"最后健康检查时间",sortable:!0,align:"center",showOverflow:!0,formatter:({cellValue:e})=>e?x(e,"YYYY-MM-DD HH:mm:ss"):"-"},{field:"addTime",title:"创建时间",sortable:!0,showOverflow:!0,formatter:({cellValue:e})=>e?x(e,"YYYY-MM-DD HH:mm:ss"):""},{field:"addWho",title:"创建人",showOverflow:!0},{field:"editTime",title:"修改时间",sortable:!0,showOverflow:!0,formatter:({cellValue:e})=>e?x(e,"YYYY-MM-DD HH:mm:ss"):""},{field:"editWho",title:"修改人",showOverflow:!0}],showCheckbox:!0,paginationConfig:{show:!0,pageInfo:f,align:"right"},menuConfig:{enabled:!0,showCopyRow:!0,showCopyCell:!0,customMenus:[{code:"view",name:"查看详情",prefixIcon:"vxe-icon-eye-fill"},{code:"edit",name:"编辑",prefixIcon:"vxe-icon-edit"},{code:"delete",name:"删除",prefixIcon:"vxe-icon-delete"},{code:"start",name:"启动",prefixIcon:"vxe-icon-caret-right"},{code:"stop",name:"停止",prefixIcon:"vxe-icon-square"},{code:"reload",name:"重载配置",prefixIcon:"vxe-icon-refresh"}]},height:"100%"},P=()=>{f.value=void 0},w=e=>{f.value?Object.assign(f.value,e):f.value=e},O=e=>{d.value=e},I=()=>{d.value=[]},k=e=>{d.value.unshift(e)},M=(e,r,c,C)=>{const h=d.value.findIndex(N=>N.instanceName===e&&N.environment===r&&N.tenantId===c);h!==-1&&Object.assign(d.value[h],C)},p=(e,r,c)=>{const C=d.value.findIndex(h=>h.instanceName===e&&h.environment===r&&h.tenantId===c);C!==-1&&d.value.splice(C,1)};return{moduleId:s,loading:n,instanceList:d,pageInfo:f,searchFormConfig:o,instanceFormConfig:T,gridConfig:y,resetPagination:P,updatePagination:w,setInstanceList:O,clearInstanceList:I,addInstanceToList:k,updateInstanceInList:M,removeInstanceFromList:p,removeInstancesFromList:e=>{e.forEach(r=>{p(r.instanceName,r.environment,r.tenantId)})}}}const v=B("/serviceCenter/hub0040");async function Q(s){return v.post("/queryServiceCenterInstances",s)}async function $(s,n){return v.post("/getServiceCenterInstance",{instanceName:s,environment:n})}async function X(s){return v.post("/addServiceCenterInstance",s)}async function Z(s){return v.post("/editServiceCenterInstance",s)}async function _(s,n){return v.post("/deleteServiceCenterInstance",{instanceName:s,environment:n})}async function ee(s,n){return v.post("/startServiceCenterInstance",{instanceName:s,environment:n})}async function te(s,n){return v.post("/stopServiceCenterInstance",{instanceName:s,environment:n})}async function ae(s,n){return v.post("/reloadServiceCenterInstance",{instanceName:s,environment:n})}function ge(s){const n=z(),d=Y(),f=j(),{loading:o,instanceList:T,pageInfo:y,setInstanceList:P,updatePagination:w,addInstanceToList:O,updateInstanceInList:I,removeInstanceFromList:k,removeInstancesFromList:M}=f,p=async t=>{var a,l,i;o.value=!0;try{let m=t;!m&&((a=s==null?void 0:s.value)!=null&&a.getFormData)&&(m=s.value.getFormData()||{});const L={...m?Object.fromEntries(Object.entries(m).filter(([,b])=>b!==""&&b!==null&&b!==void 0)):{},...E((l=y.value)==null?void 0:l.pageIndex,(i=y.value)==null?void 0:i.pageSize)},S=await Q(L);if(S.oK){if(S.bizData){const b=JSON.parse(S.bizData),V=Array.isArray(b)?b:[];P(V)}if(S.pageQueryData){const b=JSON.parse(S.pageQueryData);w(b)}}else n.error(S.errMsg||"查询实例列表失败")}catch{n.error("加载实例列表失败")}finally{o.value=!1}};return{model:f,loadInstances:p,handleSearch:async t=>{await p(t)},handleReset:async()=>{f.resetPagination(),await p()},handlePageChange:async({currentPage:t,pageSize:a})=>{w({pageIndex:t,pageSize:a}),await p()},handleRefresh:async()=>{await p()},addInstance:async t=>{o.value=!0;try{const a=await X(t);if(g(a)){const l=u(a,"服务中心实例创建成功");if(n.success(l),a.bizData){const i=JSON.parse(a.bizData);O(i)}else await p();return!0}else{const l=u(a,"新增实例失败");return n.error(l),!1}}catch{return n.error("新增实例失败"),!1}finally{o.value=!1}},editInstance:async t=>{o.value=!0;try{const a=await Z(t);if(g(a)){const l=u(a,"服务中心实例更新成功");if(n.success(l),a.bizData){const i=JSON.parse(a.bizData);I(i.instanceName,i.environment,i.tenantId,i)}else{const i=T.value.find(m=>m.instanceName===t.instanceName&&m.environment===t.environment);i&&I(t.instanceName,t.environment,i.tenantId,t)}return!0}else{const l=u(a,"编辑实例失败");return n.error(l),!1}}catch{return n.error("编辑实例失败"),!1}finally{o.value=!1}},deleteInstance:async t=>{if(!await d.warning({title:"确认删除",subtitle:"此操作不可恢复，请谨慎操作",content:`确定要删除实例 "${t.instanceName}" (${t.environment}) 吗？`,icon:U,headerStyle:"gradient",positiveText:"确定删除",negativeText:"取消",width:500}))return!1;o.value=!0;try{const l=await _(t.instanceName,t.environment);if(g(l)){const i=u(l,"删除实例成功");return n.success(i),k(t.instanceName,t.environment,t.tenantId),T.value.length===0&&y.value&&y.value.pageIndex>1&&(w({pageIndex:y.value.pageIndex-1}),await p()),!0}else{const i=u(l,"删除实例失败");return n.error(i),!1}}catch{return n.error("删除实例失败"),!1}finally{o.value=!1}},startInstance:async t=>{o.value=!0;try{const a=await ee(t.instanceName,t.environment);if(g(a)){const l=u(a,"实例启动成功");return n.success(l),I(t.instanceName,t.environment,t.tenantId,{instanceStatus:"RUNNING"}),await p(),!0}else{const l=u(a,"启动失败");return n.error(l),!1}}catch{return n.error("启动失败"),!1}finally{o.value=!1}},stopInstance:async t=>{o.value=!0;try{const a=await te(t.instanceName,t.environment);if(g(a)){const l=u(a,"实例停止成功");return n.success(l),I(t.instanceName,t.environment,t.tenantId,{instanceStatus:"STOPPED"}),await p(),!0}else{const l=u(a,"停止失败");return n.error(l),!1}}catch{return n.error("停止失败"),!1}finally{o.value=!1}},reloadInstance:async t=>{o.value=!0;try{const a=await ae(t.instanceName,t.environment);if(g(a)){const l=u(a,"配置重载成功");return n.success(l),await p(),!0}else{const l=u(a,"配置重载失败");return n.error(l),!1}}catch{return n.error("配置重载失败"),!1}finally{o.value=!1}},getInstanceDetail:async(t,a)=>{try{const l=await $(t,a);return g(l)?G(l,null):(n.error(u(l,"获取实例详情失败")),null)}catch{return n.error("获取实例详情失败"),null}}}}export{ge as u};
