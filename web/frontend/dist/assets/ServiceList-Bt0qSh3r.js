import{G as j,S as te}from"./SearchForm-YJ2LWOI7.js";import{G as Z}from"./GDataFormModal-CVDITwbR.js";import{G as Y}from"./GCard-Df0ydLzO.js";import{G as q}from"./GPane-MizfBz4X.js";import{d as K,db as oe,m as X,c as B,o as T,b as i,e,am as V,w as a,bV as ne,g as J,h as z,J as G,K as b,t as C,aO as U,r as N,aa as re,_ as W,f as P,i as Q,bW as ce,bX as F,q as de,j as ee,cr as ae}from"./index-talhFt-3.js";import"./GPagination.vue_vue_type_style_index_0_scoped_2c35df38_lang-Ds-H5BDS.js";import"./useNamespaceService-Ci56zPwP.js";import{u as ue}from"./useNamespacePage-j7OoDYUW.js";/* empty css                                                                              */import{G as me}from"./GTextShow-Cpg2qvky.js";import{e as fe,o as ve,a as pe,u as he}from"./useServiceService-DRiH148Z.js";import{c as ge}from"./index-Do6tdfLc.js";import{C as be}from"./CreateOutline-5HZeJ_Zc.js";import{A as Se}from"./ArrowBackOutline-Jb9aqebj.js";import{u as Ne}from"./useGDialog-DyYy8db0.js";import"./RefreshOutline-CA3DFaJQ.js";import"./Select-B2cdGhy0.js";import"./GModal-CCcCEJqk.js";import"./ContractOutline-BiyZGpf6.js";import"./CloseOutline-Dpm_uP78.js";import"./DownloadOutline-BSXu5v1r.js";import"./Upload-CvnZ1nba.js";import"./download-C2161hUv.js";import"./DocumentOutline-BjVf7Dk_.js";import"./useServiceCenterInstanceService-DxFF0nHi.js";import"./KeyOutline-CIJanbLW.js";import"./AddOutline-_WyjpAxi.js";import"./TrashOutline-B0_nSqhO.js";import"./DynamicTags-6ZvqYpG4.js";import"./prop-NnGblK-3.js";import"./WarningOutline-DmMvjmvd.js";import"./CheckmarkCircleOutline-DgcYcMd5.js";import"./AlertCircleOutline-KYOuJ1zE.js";import"./HourglassOutline-WUU1QmOO.js";import"./StopCircleOutline-Dq9VUHq4.js";import"./EllipsisHorizontalOutline-CQvCckwd.js";import"./InputGroup-C4T1Hgnm.js";import"./CopyOutline-BYxst-d8.js";import"./CodeOutline-B3mIr7RC.js";import"./GDialog-CQwmJXZh.js";const Ce={class:"service-node-list",id:"service-node-list"},ye=K({name:"ServiceNodeList",__name:"ServiceNodeList",props:{nodes:{default:()=>[]},loading:{type:Boolean,default:!1},moduleId:{default:"service-node-list"}},emits:["refresh"],setup(u,{emit:k}){const h=k,y=oe(),s=X(),g=N(!1),f=N(null),p=N(!1),n=[{field:"nodeId",label:"节点ID",type:"input",disabled:!0,required:!0},{field:"ipAddress",label:"IP地址",type:"input",disabled:!0,required:!0},{field:"portNumber",label:"端口号",type:"input",disabled:!0,required:!0},{field:"weight",label:"权重",type:"input",required:!0,defaultValue:1},{field:"instanceStatus",label:"实例状态",type:"select",required:!0,options:[{label:"运行中",value:"UP"},{label:"已下线",value:"DOWN"},{label:"启动中",value:"STARTING"},{label:"停止服务",value:"OUT_OF_SERVICE"}]},{field:"healthyStatus",label:"健康状态",type:"select",required:!0,options:[{label:"健康",value:"HEALTHY"},{label:"不健康",value:"UNHEALTHY"},{label:"未知",value:"UNKNOWN"}]},{field:"ephemeral",label:"临时实例",type:"select",required:!0,options:[{label:"是",value:"Y"},{label:"否",value:"N"}]},{field:"metadataJson",label:"元数据",type:"textarea",placeholder:"JSON 格式"}],o={columns:[{field:"nodeId",title:"节点ID",align:"center",width:200,showOverflow:!0,sortable:!0,filters:[{data:""}],filterRender:{name:"input"}},{field:"ipAddress",title:"IP",align:"center",showOverflow:!0,sortable:!0,filters:[{data:""}],filterRender:{name:"input"}},{field:"portNumber",title:"端口",align:"center",width:100,sortable:!0,filters:[{data:""}],filterRender:{name:"input"}},{field:"ephemeral",title:"临时实例",align:"center",width:100,slots:{default:"ephemeral"},filterRender:{name:"select",options:[{label:"全部",value:""},{label:"是",value:"Y"},{label:"否",value:"N"}]}},{field:"weight",title:"权重",align:"center",width:100,sortable:!0,filters:[{data:""}],filterRender:{name:"input"}},{field:"instanceStatus",title:"实例状态",align:"center",width:120,slots:{default:"instanceStatus"},filterRender:{name:"select",options:[{label:"全部",value:""},{label:"运行中",value:"UP"},{label:"已下线",value:"DOWN"},{label:"启动中",value:"STARTING"},{label:"停止服务",value:"OUT_OF_SERVICE"}]}},{field:"healthyStatus",title:"健康状态",align:"center",width:120,slots:{default:"healthyStatus"},filterRender:{name:"select",options:[{label:"全部",value:""},{label:"健康",value:"HEALTHY"},{label:"不健康",value:"UNHEALTHY"},{label:"未知",value:"UNKNOWN"}]}},{field:"metadataJson",title:"元数据",align:"left",showOverflow:!0,slots:{default:"metadataJson"}},{field:"lastBeatTime",title:"心跳时间",align:"center",width:180,sortable:!0,slots:{default:"lastBeatTime"}},{field:"action",title:"操作",align:"center",width:160,slots:{default:"action"}}],filterConfig:{remote:!1},showCheckbox:!1,showSeq:!0,paginationConfig:{show:!1},menuConfig:{enabled:!0,showCopyRow:!1,showCopyCell:!1,customMenus:[{code:"edit",name:"编辑"},{code:"online",name:"上线"},{code:"offline",name:"下线"},{code:"refresh",name:"刷新"}]},height:"100%"},S=t=>{if(!t)return"-";try{const l=JSON.parse(t);return Object.entries(l).map(([m,A])=>`${m}=${A}`).join(", ")}catch{return t}},I=t=>({UP:"success",DOWN:"error",STARTING:"warning",OUT_OF_SERVICE:"info"})[t]||"default",R=t=>({UP:"运行中",DOWN:"已下线",STARTING:"启动中",OUT_OF_SERVICE:"停止服务"})[t]||t,D=t=>({HEALTHY:"success",UNHEALTHY:"error",UNKNOWN:"warning"})[t]||"default",O=t=>({HEALTHY:"健康",UNHEALTHY:"不健康",UNKNOWN:"未知"})[t]||t,M=t=>t&&re(t,"YYYY-MM-DD HH:mm:ss")||"-",L=({code:t,row:l})=>{if(t==="refresh"){x();return}if(!l)return;const m=l;switch(t){case"edit":_(m);break;case"online":w(m);break;case"offline":c(m);break}},x=()=>{s.info("正在刷新节点列表..."),h("refresh")},_=t=>{f.value={...t},g.value=!0},$=t=>{w(t)},r=t=>{c(t)},v=async t=>{if(!t||!t.nodeId){s.error("节点ID不能为空");return}p.value=!0;try{const l=await fe(t);l.oK?(s.success("节点编辑成功"),g.value=!1,f.value=null,h("refresh")):s.error(l.messageId||"节点编辑失败")}catch(l){s.error(l.message||"节点编辑失败")}finally{p.value=!1}},w=t=>{y.warning({title:"确认上线",content:`确定要上线节点 ${t.ipAddress}:${t.portNumber} 吗？`,positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{try{const l=await ve(t.nodeId);l.oK?(s.success("节点上线成功"),h("refresh")):s.error(l.messageId||"节点上线失败")}catch(l){s.error(l.message||"节点上线失败")}}})},c=t=>{y.warning({title:"确认下线",content:`确定要下线节点 ${t.ipAddress}:${t.portNumber} 吗？`,positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{try{const l=await pe(t.nodeId);l.oK?(s.success("节点下线成功"),h("refresh")):s.error(l.messageId||"节点下线失败")}catch(l){s.error(l.message||"节点下线失败")}}})};return(t,l)=>(T(),B("div",Ce,[i(e(j),V({"module-id":u.moduleId,data:u.nodes,loading:u.loading},o,{onMenuClick:L}),{ephemeral:a(({row:m})=>[i(e(U),{type:m.ephemeral==="Y"?"warning":"default",size:"small"},{default:a(()=>[b(C(m.ephemeral==="Y"?"是":"否"),1)]),_:2},1032,["type"])]),instanceStatus:a(({row:m})=>[i(e(U),{type:I(m.instanceStatus),size:"small"},{default:a(()=>[b(C(R(m.instanceStatus)),1)]),_:2},1032,["type"])]),healthyStatus:a(({row:m})=>[i(e(U),{type:D(m.healthyStatus),size:"small"},{default:a(()=>[b(C(O(m.healthyStatus)),1)]),_:2},1032,["type"])]),metadataJson:a(({row:m})=>[i(e(ge),{"line-clamp":1,tooltip:!1},{default:a(()=>[b(C(S(m.metadataJson)),1)]),_:2},1024)]),lastBeatTime:a(({row:m})=>[b(C(M(m.lastBeatTime)),1)]),action:a(({row:m})=>[i(e(ne),{size:8},{default:a(()=>[i(e(G),{size:"small",type:"primary",onClick:A=>_(m)},{default:a(()=>[...l[1]||(l[1]=[b(" 编辑 ",-1)])]),_:1},8,["onClick"]),m.instanceStatus==="UP"?(T(),J(e(G),{key:0,size:"small",type:"warning",onClick:A=>r(m)},{default:a(()=>[...l[2]||(l[2]=[b(" 下线 ",-1)])]),_:1},8,["onClick"])):z("",!0),m.instanceStatus==="DOWN"?(T(),J(e(G),{key:1,size:"small",type:"success",onClick:A=>$(m)},{default:a(()=>[...l[3]||(l[3]=[b(" 上线 ",-1)])]),_:1},8,["onClick"])):z("",!0)]),_:2},1024)]),_:1},16,["module-id","data","loading"]),i(Z,{visible:g.value,"onUpdate:visible":l[0]||(l[0]=m=>g.value=m),mode:"edit",title:"编辑节点",to:"#service-node-list","form-fields":n,"initial-data":f.value||void 0,"auto-close-on-confirm":!1,"confirm-loading":p.value,onSubmit:v},null,8,["visible","initial-data","confirm-loading"])]))}}),we=W(ye,[["__scopeId","data-v-7f075df2"]]),ke={key:0,class:"service-detail"},_e={class:"service-detail-header"},Te={class:"service-detail-actions"},Ie={class:"instance-list-header"},Re=K({name:"ServiceDetail",__name:"ServiceDetail",props:{service:{default:null},loading:{type:Boolean,default:!1}},emits:["back","edit","refresh"],setup(u,{emit:k}){const h=k,y=n=>({INTERNAL:"内部服务",NACOS:"Nacos",CONSUL:"Consul",EUREKA:"Eureka",ETCD:"ETCD",ZOOKEEPER:"Zookeeper"})[n]||n,s=n=>{if(!n)return"none";try{return JSON.parse(n).type||"none"}catch{return"none"}},g=()=>{h("back")},f=()=>{h("edit")},p=()=>{h("refresh")};return(n,o)=>u.service?(T(),B("div",ke,[P("div",_e,[o[2]||(o[2]=P("h2",{class:"service-detail-title"},"服务详情",-1)),P("div",Te,[i(e(G),{type:"default",onClick:f},{icon:a(()=>[i(e(Q),null,{default:a(()=>[i(e(be))]),_:1})]),default:a(()=>[o[0]||(o[0]=b(" 编辑服务 ",-1))]),_:1}),i(e(G),{type:"primary",onClick:g},{icon:a(()=>[i(e(Q),null,{default:a(()=>[i(e(Se))]),_:1})]),default:a(()=>[o[1]||(o[1]=b(" 返回 ",-1))]),_:1})])]),i(e(Y),{class:"service-detail-card"},{default:a(()=>[i(e(ce),{column:2,bordered:"",size:"small"},{default:a(()=>[i(e(F),{label:"服务名"},{default:a(()=>[b(C(u.service.serviceName),1)]),_:1}),i(e(F),{label:"分组"},{default:a(()=>[b(C(u.service.groupName),1)]),_:1}),i(e(F),{label:"保护阈值"},{default:a(()=>[b(C(u.service.protectThreshold??0),1)]),_:1}),i(e(F),{label:"服务类型"},{default:a(()=>[b(C(y(u.service.serviceType)),1)]),_:1}),i(e(F),{label:"服务版本"},{default:a(()=>[b(C(u.service.serviceVersion||"-"),1)]),_:1}),i(e(F),{label:"服务路由类型"},{default:a(()=>[b(C(s(u.service.selectorJson)),1)]),_:1}),i(e(F),{label:"服务描述",span:2},{default:a(()=>[b(C(u.service.serviceDescription||"-"),1)]),_:1}),i(e(F),{label:"元数据",span:2},{default:a(()=>[i(me,{content:u.service.metadataJson||"{}",format:"json","auto-format":!0,"max-height":200,"show-copy-button":!0},null,8,["content"])]),_:1})]),_:1})]),_:1}),i(e(Y),{class:"service-detail-card service-instance-list-card"},{header:a(()=>[P("div",Ie,[o[3]||(o[3]=P("span",null,"服务实例列表",-1)),i(e(U),{type:"info",size:"small"},{default:a(()=>{var S;return[b(" 共 "+C(((S=u.service.nodes)==null?void 0:S.length)||0)+" 个实例 ",1)]}),_:1})])]),default:a(()=>[i(we,{nodes:u.service.nodes||[],loading:u.loading,"module-id":`service-detail-${u.service.serviceName}`,onRefresh:p},null,8,["nodes","loading","module-id"])]),_:1})])):z("",!0)}}),De=W(Re,[["__scopeId","data-v-e8fbff62"]]);function Ee(u,k){const h=X(),y=Ne(),s=he(k),g=N(!1),f=N("create"),p=N(null),n=N(!1),o=()=>{f.value="create",p.value=null,g.value=!0},S=async r=>{try{const v=await s.getServiceDetail(r.namespaceId,r.groupName,r.serviceName);if(!v){h.error("获取服务详情失败");return}f.value="edit",p.value=v,g.value=!0}catch{h.error("获取服务详情失败")}},I=async r=>{try{const v=await s.getServiceDetail(r.namespaceId,r.groupName,r.serviceName);if(!v){h.error("获取服务详情失败");return}f.value="view",p.value=v,g.value=!0}catch{h.error("获取服务详情失败")}},R=()=>{g.value=!1,p.value=null},D=async r=>{n.value=!0;try{let v=!1;f.value==="create"?v=await s.addService(r):f.value==="edit"&&(v=await s.editService({...r,namespaceId:p.value.namespaceId,groupName:p.value.groupName,serviceName:p.value.serviceName})),v&&(R(),await s.handleRefresh())}finally{n.value=!1}},O=r=>{var v,w;switch(r){case"add":o();break;case"edit":const c=((v=u==null?void 0:u.value)==null?void 0:v.getCheckboxRecords())||[];if(c.length===0){h.warning("请先选择要编辑的服务");return}if(c.length>1){h.warning("只能编辑一个服务");return}S(c[0]);break;case"delete":const t=((w=u==null?void 0:u.value)==null?void 0:w.getCheckboxRecords())||[];if(t.length===0){h.warning("请先选择要删除的服务");return}M(t);break}},M=async r=>{if(!await y.warning({title:"确认批量删除",subtitle:`将删除 ${r.length} 个服务`,content:"此操作不可恢复，请谨慎操作",positiveText:"确定删除",negativeText:"取消",width:500}))return;let w=0;for(const c of r)await s.deleteService(c)&&w++;w>0&&(h.success(`成功删除 ${w} 个服务`),await s.handleRefresh())},L=async r=>{if(!r.row)return;const v=r.row;switch(r.code){case"view":break;case"edit":await S(v);break;case"delete":await s.deleteService(v),await s.handleRefresh();break}},x=()=>{s.handleSearch()},_=r=>{r&&D(r)};return{service:s,formDialogVisible:g,formDialogMode:f,currentEditService:p,submitting:n,openAddDialog:o,openEditDialog:S,openViewDialog:I,closeFormDialog:R,handleSubmit:D,handleFormSubmit:_,handleServiceFormSubmit:(r,v)=>{r&&(v&&!r.namespaceId&&(r.namespaceId=v.namespaceId),_(r))},handleToolbarClick:O,handleMenuClick:L,handleSearch:x}}const Fe=["id"],Oe=K({name:"NamespaceList",__name:"NamespaceList",props:{showDialog:{type:Boolean,default:!0},autoLoad:{type:Boolean,default:!0},moduleId:{default:"hub0041"}},emits:["row-click","namespace-select"],setup(u,{expose:k,emit:h}){const y=u,s=ee(()=>y.moduleId),g=h,f=N(),p=N(),{service:n,formDialogVisible:o,formDialogMode:S,currentEditNamespace:I,submitting:R,handleFormSubmit:D,handleMenuClick:O,handleSearch:M}=ue(p,f),L=ee(()=>{var t,l;const c=n.model.gridConfig;return{...c,menuConfig:{enabled:!0,showCopyRow:((t=c.menuConfig)==null?void 0:t.showCopyRow)||!1,showCopyCell:((l=c.menuConfig)==null?void 0:l.showCopyCell)||!1,customMenus:[{code:"view",name:"查看详情",prefixIcon:"vxe-icon-eye-fill"}]}}}),x=c=>{c.code==="view"&&c.row&&O(c)},_=({row:c})=>{g("row-click",c),g("namespace-select",c)};return k({refresh:()=>{n.handleRefresh()},load:()=>{n.loadNamespaces()},getSelectedNamespace:()=>{var t;const c=((t=p.value)==null?void 0:t.getCheckboxRecords())||[];return c.length>0?c[0]:null},getCurrentNamespace:()=>{var c;return((c=p.value)==null?void 0:c.getCurrentRecord())||null},namespaceService:n}),de(()=>{y.autoLoad&&n.loadNamespaces()}),(c,t)=>(T(),B("div",{class:"namespace-list",id:s.value},[i(e(q),{direction:"vertical","default-size":"80px"},{1:a(()=>[i(te,{ref_key:"searchFormRef",ref:f,"module-id":s.value,fields:e(n).model.searchFormConfig.fields,"show-search-button":!0,"show-reset-button":!0,onSearch:e(M)},null,8,["module-id","fields","onSearch"])]),2:a(()=>[i(e(j),V({ref_key:"gridRef",ref:p,"module-id":s.value,data:e(n).model.namespaceList,loading:e(n).model.loading},L.value,{onPageChange:e(n).handlePageChange,onMenuClick:x,onRowClick:_}),{activeFlag:a(({row:l})=>[i(e(U),{type:l.activeFlag==="Y"?"success":"default",size:"small"},{default:a(()=>[b(C(l.activeFlag==="Y"?"活动":"非活动"),1)]),_:2},1032,["type"])]),_:1},16,["module-id","data","loading","onPageChange"])]),_:1}),u.showDialog?(T(),J(Z,{key:0,visible:e(o),"onUpdate:visible":t[0]||(t[0]=l=>ae(o)?o.value=l:null),mode:e(S),title:e(S)==="create"?"新增命名空间":e(S)==="edit"?"编辑命名空间":"查看命名空间详情",to:`#${s.value}`,"form-fields":e(n).model.namespaceFormConfig.fields,"form-tabs":e(n).model.namespaceFormConfig.tabs,"initial-data":e(I)||void 0,"auto-close-on-confirm":!1,"confirm-loading":e(R),onSubmit:e(D)},null,8,["visible","mode","title","to","form-fields","form-tabs","initial-data","confirm-loading","onSubmit"])):z("",!0)],8,Fe))}}),Me=W(Oe,[["__scopeId","data-v-5a86c99c"]]),Le=["id"],xe={key:0,class:"service-list-view"},Ae={key:1,class:"service-detail-view"},Be=K({name:"ServiceList",__name:"ServiceList",setup(u){const k=N(),h=N(),y=N(),s=N(null),g=N(!1),f=N(null),p=N(!1),n=X(),{service:o,formDialogVisible:S,formDialogMode:I,currentEditService:R,submitting:D,handleServiceFormSubmit:O,handleToolbarClick:M,handleMenuClick:L}=Ee(y,h),x=async d=>{d&&(s.value=d,await o.loadServices({},d.namespaceId))},_=d=>{s.value=d,d||o.model.setServiceList([])},$=()=>{if(!s.value){n.warning("请先在上方命名空间列表中选择一个命名空间");return}o.handleSearch(s.value.namespaceId)},r=d=>{if(d==="add"&&!s.value){n.warning("请先在上方命名空间列表中选择一个命名空间");return}M(d)},v=d=>{s.value&&o.handlePageChange(d.currentPage,d.pageSize)},w=d=>{O(d,s.value)},c=async d=>{if(!d.row)return;const E=d.row;if(d.code==="view"){await t(E);return}await L(d)},t=async d=>{p.value=!0;try{const E=await o.getServiceDetail(d.namespaceId,d.groupName,d.serviceName);E?(f.value=E,g.value=!0):n.error("获取服务详情失败")}catch{n.error("获取服务详情失败")}finally{p.value=!1}},l=()=>{g.value=!1,f.value=null},m=()=>{f.value&&(g.value=!1,c({code:"edit",row:f.value}))},A=async()=>{if(f.value){p.value=!0;try{const d=await o.getServiceDetail(f.value.namespaceId,f.value.groupName,f.value.serviceName);d?(f.value=d,n.success("服务详情已刷新")):n.error("刷新服务详情失败")}catch{n.error("刷新服务详情失败")}finally{p.value=!1}}},le=()=>{n.info("集群配置功能开发中")},ie=d=>{n.info("节点编辑功能开发中")};return(d,E)=>{const se=te;return T(),B("div",{class:"service-list",id:e(o).model.moduleId},[g.value?(T(),B("div",Ae,[i(De,{service:f.value,loading:p.value,onBack:l,onEdit:m,onRefresh:A,onClusterConfig:le,onEditNode:ie},null,8,["service","loading"])])):(T(),B("div",xe,[i(e(q),{direction:"vertical","default-size":"300px"},{1:a(()=>[i(e(Y),null,{default:a(()=>[i(e(Me),{ref_key:"namespaceListRef",ref:k,moduleId:"hub0042-namespace","show-dialog":!0,"auto-load":!0,onRowClick:x,onNamespaceSelect:_},null,512)]),_:1})]),2:a(()=>[i(e(Y),null,{default:a(()=>[i(e(q),{direction:"vertical","default-size":"80px"},{1:a(()=>[i(se,V({ref_key:"serviceSearchFormRef",ref:h,"module-id":e(o).model.moduleId},e(o).model.searchFormConfig,{onSearch:$,onToolbarClick:r}),null,16,["module-id"])]),2:a(()=>[i(e(j),V({ref_key:"serviceGridRef",ref:y,"module-id":e(o).model.moduleId,data:e(o).model.serviceList,loading:e(o).model.loading},e(o).model.gridConfig,{onPageChange:v,onMenuClick:c}),{activeFlag:a(({row:H})=>[i(e(U),{type:H.activeFlag==="Y"?"success":"default",size:"small"},{default:a(()=>[b(C(H.activeFlag==="Y"?"活动":"非活动"),1)]),_:2},1032,["type"])]),_:1},16,["module-id","data","loading"])]),_:1})]),_:1})]),_:1})])),i(Z,{visible:e(S),"onUpdate:visible":E[0]||(E[0]=H=>ae(S)?S.value=H:null),mode:e(I),title:e(I)==="create"?"新增服务":"编辑服务",to:`#${e(o).model.moduleId}`,"form-fields":e(o).model.serviceFormConfig.fields,"form-tabs":e(o).model.serviceFormConfig.tabs,"initial-data":e(R)||void 0,"auto-close-on-confirm":!1,"confirm-loading":e(D),onSubmit:w},null,8,["visible","mode","title","to","form-fields","form-tabs","initial-data","confirm-loading"])],8,Le)}}}),kt=W(Be,[["__scopeId","data-v-0074a6cd"]]);export{kt as default};
