import{G as oe}from"./GDataFormModal-CPflTnGv.js";import{c as we,G as Se,S as ke}from"./SearchForm-DOzvGtXJ.js";import{G as Ae}from"./GPane-DHnn83Ms.js";import{T as $,r as f,aa as re,i as pe,m as fe,z as K,A as ge,B as k,d1 as xe,d2 as Ve,d as Te,c as Le,b as S,w as P,e as t,cr as N,o as W,am as ce,aO as j,K as q,t as Q,g as de,_ as De}from"./index-C7VF8QMM.js";import{I as Fe,U as Pe,A as Me,D as Ne,C as Ke,a as Oe,R as Ye}from"./RateLimitConfigFormModal-DNiDfK_r.js";import"./GPagination.vue_vue_type_style_index_0_scoped_2c35df38_lang-D5LxWsgC.js";import"./AlertChannelNameSelector.vue_vue_type_style_index_0_scoped_90f3078b_lang-B4YTzgUp.js";import{u as me}from"./useGDialog-C5wX4kUM.js";import{g as Ee,r as Ge,s as He,a as ze,d as Be,e as Ue,b as _e,q as $e,c as Je,f as Re}from"./index-DSPRiyyn.js";import{A as We}from"./AlertChannelNameSelector-B5DzliQr.js";import{D as je}from"./DocumentOutline-B5MwaebU.js";import{K as qe}from"./KeyOutline-BffFZbAW.js";import{A as Qe}from"./AddOutline-511P_9IJ.js";import{C as Xe}from"./CreateOutline-WUi7ssFw.js";import{T as Ze}from"./TrashOutline-CTPgiVU8.js";import{G as et}from"./GlobeOutline-Ijk932K_.js";import{N as ue}from"./DynamicTags-BmskdQBb.js";import{W as tt}from"./WarningOutline-8XsJcO19.js";import{R as at}from"./RefreshOutline-CT5KkffG.js";import{S as lt}from"./StopCircleOutline-DVebUj9Z.js";import{P as nt}from"./PlayCircleOutline-Ds6y0BBR.js";import{C as it}from"./CheckmarkCircleOutline-CEF7M5Ms.js";import{A as st}from"./AlertCircleOutline-C_F0oHZI.js";import"./GModal-4zQmqt5p.js";import"./ContractOutline-BylC79iI.js";import"./CloseOutline-BGym3E2W.js";import"./index-SEUNGW2H.js";import"./Select-DHkKeUGd.js";import"./DownloadOutline-By9DqBID.js";import"./Upload-CZadKDzY.js";import"./download-C2161hUv.js";import"./Alert-kEAxH1d7.js";import"./index-vXGECq1G.js";import"./EllipsisHorizontalOutline-J5GTnD01.js";import"./InputGroup-BXuP0-ru.js";import"./GDialog-C6larSix.js";import"./prop-NnGblK-3.js";function ot(){const C="hub0020",u=f(!1),p=f([]),c=f(),d={fields:[{field:"instanceName",label:"实例名称",type:"input",placeholder:"请输入实例名称",span:6,clearable:!0},{field:"healthStatus",label:"健康状态",type:"select",placeholder:"请选择状态",span:6,clearable:!0,options:[{label:"全部",value:""},{label:"健康",value:"Y"},{label:"不健康",value:"N"}]},{field:"activeFlag",label:"活动状态",type:"select",placeholder:"请选择状态",span:6,clearable:!0,options:[{label:"全部",value:""},{label:"活动",value:"Y"},{label:"非活动",value:"N"}]}],toolbarButtons:[{key:"add",label:"新建实例",icon:Qe,type:"primary",tooltip:"新建网关实例"},{key:"edit",label:"编辑",icon:Xe,tooltip:"编辑选中的实例"},{key:"delete",label:"删除",icon:Ze,type:"error",tooltip:"删除选中的实例"}],showSearchButton:!0,showResetButton:!0},A={tabs:[{key:"basic",label:"基本信息"},{key:"tls",label:"TLS配置"},{key:"performance",label:"性能配置"},{key:"other",label:"其它"}],fields:[{field:"instanceName",label:"实例名称",type:"input",placeholder:"请输入实例名称",span:12,tabKey:"basic",required:!0},{field:"bindAddress",label:"绑定地址",type:"input",placeholder:"如: 0.0.0.0",span:12,tabKey:"basic",defaultValue:"0.0.0.0",tips:"服务器绑定的网络地址，0.0.0.0表示监听所有网络接口"},{field:"httpPort",label:"HTTP端口",type:"number",placeholder:"如: 8080",span:12,tabKey:"basic",defaultValue:8080,props:{min:1,max:65535}},{field:"httpsPort",label:"HTTPS端口",type:"number",placeholder:"如: 8443",span:12,tabKey:"basic",defaultValue:8443,tips:"HTTPS服务监听的端口号，范围1-65535，需要启用TLS后生效",props:{min:1,max:65535}},{field:"activeFlag",label:"自动启动",type:"switch",span:12,tabKey:"basic",defaultValue:"Y",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"instanceDesc",label:"实例描述",type:"textarea",placeholder:"请输入实例描述",span:24,tabKey:"basic",props:{rows:3}},{field:"tls-config-group",label:"TLS安全配置",type:"fieldset",tabKey:"tls",children:[{field:"certStorageType",label:"证书存储类型",type:"select",span:12,defaultValue:"DATABASE",show:!1,options:[{label:"文件存储",value:"FILE"},{label:"数据库存储",value:"DATABASE"}]},{field:"tlsEnabled",label:"启用TLS",type:"switch",span:12,defaultValue:"N",tips:"启用HTTPS/TLS加密传输，保护数据传输安全",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"certPassword",label:"证书密码",type:"input",placeholder:"请输入证书密码(可选)",span:12,tips:"如果私钥文件已加密，需要提供密码进行解密",props:{type:"password",showPasswordOn:"click"}},{field:"tlsVersion",label:"TLS版本",type:"select",placeholder:"选择支持的TLS版本",span:12,defaultValue:["1.2"],tips:"选择支持的TLS协议版本，建议至少启用TLS 1.2，TLS 1.0和1.1已不安全",props:{multiple:!0,maxTagCount:2},options:[{label:"TLS 1.0",value:"1.0"},{label:"TLS 1.1",value:"1.1"},{label:"TLS 1.2",value:"1.2"},{label:"TLS 1.3",value:"1.3"}]},{field:"enableHttp2",label:"启用HTTP/2",type:"switch",span:12,defaultValue:"Y",tips:"启用HTTP/2协议，支持多路复用、头部压缩等特性，提升性能（需要TLS支持）",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"tlsCipherSuites",label:"TLS密码套件",type:"input",placeholder:"多个密码套件用逗号分隔，如: TLS_AES_256_GCM_SHA384,TLS_CHACHA20_POLY1305_SHA256，留空使用默认配置",span:24,tips:"指定允许的TLS密码套件，留空使用系统默认的安全配置，建议使用强加密套件",clearable:!0},{field:"certFileList",label:"证书文件",type:"file",span:12,props:{title:"证书文件",titleIcon:je,titleIconColor:"#18a058",showDownload:!0,config:{accept:".crt,.pem,.cer",max:1,maxSize:10*1024*1024,mode:"text",uploadText:"点击或拖拽上传证书",uploadDescription:"支持 .crt, .pem, .cer"}}},{field:"keyFileList",label:"私钥文件",type:"file",span:12,props:{title:"私钥文件",titleIcon:qe,titleIconColor:"#f0a020",showDownload:!0,config:{accept:".key,.pem",max:1,maxSize:10*1024*1024,mode:"text",uploadText:"点击或拖拽上传私钥",uploadDescription:"支持 .key, .pem"}}}]},{field:"performance-config-group",label:"性能配置",type:"fieldset",tabKey:"performance",children:[{field:"maxConnections",label:"最大连接数",type:"number",placeholder:"10000",span:12,defaultValue:1e4,tips:"同时处理的最大并发连接数，超过此值的新连接将被拒绝",props:{min:100,max:1e5}},{field:"maxWorkers",label:"最大工作协程数",type:"number",placeholder:"1000",span:12,defaultValue:1e3,tips:"用于处理请求的最大工作协程数，影响并发处理能力",props:{min:100,max:1e4}},{field:"readTimeoutMs",label:"读取超时(ms)",type:"number",placeholder:"30000",span:12,defaultValue:3e4,tips:"从客户端读取请求头的最大时间，超时则关闭连接",props:{min:1e3,max:3e5}},{field:"writeTimeoutMs",label:"写入超时(ms)",type:"number",placeholder:"30000",span:12,defaultValue:3e4,tips:"向客户端写入响应的最大时间，超时则关闭连接",props:{min:1e3,max:3e5}},{field:"idleTimeoutMs",label:"空闲超时(ms)",type:"number",placeholder:"60000",span:12,defaultValue:6e4,tips:"保持连接空闲的最大时间，超时则关闭连接（用于HTTP Keep-Alive）",props:{min:1e3,max:6e5}},{field:"maxHeaderBytes",label:"最大请求头大小(字节)",type:"number",placeholder:"1048576",span:12,defaultValue:1048576,tips:"限制单个请求头的最大字节数，防止恶意请求头过大，对应 http.Server.MaxHeaderBytes",props:{min:1024,max:10485760}}]},{field:"keepalive-config-group",label:"Keep-Alive配置",type:"fieldset",tabKey:"performance",children:[{field:"keepAliveEnabled",label:"HTTP Keep-Alive",type:"switch",span:12,defaultValue:"Y",tips:"启用HTTP Keep-Alive，允许在同一个TCP连接上发送多个HTTP请求，提高性能",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"tcpKeepAliveEnabled",label:"TCP Keep-Alive",type:"switch",span:12,defaultValue:"Y",tips:"启用TCP Keep-Alive，定期发送探测包检测连接是否存活，自动清理僵尸连接",props:{checkedValue:"Y",uncheckedValue:"N"}}]},{field:"noteText",label:"备注",type:"textarea",placeholder:"请输入备注信息",span:24,tabKey:"other",props:{rows:3}},{field:"addTime",label:"创建时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"addWho",label:"创建人",type:"input",span:12,tabKey:"other",disabled:!0},{field:"editTime",label:"修改时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"editWho",label:"修改人",type:"input",span:12,tabKey:"other",disabled:!0}]},b={tabs:[{key:"basic",label:"基础配置"},{key:"cleanup",label:"清理配置"},{key:"alert",label:"预警配置"},{key:"other",label:"其它"}],fields:[{field:"logConfigId",label:"日志配置ID",type:"input",span:12,show:!1},{field:"tenantId",label:"租户ID",type:"input",span:12,show:!1},{field:"configName",label:"日志配置名称",type:"input",placeholder:"请输入日志配置名称",span:12,tabKey:"basic",required:!0},{field:"logFormat",label:"日志格式",type:"select",placeholder:"选择日志格式",span:12,tabKey:"basic",defaultValue:"JSON",options:[{label:"JSON格式",value:"JSON"},{label:"文本格式",value:"TEXT"},{label:"CSV格式",value:"CSV"}]},{field:"configDesc",label:"日志配置描述",type:"textarea",placeholder:"请输入日志配置描述",span:24,tabKey:"basic",props:{rows:2}},{field:"content-control-group",label:"日志内容控制",type:"fieldset",tabKey:"basic",props:{titleSize:300},children:[{field:"recordRequestBody",label:"记录请求体",type:"switch",span:12,defaultValue:"N",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"recordResponseBody",label:"记录响应体",type:"switch",span:12,defaultValue:"N",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"recordHeaders",label:"记录请求头",type:"switch",span:12,defaultValue:"Y",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"maxBodySizeBytes",label:"最大报文大小(字节)",type:"number",placeholder:"1048576",span:12,defaultValue:1048576,props:{min:0}}]},{field:"output-target-group",label:"日志输出目标",type:"fieldset",tabKey:"basic",props:{titleSize:300},children:[{field:"outputTargets",label:"输出目标",type:"select",placeholder:"选择日志输出目标",span:24,defaultValue:"DATABASE",options:[{label:"文件输出",value:"FILE"},{label:"数据库输出",value:"DATABASE"},{label:"MongoDB输出",value:"MONGODB"},{label:"Elasticsearch输出",value:"ELASTICSEARCH"},{label:"ClickHouse输出",value:"CLICKHOUSE"}]},{field:"fileConfig.filePath",label:"文件路径",type:"input",placeholder:"./logs/gateway.log",span:12,defaultValue:"./logs/gateway.log",show:i=>{const m=i.outputTargets||"";return typeof m=="string"&&m.includes("FILE")}},{field:"logRetentionDays",label:"文件保留天数",type:"number",placeholder:"30",span:12,defaultValue:30,props:{min:1},show:i=>{const m=i.outputTargets||"";return typeof m=="string"&&m.includes("FILE")}}]},{field:"async-processing-group",label:"异步和批量处理",type:"fieldset",tabKey:"basic",props:{titleSize:300},children:[{field:"enableAsyncLogging",label:"启用异步日志",type:"switch",span:12,defaultValue:"Y",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"asyncQueueSize",label:"异步队列大小",type:"number",placeholder:"1000",span:12,defaultValue:1e3,props:{min:1}},{field:"batchSize",label:"批处理大小",type:"number",placeholder:"100",span:12,defaultValue:100,props:{min:1}},{field:"asyncFlushIntervalMs",label:"异步刷新间隔(ms)",type:"number",placeholder:"5000",span:12,defaultValue:5e3,props:{min:100,max:6e4}},{field:"enableBatchProcessing",label:"启用批量处理",type:"switch",span:12,defaultValue:"Y",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"batchTimeoutMs",label:"批处理超时(ms)",type:"number",placeholder:"1000",span:12,defaultValue:1e3,props:{min:1e3,max:3e5}}]},{field:"sensitive-data-group",label:"敏感数据处理",type:"fieldset",tabKey:"basic",props:{titleSize:300},children:[{field:"enableSensitiveDataMasking",label:"启用敏感数据脱敏",type:"switch",span:12,defaultValue:"N",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"maskingPattern",label:"脱敏模式",type:"select",placeholder:"选择脱敏模式",span:12,defaultValue:"****",options:[{label:"替换为*",value:"****"},{label:"替换为[MASKED]",value:"[MASKED]"},{label:"保留前后字符",value:"KEEP_EDGE"},{label:"自定义规则",value:"CUSTOM"}]},{field:"sensitiveFields",label:"敏感字段",type:"custom",span:24,defaultValue:[],render:i=>$(ue,{value:i.sensitiveFields||[],"onUpdate:value":m=>{i.sensitiveFields=m},placeholder:"添加敏感字段"})}]},{field:"cleanup-config-group",label:"日志清理配置",type:"fieldset",tabKey:"cleanup",props:{titleSize:300},children:[{field:"extProperty.cleanupEnabled",label:"开启自动清理",type:"switch",span:12,defaultValue:"N",tips:"开启后会定期清理过期的访问日志和后端追踪日志",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"extProperty.retentionDays",label:"日志保留天数",type:"number",span:12,defaultValue:30,placeholder:"请输入日志保留天数",tips:"超过此天数的日志将被清理，范围：1-3650天",props:{min:1,max:3650,precision:0}},{field:"extProperty.cleanupIntervalHour",label:"清理间隔（小时）",type:"number",span:12,defaultValue:24,placeholder:"请输入清理间隔",tips:"每隔多少小时执行一次清理任务，最小值为1小时",props:{min:1,max:168,precision:0}},{field:"extProperty.scheduledTime",label:"首次执行时间",type:"input",span:12,defaultValue:"02:00",placeholder:"请输入执行时间（HH:MM）",tips:"首次执行清理的时间，格式：HH:MM（如 02:00 表示凌晨2点）",props:{maxlength:5}},{field:"extProperty.batchDeleteSize",label:"批量删除大小",type:"number",span:12,defaultValue:1e3,placeholder:"请输入批量删除大小",tips:"每批删除的记录数，避免长事务，范围：100-10000",props:{min:100,max:1e4,precision:0}}]},{field:"alert-config-group",label:"告警配置",type:"fieldset",tabKey:"alert",props:{titleSize:300},children:[{field:"extProperty.alertEnabled",label:"开启告警",type:"switch",span:12,defaultValue:"N",tips:"开启后才会对 404 / 超时 等事件触发告警",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"extProperty.channelName",label:"告警渠道名称",type:"custom",span:12,placeholder:"请输入告警渠道名称或点击选择",tips:"不填写则使用默认告警渠道",render:i=>$(We,{modelValue:i["extProperty.channelName"]||"","onUpdate:modelValue":m=>{i["extProperty.channelName"]=m}})},{field:"extProperty.alertStatusCodes",label:"状态码告警",type:"custom",span:24,defaultValue:["502"],tips:"选择需要告警的HTTP状态码，多个状态码用逗号分隔",render:i=>{const m=i["extProperty.alertStatusCodes"]||[],x=Array.isArray(m)?m.map(I=>String(I)):typeof m=="string"?m.split(",").map(I=>I.trim()).filter(Boolean):[];return $(ue,{value:x,"onUpdate:value":I=>{i["extProperty.alertStatusCodes"]=I},placeholder:"输入状态码，如: 502, 503, 504"})}},{field:"extProperty.alertOnTimeout",label:"超时告警",type:"switch",span:8,defaultValue:"Y",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"extProperty.timeoutThresholdMs",label:"超时阈值(ms)",type:"number",span:8,defaultValue:12e4,tips:"当总耗时 >= 阈值（毫秒）时触发超时告警"}]},{field:"addTime",label:"创建时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"addWho",label:"创建人",type:"input",span:12,tabKey:"other",disabled:!0},{field:"editTime",label:"修改时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"editWho",label:"修改人",type:"input",span:12,tabKey:"other",disabled:!0}]},h={columns:[{field:"gatewayInstanceId",title:"实例ID",sortable:!0,align:"center",showOverflow:!0},{field:"instanceName",title:"实例名称",sortable:!0,align:"center",showOverflow:!0},{field:"instanceDesc",title:"实例描述",align:"center",showOverflow:"tooltip"},{field:"bindAddress",title:"绑定地址",align:"center",showOverflow:!0},{field:"httpPort",title:"HTTP端口",align:"center"},{field:"httpsPort",title:"HTTPS端口",align:"center"},{field:"tlsEnabled",title:"TLS",align:"center",slots:{default:"tlsEnabled"}},{field:"maxConnections",title:"最大连接数",align:"center",formatter:({cellValue:i})=>i?i.toLocaleString():"0"},{field:"healthStatus",title:"健康状态",align:"center",slots:{default:"healthStatus"}},{field:"activeFlag",title:"活动状态",align:"center",slots:{default:"activeFlag"}},{field:"addTime",title:"创建时间",sortable:!0,showOverflow:!0,formatter:({cellValue:i})=>i?re(i,"YYYY-MM-DD HH:mm:ss"):""},{field:"addWho",title:"创建人",showOverflow:!0},{field:"editTime",title:"修改时间",sortable:!0,showOverflow:!0,formatter:({cellValue:i})=>i?re(i,"YYYY-MM-DD HH:mm:ss"):""},{field:"editWho",title:"修改人",showOverflow:!0}],showCheckbox:!0,paginationConfig:{show:!0,pageInfo:c,align:"right"},menuConfig:{enabled:!0,showCopyRow:!0,showCopyCell:!0,customMenus:[{code:"view",name:"查看详情",prefixIcon:"vxe-icon-eye-fill"},{code:"edit",name:"编辑",prefixIcon:"vxe-icon-edit"},{code:"delete",name:"删除",prefixIcon:"vxe-icon-delete"},{code:"start",name:"启动",prefixIcon:"vxe-icon-caret-right"},{code:"stop",name:"停止",prefixIcon:"vxe-icon-square"},{code:"globalConfig",name:"全局配置",prefixIcon:"vxe-icon-setting",children:[{code:"ipAccessControl",name:"IP访问控制",prefixIcon:"vxe-icon-lock"},{code:"userAgentAccessControl",name:"User-Agent访问控制",prefixIcon:"vxe-icon-user"},{code:"apiAccessControl",name:"API访问控制",prefixIcon:"vxe-icon-link"},{code:"domainAccessControl",name:"域名访问控制",prefixIcon:()=>$(pe,{size:12},{default:()=>$(et)})},{code:"corsConfig",name:"跨域配置",prefixIcon:"vxe-icon-link"},{code:"authConfig",name:"认证配置",prefixIcon:"vxe-icon-setting"},{code:"rateLimitConfig",name:"限流配置",prefixIcon:"vxe-icon-setting"}]},{code:"logConfig",name:"日志配置",prefixIcon:"vxe-icon-setting"},{code:"reload",name:"网关重载",prefixIcon:"vxe-icon-refresh"}]},height:"100%"},T=()=>{c.value=void 0},L=i=>{c.value?Object.assign(c.value,i):c.value=i},V=i=>{p.value=i},M=()=>{p.value=[]},O=i=>{p.value.unshift(i)},w=(i,m,x)=>{const I=p.value.findIndex(F=>F.gatewayInstanceId===i&&F.tenantId===m);I!==-1&&Object.assign(p.value[I],x)},D=(i,m)=>{const x=p.value.findIndex(I=>I.gatewayInstanceId===i&&I.tenantId===m);x!==-1&&p.value.splice(x,1)};return{moduleId:C,loading:u,instanceList:p,pageInfo:c,searchFormConfig:d,instanceFormConfig:A,logConfigFormConfig:b,gridConfig:h,resetPagination:T,updatePagination:L,setInstanceList:V,clearInstanceList:M,addInstanceToList:O,updateInstanceInList:w,removeInstanceFromList:D,removeInstancesFromList:i=>{i.forEach(m=>{D(m.gatewayInstanceId,m.tenantId)})}}}function rt(C){const u=fe(),p=me(),c=ot(),{loading:d,instanceList:A,pageInfo:b,setInstanceList:h,updatePagination:T,addInstanceToList:L,updateInstanceInList:V,removeInstanceFromList:M,removeInstancesFromList:O}=c,w=async n=>{var r,s,y;d.value=!0;try{let v=n;!v&&((r=C==null?void 0:C.value)!=null&&r.getFormData)&&(v=C.value.getFormData()||{});const U={...v?Object.fromEntries(Object.entries(v).filter(([,o])=>o!==""&&o!==null&&o!==void 0)):{},...we((s=b.value)==null?void 0:s.pageIndex,(y=b.value)==null?void 0:y.pageSize)},g=await $e(U);if(g.oK){if(g.bizData){const o=JSON.parse(g.bizData),J=Array.isArray(o)?o:[];h(J)}if(g.pageQueryData){const o=JSON.parse(g.pageQueryData);T(o)}}else u.error(g.errMsg||"查询实例列表失败")}catch{u.error("加载实例列表失败")}finally{d.value=!1}};return{model:c,loadInstances:w,handleSearch:async n=>{await w(n)},handleReset:async()=>{c.resetPagination(),await w()},handlePageChange:async({currentPage:n,pageSize:r})=>{T({pageIndex:n,pageSize:r}),await w()},handleRefresh:async()=>{await w()},addInstance:async n=>{d.value=!0;try{const r={...n,tlsVersion:Array.isArray(n.tlsVersion)?n.tlsVersion.join(","):n.tlsVersion};delete r.logConfig;const s=await _e(r);if(K(s)){const y=k(s,"网关实例创建成功");if(u.success(y),s.bizData){const v=JSON.parse(s.bizData);L(v)}else await w();return!0}else{const y=k(s,"新增实例失败");return u.error(y),!1}}catch{return u.error("新增实例失败"),!1}finally{d.value=!1}},editInstance:async n=>{d.value=!0;try{const r={...n,tlsVersion:Array.isArray(n.tlsVersion)?n.tlsVersion.join(","):n.tlsVersion};delete r.logConfig;const s=await Ue(r);if(K(s)){const y=k(s,"网关实例更新成功");if(u.success(y),s.bizData){const v=JSON.parse(s.bizData);V(v.gatewayInstanceId,v.tenantId,v)}else{const v=A.value.find(G=>G.gatewayInstanceId===n.gatewayInstanceId);v&&V(n.gatewayInstanceId,v.tenantId,r)}return!0}else{const y=k(s,"编辑实例失败");return u.error(y),!1}}catch{return u.error("编辑实例失败"),!1}finally{d.value=!1}},deleteInstance:async n=>{if(!await p.warning({title:"确认删除",subtitle:"此操作不可恢复，请谨慎操作",content:`确定要删除实例 "${n.instanceName}" 吗？`,icon:tt,headerStyle:"gradient",positiveText:"确定删除",negativeText:"取消",width:500}))return!1;d.value=!0;try{const s=await Be(n.gatewayInstanceId,n.tenantId);if(K(s)){const y=k(s,"删除实例成功");return u.success(y),M(n.gatewayInstanceId,n.tenantId),A.value.length===0&&b.value&&b.value.pageIndex>1&&(T({pageIndex:b.value.pageIndex-1}),await w()),!0}else{const y=k(s,"删除实例失败");return u.error(y),!1}}catch{return u.error("删除实例失败"),!1}finally{d.value=!1}},startInstance:async n=>{d.value=!0;try{const r=await ze(n.gatewayInstanceId,n.tenantId);if(K(r)){const s=k(r,"实例启动成功");return u.success(s),V(n.gatewayInstanceId,n.tenantId,{healthStatus:"Y"}),!0}else{const s=k(r,"启动失败");return u.error(s),!1}}catch{return u.error("启动失败"),!1}finally{d.value=!1}},stopInstance:async n=>{d.value=!0;try{const r=await He(n.gatewayInstanceId,n.tenantId);if(K(r)){const s=k(r,"实例停止成功");return u.success(s),V(n.gatewayInstanceId,n.tenantId,{healthStatus:"N"}),!0}else{const s=k(r,"停止失败");return u.error(s),!1}}catch{return u.error("停止失败"),!1}finally{d.value=!1}},reloadInstance:async n=>{d.value=!0;try{const r=await Ge(n.gatewayInstanceId,n.tenantId);if(K(r)){const s=k(r,"网关重载成功");return u.success(s),await w(),!0}else{const s=k(r,"网关重载失败");return u.error(s),!1}}catch{return u.error("网关重载失败"),!1}finally{d.value=!1}},getInstanceDetail:async(n,r)=>{try{const s=await Ee(n,r);return K(s)?ge(s,null):(u.error(k(s,"获取实例详情失败")),null)}catch{return u.error("获取实例详情失败"),null}}}}function ct(C,u){const p=fe(),c=me(),d=rt(u),A=f(!1),b=f("create"),h=f(null),T=f(!1),L=f(!1),V=f(""),M=f(!1),O=f("edit"),w=f(null),D=f(!1),H=f(!1),i=f(""),m=async l=>{i.value=l.gatewayInstanceId,H.value=!0},x=f(!1),I=f(""),F=async l=>{I.value=l.gatewayInstanceId,x.value=!0},z=f(!1),Y=f(""),B=async l=>{Y.value=l.gatewayInstanceId,z.value=!0},E=f(!1),n=f(""),r=async l=>{n.value=l.gatewayInstanceId,E.value=!0},s=f(!1),y=f(""),v=async l=>{y.value=l.gatewayInstanceId,s.value=!0},G=f(!1),U=f(""),g=async l=>{U.value=l.gatewayInstanceId,G.value=!0},o=f(!1),J=f(""),X=async l=>{J.value=l.gatewayInstanceId,o.value=!0},Z=()=>{b.value="create",h.value=null,A.value=!0},R=async l=>{try{const e=await d.getInstanceDetail(l.gatewayInstanceId,l.tenantId);if(!e){p.error("获取实例详情失败");return}const a={...e};e.certContent?a.certFileList=[{id:"cert-file",name:e.certFilePath||"certificate.pem",content:e.certContent,status:"finished"}]:a.certFileList=[],e.keyContent?a.keyFileList=[{id:"key-file",name:e.keyFilePath||"private-key.pem",content:e.keyContent,status:"finished"}]:a.keyFileList=[],b.value="edit",h.value=a,A.value=!0}catch{p.error("获取实例详情失败")}},ee=()=>{A.value=!1,h.value=null},te=async l=>{try{const e=await d.getInstanceDetail(l.gatewayInstanceId,l.tenantId);if(!e){p.error("获取实例详情失败");return}const a={...e};e.certContent?a.certFileList=[{id:"cert-file",name:e.certFilePath||"certificate.pem",content:e.certContent,status:"finished"}]:a.certFileList=[],e.keyContent?a.keyFileList=[{id:"key-file",name:e.keyFilePath||"private-key.pem",content:e.keyContent,status:"finished"}]:a.keyFileList=[],b.value="view",h.value=a,A.value=!0}catch{p.error("获取实例详情失败")}},ye=async l=>{await d.handleSearch(l)},be=async l=>{if(l&&b.value!=="view"){T.value=!0;try{const e={...l};if(e.certFileList&&Array.isArray(e.certFileList)&&e.certFileList.length>0){const a=e.certFileList[0];a&&(a.content&&(e.certContent=a.content),a.name&&(e.certFilePath=a.name))}else b.value==="edit"&&h.value&&h.value.certFilePath&&!e.certFilePath&&(e.certFilePath=h.value.certFilePath);if(delete e.certFileList,e.keyFileList&&Array.isArray(e.keyFileList)&&e.keyFileList.length>0){const a=e.keyFileList[0];a&&(a.content&&(e.keyContent=a.content),a.name&&(e.keyFilePath=a.name))}else b.value==="edit"&&h.value&&h.value.keyFilePath&&!e.keyFilePath&&(e.keyFilePath=h.value.keyFilePath);if(delete e.keyFileList,b.value==="create")await d.addInstance(e)&&ee();else if(b.value==="edit"){if(!h.value)return;await d.editInstance({...e,gatewayInstanceId:h.value.gatewayInstanceId})&&ee()}}finally{T.value=!1}}},he=async(l,e)=>{switch(l){case"add":Z();break;case"edit":{if(!(C!=null&&C.value)){p.warning("Grid 引用未设置");return}const a=C.value.getCurrentRecord();if(!a){p.warning("请先点击选择要编辑的实例");return}await R(a);break}case"delete":{if(!(C!=null&&C.value)){p.warning("Grid 引用未设置");return}const a=C.value.getCurrentRecord();if(!a){p.warning("请先点击选择要删除的实例");return}await d.deleteInstance(a);break}case"search":{await d.handleSearch(e);break}}},ve=l=>{V.value=l.gatewayInstanceId,L.value=!0},ae=async l=>{O.value="edit";try{if(!l.logConfigId){p.warning("该实例尚未配置日志，请先创建日志配置");return}const e=await Re(l.logConfigId);if(K(e)){const a=ge(e,{});if(a.sensitiveFields){if(typeof a.sensitiveFields=="string")try{a.sensitiveFields=JSON.parse(a.sensitiveFields)}catch{a.sensitiveFields=a.sensitiveFields.split(",").map(_=>_.trim()).filter(Boolean)}}else a.sensitiveFields=[];Ve(a),w.value=a,M.value=!0}else{const a=k(e,"获取日志配置失败");p.error(a)}}catch(e){p.error("获取日志配置失败"),console.error("Error fetching log config:",e)}},le=()=>{M.value=!1,w.value=null},Ie=async l=>{if(l&&O.value!=="view"){D.value=!0;try{if(!l.logConfigId){p.error("日志配置信息不完整");return}const e={...l};e.sensitiveFields&&Array.isArray(e.sensitiveFields)&&(e.sensitiveFields=JSON.stringify(e.sensitiveFields)),xe(e);const a=await Je(e);if(K(a)){const _=k(a,"日志配置保存成功");p.success(_),le()}else{const _=k(a,"保存日志配置失败");p.error(_)}}catch(e){p.error("保存日志配置失败"),console.error("Error saving log config:",e)}finally{D.value=!1}}},Ce=()=>{L.value=!1,V.value=""},ne=async l=>{await c.warning({title:"确认启动",subtitle:"启动后将开始处理请求",content:`确定要启动实例"${l.instanceName}"吗？`,icon:nt,headerStyle:"gradient",positiveText:"确定启动",negativeText:"取消",width:500})&&d.startInstance(l)},ie=async l=>{await c.warning({title:"确认停止",subtitle:"停止后将无法处理请求",content:`确定要停止实例"${l.instanceName}"吗？`,icon:lt,headerStyle:"gradient",positiveText:"确定停止",negativeText:"取消",width:500})&&d.stopInstance(l)},se=async l=>{await c.warning({title:"确认网关重载",subtitle:"重载将重新加载配置",content:`确定要对实例"${l.instanceName}"执行网关重载操作吗？`,icon:at,headerStyle:"gradient",positiveText:"确定重载",negativeText:"取消",width:500})&&d.reloadInstance(l)};return{service:d,formDialogVisible:A,formDialogMode:b,currentEditInstance:h,submitting:T,openAddDialog:Z,openEditDialog:R,openViewDialog:te,handleFormSubmit:be,configDialogVisible:L,currentConfigInstanceId:V,openConfigDialog:ve,closeConfigDialog:Ce,logConfigDialogVisible:M,logConfigDialogMode:O,currentLogConfig:w,logConfigSubmitting:D,openLogConfigDialog:ae,closeLogConfigDialog:le,handleLogConfigSubmit:Ie,ipAccessControlDialogVisible:H,ipAccessControlSecurityConfigId:i,openIpAccessControlDialog:m,userAgentAccessControlDialogVisible:x,userAgentAccessControlSecurityConfigId:I,openUserAgentAccessControlDialog:F,apiAccessControlDialogVisible:z,apiAccessControlSecurityConfigId:Y,openApiAccessControlDialog:B,domainAccessControlDialogVisible:E,domainAccessControlSecurityConfigId:n,openDomainAccessControlDialog:r,corsConfigDialogVisible:s,corsConfigGatewayInstanceId:y,openCorsConfigDialog:v,authConfigDialogVisible:G,authConfigGatewayInstanceId:U,openAuthConfigDialog:g,rateLimitConfigDialogVisible:o,rateLimitConfigGatewayInstanceId:J,openRateLimitConfigDialog:X,handleToolbarClick:he,handleMenuClick:async({code:l,row:e})=>{if(e)switch(l){case"view":await te(e);break;case"edit":await R(e);break;case"delete":await d.deleteInstance(e);break;case"start":ne(e);break;case"stop":ie(e);break;case"ipAccessControl":await m(e);break;case"userAgentAccessControl":await F(e);break;case"apiAccessControl":await B(e);break;case"domainAccessControl":await r(e);break;case"corsConfig":await v(e);break;case"authConfig":await g(e);break;case"rateLimitConfig":await X(e);break;case"logConfig":ae(e);break;case"reload":se(e);break}},handleSearch:ye,handleStartInstance:ne,handleStopInstance:ie,handleReloadInstance:se}}const dt=["id"],ut=Te({name:"GatewayInstanceManager",__name:"GatewayInstanceManager",setup(C){const u=f(),p=f(),{service:c,formDialogVisible:d,formDialogMode:A,currentEditInstance:b,submitting:h,handleFormSubmit:T,logConfigDialogVisible:L,logConfigDialogMode:V,currentLogConfig:M,logConfigSubmitting:O,handleLogConfigSubmit:w,ipAccessControlDialogVisible:D,ipAccessControlSecurityConfigId:H,userAgentAccessControlDialogVisible:i,userAgentAccessControlSecurityConfigId:m,apiAccessControlDialogVisible:x,apiAccessControlSecurityConfigId:I,domainAccessControlDialogVisible:F,domainAccessControlSecurityConfigId:z,corsConfigDialogVisible:Y,corsConfigGatewayInstanceId:B,authConfigDialogVisible:E,authConfigGatewayInstanceId:n,rateLimitConfigDialogVisible:r,rateLimitConfigGatewayInstanceId:s,handleToolbarClick:y,handleMenuClick:v,handleSearch:G}=ct(p,u);return(U,g)=>(W(),Le("div",{class:"gateway-instance-manager",id:t(c).model.moduleId},[S(t(Ae),{direction:"vertical","default-size":"80px"},{1:P(()=>[S(ke,ce({ref_key:"searchFormRef",ref:u,"module-id":t(c).model.moduleId},t(c).model.searchFormConfig,{onSearch:t(G),onToolbarClick:t(y)}),null,16,["module-id","onSearch","onToolbarClick"])]),2:P(()=>[S(t(Se),ce({ref_key:"gridRef",ref:p,"module-id":t(c).model.moduleId,data:t(c).model.instanceList,loading:t(c).model.loading},t(c).model.gridConfig,{onPageChange:t(c).handlePageChange,onMenuClick:t(v)}),{tlsEnabled:P(({row:o})=>[S(t(j),{type:o.tlsEnabled==="Y"?"success":"default",size:"small"},{default:P(()=>[q(Q(o.tlsEnabled==="Y"?"启用":"禁用"),1)]),_:2},1032,["type"])]),healthStatus:P(({row:o})=>[S(t(j),{type:o.healthStatus==="Y"?"success":"error",size:"small"},{icon:P(()=>[S(t(pe),null,{default:P(()=>[o.healthStatus==="Y"?(W(),de(t(it),{key:0})):(W(),de(t(st),{key:1}))]),_:2},1024)]),default:P(()=>[q(" "+Q(o.healthStatus==="Y"?"在线":"离线"),1)]),_:2},1032,["type"])]),activeFlag:P(({row:o})=>[S(t(j),{type:o.activeFlag==="Y"?"success":"default",size:"small"},{default:P(()=>[q(Q(o.activeFlag==="Y"?"活动":"非活动"),1)]),_:2},1032,["type"])]),_:1},16,["module-id","data","loading","onPageChange","onMenuClick"])]),_:1}),S(oe,{visible:t(d),"onUpdate:visible":g[0]||(g[0]=o=>N(d)?d.value=o:null),mode:t(A),title:t(A)==="create"?"新增实例":t(A)==="edit"?"编辑实例":"查看实例详情",to:`#${t(c).model.moduleId}`,"form-fields":t(c).model.instanceFormConfig.fields,"form-tabs":t(c).model.instanceFormConfig.tabs,"initial-data":t(b)||void 0,"auto-close-on-confirm":!1,"confirm-loading":t(h),onSubmit:t(T)},null,8,["visible","mode","title","to","form-fields","form-tabs","initial-data","confirm-loading","onSubmit"]),S(oe,{visible:t(L),"onUpdate:visible":g[1]||(g[1]=o=>N(L)?L.value=o:null),mode:t(V),title:t(V)==="edit"?"编辑日志配置":"查看日志配置",to:`#${t(c).model.moduleId}`,"form-tabs":t(c).model.logConfigFormConfig.tabs,"form-fields":t(c).model.logConfigFormConfig.fields,"initial-data":t(M)||void 0,"auto-close-on-confirm":!1,"confirm-loading":t(O),onSubmit:t(w)},null,8,["visible","mode","title","to","form-tabs","form-fields","initial-data","confirm-loading","onSubmit"]),S(Fe,{visible:t(D),"onUpdate:visible":g[2]||(g[2]=o=>N(D)?D.value=o:null),"module-id":"hub0020:ipAccessControl","security-config-id":t(H),title:"IP访问控制配置",width:1200,to:`#${t(c).model.moduleId}`},null,8,["visible","security-config-id","to"]),S(Pe,{visible:t(i),"onUpdate:visible":g[3]||(g[3]=o=>N(i)?i.value=o:null),"module-id":"hub0020:userAgentAccessControl","security-config-id":t(m),title:"User-Agent访问控制配置",width:1200,to:`#${t(c).model.moduleId}`},null,8,["visible","security-config-id","to"]),S(Me,{visible:t(x),"onUpdate:visible":g[4]||(g[4]=o=>N(x)?x.value=o:null),"module-id":"hub0020:apiAccessControl","security-config-id":t(I),title:"API访问控制配置",width:1200,to:`#${t(c).model.moduleId}`},null,8,["visible","security-config-id","to"]),S(Ne,{visible:t(F),"onUpdate:visible":g[5]||(g[5]=o=>N(F)?F.value=o:null),"module-id":"hub0020:domainAccessControl","security-config-id":t(z),title:"域名访问控制配置",width:1200,to:`#${t(c).model.moduleId}`},null,8,["visible","security-config-id","to"]),S(Ke,{visible:t(Y),"onUpdate:visible":g[6]||(g[6]=o=>N(Y)?Y.value=o:null),"gateway-instance-id":t(B),width:800,to:`#${t(c).model.moduleId}`,"module-id":"hub0020:corsConfig"},null,8,["visible","gateway-instance-id","to"]),S(Oe,{visible:t(E),"onUpdate:visible":g[7]||(g[7]=o=>N(E)?E.value=o:null),"gateway-instance-id":t(n),width:800,to:`#${t(c).model.moduleId}`,"module-id":"hub0020:authConfig"},null,8,["visible","gateway-instance-id","to"]),S(Ye,{visible:t(r),"onUpdate:visible":g[8]||(g[8]=o=>N(r)?r.value=o:null),"gateway-instance-id":t(s),width:800,to:`#${t(c).model.moduleId}`,"module-id":"hub0020:rateLimitConfig"},null,8,["visible","gateway-instance-id","to"])],8,dt))}}),qt=De(ut,[["__scopeId","data-v-c8ba6cfe"]]);export{qt as default};
