import{r as X,t as Z,v as ee,w as le,x as ae,y as se,z as oe,A as te}from"./index-CpJN9nzJ.js";import{b as j,cT as re,f as H,r as c,g as A,d as W,R as J,q as R,w as s,n as e,o as N,m as l,t as V,C as u,J as p,E as P,cz as D,a7 as q,B as Y,I as h,x as ie,al as ne,a0 as ue,a2 as de,_ as G,h as pe,c as me,v as E,cU as fe,V as F,ao as ce}from"./index-CzIbiPcR.js";import{a as ve,b as Q,_ as z}from"./RadioGroup-BBKwhzSS.js";import{_ as ge}from"./DynamicTags-BE01c2Nw.js";import{a as be,b as $,_ as ye}from"./DataTable-CMD0QL_W.js";import{N as K}from"./DatePicker-B9xNNxDH.js";import{R as Te}from"./RefreshOutline-CA3Zk8OZ.js";import{A as Se}from"./AddOutline-DReI0b2u.js";import{T as Pe}from"./TrashOutline-2R_Ts6Ka.js";import{R as Ie}from"./ReloadOutline-Btqzp1-L.js";import"./Popconfirm-Jlwr2tlU.js";function _e(){const y=j(),m=re(),d=H({resourceType:"",resourceCode:"",permissionScope:void 0,userId:"",roleId:"",pageNum:1,pageSize:10}),x=c([]),b=c(!1),I=c(0),T=c([]),S=A(()=>T.value.length>0),v=A(()=>({page:d.pageNum||1,pageSize:d.pageSize||10,itemCount:I.value,showSizePicker:!0,pageSizes:[10,20,50,100],showQuickJumper:!0,onUpdatePage:i=>{d.pageNum=i,g()},onUpdatePageSize:i=>{d.pageSize=i,d.pageNum=1,g()}})),g=async()=>{try{b.value=!0;const i=await X(d);if(i.oK&&i.bizData){const f=Array.isArray(i.bizData)?i.bizData:JSON.parse(i.bizData);x.value=f.list||f,I.value=f.total||f.length}else y.error(i.errMsg||"获取数据权限列表失败")}catch(i){console.error("加载数据权限列表失败:",i),y.error("获取数据权限列表失败")}finally{b.value=!1}};return{queryParams:d,dataPermissionList:x,loading:b,total:I,checkedRowKeys:T,hasSelection:S,paginationReactive:v,loadDataPermissionList:g,handleSearch:()=>{d.pageNum=1,g()},resetQuery:()=>{Object.assign(d,{resourceType:"",resourceCode:"",permissionScope:void 0,userId:"",roleId:"",pageNum:1,pageSize:10}),g()},handleRefresh:()=>{g()},handleDelete:i=>{m.warning({title:"确认删除",content:"确定要删除此数据权限吗？此操作不可恢复。",positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{try{const f=await ee(i.dataPermissionId);f.oK?(y.success("删除成功"),g()):y.error(f.errMsg||"删除失败")}catch(f){console.error("删除数据权限失败:",f),y.error("删除失败")}}})},handleBatchDelete:()=>{if(T.value.length===0){y.warning("请选择要删除的数据权限");return}m.warning({title:"确认批量删除",content:`确定要删除选中的 ${T.value.length} 个数据权限吗？此操作不可恢复。`,positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{try{const i=await Z(T.value);i.successCount>0?(y.success(`批量删除成功，成功删除 ${i.successCount} 个数据权限${i.failureCount>0?`，失败 ${i.failureCount} 个`:""}`),T.value=[],g()):y.error("批量删除失败")}catch(i){console.error("批量删除数据权限失败:",i),y.error("批量删除失败")}}})}}}const xe=W({__name:"DataPermissionFormDialog",props:{visible:{type:Boolean,default:!1},formData:{default:()=>({})},isEdit:{type:Boolean,default:!1}},emits:["update:visible","success"],setup(y,{emit:m}){const d=y,x=m,b=j(),I=c(),T=c(!1),S=c({}),v=c("user"),g=c([]),U=c([]),C=c(!1),t=H({userId:"",roleId:"",resourceType:"",resourceCode:"",permissionScope:"SELF",scopeValue:"",filterCondition:"",columnPermissions:[],operationPermissions:["read"],effectiveTime:null,expireTime:null,noteText:""}),k=A({get:()=>d.visible,set:o=>x("update:visible",o)}),_=A(()=>[{label:"全部",value:"ALL"},{label:"租户",value:"TENANT"},{label:"部门",value:"DEPT"},{label:"个人",value:"SELF"},{label:"自定义",value:"CUSTOM"}]),i={userId:[{required:v.value==="user",message:"请选择用户",trigger:"change"}],roleId:[{required:v.value==="role",message:"请选择角色",trigger:"change"}],resourceType:[{required:!0,message:"请输入资源类型",trigger:"blur"},{min:1,max:50,message:"资源类型长度应在 1-50 个字符之间",trigger:"blur"}],resourceCode:[{required:!0,message:"请输入资源编码",trigger:"blur"},{min:1,max:100,message:"资源编码长度应在 1-100 个字符之间",trigger:"blur"}],permissionScope:[{required:!0,message:"请选择权限范围",trigger:"change"}],operationPermissions:[{type:"array",required:!0,message:"请选择操作权限",trigger:"change"}]},f=o=>{o==="user"?t.roleId="":t.userId=""},L=o=>{o!=="CUSTOM"&&(t.scopeValue="")},M=async o=>{if(!o){g.value=[];return}try{C.value=!0,g.value=[{label:`用户${o}1`,value:`user_${o}_1`},{label:`用户${o}2`,value:`user_${o}_2`}]}catch(a){console.error("搜索用户失败:",a)}finally{C.value=!1}},B=async()=>{try{const o=await se();U.value=o.map(a=>({label:a.roleName,value:a.roleId}))}catch(o){console.error("加载角色选项失败:",o),b.error("加载角色选项失败")}};J(()=>d.formData,o=>{o&&Object.keys(o).length>0?(S.value={...o},v.value=o.userId?"user":"role",Object.assign(t,{userId:o.userId||"",roleId:o.roleId||"",resourceType:o.resourceType||"",resourceCode:o.resourceCode||"",permissionScope:o.permissionScope||"SELF",scopeValue:o.scopeValue||"",filterCondition:o.filterCondition||"",columnPermissions:o.columnPermissions?JSON.parse(o.columnPermissions):[],operationPermissions:o.operationPermissions?o.operationPermissions.split(","):["read"],effectiveTime:o.effectiveTime?new Date(o.effectiveTime).getTime():null,expireTime:o.expireTime?new Date(o.expireTime).getTime():null,noteText:o.noteText||""})):O()},{immediate:!0}),J(()=>d.visible,o=>{o&&B()});const O=()=>{v.value="user",Object.assign(t,{userId:"",roleId:"",resourceType:"",resourceCode:"",permissionScope:"SELF",scopeValue:"",filterCondition:"",columnPermissions:[],operationPermissions:["read"],effectiveTime:null,expireTime:null,noteText:""}),S.value={}},w=()=>{O(),k.value=!1},n=async()=>{var o;try{await((o=I.value)==null?void 0:o.validate()),T.value=!0;const a={...t,userId:v.value==="user"?t.userId:void 0,roleId:v.value==="role"?t.roleId:void 0,columnPermissions:t.columnPermissions,operationPermissions:t.operationPermissions,effectiveTime:t.effectiveTime?new Date(t.effectiveTime).toISOString():void 0,expireTime:t.expireTime?new Date(t.expireTime).toISOString():void 0};let r;d.isEdit&&S.value.dataPermissionId?r=await le({...a,dataPermissionId:S.value.dataPermissionId}):r=await ae(a),ue(r)?(b.success(d.isEdit?"数据权限更新成功":"数据权限创建成功"),O(),x("success")):b.error(de(r,"操作失败"))}catch(a){console.error("提交数据权限表单失败:",a),a!=null&&a.message?b.error(a.message):b.error("操作失败")}finally{T.value=!1}};return(o,a)=>(N(),R(e(ne),{show:k.value,"onUpdate:show":a[13]||(a[13]=r=>k.value=r),"mask-closable":!1,preset:"dialog",title:o.isEdit?"编辑数据权限":"新建数据权限",class:"data-permission-form-dialog",style:{width:"700px"}},{action:s(()=>[l(e(q),null,{default:s(()=>[l(e(h),{onClick:w},{default:s(()=>a[24]||(a[24]=[p("取消")])),_:1}),l(e(h),{type:"primary",loading:T.value,onClick:n},{default:s(()=>[p(ie(o.isEdit?"更新":"创建"),1)]),_:1},8,["loading"])]),_:1})]),default:s(()=>[l(e(Y),{ref_key:"formRef",ref:I,model:t,rules:i,"label-placement":"left","label-width":"120px","require-mark-placement":"right-hanging"},{default:s(()=>[l(e(u),{label:"权限类型"},{default:s(()=>[l(e(ve),{value:v.value,"onUpdate:value":[a[0]||(a[0]=r=>v.value=r),f]},{default:s(()=>[l(e(Q),{value:"user"},{default:s(()=>a[14]||(a[14]=[p("用户权限")])),_:1}),l(e(Q),{value:"role"},{default:s(()=>a[15]||(a[15]=[p("角色权限")])),_:1})]),_:1},8,["value"])]),_:1}),v.value==="user"?(N(),R(e(u),{key:0,label:"用户",path:"userId"},{default:s(()=>[l(e(z),{value:t.userId,"onUpdate:value":a[1]||(a[1]=r=>t.userId=r),placeholder:"请选择用户",options:g.value,filterable:"",remote:"",loading:C.value,onSearch:M,clearable:""},null,8,["value","options","loading"])]),_:1})):V("",!0),v.value==="role"?(N(),R(e(u),{key:1,label:"角色",path:"roleId"},{default:s(()=>[l(e(z),{value:t.roleId,"onUpdate:value":a[2]||(a[2]=r=>t.roleId=r),placeholder:"请选择角色",options:U.value,filterable:"",clearable:""},null,8,["value","options"])]),_:1})):V("",!0),l(e(u),{label:"资源类型",path:"resourceType"},{feedback:s(()=>[l(e(D),{depth:"3",style:{"font-size":"12px"}},{default:s(()=>a[16]||(a[16]=[p(" 资源类型，如：TABLE（数据表）、API（接口）、MODULE（模块） ")])),_:1})]),default:s(()=>[l(e(P),{value:t.resourceType,"onUpdate:value":a[3]||(a[3]=r=>t.resourceType=r),placeholder:"请输入资源类型，如：TABLE、API、MODULE",maxlength:"50"},null,8,["value"])]),_:1}),l(e(u),{label:"资源编码",path:"resourceCode"},{feedback:s(()=>[l(e(D),{depth:"3",style:{"font-size":"12px"}},{default:s(()=>a[17]||(a[17]=[p(" 具体的资源编码，如：HUB_AUTH_ROLE、/api/hub0005/roles ")])),_:1})]),default:s(()=>[l(e(P),{value:t.resourceCode,"onUpdate:value":a[4]||(a[4]=r=>t.resourceCode=r),placeholder:"请输入资源编码",maxlength:"100"},null,8,["value"])]),_:1}),l(e(u),{label:"权限范围",path:"permissionScope"},{default:s(()=>[l(e(z),{value:t.permissionScope,"onUpdate:value":[a[5]||(a[5]=r=>t.permissionScope=r),L],placeholder:"请选择权限范围",options:_.value},null,8,["value","options"])]),_:1}),t.permissionScope==="CUSTOM"?(N(),R(e(u),{key:2,label:"范围值",path:"scopeValue"},{feedback:s(()=>[l(e(D),{depth:"3",style:{"font-size":"12px"}},{default:s(()=>a[18]||(a[18]=[p(' 自定义权限范围的JSON配置，如：{"deptIds": ["dept1", "dept2"]} ')])),_:1})]),default:s(()=>[l(e(P),{value:t.scopeValue,"onUpdate:value":a[6]||(a[6]=r=>t.scopeValue=r),type:"textarea",placeholder:"请输入自定义范围值（JSON格式）",rows:3},null,8,["value"])]),_:1})):V("",!0),l(e(u),{label:"过滤条件",path:"filterCondition"},{feedback:s(()=>[l(e(D),{depth:"3",style:{"font-size":"12px"}},{default:s(()=>a[19]||(a[19]=[p(" SQL WHERE条件，用于过滤数据，如：tenantId = 'tenant1' AND status = 'Y' ")])),_:1})]),default:s(()=>[l(e(P),{value:t.filterCondition,"onUpdate:value":a[7]||(a[7]=r=>t.filterCondition=r),type:"textarea",placeholder:"请输入SQL WHERE条件",rows:3},null,8,["value"])]),_:1}),l(e(u),{label:"字段权限",path:"columnPermissions"},{feedback:s(()=>[l(e(D),{depth:"3",style:{"font-size":"12px"}},{default:s(()=>a[20]||(a[20]=[p(" 用户可以访问的数据字段列表，为空表示可以访问所有字段 ")])),_:1})]),default:s(()=>[l(e(ge),{value:t.columnPermissions,"onUpdate:value":a[8]||(a[8]=r=>t.columnPermissions=r),placeholder:"添加可访问的字段名"},null,8,["value"])]),_:1}),l(e(u),{label:"操作权限",path:"operationPermissions"},{default:s(()=>[l(e(be),{value:t.operationPermissions,"onUpdate:value":a[9]||(a[9]=r=>t.operationPermissions=r)},{default:s(()=>[l(e(q),null,{default:s(()=>[l(e($),{value:"read"},{default:s(()=>a[21]||(a[21]=[p("只读")])),_:1}),l(e($),{value:"write"},{default:s(()=>a[22]||(a[22]=[p("读写")])),_:1}),l(e($),{value:"delete"},{default:s(()=>a[23]||(a[23]=[p("删除")])),_:1})]),_:1})]),_:1},8,["value"])]),_:1}),l(e(u),{label:"生效时间",path:"effectiveTime"},{default:s(()=>[l(e(K),{value:t.effectiveTime,"onUpdate:value":a[10]||(a[10]=r=>t.effectiveTime=r),type:"datetime",placeholder:"选择生效时间，不选择表示立即生效",clearable:"",style:{width:"100%"}},null,8,["value"])]),_:1}),l(e(u),{label:"过期时间",path:"expireTime"},{default:s(()=>[l(e(K),{value:t.expireTime,"onUpdate:value":a[11]||(a[11]=r=>t.expireTime=r),type:"datetime",placeholder:"选择过期时间，不选择表示永不过期",clearable:"",style:{width:"100%"}},null,8,["value"])]),_:1}),l(e(u),{label:"备注信息",path:"noteText"},{default:s(()=>[l(e(P),{value:t.noteText,"onUpdate:value":a[12]||(a[12]=r=>t.noteText=r),type:"textarea",placeholder:"请输入备注信息",rows:3,maxlength:"500","show-count":""},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]))}}),he=G(xe,[["__scopeId","data-v-d3bc0991"]]),Ce={class:"data-permission-management-container"},ke=W({__name:"DataPermissionManagement",setup(y){const{queryParams:m,dataPermissionList:d,loading:x,checkedRowKeys:b,hasSelection:I,paginationReactive:T,loadDataPermissionList:S,handleSearch:v,resetQuery:g,handleRefresh:U,handleDelete:C,handleBatchDelete:t}=_e(),k=c(),_=c(!1),i=c({}),f=c(!1),L=te(B,C),M=()=>{i.value={},f.value=!1,_.value=!0};function B(w){i.value={...w},f.value=!0,_.value=!0}const O=()=>{_.value=!1,S()};return pe(()=>{S()}),(w,n)=>(N(),me("div",Ce,[l(e(F),{size:"small",class:"search-card"},{default:s(()=>[l(e(Y),{inline:"",model:e(m),"label-placement":"left"},{default:s(()=>[l(e(u),{label:"资源类型"},{default:s(()=>[l(e(P),{value:e(m).resourceType,"onUpdate:value":n[0]||(n[0]=o=>e(m).resourceType=o),placeholder:"请输入资源类型",clearable:"",style:{width:"150px"}},null,8,["value"])]),_:1}),l(e(u),{label:"资源编码"},{default:s(()=>[l(e(P),{value:e(m).resourceCode,"onUpdate:value":n[1]||(n[1]=o=>e(m).resourceCode=o),placeholder:"请输入资源编码",clearable:"",style:{width:"200px"}},null,8,["value"])]),_:1}),l(e(u),{label:"权限范围"},{default:s(()=>[l(e(z),{value:e(m).permissionScope,"onUpdate:value":n[2]||(n[2]=o=>e(m).permissionScope=o),placeholder:"请选择权限范围",clearable:"",style:{width:"150px"},options:e(oe)},null,8,["value","options"])]),_:1}),l(e(u),{label:"用户ID"},{default:s(()=>[l(e(P),{value:e(m).userId,"onUpdate:value":n[3]||(n[3]=o=>e(m).userId=o),placeholder:"请输入用户ID",clearable:"",style:{width:"150px"}},null,8,["value"])]),_:1}),l(e(u),{label:"角色ID"},{default:s(()=>[l(e(P),{value:e(m).roleId,"onUpdate:value":n[4]||(n[4]=o=>e(m).roleId=o),placeholder:"请输入角色ID",clearable:"",style:{width:"150px"}},null,8,["value"])]),_:1}),l(e(u),null,{default:s(()=>[l(e(h),{type:"primary",onClick:e(v)},{icon:s(()=>[l(e(E),null,{default:s(()=>[l(e(fe))]),_:1})]),default:s(()=>[n[7]||(n[7]=p(" 搜索 "))]),_:1},8,["onClick"]),l(e(h),{onClick:e(g),style:{"margin-left":"8px"}},{icon:s(()=>[l(e(E),null,{default:s(()=>[l(e(Te))]),_:1})]),default:s(()=>[n[8]||(n[8]=p(" 重置 "))]),_:1},8,["onClick"])]),_:1})]),_:1},8,["model"])]),_:1}),l(e(F),{size:"small",class:"action-card"},{default:s(()=>[l(e(q),null,{default:s(()=>[l(e(h),{type:"primary",onClick:M},{icon:s(()=>[l(e(E),null,{default:s(()=>[l(e(Se))]),_:1})]),default:s(()=>[n[9]||(n[9]=p(" 新建数据权限 "))]),_:1}),l(e(h),{type:"error",disabled:!e(I),onClick:e(t)},{icon:s(()=>[l(e(E),null,{default:s(()=>[l(e(Pe))]),_:1})]),default:s(()=>[n[10]||(n[10]=p(" 批量删除 "))]),_:1},8,["disabled","onClick"]),l(e(h),{onClick:e(U)},{icon:s(()=>[l(e(E),null,{default:s(()=>[l(e(Ie))]),_:1})]),default:s(()=>[n[11]||(n[11]=p(" 刷新 "))]),_:1},8,["onClick"])]),_:1})]),_:1}),l(e(F),{size:"small",class:"table-card"},{default:s(()=>[l(e(ye),{ref_key:"dataTableRef",ref:k,columns:e(L),data:e(d),loading:e(x),pagination:e(T),"row-key":o=>o.dataPermissionId,"checked-row-keys":e(b),"onUpdate:checkedRowKeys":n[5]||(n[5]=o=>ce(b)?b.value=o:null),"flex-height":"",style:{height:"500px"}},null,8,["columns","data","loading","pagination","row-key","checked-row-keys"])]),_:1}),l(he,{visible:_.value,"onUpdate:visible":n[6]||(n[6]=o=>_.value=o),"form-data":i.value,"is-edit":f.value,onSuccess:O},null,8,["visible","form-data","is-edit"])]))}}),Be=G(ke,[["__scopeId","data-v-4c1b7282"]]);export{Be as default};
