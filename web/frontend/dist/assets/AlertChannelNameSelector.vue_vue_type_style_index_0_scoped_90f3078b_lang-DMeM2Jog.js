import"./GPagination.vue_vue_type_style_index_0_scoped_2c35df38_lang-Cl3FsyCO.js";import{u as se}from"./useGDialog-CebP_ODM.js";import{af as ie,r as _,m as z,z as F,A as E,d2 as ee,B as D,d as ae,a7 as $,av as re,g as oe,o as te,w as x,f as ce,e as T,b as O,am as R,aO as K,K as W,t as Y,_ as le,c as ue,G as de,J as pe,i as fe,aQ as ge,T as me,aa as Q}from"./index-bKVtVsSX.js";import{c as ne,G as he,S as be}from"./SearchForm-wLSWNkX3.js";import{G as ve}from"./GPane-L7gHnozL.js";import{G as ye}from"./GModal-DETqCgwG.js";import{C as Z,A as Ce,D as we,q as Te}from"./index-3Za6Osat.js";import{E as Se}from"./EllipsisHorizontalOutline-wlPychfE.js";import{N as Le}from"./InputGroup-Cfyn4FCC.js";import{A as _e}from"./AddOutline-e9mIKA9k.js";import{T as ke}from"./TrashOutline-fmGjC74g.js";const j=ie("/gateway/hub0080"),Ne=async s=>j.post("/queryAlertConfigs",s),Pe=async s=>j.post("/getAlertConfig",{channelName:s}),xe=async s=>j.post("/createAlertConfig",s),Oe=async s=>j.post("/updateAlertConfig",s),Ve=async s=>j.post("/setDefaultChannel",{channelName:s}),Ie=async(s,r,a)=>{const n={channelName:s};return r&&(n.title=r),a&&(n.content=a),j.post("/testAlertChannel",n)},Ae=async s=>j.post("/reloadAlertChannel",{channelName:s}),B=[{label:"邮件",value:"email"},{label:"QQ",value:"qq"},{label:"企业微信",value:"wechat_work"},{label:"钉钉",value:"dingtalk"},{label:"Webhook",value:"webhook"},{label:"短信",value:"sms"}],Fe=[{label:"启用",value:"Y"},{label:"禁用",value:"N"}],X=[{label:"是",value:"Y"},{label:"否",value:"N"}],De=[{label:"是",value:"Y"},{label:"否",value:"N"}],qe=[{label:"文本",value:"text"},{label:"HTML",value:"html"},{label:"Markdown",value:"markdown"}];function Me(s){const r=`hub0081:alert-template-list${s?`:${s}`:""}`,a=_(!1),n=_([]),o=_(),b=c=>{if(!c)return"";const h=Z.find(d=>d.value===c);return(h==null?void 0:h.label)||String(c)},g=c=>{if(!c)return"";const h=we.find(d=>d.value===c);return(h==null?void 0:h.label)||String(c)},u={fields:[{field:"templateName",label:"模板名称",type:"input",placeholder:"请输入模板名称",span:8,clearable:!0},{field:"channelType",label:"渠道类型",type:"select",placeholder:"请选择渠道类型",span:8,clearable:!0,options:[{label:"全部",value:""},...Z.map(c=>({label:c.label,value:c.value}))],defaultValue:s||""},{field:"activeFlag",label:"启用状态",type:"select",placeholder:"请选择启用状态",span:8,clearable:!0,options:[{label:"全部",value:""},...Ce.map(c=>({label:c.label,value:c.value}))],defaultValue:"Y"}],showSearchButton:!0,showResetButton:!0},m={columns:[{field:"templateName",title:"模板名称",align:"center",showOverflow:"tooltip",width:180},{field:"channelType",title:"渠道类型",align:"center",width:120,slots:{default:"channelType"}},{field:"displayFormat",title:"显示格式",align:"center",width:120,slots:{default:"displayFormat"}},{field:"activeFlag",title:"启用状态",align:"center",width:100,slots:{default:"activeFlag"}},{field:"templateDesc",title:"模板描述",align:"center",showOverflow:"tooltip",width:240}],showCheckbox:!1,paginationConfig:{show:!0,pageInfo:o,align:"right"}};function C(c){n.value=c}function k(c){a.value=c}function P(){o.value=void 0}function S(c){o.value?Object.assign(o.value,c):o.value=c}return{moduleId:r,loading:a,templateList:n,pageInfo:o,searchFormConfig:u,gridConfig:m,getChannelTypeLabel:b,getDisplayFormatLabel:g,setTemplateList:C,setLoading:k,resetPagination:P,updatePagination:S}}function Ee(s,r){const a=z(),n=Me(r);return{model:n,loadTemplateList:async b=>{var g,u,m;try{n.setLoading(!0);let C=b;!C&&((g=s==null?void 0:s.value)!=null&&g.getFormData)&&(C=s.value.getFormData()||{});const P={...C?Object.fromEntries(Object.entries(C).filter(([,c])=>c!==""&&c!==null&&c!==void 0)):{},...ne((u=n.pageInfo.value)==null?void 0:u.pageIndex,(m=n.pageInfo.value)==null?void 0:m.pageSize)},S=await Te(P);if(F(S)){const c=E(S,[])||[];n.setTemplateList(c);const h=ee(S);h&&Object.keys(h).length>0?n.updatePagination(h):n.resetPagination()}else a.error(D(S,"加载模板列表失败")),n.setTemplateList([]),n.resetPagination()}catch(C){console.error("加载模板列表失败:",C),a.error(C.message||"加载模板列表失败"),n.setTemplateList([]),n.resetPagination()}finally{n.setLoading(!1)}}}}function je(s,r,a){const n=Ee(r,a);return{service:n,handleSearch:async()=>{n.model.resetPagination(),await n.loadTemplateList()},handlePageChange:async({currentPage:g,pageSize:u})=>{n.model.updatePagination({pageIndex:g,pageSize:u}),await n.loadTemplateList()}}}const Ge=["id"],Ke=ae({name:"TemplateListModal",__name:"TemplateListModal",props:{visible:{type:Boolean,default:!1},title:{default:""},width:{default:1200},to:{default:void 0},modelValue:{default:""},channelType:{default:void 0}},emits:["update:visible","after-leave","select","update:modelValue"],setup(s,{emit:r}){const a=s,n=r,o=_(),b=_(),g=_(a.visible),u=$(()=>a.visible,h=>{g.value=h,h&&C()}),{service:m,handleSearch:C,handlePageChange:k}=je(b,o,a.channelType),P=h=>{g.value=h,n("update:visible",h)},S=()=>{n("after-leave")},c=({row:h})=>{if(h){const d=h.templateName||"";n("update:modelValue",d),n("select",h),P(!1)}};return re(()=>{u()}),(h,d)=>(te(),oe(T(ye),{visible:g.value,title:a.title||"选择模板",width:a.width||1200,to:a.to,"show-footer":!1,"onUpdate:visible":P,onAfterLeave:S},{default:x(()=>[ce("div",{class:"template-list-modal",id:T(m).model.moduleId},[O(T(ve),{direction:"vertical","no-resize":!0},{1:x(()=>[O(be,R({ref_key:"searchFormRef",ref:o,"module-id":T(m).model.moduleId},T(m).model.searchFormConfig,{onSearch:T(C)}),null,16,["module-id","onSearch"])]),2:x(()=>[O(T(he),R({ref_key:"gridRef",ref:b,"module-id":T(m).model.moduleId,data:T(m).model.templateList,loading:T(m).model.loading},T(m).model.gridConfig,{onPageChange:T(k),onRowClick:c}),{channelType:x(({row:t})=>[O(T(K),{size:"small",type:"info"},{default:x(()=>[W(Y(T(m).model.getChannelTypeLabel(t.channelType)||"通用"),1)]),_:2},1024)]),displayFormat:x(({row:t})=>[O(T(K),{size:"small",type:t.displayFormat==="table"?"warning":"default"},{default:x(()=>[W(Y(T(m).model.getDisplayFormatLabel(t.displayFormat)),1)]),_:2},1032,["type"])]),activeFlag:x(({row:t})=>[O(T(K),{size:"small",type:t.activeFlag==="Y"?"success":"default"},{default:x(()=>[W(Y(t.activeFlag==="Y"?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1},16,["module-id","data","loading","onPageChange"])]),_:1})],8,Ge)]),_:1},8,["visible","title","width","to"]))}}),We=le(Ke,[["__scopeId","data-v-3a649ec4"]]),Ye=ae({name:"TemplateNameSelector",__name:"TemplateNameSelector",props:{modelValue:{default:""},channelType:{default:void 0}},emits:["update:modelValue"],setup(s,{emit:r}){const a=s,n=r,o=_(!1),b=_(a.modelValue);$(()=>a.modelValue,m=>{b.value=m}),$(b,m=>{n("update:modelValue",m)});const g=m=>{b.value=m},u=()=>{o.value=!0};return(m,C)=>(te(),ue(ge,null,[O(T(Le),null,{default:x(()=>[O(T(de),{value:s.modelValue,placeholder:"请输入模板名称或点击选择",clearable:"",size:"small","onUpdate:value":g},null,8,["value"]),O(T(pe),{type:"primary",size:"small",onClick:u},{icon:x(()=>[O(T(fe),null,{default:x(()=>[O(T(Se))]),_:1})]),_:1})]),_:1}),O(We,{visible:o.value,"onUpdate:visible":C[0]||(C[0]=k=>o.value=k),"model-value":b.value,"onUpdate:modelValue":C[1]||(C[1]=k=>b.value=k),title:"选择模板",width:1200},null,8,["visible","model-value"])],64))}}),Qe=le(Ye,[["__scopeId","data-v-7232b404"]]);function Be(){const s="hub0080:alert-config",r=_(!1),a=_([]),n=_(),o={fields:[{field:"channelName",label:"渠道名称",type:"input",placeholder:"请输入渠道名称",span:6,clearable:!0},{field:"channelType",label:"渠道类型",type:"select",placeholder:"请选择渠道类型",span:6,clearable:!0,options:[{label:"全部",value:""},...B.map(e=>({label:e.label,value:e.value}))]},{field:"activeFlag",label:"启用状态",type:"select",placeholder:"请选择启用状态",span:6,clearable:!0,options:[{label:"全部",value:""},...Fe.map(e=>({label:e.label,value:e.value}))]},{field:"defaultFlag",label:"默认渠道",type:"select",placeholder:"请选择是否默认",span:6,clearable:!0,options:[{label:"全部",value:""},...X.map(e=>({label:e.label,value:e.value}))]}],toolbarButtons:[{key:"add",label:"新增渠道",icon:_e,type:"primary",tooltip:"新增告警渠道配置"},{key:"delete",label:"删除",icon:ke,type:"error",tooltip:"批量删除选中的渠道"}],showSearchButton:!0,showResetButton:!0},b=e=>{const p=B.find(V=>V.value===e);return(p==null?void 0:p.label)||e},g=e=>({email:"primary",qq:"info",wechat_work:"success",dingtalk:"warning",webhook:"default",sms:"error"})[e]||"default",u={columns:[{field:"channelName",title:"渠道名称",align:"center",showOverflow:"tooltip",width:160},{field:"channelType",title:"渠道类型",align:"center",width:120,slots:{default:"channelType"}},{field:"channelDesc",title:"渠道描述",align:"center",showOverflow:"tooltip",width:200},{field:"priorityLevel",title:"优先级",align:"center",width:100},{field:"defaultFlag",title:"默认渠道",align:"center",width:100,slots:{default:"defaultFlag"}},{field:"activeFlag",title:"启用状态",align:"center",width:100,slots:{default:"activeFlag"}},{field:"totalSentCount",title:"总发送数",align:"center",width:100},{field:"successCount",title:"成功数",align:"center",width:100},{field:"failureCount",title:"失败数",align:"center",width:100},{field:"lastSendTime",title:"最后发送时间",align:"center",formatter:({row:e})=>Q(e.lastSendTime),width:160},{field:"addTime",title:"创建时间",align:"center",formatter:({row:e})=>Q(e.addTime),width:160},{field:"editTime",title:"修改时间",align:"center",formatter:({row:e})=>Q(e.editTime),width:160}],showCheckbox:!0,paginationConfig:{show:!0,pageInfo:n,align:"right"},menuConfig:{enabled:!0,showCopyRow:!0,customMenus:[{code:"view",name:"查看详情",prefixIcon:"vxe-icon-eye-fill"},{code:"edit",name:"编辑",prefixIcon:"vxe-icon-edit"},{code:"copy",name:"复制",prefixIcon:"vxe-icon-copy"},{code:"reload",name:"重载配置",prefixIcon:"vxe-icon-refresh"},{code:"setDefault",name:"设为默认",prefixIcon:"vxe-icon-star"},{code:"test",name:"预警测试",prefixIcon:"vxe-icon-check"},{code:"delete",name:"删除",prefixIcon:"vxe-icon-delete"}]}};function m(e){a.value=e}function C(e){r.value=e}function k(){n.value=void 0}function P(e){n.value?Object.assign(n.value,e):n.value=e}function S(e){a.value.push(e)}function c(e,p,V){const q=a.value.findIndex(I=>I.channelName===e&&(!p||I.tenantId===p));q!==-1&&Object.assign(a.value[q],V)}function h(e){const p=a.value.findIndex(V=>V.channelName===e);p>=0&&a.value.splice(p,1)}function d(e){a.value=a.value.filter(p=>!e.includes(p.channelName))}const t=[{key:"basic",label:"基本信息"},{key:"config",label:"渠道配置"},{key:"other",label:"其他信息"}],v=[{field:"channelName",label:"渠道名称",type:"input",span:12,primary:!0,tabKey:"basic",required:!0,rules:[{required:!0,message:"请输入渠道名称",trigger:["blur","input"]},{max:32,message:"渠道名称不能超过32个字符",trigger:["blur","input"]},{pattern:/^[a-zA-Z0-9_]+$/,message:"渠道名称只能包含英文字母、数字和下划线",trigger:["blur","input"]}]},{field:"tenantId",label:"租户ID",type:"input",span:12,show:!1},{field:"channelType",label:"渠道类型",type:"select",placeholder:"请选择渠道类型",span:12,tabKey:"basic",required:!0,defaultValue:"email",options:B.map(e=>({label:e.label,value:e.value})),rules:[{required:!0,message:"请选择渠道类型",trigger:["blur","change"]}]},{field:"channelDesc",label:"渠道描述",type:"input",placeholder:"请输入渠道描述",span:12,tabKey:"basic",props:{type:"textarea",rows:2,maxlength:500,showCount:!0}},{field:"priorityLevel",label:"优先级",type:"number",placeholder:"请输入优先级（1-10，数字越小优先级越高）",span:12,tabKey:"basic",defaultValue:5,tips:"优先级范围：1-10，数字越小优先级越高",props:{min:1,max:10,precision:0},rules:[{required:!0,type:"number",message:"请输入优先级",trigger:["blur","change"]}]},{field:"defaultFlag",label:"默认渠道",type:"select",placeholder:"请选择是否设为默认渠道",span:12,tabKey:"basic",defaultValue:"N",options:X.map(e=>({label:e.label,value:e.value})),tips:"设为默认后，发送告警时如果不指定渠道，将使用此渠道"},{field:"activeFlag",label:"启用状态",type:"switch",span:12,tabKey:"basic",defaultValue:"Y",tips:"禁用后此渠道将不会被使用",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"defaultTemplateName",label:"默认模板名称",type:"custom",span:12,tabKey:"basic",placeholder:"请输入模板名称或点击选择",render:e=>me(Qe,{modelValue:e.defaultTemplateName||"","onUpdate:modelValue":p=>{e.defaultTemplateName=p},channelType:e.channelType})},{field:"serverConfigGroup",label:"服务器配置",type:"fieldset",span:24,tabKey:"config",show:e=>e.channelType==="email",children:[{field:"serverConfig.smtp_host",label:"SMTP服务器地址",type:"input",placeholder:"请输入SMTP服务器地址，如：smtp.example.com",span:12,required:!0,tips:"SMTP服务器地址，如 smtp.gmail.com",rules:[{required:!0,message:"请输入SMTP服务器地址",trigger:["blur","input"]}]},{field:"serverConfig.smtp_port",label:"SMTP端口",type:"number",placeholder:"请输入SMTP端口",span:12,required:!0,defaultValue:587,tips:"SMTP端口，常用端口：587(TLS), 465(SSL), 25(非加密)",props:{min:1,max:65535,precision:0},rules:[{required:!0,type:"number",message:"请输入SMTP端口",trigger:["blur","change"]}]},{field:"serverConfig.username",label:"用户名",type:"input",placeholder:"请输入SMTP用户名",span:12,required:!0,tips:"SMTP认证用户名，通常是邮箱地址",rules:[{required:!0,message:"请输入用户名",trigger:["blur","input"]}]},{field:"serverConfig.password",label:"密码",type:"input",placeholder:"请输入SMTP密码",span:12,required:!0,tips:"SMTP认证密码或授权码",props:{type:"password",showPasswordOn:"click"},rules:[{required:!0,message:"请输入密码",trigger:["blur","input"]}]},{field:"serverConfig.from",label:"发件人地址",type:"input",placeholder:"请输入发件人邮箱地址",span:12,required:!0,tips:"默认发件人邮箱地址",rules:[{required:!0,message:"请输入发件人地址",trigger:["blur","input"]},{type:"email",message:"请输入有效的邮箱地址",trigger:["blur","input"]}]},{field:"serverConfig.from_name",label:"发件人名称",type:"input",placeholder:"请输入发件人名称（可选）",span:12,tips:"发件人显示名称，如：系统告警"},{field:"serverConfig.use_tls",label:"使用TLS",type:"switch",span:12,defaultValue:!0,tips:"是否使用TLS加密连接",props:{checkedValue:!0,uncheckedValue:!1}},{field:"serverConfig.skip_verify",label:"跳过证书验证",type:"switch",span:12,defaultValue:!1,tips:"是否跳过TLS证书验证（不推荐，仅用于测试）",props:{checkedValue:!0,uncheckedValue:!1}},{field:"serverConfig.timeout",label:"超时时间（秒）",type:"number",placeholder:"请输入超时时间",span:12,defaultValue:30,tips:"SMTP连接超时时间",props:{min:1,max:300,precision:0}}]},{field:"qqServerConfigGroup",label:"服务器配置",type:"fieldset",span:24,tabKey:"config",show:e=>e.channelType==="qq",children:[{field:"serverConfig.webhook_url",label:"Webhook地址",type:"input",placeholder:"请输入QQ机器人Webhook地址",span:24,required:!0,tips:"QQ机器人Webhook地址，从QQ群机器人配置中获取",rules:[{required:!0,message:"请输入Webhook地址",trigger:["blur","input"]},{type:"url",message:"请输入有效的URL地址",trigger:["blur","input"]}]},{field:"serverConfig.secret",label:"签名密钥",type:"input",placeholder:"请输入签名密钥（可选）",span:12,tips:"QQ机器人签名密钥（如果配置了签名验证）",props:{type:"password",showPasswordOn:"click"}},{field:"serverConfig.timeout",label:"超时时间（秒）",type:"number",placeholder:"请输入超时时间",span:12,defaultValue:30,tips:"HTTP请求超时时间",props:{min:1,max:300,precision:0}}]},{field:"wechatWorkServerConfigGroup",label:"服务器配置",type:"fieldset",span:24,tabKey:"config",show:e=>e.channelType==="wechat_work",children:[{field:"serverConfig.webhook_url",label:"Webhook地址",type:"input",placeholder:"请输入企业微信机器人Webhook地址",span:24,required:!0,tips:"企业微信机器人Webhook地址，从企业微信群机器人配置中获取",rules:[{required:!0,message:"请输入Webhook地址",trigger:["blur","input"]},{type:"url",message:"请输入有效的URL地址",trigger:["blur","input"]}]},{field:"serverConfig.secret",label:"签名密钥",type:"input",placeholder:"请输入签名密钥（可选）",span:12,tips:"企业微信机器人签名密钥（如果配置了签名验证）",props:{type:"password",showPasswordOn:"click"}},{field:"serverConfig.message_type",label:"消息类型",type:"select",placeholder:"请选择消息类型",span:12,defaultValue:"markdown",tips:"消息类型：text（文本）或 markdown（Markdown格式）",options:[{label:"文本",value:"text"},{label:"Markdown",value:"markdown"}]},{field:"serverConfig.timeout",label:"超时时间（秒）",type:"number",placeholder:"请输入超时时间",span:12,defaultValue:30,tips:"HTTP请求超时时间",props:{min:1,max:300,precision:0}}]},{field:"sendConfigGroup",label:"发送配置",type:"fieldset",span:24,tabKey:"config",show:e=>e.channelType==="email",children:[{field:"sendConfig.to",label:"收件人列表",type:"input",placeholder:"请输入收件人邮箱，多个用逗号分隔",span:24,required:!0,tips:"收件人邮箱地址列表，多个用逗号分隔，如：user1@example.com,user2@example.com",rules:[{required:!0,message:"请输入收件人列表",trigger:["blur","input"]}]},{field:"sendConfig.cc",label:"抄送列表",type:"input",placeholder:"请输入抄送邮箱，多个用逗号分隔（可选）",span:12,tips:"抄送邮箱地址列表，多个用逗号分隔"},{field:"sendConfig.bcc",label:"密送列表",type:"input",placeholder:"请输入密送邮箱，多个用逗号分隔（可选）",span:12,tips:"密送邮箱地址列表，多个用逗号分隔"}]},{field:"qqSendConfigGroup",label:"发送配置",type:"fieldset",span:24,tabKey:"config",show:e=>e.channelType==="qq",children:[{field:"sendConfig.at_all",label:"@所有人",type:"switch",span:12,defaultValue:!1,tips:"是否@所有人",props:{checkedValue:!0,uncheckedValue:!1}},{field:"sendConfig.at_users",label:"@指定用户",type:"input",placeholder:"请输入QQ号，多个用逗号分隔（可选）",span:12,tips:"要@的QQ号列表，多个用逗号分隔"}]},{field:"wechatWorkSendConfigGroup",label:"发送配置",type:"fieldset",span:24,tabKey:"config",show:e=>e.channelType==="wechat_work",children:[{field:"sendConfig.mentioned_list",label:"@成员列表（userid）",type:"input",placeholder:"请输入成员userid，多个用逗号分隔（可选）",span:12,tips:"要@的成员userid列表，多个用逗号分隔"},{field:"sendConfig.mentioned_mobile_list",label:"@成员手机号列表",type:"input",placeholder:"请输入成员手机号，多个用逗号分隔（可选）",span:12,tips:"要@的成员手机号列表，多个用逗号分隔"}]},{field:"commonConfigGroup",label:"通用配置",type:"fieldset",span:24,tabKey:"config",children:[{field:"messageContentFormat",label:"消息内容格式",type:"select",placeholder:"请选择消息内容格式",span:12,defaultValue:"html",options:qe.map(e=>({label:e.label,value:e.value})),tips:"消息内容的格式类型"},{field:"timeoutSeconds",label:"超时时间（秒）",type:"number",placeholder:"请输入超时时间",span:12,defaultValue:30,props:{min:1,max:300,precision:0}},{field:"retryCount",label:"重试次数",type:"number",placeholder:"请输入重试次数",span:12,defaultValue:3,props:{min:0,max:10,precision:0}},{field:"retryIntervalSecs",label:"重试间隔（秒）",type:"number",placeholder:"请输入重试间隔",span:12,defaultValue:5,props:{min:1,max:60,precision:0}},{field:"asyncSendFlag",label:"异步发送",type:"select",placeholder:"请选择是否异步发送",span:12,defaultValue:"Y",options:De.map(e=>({label:e.label,value:e.value})),tips:"启用异步发送可提高性能，但可能延迟消息到达"}]},{field:"noteText",label:"备注信息",type:"input",placeholder:"请输入备注信息",span:24,tabKey:"other",props:{type:"textarea",rows:3,maxlength:500,showCount:!0}},{field:"addTime",label:"创建时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"addWho",label:"创建人",type:"input",span:12,tabKey:"other",disabled:!0},{field:"editTime",label:"修改时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"editWho",label:"修改人",type:"input",span:12,tabKey:"other",disabled:!0}];return{moduleId:s,loading:r,configList:a,pageInfo:n,searchFormConfig:o,gridConfig:u,formFields:v,formTabs:t,getChannelTypeLabel:b,getChannelTypeTagType:g,setConfigList:m,setLoading:C,resetPagination:k,updatePagination:P,addConfigToList:S,updateConfigInList:c,removeConfigFromList:h,removeConfigsFromList:d}}function $e(s){const r=z(),a=Be(),{addConfigToList:n,updateConfigInList:o,removeConfigFromList:b,removeConfigsFromList:g}=a,u=async d=>{var t,v,e;try{a.setLoading(!0);let p=d;!p&&((t=s==null?void 0:s.value)!=null&&t.getFormData)&&(p=s.value.getFormData()||{});const q={...p?Object.fromEntries(Object.entries(p).filter(([,A])=>A!==""&&A!==null&&A!==void 0)):{},...ne((v=a.pageInfo.value)==null?void 0:v.pageIndex,(e=a.pageInfo.value)==null?void 0:e.pageSize)},I=await Ne(q);if(F(I)){const A=E(I,[])||[];a.setConfigList(A);const M=ee(I);M&&Object.keys(M).length>0?a.updatePagination(M):a.resetPagination()}else r.error(D(I,"加载配置列表失败")),a.setConfigList([]),a.resetPagination()}catch(p){console.error("加载配置列表失败:",p),r.error(p.message||"加载配置列表失败"),a.setConfigList([]),a.resetPagination()}finally{a.setLoading(!1)}},m=async d=>{try{const t=await Pe(d);return F(t)?E(t):(r.error(D(t,"获取配置详情失败")),null)}catch(t){return console.error("获取配置详情失败:",t),r.error(t.message||"获取配置详情失败"),null}},C=async d=>{try{a.setLoading(!0);const t=await xe(d);if(F(t)){r.success("新增配置成功");const v=E(t,null);return v?n(v):await u(),!0}else return r.error(D(t,"新增配置失败")),!1}catch(t){return console.error("新增配置失败:",t),r.error(t.message||"新增配置失败"),!1}finally{a.setLoading(!1)}},k=async(d,t)=>{try{a.setLoading(!0);const v={...t,channelName:d},e=await Oe(v);if(F(e)){r.success("编辑配置成功");const p=E(e,null);return p?o(p.channelName,p.tenantId,p):await u(),!0}else return r.error(D(e,"编辑配置失败")),!1}catch(v){return console.error("编辑配置失败:",v),r.error(v.message||"编辑配置失败"),!1}finally{a.setLoading(!1)}};return{model:a,loadConfigList:u,getConfigDetail:m,addConfig:C,editConfig:k,setDefault:async d=>{try{a.setLoading(!0);const t=await Ve(d);return F(t)?(r.success("设置默认渠道成功"),await u(),!0):(r.error(D(t,"设置默认渠道失败")),!1)}catch(t){return console.error("设置默认渠道失败:",t),r.error(t.message||"设置默认渠道失败"),!1}finally{a.setLoading(!1)}},toggleConfigStatus:async d=>{const t=d.activeFlag==="Y"?"N":"Y";return await k(d.channelName,{...d,activeFlag:t})},testChannel:async d=>{try{a.setLoading(!0);const t=await Ie(d);if(F(t)){const v=E(t),e=(v==null?void 0:v.message)||"告警渠道测试成功";return r.success(e),!0}else return r.error(D(t,"告警渠道测试失败")),!1}catch(t){return console.error("测试告警渠道失败:",t),r.error(t.message||"测试告警渠道失败"),!1}finally{a.setLoading(!1)}},reloadChannel:async d=>{try{a.setLoading(!0);const t=await Ae(d);if(F(t)){const v=E(t),e=v!=null&&v.reloaded?"配置重载成功":(v==null?void 0:v.message)||"配置重载成功";return r.success(e),!0}else return r.error(D(t,"配置重载失败")),!1}catch(t){return console.error("配置重载失败:",t),r.error(t.message||"配置重载失败"),!1}finally{a.setLoading(!1)}}}}function sa(s,r){const a=z(),n=se(),o=$e(r),b=_(!1),g=_("create"),u=_(null),m=async l=>{o.model.resetPagination(),await o.loadConfigList(l)},C=async({currentPage:l,pageSize:i})=>{o.model.updatePagination({pageIndex:l,pageSize:i}),await o.loadConfigList()},k=async(l,i)=>{switch(l){case"add":P();break;case"delete":{if(!(s!=null&&s.value)){a.warning("Grid 引用未设置");return}const w=s.value.getCurrentRecord();if(!w){a.warning("请先点击选择要删除的配置");return}await V(w);break}case"search":{await m(i);break}default:console.warn("未知的工具栏按钮:",l)}},P=()=>{g.value="create",u.value=null,b.value=!0},S=l=>{const i=f=>{if(typeof f=="string"&&f)try{return JSON.parse(f)}catch{return f}return f},w=i(l.serverConfig)||{},y=i(l.sendConfig)||{},L={...l};return w&&typeof w=="object"&&Object.keys(w).forEach(f=>{L[`serverConfig.${f}`]=w[f]}),y&&typeof y=="object"&&Object.keys(y).forEach(f=>{const N=y[f];Array.isArray(N)&&(f==="to"||f==="cc"||f==="bcc"||f==="at_users"||f==="mentioned_list"||f==="mentioned_mobile_list")?L[`sendConfig.${f}`]=N.join(", "):L[`sendConfig.${f}`]=N}),L},c=async l=>{if(!l.channelName){a.warning("渠道名称不能为空");return}try{const i=await o.getConfigDetail(l.channelName);if(i){g.value="edit",u.value=i;const w=S(i);u.value=w,b.value=!0}else g.value="edit",u.value=S(l),b.value=!0}catch{g.value="edit",u.value=S(l),b.value=!0}},h=async l=>{if(!l.channelName){a.warning("渠道名称不能为空");return}try{const i=await o.getConfigDetail(l.channelName);if(i){g.value="view";const w=S(i);u.value=w,b.value=!0}else g.value="view",u.value=S(l),b.value=!0}catch{g.value="view",u.value=S(l),b.value=!0}},d=async l=>{if(!l.channelName){a.warning("渠道名称不能为空");return}try{const w=await o.getConfigDetail(l.channelName)||l,y=S(w);y.channelName="",y.tenantId=y.tenantId||"",delete y.addTime,delete y.addWho,delete y.editTime,delete y.editWho,delete y.oprSeqFlag,delete y.currentVersion,y.totalSentCount=0,y.successCount=0,y.failureCount=0,y.lastSendTime=null,y.lastSuccessTime=null,y.lastFailureTime=null,y.lastErrorMessage=null,g.value="create",u.value=y,b.value=!0}catch(i){a.error("获取配置详情失败，无法复制"),console.error("复制配置失败:",i)}},t=()=>{b.value=!1,u.value=null},v=l=>{const i={};Object.keys(l).forEach(L=>{if(L.startsWith("serverConfig.")){const f=L.replace("serverConfig.",""),N=l[L];N!=null&&N!==""&&(i[f]=N)}});const w={};Object.keys(l).forEach(L=>{if(L.startsWith("sendConfig.")){const f=L.replace("sendConfig.",""),N=l[L];if(N!=null&&N!=="")if(typeof N=="string"&&(f==="to"||f==="cc"||f==="bcc"||f==="at_users"||f==="mentioned_list"||f==="mentioned_mobile_list")){const J=N.split(",").map(G=>G.trim()).filter(G=>G);J.length>0&&(w[f]=J)}else w[f]=N}});const y={};return Object.keys(l).forEach(L=>{!L.startsWith("serverConfig.")&&!L.startsWith("sendConfig.")&&(y[L]=l[L])}),{...y,serverConfig:Object.keys(i).length>0?JSON.stringify(i):void 0,sendConfig:Object.keys(w).length>0?JSON.stringify(w):void 0}},e=async l=>{if(l){if(g.value==="view"){t();return}try{const i=v(l);let w=!1;g.value==="create"?w=await o.addConfig(i):g.value==="edit"&&u.value&&(w=await o.editConfig(u.value.channelName,i)),w&&t()}catch(i){console.error("提交配置失败:",i),a.error(i.message||"提交失败，请重试")}}},p=async({menu:l,row:i})=>{switch(l.code){case"view":await h(i);break;case"edit":await c(i);break;case"copy":await d(i);break;case"reload":await H(i);break;case"setDefault":await q(i);break;case"test":await U(i);break;case"delete":await V(i);break;default:console.warn("未知的菜单项:",l.code)}},V=async l=>{await n.warning({title:"确认删除",content:`确定要删除渠道配置"${l.channelName}"吗？此操作不可恢复。`,positiveText:"删除",negativeText:"取消"})&&a.warning("删除功能暂未实现")},q=async l=>{if(l.defaultFlag==="Y"){a.info("该渠道已经是默认渠道");return}await n.warning({title:"确认设置",content:`确定要将渠道"${l.channelName}"设置为默认渠道吗？`,positiveText:"确定",negativeText:"取消"})&&await o.setDefault(l.channelName)},I=async l=>{await o.toggleConfigStatus(l)},A=_(!1),M=_(null),U=async l=>{if(!l.channelName){a.warning("渠道名称不能为空");return}if(l.activeFlag!=="Y"){a.warning("该渠道未启用，无法测试");return}M.value=l,A.value=!0},H=async l=>{if(!l.channelName){a.warning("渠道名称不能为空");return}if(!await n.warning({title:"确认重载",content:`确定要重载渠道"${l.channelName}"的配置吗？重载后将立即生效。`,positiveText:"重载",negativeText:"取消"}))return;await o.reloadChannel(l.channelName)&&await o.loadConfigList()};return{service:o,formDialogVisible:b,formDialogMode:g,currentEditConfig:u,testModalVisible:A,currentTestConfig:M,handleSearch:m,handlePageChange:C,handleToolbarClick:k,handleMenuClick:p,openAddDialog:P,openEditDialog:c,openViewDialog:h,openCopyDialog:d,closeFormDialog:t,handleFormSubmit:e,handleDelete:V,handleSetDefault:q,handleToggleStatus:I,handleTestChannel:U,handleReloadChannel:H,closeTestModal:()=>{A.value=!1,M.value=null}}}export{B as C,Ie as t,sa as u};
