import{f as Ye,c as ze,b as Ce,a as Be,S as Re,G as $e}from"./SearchForm-DJb0ZWNX.js";import{G as xe,u as Ue}from"./GDataFormModal-DgGQw7yy.js";import{G as Ze}from"./GTree-Bgf3CwAL.js";import{X as Qe,r as _,c as Ie,a2 as P,j as ee,m as re,z as J,A as se,cX as Pe,P as fe,af as we,B,aG as $,d as he,v as We,b as te,o as j,g as O,i as de,e as S,f as a,w as C,J as ie,G as Se,ch as ue,I as Ge,h as oe,R as qe,_ as ve,T as pe,a4 as ge,K as W,t as R,ci as ye,H as De,aI as Ke,bO as et,n as tt,cH as at,cx as Le,cD as lt}from"./index-Bj7ga03z.js";import{A as Ne,T as je}from"./TrashOutline-PbDgU_HB.js";import{S as be}from"./ServerOutline-DhMnbK2u.js";import{R as rt}from"./RefreshOutline-rlOCtCAg.js";import"./GDialog.vue_vue_type_style_index_0_scoped_82fcf09e_lang-B91gX0Tb.js";/* empty css                                                                    */import{C as it}from"./CreateOutline-CkVjEItu.js";import{W as me}from"./WarningOutline-BOd_sKjP.js";import{C as st}from"./OptionsOutline-uty6-gO6.js";import{N as ot}from"./Radio-COvupTNC.js";import{S as H,L as U}from"./types-BgPBDzuW.js";import{P as nt}from"./PencilOutline-tC1w6OYQ.js";import"./index-DR_R-bYe.js";import"./DatePicker-CslHYILL.js";import"./Select-CyEkftkI.js";import"./Grid-BcOseQst.js";import"./InputNumber-CEFiX_Zn.js";import"./Switch-CnvGQQBH.js";import"./Scrollbar-wRO2n3Ge.js";import"./InformationCircleOutline-D2sRkwoP.js";import"./CopyOutline-BDGu0fpY.js";import"./Checkbox-CGigI9sY.js";import"./download-C2161hUv.js";const X=Qe("/gateway/hub0022");async function ct(s){return X.post("/queryAllGatewayInstances",s)}async function dt(s){return X.post("/getProxyConfigsByInstance",{gatewayInstanceId:s})}async function ut(s){return X.post("/addProxyConfig",s)}async function pt(s){return X.post("/editProxyConfig",s)}async function ft(s){return X.post("/queryServiceDefinitions",s)}async function Fe(s,m){return X.post("/getServiceDefinition",{serviceDefinitionId:s,tenantId:m})}async function ht(s){return X.post("/addServiceDefinition",s)}async function Te(s){return X.post("/editServiceDefinition",s)}async function He(s,m){return X.post("/deleteServiceDefinition",{serviceDefinitionId:s,tenantId:m})}async function vt(s){return X.post("/queryServiceNodes",s)}async function Ve(s,m){return X.post("/getServiceNode",{serviceNodeId:s,tenantId:m})}async function yt(s){return X.post("/addServiceNode",s)}async function gt(s){return X.post("/editServiceNode",s)}async function bt(s,m){return X.post("/deleteServiceNode",{serviceNodeId:s,tenantId:m})}async function mt(s){return X.post("/batchDeleteServiceNodes",{serviceNodeIds:s,tenantId:"default"})}async function wt(s){return X.post("/registServiceQuery",s)}var N=(s=>(s.HTTP="http",s.WEBSOCKET="websocket",s.TCP="tcp",s.UDP="udp",s))(N||{});function Tt(){const s="hub0022",m=_(!1),r=_([]),y=_(1),p=_(20),i=_(0),g=_(""),h=Ie(()=>r.value.map(t=>({key:t.gatewayInstanceId,label:I(t),instance:t})));function I(t){const d=t.tlsEnabled==="Y"?t.httpsPort:t.httpPort;return`${t.instanceName||"未命名"} (${t.bindAddress||"-"}:${d||"-"})`}function E(t){r.value=t}function x(t){m.value=t}function M(t){y.value=t}function F(t){p.value=t}function L(t){g.value=t}function e(t){i.value=t}function l(){y.value=1}function u(){g.value=""}const V={enabled:!0,showCopyNode:!0,customMenus:[{code:"addProxy",name:"代理配置",prefixIcon:()=>P(ee,{size:14},{default:()=>P(Ne)})}]},A={tabs:[{key:"basic",label:"基本信息"},{key:"http",label:"HTTP配置",show:t=>t.proxyType===N.HTTP},{key:"websocket",label:"WebSocket配置",show:t=>t.proxyType===N.WEBSOCKET},{key:"tcp",label:"TCP配置",show:t=>t.proxyType===N.TCP},{key:"udp",label:"UDP配置",show:t=>t.proxyType===N.UDP},{key:"custom",label:"其它"}],fields:[{field:"proxyConfigId",label:"代理配置ID",type:"input",span:12,tabKey:"basic",primary:!0,show:!1},{field:"gatewayInstanceId",label:"网关实例ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"tenantId",label:"租户ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"proxyName",label:"代理名称",type:"input",placeholder:"请输入代理名称",span:12,tabKey:"basic",required:!0,tips:"代理配置的唯一标识名称，用于区分不同的代理配置",rules:[{required:!0,message:"请输入代理名称",trigger:["blur","input"]},{max:50,message:"代理名称不能超过50个字符",trigger:["blur","input"]}]},{field:"proxyType",label:"代理类型",type:"select",placeholder:"请选择代理类型",span:12,tabKey:"basic",required:!0,defaultValue:N.HTTP,tips:"选择代理协议类型：HTTP(支持HTTP/HTTPS协议)、WebSocket(支持WebSocket协议)、TCP(支持TCP协议)、UDP(支持UDP协议)",options:[{label:"HTTP",value:N.HTTP},{label:"WebSocket",value:N.WEBSOCKET},{label:"TCP",value:N.TCP},{label:"UDP",value:N.UDP}],rules:[{required:!0,message:"请选择代理类型",trigger:["blur","change"]}]},{field:"configPriority",label:"配置优先级",type:"number",placeholder:"请输入配置优先级",span:12,tabKey:"basic",required:!0,defaultValue:100,tips:"配置优先级，数值越小优先级越高。当存在多个代理配置时，优先级高的配置会优先匹配",props:{min:0,max:999},rules:[{required:!0,message:"请输入优先级",trigger:["blur","change"],validator:(t,d)=>{if(d==null||d==="")return new Error("请输入优先级");const w=Number(d);return isNaN(w)?new Error("优先级必须是数字"):w<0||w>999?new Error("优先级必须是0-999之间的数字"):!0}}]},{field:"activeFlag",label:"状态",type:"switch",span:12,tabKey:"basic",defaultValue:"Y",tips:"代理配置的启用状态。启用后配置才会生效，禁用后代理将不会处理请求",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"noteText",label:"备注",type:"textarea",placeholder:"请输入备注信息",span:24,tabKey:"basic",tips:"代理配置的备注说明，用于记录配置的用途、注意事项等信息",props:{rows:3}},{field:"proxyConfig.httpVersion",label:"HTTP版本",type:"select",placeholder:"请选择HTTP版本",span:12,tabKey:"http",show:t=>t.proxyType===N.HTTP,defaultValue:"1.1",tips:"HTTP协议版本，HTTP/1.0 或 HTTP/1.1。HTTP/1.1 支持连接复用、管道化等特性，性能更好",options:[{label:"HTTP/1.0",value:"1.0"},{label:"HTTP/1.1",value:"1.1"}]},{field:"proxyConfig.connectTimeout",label:"连接超时（秒）",type:"number",placeholder:"请输入连接超时",span:12,tabKey:"http",show:t=>t.proxyType===N.HTTP,defaultValue:30,tips:"建立TCP连接的超时时间，超过此时间未建立连接则请求失败",props:{min:1}},{field:"proxyConfig.keepAlive",label:"保持连接",type:"switch",span:12,tabKey:"http",show:t=>t.proxyType===N.HTTP,defaultValue:!0,tips:"是否启用HTTP Keep-Alive连接复用。启用后可以复用TCP连接，提高性能，减少连接建立开销"},{field:"proxyConfig.maxIdleConns",label:"最大空闲连接数",type:"number",placeholder:"请输入最大空闲连接数",span:12,tabKey:"http",show:t=>t.proxyType===N.HTTP,defaultValue:100,tips:"连接池中保持的最大空闲连接数。空闲连接可以被复用，提高性能，但会占用内存资源",props:{min:0}},{field:"proxyConfig.idleConnTimeout",label:"空闲连接超时（秒）",type:"number",placeholder:"请输入空闲连接超时",span:12,tabKey:"http",show:t=>t.proxyType===N.HTTP,required:!0,defaultValue:90,tips:"连接池中空闲连接的最大保持时间，超过此时间的空闲连接会被关闭释放资源",props:{min:1,max:7200},rules:[{required:!0,message:"请输入空闲连接超时时间",trigger:["blur","change"],type:"number",validator:(t,d)=>d==null?new Error("请输入空闲连接超时时间"):d<1?new Error("空闲连接超时时间必须大于0秒"):d>7200?new Error("空闲连接超时时间不能超过7200秒"):!0}]},{field:"proxyConfig.timeout",label:"总超时时间（秒）",type:"number",placeholder:"请输入超时时间",span:12,tabKey:"http",show:t=>t.proxyType===N.HTTP,required:!0,defaultValue:60,tips:"请求的总超时时间（包括连接、发送、读取），超过此时间未完成则请求失败",props:{min:1,max:3600},rules:[{required:!0,message:"请输入超时时间",trigger:["blur","change"],type:"number",validator:(t,d)=>d==null?new Error("请输入超时时间"):d<1?new Error("超时时间必须大于0秒"):d>3600?new Error("超时时间不能超过3600秒"):!0}]},{field:"proxyConfig.sendTimeout",label:"发送超时（秒）",type:"number",placeholder:"请输入发送超时",span:12,tabKey:"http",show:t=>t.proxyType===N.HTTP,defaultValue:60,tips:"发送请求数据的超时时间，超过此时间未发送完成则请求失败",props:{min:1}},{field:"proxyConfig.readTimeout",label:"读取超时（秒）",type:"number",placeholder:"请输入读取超时",span:12,tabKey:"http",show:t=>t.proxyType===N.HTTP,defaultValue:60,tips:"读取响应数据的超时时间，超过此时间未读取完成则请求失败",props:{min:1}},{field:"proxyConfig.retryCount",label:"重试次数",type:"number",placeholder:"请输入重试次数",span:12,tabKey:"http",show:t=>t.proxyType===N.HTTP,defaultValue:3,tips:"请求失败时的自动重试次数。设置为0表示不重试",props:{min:0}},{field:"proxyConfig.retryTimeout",label:"重试超时（秒）",type:"number",placeholder:"请输入重试超时",span:12,tabKey:"http",show:t=>t.proxyType===N.HTTP,required:!0,defaultValue:30,tips:"每次重试的超时时间，如果单次重试超过此时间则重试失败，继续下一次重试",props:{min:1,max:300},rules:[{required:!0,message:"请输入重试超时时间",trigger:["blur","change"],type:"number",validator:(t,d)=>d==null?new Error("请输入重试超时时间"):d<1?new Error("重试超时时间必须大于0秒"):d>300?new Error("重试超时时间不能超过300秒"):!0}]},{field:"proxyConfig.proxyBuffering",label:"代理缓冲",type:"switch",span:12,tabKey:"http",show:t=>t.proxyType===N.HTTP,defaultValue:!0,tips:"是否启用代理缓冲。启用后会在代理层缓冲请求和响应，可以优化传输性能"},{field:"proxyConfig.bufferSize",label:"缓冲区大小（字节）",type:"number",placeholder:"请输入缓冲区大小",span:12,tabKey:"http",show:t=>t.proxyType===N.HTTP,defaultValue:4096,tips:"默认缓冲区大小，用于临时存储请求和响应数据",props:{min:0}},{field:"proxyConfig.maxBufferSize",label:"最大缓冲区大小（字节）",type:"number",placeholder:"请输入最大缓冲区大小",span:12,tabKey:"http",show:t=>t.proxyType===N.HTTP,defaultValue:65536,tips:"缓冲区的最大大小限制，防止缓冲区无限增长导致内存溢出",props:{min:0}},{field:"proxyConfig.copyResponseBody",label:"复制响应体",type:"switch",span:12,tabKey:"http",show:t=>t.proxyType===N.HTTP,defaultValue:!1,tips:"是否复制完整的响应体到内存。启用后可以多次读取响应，但会占用更多内存"},{field:"proxyConfig.followRedirects",label:"跟随重定向",type:"switch",span:12,tabKey:"http",show:t=>t.proxyType===N.HTTP,defaultValue:!1,tips:"是否自动跟随HTTP重定向响应（3xx状态码）。启用后会自动跳转到重定向地址"},{field:"proxyConfig.preserveHost",label:"保留原始Host",type:"switch",span:12,tabKey:"http",show:t=>t.proxyType===N.HTTP,defaultValue:!1,tips:"是否保留客户端原始Host请求头。启用后目标服务器会看到原始Host，而不是代理服务器的地址"},{field:"proxyConfig.addXForwardedFor",label:"添加X-Forwarded-For",type:"switch",span:12,tabKey:"http",show:t=>t.proxyType===N.HTTP,defaultValue:!0,tips:"是否添加X-Forwarded-For请求头，用于标识客户端的真实IP地址，方便目标服务器获取客户端信息"},{field:"proxyConfig.addXRealIP",label:"添加X-Real-IP",type:"switch",span:12,tabKey:"http",show:t=>t.proxyType===N.HTTP,defaultValue:!0,tips:"是否添加X-Real-IP请求头，用于标识客户端的真实IP地址，是X-Forwarded-For的简化版本"},{field:"proxyConfig.addXForwardedProto",label:"添加X-Forwarded-Proto",type:"switch",span:12,tabKey:"http",show:t=>t.proxyType===N.HTTP,defaultValue:!0,tips:"是否添加X-Forwarded-Proto请求头，用于标识客户端使用的协议（http或https）"},{field:"proxyConfig.tlsInsecureSkipVerify",label:"跳过TLS证书验证",type:"switch",span:12,tabKey:"http",show:t=>t.proxyType===N.HTTP,defaultValue:!1,tips:"是否跳过TLS证书验证（仅用于测试环境）。生产环境建议关闭以确保安全性"},{field:"proxyConfig.tlsMinVersion",label:"最小TLS版本",type:"select",placeholder:"请选择最小TLS版本",span:12,tabKey:"http",show:t=>t.proxyType===N.HTTP,defaultValue:"1.2",tips:"支持的最小TLS协议版本。低于此版本的连接将被拒绝，建议使用TLS 1.2或更高版本",options:[{label:"TLS 1.0",value:"1.0"},{label:"TLS 1.1",value:"1.1"},{label:"TLS 1.2",value:"1.2"},{label:"TLS 1.3",value:"1.3"}]},{field:"proxyConfig.tlsMaxVersion",label:"最大TLS版本",type:"select",placeholder:"请选择最大TLS版本",span:12,tabKey:"http",show:t=>t.proxyType===N.HTTP,defaultValue:"1.3",tips:"支持的最大TLS协议版本。高于此版本的连接将降级到此版本",options:[{label:"TLS 1.0",value:"1.0"},{label:"TLS 1.1",value:"1.1"},{label:"TLS 1.2",value:"1.2"},{label:"TLS 1.3",value:"1.3"}]},{field:"proxyConfig.tlsServerName",label:"TLS服务器名称",type:"input",placeholder:"请输入TLS服务器名称（可选）",span:12,tabKey:"http",show:t=>t.proxyType===N.HTTP,tips:"TLS SNI（Server Name Indication）服务器名称，用于指定要连接的服务器主机名，通常与证书域名匹配"},{field:"proxyConfig.pingInterval",label:"Ping间隔（秒）",type:"number",placeholder:"请输入Ping间隔",span:12,tabKey:"websocket",show:t=>t.proxyType===N.WEBSOCKET,defaultValue:30,tips:"WebSocket连接心跳检测的Ping消息发送间隔，用于保持连接活跃并检测连接状态",props:{min:1}},{field:"proxyConfig.pongTimeout",label:"Pong超时（秒）",type:"number",placeholder:"请输入Pong超时",span:12,tabKey:"websocket",show:t=>t.proxyType===N.WEBSOCKET,defaultValue:10,tips:"发送Ping消息后等待Pong响应的超时时间，超过此时间未收到Pong则视为连接断开",props:{min:1}},{field:"proxyConfig.maxMessageSize",label:"最大消息大小（字节）",type:"number",placeholder:"请输入最大消息大小",span:12,tabKey:"websocket",show:t=>t.proxyType===N.WEBSOCKET,defaultValue:32768,tips:"WebSocket单条消息的最大大小限制，超过此大小的消息将被拒绝，防止内存溢出",props:{min:0}},{field:"proxyConfig.enableCompression",label:"启用压缩",type:"switch",span:12,tabKey:"websocket",show:t=>t.proxyType===N.WEBSOCKET,defaultValue:!1,tips:"是否启用WebSocket消息压缩（permessage-deflate）。启用后可以减少网络传输量，但会增加CPU开销"},{field:"proxyConfig.connectTimeout",label:"连接超时（秒）",type:"number",placeholder:"请输入连接超时",span:12,tabKey:"tcp",show:t=>t.proxyType===N.TCP,defaultValue:5,tips:"建立TCP连接的超时时间，超过此时间未建立连接则连接失败",props:{min:1}},{field:"proxyConfig.keepAlive",label:"保持连接",type:"switch",span:12,tabKey:"tcp",show:t=>t.proxyType===N.TCP,defaultValue:!0,tips:"是否启用TCP Keep-Alive机制。启用后会定期发送探测包保持TCP连接活跃，及时发现断开的连接"},{field:"proxyConfig.bufferSize",label:"缓冲区大小（字节）",type:"number",placeholder:"请输入缓冲区大小",span:12,tabKey:"udp",show:t=>t.proxyType===N.UDP,defaultValue:4096,tips:"UDP数据包接收缓冲区大小，影响可以接收的最大UDP数据包大小",props:{min:1}},{field:"customConfig",label:"自定义配置",type:"textarea",placeholder:"{}",span:24,tabKey:"custom",tips:"自定义配置项（JSON格式），用于存储额外的配置参数，可根据实际需求扩展使用",props:{rows:5}},{field:"addTime",label:"创建时间",type:"datetime",span:12,tabKey:"custom",disabled:!0},{field:"addWho",label:"创建人",type:"input",span:12,tabKey:"custom",disabled:!0},{field:"editTime",label:"修改时间",type:"datetime",span:12,tabKey:"custom",disabled:!0},{field:"editWho",label:"修改人",type:"input",span:12,tabKey:"custom",disabled:!0}]};return{moduleId:s,loading:m,instanceList:r,currentPage:y,pageSize:p,totalCount:i,filterKeyword:g,treeData:h,treeMenuConfig:V,proxyFormConfig:A,getInstanceLabel:I,setInstanceList:E,setLoading:x,setCurrentPage:M,setPageSize:F,setTotalCount:e,setFilterKeyword:L,resetPage:l,clearFilter:u}}function St(s){const m=re(),{loading:r,currentPage:y,pageSize:p,filterKeyword:i,setInstanceList:g,setTotalCount:h,setLoading:I,resetPage:E}=s;async function x(){try{I(!0);const M=await ct({activeFlag:"Y",instanceName:i.value.trim()||void 0,pageIndex:y.value,pageSize:p.value});if(J(M)){const F=se(M,[]);g(Array.isArray(F)?F:[]);try{const L=Pe(M);h(L.totalCount||0)}catch(L){console.warn("解析分页信息失败:",L),h(0)}}else m.error(M.errMsg||"获取网关实例列表失败"),g([]),h(0)}catch(M){console.error("加载网关实例失败:",M),m.error("加载网关实例失败"),g([]),h(0)}finally{I(!1)}}return{loadGatewayInstances:x}}function Ct(){const s=re(),m=Tt(),r=St(m),y=_(!1),p=_("create"),i=_(null),g=_(!1),h=_(""),I=fe(m.filterKeyword,()=>{m.resetPage(),r.loadGatewayInstances()});we(()=>{I()});const E=n=>{const c=T=>{if(typeof T=="string"&&T)try{return JSON.parse(T)}catch{return T}return T},o={...n},f=c(n.proxyConfig);f&&typeof f=="object"&&!Array.isArray(f)&&(Object.keys(f).forEach(T=>{o[`proxyConfig.${T}`]=f[T]}),delete o.proxyConfig);const v=c(n.customConfig);if(v&&typeof v=="object")try{o.customConfig=JSON.stringify(v,null,2)}catch{o.customConfig="{}"}else o.customConfig="{}";return o},x=n=>{const c={};Object.keys(n).forEach(f=>{f.startsWith("proxyConfig.")||(c[f]=n[f])});const o={};if(Object.keys(n).forEach(f=>{if(f.startsWith("proxyConfig.")){const v=f.replace("proxyConfig.","");o[v]=n[f]}}),Object.keys(o).length>0?c.proxyConfig=JSON.stringify(o):c.proxyConfig="{}",n.customConfig)if(typeof n.customConfig=="string")try{JSON.parse(n.customConfig),c.customConfig=n.customConfig}catch{c.customConfig="{}"}else typeof n.customConfig=="object"?c.customConfig=JSON.stringify(n.customConfig):c.customConfig="{}";else c.customConfig="{}";return c},M=async()=>{const n=h.value;if(n)try{const c=await dt(n);if(J(c)){const o=se(c,null);o?(i.value=o,p.value="edit"):(i.value=null,p.value="create")}else i.value=null,p.value="create"}catch{i.value=null,p.value="create"}},F=async n=>{h.value=n.gatewayInstanceId,await M(),y.value=!0},L=()=>{if(p.value==="create")return{gatewayInstanceId:h.value,proxyType:"http",configPriority:100,activeFlag:"Y"};if(i.value)return E(i.value)},e=async n=>{if(!n||p.value==="view")return!1;try{g.value=!0;const o={...x(n),tenantId:"default",gatewayInstanceId:h.value||n.gatewayInstanceId};let f=!1;if(p.value==="create"){const v=await ut(o);J(v)?(s.success(B(v,"创建代理配置成功")),f=!0):s.error(B(v,"创建代理配置失败"))}else if(p.value==="edit"&&i.value){const v=await pt({...o,proxyConfigId:i.value.proxyConfigId});J(v)?(s.success(B(v,"更新代理配置成功")),f=!0):s.error(B(v,"更新代理配置失败"))}return f&&await M(),f}catch{return s.error("操作失败"),!1}finally{g.value=!1}};function l({option:n}){return n.instance?P(ee,{size:16,color:"var(--g-primary)",style:{marginRight:"6px",flexShrink:0}},{default:()=>P(be)}):null}function u({option:n}){return P("span",{class:"tree-node-label",style:{display:"inline-block",padding:"1px 4px",borderRadius:"4px",transition:"background-color 0.2s"}},n.label)}function V({option:n}){const c=n;return c.instance?P($,{type:c.instance.healthStatus==="Y"?"success":"warning",size:"small",style:{marginLeft:"8px",flexShrink:0}},{default:()=>c.instance.healthStatus==="Y"?"健康":"异常"}):null}function A(n,c,o){const f=c;f.instance&&o("select",f.instance.gatewayInstanceId,f.instance)}function t({currentPage:n,pageSize:c}){m.setCurrentPage(n),m.setPageSize(c),r.loadGatewayInstances()}function d(){r.loadGatewayInstances()}async function w({code:n,node:c}){if(!c)return;const o=c;if(!o.instance)return;const f=o.instance;switch(n){case"addProxy":await F(f);break}}return{model:m,service:r,proxyFormDialogVisible:y,proxyFormDialogMode:p,currentEditProxy:i,proxySubmitting:g,getProxyFormInitialData:L,renderNodePrefix:l,renderNodeLabel:u,renderNodeSuffix:V,handleTreeSelect:A,handlePageChange:t,handleRefresh:d,handleMenuClick:w,handleProxyFormSubmit:e}}const xt={class:"gateway-instance-tree"},It={class:"instance-tree-header"},Pt={class:"instance-header"},Nt={class:"instance-filter"},_t={class:"instance-tree-container"},kt={key:0,class:"instance-pagination"},Ot=he({name:"GatewayInstanceTree",__name:"GatewayInstanceTree",props:{parentModuleId:{default:"proxy-management"}},emits:["select"],setup(s,{expose:m,emit:r}){const y=s,p=r,i=Ct();return We(()=>{i.service.loadGatewayInstances()}),m({refresh:i.service.loadGatewayInstances,resetPage:i.model.resetPage,clearFilter:i.model.clearFilter}),(g,h)=>(j(),te("div",xt,[O("div",It,[O("div",Pt,[S(a(ee),{size:"20",color:"var(--g-primary)"},{default:C(()=>[S(a(be))]),_:1}),h[3]||(h[3]=O("span",null,"网关实例列表",-1)),h[4]||(h[4]=O("div",{class:"flex-spacer"},null,-1)),S(a(ie),{text:"",size:"small",onClick:a(i).handleRefresh,disabled:a(i).model.loading.value,loading:a(i).model.loading.value},{icon:C(()=>[S(a(ee),{component:a(rt)},null,8,["component"])]),_:1},8,["onClick","disabled","loading"])]),O("div",Nt,[S(a(Se),{value:a(i).model.filterKeyword.value,"onUpdate:value":h[0]||(h[0]=I=>a(i).model.filterKeyword.value=I),placeholder:"搜索实例名称、地址或端口",clearable:"",size:"small"},{prefix:C(()=>[S(a(ee),{component:a(ue)},null,8,["component"])]),_:1},8,["value"])])]),O("div",_t,[S(a(Ge),{show:a(i).model.loading.value},{default:C(()=>[a(i).model.treeData.value.length>0?(j(),oe(a(Ze),{key:0,data:a(i).model.treeData.value,"show-icon":!0,"block-line":!0,"node-height":32,"show-line":!0,ellipsis:!0,"ellipsis-line-clamp":1,"ellipsis-tooltip":!0,"module-id":a(i).model.moduleId,"menu-config":a(i).model.treeMenuConfig,"render-prefix":a(i).renderNodePrefix,"render-label":a(i).renderNodeLabel,"render-suffix":a(i).renderNodeSuffix,onSelect:h[1]||(h[1]=(I,E)=>a(i).handleTreeSelect(I,E,p)),onMenuClick:a(i).handleMenuClick},null,8,["data","module-id","menu-config","render-prefix","render-label","render-suffix","onMenuClick"])):(j(),oe(a(qe),{key:1,description:"暂无可用的网关实例",style:{padding:"40px 0"}},{icon:C(()=>[S(a(ee),{size:"40",color:"var(--g-primary)"},{default:C(()=>[S(a(be))]),_:1})]),_:1}))]),_:1},8,["show"])]),a(i).model.totalCount.value>0?(j(),te("div",kt,[S(a(Ye),{"current-page":a(i).model.currentPage.value,"page-size":a(i).model.pageSize.value,total:a(i).model.totalCount.value,layouts:["PrevPage","NextPage"],align:"center",onPageChange:a(i).handlePageChange},null,8,["current-page","page-size","total","onPageChange"])])):de("",!0),S(xe,{visible:a(i).proxyFormDialogVisible.value,"onUpdate:visible":h[2]||(h[2]=I=>a(i).proxyFormDialogVisible.value=I),mode:a(i).proxyFormDialogMode.value,title:a(i).proxyFormDialogMode.value==="create"?"新增代理配置":a(i).proxyFormDialogMode.value==="edit"?"编辑代理配置":"查看代理配置详情",to:`#${y.parentModuleId}`,"form-fields":a(i).model.proxyFormConfig.fields,"form-tabs":a(i).model.proxyFormConfig.tabs,"initial-data":a(i).getProxyFormInitialData(),"auto-close-on-confirm":!1,"confirm-loading":a(i).proxySubmitting.value,onSubmit:a(i).handleProxyFormSubmit},null,8,["visible","mode","title","to","form-fields","form-tabs","initial-data","confirm-loading","onSubmit"])]))}}),Et=ve(Ot,[["__scopeId","data-v-f8fbd456"]]);function Mt(){const s="hub0022:manageNodes",m=_(!1),r=_([]),y=_();return{moduleId:s,loading:m,nodeList:r,pageInfo:y,searchFormConfig:{fields:[{field:"nodeHost",label:"节点主机",type:"input",placeholder:"请输入节点主机地址",span:6,clearable:!0},{field:"healthStatus",label:"健康状态",type:"select",placeholder:"请选择健康状态",span:6,clearable:!0,options:[{label:"全部",value:""},{label:"健康",value:"Y"},{label:"不健康",value:"N"}]},{field:"activeFlag",label:"在线状态",type:"select",placeholder:"请选择在线状态",span:6,clearable:!0,options:[{label:"全部",value:""},{label:"在线",value:"Y"},{label:"离线",value:"N"}]}],toolbarButtons:[{key:"add",label:"新建节点",icon:Ne,type:"primary",tooltip:"新建服务节点"},{key:"edit",label:"编辑",icon:it,type:"default",tooltip:"编辑选中的服务节点"},{key:"delete",label:"删除",icon:je,type:"error",tooltip:"批量删除选中的服务节点"}],showSearchButton:!0,showResetButton:!0},nodeFormConfig:{tabs:[{key:"basic",label:"基本信息"},{key:"metadata",label:"元数据配置"},{key:"other",label:"其他配置"}],fields:[{field:"serviceNodeId",label:"服务节点ID",type:"input",span:12,tabKey:"basic",primary:!0,show:!1},{field:"nodeId",label:"节点ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"serviceDefinitionId",label:"服务定义ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"tenantId",label:"租户ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"nodeProtocol",label:"节点协议",type:"select",placeholder:"请选择协议",span:12,tabKey:"basic",required:!0,defaultValue:"HTTP",props:{onUpdateValue:(e,l)=>{if(l&&l.nodeHost&&l.nodePort!==void 0&&e){const u=e.toLowerCase();l.nodeUrl=`${u}://${l.nodeHost}:${l.nodePort}`}}},options:[{label:"HTTP",value:"HTTP"},{label:"HTTPS",value:"HTTPS"}],rules:[{required:!0,message:"请选择节点协议",trigger:["blur","change"]}]},{field:"nodeHost",label:"节点主机",type:"input",placeholder:"请输入主机地址",span:12,tabKey:"basic",required:!0,props:{onUpdateValue:(e,l)=>{if(l&&e&&l.nodePort!==void 0&&l.nodeProtocol){const u=l.nodeProtocol.toLowerCase();l.nodeUrl=`${u}://${e}:${l.nodePort}`}}},rules:[{required:!0,message:"请输入节点主机地址",trigger:["blur","input"]},{pattern:/^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$|^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])$/,message:"请输入有效的IP地址或域名",trigger:["blur","input"]}]},{field:"nodePort",label:"节点端口",type:"number",placeholder:"请输入端口",span:12,tabKey:"basic",required:!0,props:{min:1,max:65535,onUpdateValue:(e,l)=>{if(l&&l.nodeHost&&e!==void 0&&l.nodeProtocol){const u=l.nodeProtocol.toLowerCase();l.nodeUrl=`${u}://${l.nodeHost}:${e}`}}},rules:[{required:!0,type:"number",message:"请输入节点端口",trigger:["blur","change"]}]},{field:"nodeWeight",label:"节点权重",type:"number",placeholder:"权重值",span:12,tabKey:"basic",required:!0,defaultValue:100,props:{min:1,max:1e3},rules:[{required:!0,type:"number",message:"请输入节点权重",trigger:["blur","change"]}]},{field:"nodeUrl",label:"节点URL",type:"input",placeholder:"输入完整URL或由上方字段自动生成",span:24,tabKey:"basic",required:!0,tips:"支持直接输入完整URL(如 https://www.example.com)，将自动解析为协议、主机和端口",props:{onUpdateValue:(e,l)=>{if(l&&e&&(e.startsWith("http://")||e.startsWith("https://")))try{const u=new URL(e);l.nodeProtocol=u.protocol==="https:"?"HTTPS":"HTTP",l.nodeHost=u.hostname,u.port?l.nodePort=parseInt(u.port,10):l.nodePort=u.protocol==="https:"?443:80}catch(u){console.warn("URL解析失败:",u)}}},rules:[{required:!0,message:"请输入节点URL",trigger:["blur","input"]},{validator:(e,l)=>{if(l&&(l.startsWith("http://")||l.startsWith("https://")))try{return new URL(l),!0}catch{return new Error("请输入有效的URL格式")}return!0},trigger:["blur","input"]}]},{field:"healthStatus",label:"健康状态",type:"switch",span:12,tabKey:"basic",defaultValue:"Y",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"activeFlag",label:"在线状态",type:"switch",span:12,tabKey:"basic",defaultValue:"Y",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"noteText",label:"备注信息",type:"textarea",placeholder:"请输入备注信息",span:24,tabKey:"basic",props:{rows:4}},{field:"nodeMetadata",label:"节点元数据",type:"textarea",placeholder:"{}",span:24,tabKey:"metadata",props:{rows:8},rules:[{validator:(e,l)=>{if(l&&typeof l=="string"&&l.trim())try{return JSON.parse(l),!0}catch{return new Error("请输入有效的JSON格式")}return!0},trigger:["blur"]}]},{field:"addTime",label:"创建时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"addWho",label:"创建人",type:"input",span:12,tabKey:"other",disabled:!0},{field:"editTime",label:"修改时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"editWho",label:"修改人",type:"input",span:12,tabKey:"other",disabled:!0}]},gridConfig:{columns:[{field:"serviceNodeId",title:"服务节点ID",visible:!1},{field:"tenantId",title:"租户ID",visible:!1},{field:"serviceDefinitionId",title:"服务定义ID",visible:!1},{field:"nodeId",title:"节点ID",sortable:!0,align:"center",showOverflow:!0,width:150},{field:"nodeUrl",title:"节点地址",sortable:!0,align:"left",showOverflow:!0,width:250},{field:"nodeHost",title:"节点主机",sortable:!0,align:"center",showOverflow:!0,width:150},{field:"nodePort",title:"节点端口",sortable:!0,align:"center",width:100},{field:"nodeProtocol",title:"协议",align:"center",width:80,slots:{default:"nodeProtocol"}},{field:"nodeWeight",title:"权重",align:"center",width:80},{field:"healthStatus",title:"健康状态",align:"center",width:100,slots:{default:"healthStatus"}},{field:"activeFlag",title:"在线状态",align:"center",width:100,slots:{default:"activeFlag"}},{field:"lastHealthCheckTime",title:"最后检查时间",align:"center",showOverflow:!0,formatter:({cellValue:e})=>e?pe(e,"YYYY-MM-DD HH:mm:ss"):"-",width:180},{field:"noteText",title:"备注",align:"left",showOverflow:!0,width:150},{field:"addTime",title:"创建时间",sortable:!0,align:"center",showOverflow:!0,formatter:({cellValue:e})=>e?pe(e,"YYYY-MM-DD HH:mm:ss"):"",width:180},{field:"addWho",title:"创建人",align:"center",showOverflow:!0,width:120},{field:"editTime",title:"修改时间",sortable:!0,align:"center",showOverflow:!0,formatter:({cellValue:e})=>e?pe(e,"YYYY-MM-DD HH:mm:ss"):"",width:180},{field:"editWho",title:"修改人",align:"center",showOverflow:!0,width:120}],showCheckbox:!0,paginationConfig:{show:!0,pageInfo:y,align:"right"},menuConfig:{enabled:!0,showCopyRow:!0,showCopyCell:!0,customMenus:[{code:"edit",name:"编辑",prefixIcon:"vxe-icon-edit"},{code:"delete",name:"删除",prefixIcon:"vxe-icon-delete"}]},height:"100%",rowId:"serviceNodeId"},resetPagination:()=>{y.value=void 0},updatePagination:e=>{y.value?Object.assign(y.value,e):y.value=e},setNodeList:e=>{r.value=e},addNodeToList:e=>{r.value.push(e)},updateNodeInList:e=>{const l=r.value.findIndex(u=>u.serviceNodeId===e.serviceNodeId);l>=0&&(r.value[l]=e)},removeNodeFromList:e=>{const l=r.value.findIndex(u=>u.serviceNodeId===e);l>=0&&r.value.splice(l,1)},removeNodesFromList:e=>{r.value=r.value.filter(l=>!e.includes(l.serviceNodeId))}}}var Je=(s=>(s[s.OFFLINE=0]="OFFLINE",s[s.ONLINE=1]="ONLINE",s[s.MAINTENANCE=2]="MAINTENANCE",s))(Je||{});function Dt(s,m){const r=re(),y=Ue(),p=Mt(),{loading:i,nodeList:g,pageInfo:h,setNodeList:I,updatePagination:E,addNodeToList:x,updateNodeInList:M,removeNodeFromList:F,removeNodesFromList:L}=p,e=async c=>{var o,f,v;i.value=!0;try{let T=c;!T&&((o=m==null?void 0:m.value)!=null&&o.getFormData)&&(T=m.value.getFormData()||{});const K=T?Object.fromEntries(Object.entries(T).filter(([,G])=>G!==""&&G!==null&&G!==void 0)):{},q=(s==null?void 0:s.value)||K.serviceDefinitionId;if(!q){r.error("serviceDefinitionId不能为空");return}const ae={serviceDefinitionId:q,...K,...ze((f=h.value)==null?void 0:f.pageIndex,(v=h.value)==null?void 0:v.pageSize)},Q=await vt(ae);if(J(Q)){const G=se(Q,[]);I(Array.isArray(G)?G:[]);const b=Pe(Q);b&&Object.keys(b).length>0&&E(b)}else r.error(B(Q,"查询服务节点列表失败"))}catch{r.error("加载服务节点列表失败")}finally{i.value=!1}};return{model:p,loadNodeList:e,handleSearch:async c=>{p.resetPagination(),await e(c)},handleReset:async()=>{p.resetPagination(),await e()},handlePageChange:async({currentPage:c,pageSize:o})=>{E({pageIndex:c,pageSize:o}),await e()},handleRefresh:async()=>{await e()},addNode:async c=>{i.value=!0;try{const o=await yt(c);return J(o)?(r.success(B(o,"新增服务节点成功")),await e(),!0):(r.error(B(o,"新增服务节点失败")),!1)}catch{return r.error("新增服务节点失败"),!1}finally{i.value=!1}},editNode:async c=>{i.value=!0;try{const o=await gt(c);return J(o)?(r.success(B(o,"编辑服务节点成功")),await e(),!0):(r.error(B(o,"编辑服务节点失败")),!1)}catch{return r.error("编辑服务节点失败"),!1}finally{i.value=!1}},deleteNode:async c=>{const o=g.value.find(v=>v.serviceNodeId===c);if(!o)return r.error("未找到要删除的服务节点"),!1;if(!await y.warning({title:"确认删除",subtitle:"此操作不可恢复，请谨慎操作",content:`确定要删除服务节点 "${o.nodeUrl||o.nodeHost||c}" 吗？`,icon:me,headerStyle:"gradient",positiveText:"确定删除",negativeText:"取消",width:500}))return!1;i.value=!0;try{const v=await bt(c,"default");return J(v)?(r.success(B(v,"删除服务节点成功")),F(c),g.value.length===0&&h.value&&h.value.pageIndex>1?(E({pageIndex:h.value.pageIndex-1}),await e()):await e(),!0):(r.error(B(v,"删除服务节点失败")),!1)}catch{return r.error("删除服务节点失败"),!1}finally{i.value=!1}},batchDeleteNodes:async c=>{if(!await y.warning({title:"确认批量删除",subtitle:"此操作不可恢复，请谨慎操作",content:`确定要删除选中的 ${c.length} 个服务节点吗？`,icon:me,headerStyle:"gradient",positiveText:"确定删除",negativeText:"取消",width:500}))return!1;i.value=!0;try{const f=await mt(c);return J(f)?(r.success(B(f,"批量删除服务节点成功")),L(c),await e(),!0):(r.error(B(f,"批量删除服务节点失败")),!1)}catch{return r.error("批量删除服务节点失败"),!1}finally{i.value=!1}}}}function Kt(s,m,r){const y=re(),p=Dt(m,r),i=_(!1),g=_("create"),h=_(null),I=t=>{const d=n=>{if(typeof n=="string"&&n)try{return JSON.parse(n)}catch{return n}return n},w={...t};if(t.nodeMetadata){const n=d(t.nodeMetadata);if(n&&typeof n=="object")try{w.nodeMetadata=JSON.stringify(n,null,2)}catch{w.nodeMetadata="{}"}else w.nodeMetadata=t.nodeMetadata||"{}"}else w.nodeMetadata="{}";return w},E=t=>{const d={...t};if(t.nodeMetadata)if(typeof t.nodeMetadata=="string")try{JSON.parse(t.nodeMetadata),d.nodeMetadata=t.nodeMetadata}catch{d.nodeMetadata="{}"}else typeof t.nodeMetadata=="object"?d.nodeMetadata=JSON.stringify(t.nodeMetadata):d.nodeMetadata="{}";else d.nodeMetadata="{}";return t.nodePort!==void 0&&(d.nodePort=Number(t.nodePort)),t.nodeWeight!==void 0&&(d.nodeWeight=Number(t.nodeWeight)),t.nodeStatus!==void 0&&(d.nodeStatus=Number(t.nodeStatus)),d},x=()=>{g.value="create",h.value=null,i.value=!0},M=async t=>{if(t.serviceNodeId)try{const d=await Ve(t.serviceNodeId,"default");if(J(d)){const w=se(d,null);if(w){g.value="edit",h.value=I(w),i.value=!0;return}}}catch{}g.value="edit",h.value=I(t),i.value=!0},F=async t=>{if(t.serviceNodeId)try{const d=await Ve(t.serviceNodeId,"default");if(J(d)){const w=se(d,null);if(w){g.value="view",h.value=I(w),i.value=!0;return}}}catch{}g.value="view",h.value=I(t),i.value=!0},L=()=>{i.value=!1,h.value=null},e=()=>{if(g.value==="create")return{serviceDefinitionId:(m==null?void 0:m.value)||"",nodeUrl:"http://192.168.1.0:8080",nodeHost:"192.168.1.0",nodePort:8080,nodeProtocol:"HTTP",nodeWeight:100,healthStatus:"Y",activeFlag:"Y",nodeStatus:Je.ONLINE,nodeMetadata:"{}",noteText:""};if(h.value)return h.value},l=async t=>{var d;if(!t||g.value==="view")return!1;try{const w=E(t);if(!w.serviceDefinitionId&&(m!=null&&m.value)&&(w.serviceDefinitionId=m.value),!w.serviceDefinitionId)return y.error("服务定义ID不能为空"),!1;let n=!1;return g.value==="create"?n=await p.addNode(w):g.value==="edit"&&((d=h.value)!=null&&d.serviceNodeId)&&(w.serviceNodeId=h.value.serviceNodeId,n=await p.editNode(w)),n&&L(),n}catch{return y.error("操作失败"),!1}},u=async(t,d)=>{var w,n,c,o;switch(t){case"add":x();break;case"edit":{if(!(s!=null&&s.value)){y.warning("Grid 引用未设置");return}const f=(n=(w=s.value).getCurrentRecord)==null?void 0:n.call(w);if(!f){y.warning("请先点击选择要编辑的服务节点");return}await M(f);break}case"delete":{if(!(s!=null&&s.value)){y.warning("Grid 引用未设置");return}const f=(o=(c=s.value).getCurrentRecord)==null?void 0:o.call(c);if(!f){y.warning("请先点击选择要删除的服务节点");return}await p.deleteNode(f.serviceNodeId);break}case"search":{await A(d);break}}},V=async({code:t,row:d})=>{if(d)switch(t){case"edit":await M(d);break;case"delete":await p.deleteNode(d.serviceNodeId);break}},A=async t=>{await p.handleSearch(t)};return{service:p,formDialogVisible:i,formDialogMode:g,currentEditNode:h,getFormInitialData:e,openAddDialog:x,openEditDialog:M,openViewDialog:F,closeFormDialog:L,handleFormSubmit:l,handleToolbarClick:u,handleMenuClick:V,handleSearch:A}}const Lt={class:"service-node-list-modal",id:"hub0022-service-node-list"},Ft=he({name:"ServiceNodeListModal",__name:"ServiceNodeListModal",props:{visible:{type:Boolean,default:!1},title:{default:"服务节点管理"},width:{default:1200},to:{type:[String,Boolean],default:void 0},serviceDefinitionId:{default:void 0}},emits:["update:visible","close","refresh"],setup(s,{emit:m}){const r=s,y=m,p=_(),i=_(),g=_(r.visible),h=fe(()=>r.visible,d=>{g.value=d}),I=_(r.serviceDefinitionId),E=fe(()=>r.serviceDefinitionId,d=>{I.value=d,g.value&&d&&x.handleRefresh()});we(()=>{h(),E()});const{service:x,formDialogVisible:M,formDialogMode:F,getFormInitialData:L,handleFormSubmit:e,handleToolbarClick:l,handleMenuClick:u,handleSearch:V}=Kt(i,I,p),A=d=>{g.value=d,y("update:visible",d),d?(y("refresh"),I.value&&x.handleRefresh()):y("close")},t=()=>{g.value||(M.value=!1,F.value="create",x.model.nodeList.value=[],x.model.resetPagination())};return(d,w)=>(j(),oe(a($e),{visible:g.value,title:r.title||"服务节点管理",width:r.width||1200,to:r.to,"show-footer":!1,"onUpdate:visible":A,onAfterLeave:t},{default:C(()=>[O("div",Lt,[S(a(Ce),{direction:"vertical","no-resize":!0},{1:C(()=>[S(Re,ge({ref_key:"searchFormRef",ref:p,"module-id":a(x).model.moduleId},a(x).model.searchFormConfig,{onSearch:a(V),onToolbarClick:a(l)}),null,16,["module-id","onSearch","onToolbarClick"])]),2:C(()=>[S(a(Be),ge({ref_key:"gridRef",ref:i,"module-id":a(x).model.moduleId,data:a(x).model.nodeList,loading:a(x).model.loading},a(x).model.gridConfig,{onPageChange:a(x).handlePageChange,onMenuClick:a(u)}),{nodeProtocol:C(({row:n})=>[S(a($),{type:n.nodeProtocol==="HTTPS"?"success":"info",size:"small"},{default:C(()=>[W(R(n.nodeProtocol),1)]),_:2},1032,["type"])]),healthStatus:C(({row:n})=>[S(a($),{type:n.healthStatus==="Y"?"success":"error",size:"small"},{default:C(()=>[W(R(n.healthStatus==="Y"?"健康":"不健康"),1)]),_:2},1032,["type"])]),nodeStatus:C(({row:n})=>[S(a($),{type:n.nodeStatus===1?"success":n.nodeStatus===0?"error":"warning",size:"small"},{default:C(()=>[W(R(n.nodeStatus===1?"在线":n.nodeStatus===0?"下线":"维护"),1)]),_:2},1032,["type"])]),activeFlag:C(({row:n})=>[S(a($),{type:n.activeFlag==="Y"?"success":"default",size:"small"},{default:C(()=>[W(R(n.activeFlag==="Y"?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1},16,["module-id","data","loading","onPageChange","onMenuClick"])]),_:1}),S(xe,{visible:a(M),"onUpdate:visible":w[0]||(w[0]=n=>ye(M)?M.value=n:null),mode:a(F),title:a(F)==="create"?"新增服务节点":a(F)==="edit"?"编辑服务节点":"查看服务节点详情",to:"#hub0022-service-node-list","form-fields":a(x).model.nodeFormConfig.fields,"form-tabs":a(x).model.nodeFormConfig.tabs,"initial-data":a(L)(),"auto-close-on-confirm":!1,"confirm-loading":a(x).model.loading.value,onSubmit:a(e)},null,8,["visible","mode","title","form-fields","form-tabs","initial-data","confirm-loading","onSubmit"])])]),_:1},8,["visible","title","width","to"]))}}),Ht=ve(Ft,[["__scopeId","data-v-f9b087ea"]]),Vt={class:"service-search-section"},At={class:"search-form"},Yt={class:"search-row"},zt={class:"search-actions"},Bt={key:0,class:"selected-service-section"},Rt={class:"selected-service-card"},$t={class:"service-info"},Ut={class:"service-name"},Wt={class:"service-meta"},Gt={class:"service-path"},qt={class:"services-list-section"},jt={class:"section-header"},Jt={key:0,class:"section-info"},Xt={class:"service-cards-container"},Zt=["onClick"],Qt={class:"card-header"},ea={class:"card-title-row"},ta={class:"service-name"},aa={class:"service-status"},la={class:"card-content"},ra={class:"service-info-grid"},ia={class:"info-item"},sa={class:"info-item"},oa={class:"info-item"},na={class:"info-value"},ca={class:"info-item"},da={class:"info-value"},ua={key:0,class:"pagination-wrapper"},pa=he({__name:"ServiceRegistrySelector",props:{show:{type:Boolean},currentService:{}},emits:["update:show","select"],setup(s,{emit:m}){const r=s,y=m,p=re(),i=_(!1),g=_([]),h=_(null),I=_(""),E=_(""),x=_(void 0),M=Ie({get:()=>r.show,set:n=>y("update:show",n)}),F=fe(()=>r.show,n=>{n?(h.value=r.currentService||null,L(),e()):(h.value=null,I.value="",E.value="",L())});we(()=>{F()});function L(){x.value=void 0}async function e(n={}){var c,o,f;try{i.value=!0;const v={tenantId:"default",pageIndex:((c=x.value)==null?void 0:c.pageIndex)||1,pageSize:((o=x.value)==null?void 0:o.pageSize)||10,...n},T=await wt(v);if(J(T)){const K=se(T,[]);g.value=Array.isArray(K)?K:[];try{const q=Pe(T);x.value=q}catch(q){console.warn("解析分页信息失败:",q),x.value={pageIndex:v.pageIndex||1,pageSize:v.pageSize||10,totalCount:(K==null?void 0:K.length)||0,totalPageIndex:Math.ceil(((K==null?void 0:K.length)||0)/(v.pageSize||10)),baseData:"",curPageCount:(K==null?void 0:K.length)||0,dbsId:"",mainKey:"",orderByList:"",otherData:"",paramObjectsJson:"",timeTypeFieldNames:""}}console.log("获取服务列表成功:",g.value.length,"总数:",(f=x.value)==null?void 0:f.totalCount)}else{const K=B(T,"获取服务列表失败");p.error(K),g.value=[],x.value=void 0}}catch(v){console.error("获取服务列表失败:",v),p.error("获取服务列表失败: "+((v==null?void 0:v.message)||"未知错误")),g.value=[],x.value=void 0}finally{i.value=!1}}function l({currentPage:n,pageSize:c}){e({pageIndex:n,pageSize:c})}function u(){const n={};I.value&&(n.serviceName=I.value),E.value&&(n.groupName=E.value),L(),e({...n,pageIndex:1,pageSize:10})}function V(){I.value="",E.value="",L(),e({pageIndex:1,pageSize:10})}function A(n){h.value=n,console.log("选择服务:",n.serviceName)}function t(){h.value=null}function d(){if(!h.value){p.warning("请选择一个服务");return}y("select",h.value),p.success(`已选择服务：${h.value.serviceName}`),w()}function w(){y("update:show",!1)}return(n,c)=>(j(),oe(a($e),{visible:M.value,"onUpdate:visible":c[3]||(c[3]=o=>M.value=o),title:"选择注册服务","header-icon":a(ue),width:1200,"mask-closable":!1,"show-fullscreen-toggle":!1,to:"#hub0022-service-definition-list",onClose:w,onCancel:w,onConfirm:d,"show-confirm":!0,"show-cancel":!0,"confirm-text":"确认选择","cancel-text":"取消"},{default:C(()=>[O("div",Vt,[O("div",At,[O("div",Yt,[S(a(Se),{value:I.value,"onUpdate:value":c[0]||(c[0]=o=>I.value=o),placeholder:"搜索服务名称",clearable:"",onClear:u,onKeyup:De(u,["enter"]),style:{width:"240px"}},{prefix:C(()=>[S(a(ee),null,{default:C(()=>[S(a(ue))]),_:1})]),_:1},8,["value"]),S(a(Se),{value:E.value,"onUpdate:value":c[1]||(c[1]=o=>E.value=o),placeholder:"搜索分组名称",clearable:"",onClear:u,onKeyup:De(u,["enter"]),style:{width:"240px"}},{prefix:C(()=>[S(a(ee),null,{default:C(()=>[S(a(ue))]),_:1})]),_:1},8,["value"]),O("div",zt,[S(a(ie),{onClick:u,type:"primary"},{default:C(()=>c[4]||(c[4]=[W(" 搜索 ")])),_:1}),S(a(ie),{onClick:V},{default:C(()=>c[5]||(c[5]=[W(" 重置 ")])),_:1})])])])]),h.value?(j(),te("div",Bt,[c[7]||(c[7]=O("div",{class:"section-title"},"当前选择的服务",-1)),O("div",Rt,[O("div",$t,[O("div",Ut,R(h.value.serviceName),1),O("div",Wt,[S(a($),{type:"info",size:"small"},{default:C(()=>[W(R(h.value.groupName),1)]),_:1}),S(a($),{type:"success",size:"small"},{default:C(()=>[W(R(h.value.protocolType),1)]),_:1}),O("span",Gt,R(h.value.contextPath),1)])]),S(a(ie),{text:"",type:"error",onClick:t},{icon:C(()=>[S(a(ee),null,{default:C(()=>[S(a(st))]),_:1})]),default:C(()=>[c[6]||(c[6]=W(" 取消选择 "))]),_:1})])])):de("",!0),O("div",qt,[O("div",jt,[c[8]||(c[8]=O("div",{class:"section-title"},"可选择的服务",-1)),x.value&&x.value.totalCount>0?(j(),te("div",Jt," 共 "+R(x.value.totalCount)+" 个服务 ",1)):de("",!0)]),S(a(Ge),{show:i.value},{default:C(()=>[g.value.length>0?(j(),te(Ke,{key:0},[O("div",Xt,[(j(!0),te(Ke,null,et(g.value,o=>{var f,v;return j(),te("div",{key:o.serviceName,class:tt(["service-card",{selected:((f=h.value)==null?void 0:f.serviceName)===o.serviceName}]),onClick:T=>A(o)},[O("div",Qt,[O("div",ea,[S(a(ot),{checked:((v=h.value)==null?void 0:v.serviceName)===o.serviceName,onClick:c[2]||(c[2]=at(()=>{},["stop"])),class:"card-radio"},null,8,["checked"]),O("div",ta,R(o.serviceName),1),O("div",aa,[S(a($),{type:o.activeFlag==="Y"?"success":"error",size:"small",round:""},{default:C(()=>[W(R(o.activeFlag==="Y"?"启用":"禁用"),1)]),_:2},1032,["type"])])])]),O("div",la,[O("div",ra,[O("div",ia,[c[9]||(c[9]=O("span",{class:"info-label"},"分组",-1)),S(a($),{type:"info",size:"small"},{default:C(()=>[W(R(o.groupName||"DEFAULT"),1)]),_:2},1024)]),O("div",sa,[c[10]||(c[10]=O("span",{class:"info-label"},"协议",-1)),S(a($),{type:"primary",size:"small"},{default:C(()=>[W(R(o.protocolType),1)]),_:2},1024)]),O("div",oa,[c[11]||(c[11]=O("span",{class:"info-label"},"路径",-1)),O("span",na,R(o.contextPath||"/"),1)]),O("div",ca,[c[12]||(c[12]=O("span",{class:"info-label"},"实例数",-1)),O("span",da,R(o.instances?o.instances.length:"0"),1)])])])],10,Zt)}),128))]),x.value&&x.value.totalCount>0?(j(),te("div",ua,[S(a(Ye),{"page-info":x.value,"page-sizes":[10,20,50],onPageChange:l},null,8,["page-info"])])):de("",!0)],64)):i.value?de("",!0):(j(),oe(a(qe),{key:1,description:"暂无可用的注册服务",style:{padding:"40px 0"}}))]),_:1},8,["show"])])]),_:1},8,["visible","header-icon"]))}}),fa=ve(pa,[["__scopeId","data-v-6566e8b1"]]);function ha(){const s="hub0022",m=_(!1),r=_([]),y=_(),p={fields:[{field:"serviceName",label:"服务名称",type:"input",placeholder:"请输入服务名称",span:6,clearable:!0},{field:"serviceType",label:"服务类型",type:"select",placeholder:"请选择服务类型",span:6,clearable:!0,options:[{label:"静态配置",value:H.STATIC},{label:"服务发现",value:H.DISCOVERY}]},{field:"loadBalanceStrategy",label:"负载均衡策略",type:"select",placeholder:"请选择负载均衡策略",span:6,clearable:!0,options:[{label:"轮询算法",value:U.ROUND_ROBIN},{label:"随机算法",value:U.RANDOM},{label:"IP哈希算法",value:U.IP_HASH},{label:"最少连接算法",value:U.LEAST_CONN},{label:"加权轮询算法",value:U.WEIGHTED_ROUND_ROBIN},{label:"一致性哈希算法",value:U.CONSISTENT_HASH}]},{field:"activeFlag",label:"状态",type:"select",placeholder:"请选择状态",span:6,options:[{label:"全部",value:""},{label:"启用",value:"Y"},{label:"禁用",value:"N"}]}],toolbarButtons:[{key:"add",label:"新增服务",icon:Ne,type:"primary",tooltip:"新增服务定义"},{key:"delete",label:"删除",icon:je,type:"error",tooltip:"批量删除选中的服务定义"},{key:"manageNodes",label:"节点管理",icon:lt,type:"default",tooltip:"管理服务节点"}],showSearchButton:!0,showResetButton:!0},i={tabs:[{key:"basic",label:"基本信息"},{key:"loadbalance",label:"负载均衡",show:e=>e.serviceType===H.STATIC},{key:"health",label:"健康检查",show:e=>e.serviceType===H.STATIC},{key:"discovery",label:"服务发现",show:e=>e.serviceType===H.DISCOVERY},{key:"other",label:"其他配置"}],fields:[{field:"serviceDefinitionId",label:"服务定义ID",type:"input",span:12,tabKey:"basic",primary:!0,show:!1},{field:"tenantId",label:"租户ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"proxyConfigId",label:"代理配置ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"serviceName",label:"服务名称",type:"input",placeholder:"请输入服务名称",span:12,tabKey:"basic",required:!0,tips:"服务的唯一标识名称，用于区分不同的后端服务，长度2-50个字符",rules:[{required:!0,message:"请输入服务名称",trigger:["blur","input"]},{min:2,max:50,message:"服务名称长度在2-50个字符",trigger:["blur","input"]}]},{field:"serviceType",label:"服务类型",type:"select",placeholder:"请选择服务类型",span:12,tabKey:"basic",required:!0,defaultValue:H.STATIC,tips:"静态配置：手动配置服务节点地址；服务发现：从服务注册中心自动发现服务实例",options:[{label:"静态配置",value:H.STATIC},{label:"服务发现",value:H.DISCOVERY}],rules:[{required:!0,message:"请选择服务类型",trigger:["blur","change"],validator:(e,l)=>l==null||l===""?new Error("请选择服务类型"):typeof l=="number"&&(l===0||l===1)?!0:new Error("请选择有效的服务类型")}]},{field:"serviceDesc",label:"服务描述",type:"textarea",placeholder:"请输入服务描述",span:24,tabKey:"basic",tips:"服务的详细描述信息，用于说明服务的用途和功能",props:{rows:3}},{field:"loadBalanceStrategy",label:"负载均衡策略",type:"select",placeholder:"请选择负载均衡策略",span:12,tabKey:"loadbalance",required:!0,show:e=>e.serviceType===H.STATIC,defaultValue:U.ROUND_ROBIN,tips:"轮询：按顺序依次分发请求；随机：随机选择节点；IP哈希：根据客户端IP哈希选择节点；最少连接：选择连接数最少的节点；加权轮询：根据节点权重轮询；一致性哈希：保证相同请求路由到同一节点",options:[{label:"轮询算法",value:U.ROUND_ROBIN},{label:"随机算法",value:U.RANDOM},{label:"IP哈希算法",value:U.IP_HASH},{label:"最少连接算法",value:U.LEAST_CONN},{label:"加权轮询算法",value:U.WEIGHTED_ROUND_ROBIN},{label:"一致性哈希算法",value:U.CONSISTENT_HASH}],rules:[{required:!0,message:"请选择负载均衡策略",trigger:["blur","change"],validator:(e,l,u)=>u.serviceType===H.STATIC&&(l==null||l==="")?new Error("请选择负载均衡策略"):!0}]},{field:"sessionAffinity",label:"会话亲和性",type:"switch",span:12,tabKey:"loadbalance",show:e=>e.serviceType===H.STATIC,defaultValue:"N",tips:"启用后，同一客户端的请求会尽量路由到同一个后端节点，保证会话状态的一致性",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"stickySession",label:"粘性会话",type:"switch",span:12,tabKey:"loadbalance",show:e=>e.serviceType===H.STATIC,defaultValue:"N",tips:"启用后，通过Cookie等方式强制将同一会话的请求路由到固定的后端节点",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"maxRetries",label:"最大重试次数",type:"number",placeholder:"3",span:12,tabKey:"loadbalance",show:e=>e.serviceType===H.STATIC,defaultValue:3,tips:"当请求失败时，最多重试的次数。范围0-10，0表示不重试",props:{min:0,max:10},rules:[{required:!0,message:"请输入最大重试次数",trigger:["blur","change"],validator:(e,l)=>{if(l==null||l==="")return new Error("请输入最大重试次数");const u=Number(l);return isNaN(u)||u<0||u>10?new Error("重试次数必须在0-10之间"):!0}}]},{field:"retryTimeoutMs",label:"重试超时时间(ms)",type:"number",placeholder:"5000",span:12,tabKey:"loadbalance",show:e=>e.serviceType===H.STATIC,defaultValue:5e3,tips:"每次重试请求的超时时间（毫秒）。范围100-60000ms",props:{min:100,max:6e4},rules:[{required:!0,message:"请输入重试超时时间",trigger:["blur","change"],validator:(e,l)=>{if(l==null||l==="")return new Error("请输入重试超时时间");const u=Number(l);return isNaN(u)||u<100||u>6e4?new Error("超时时间必须在100-60000毫秒之间"):!0}}]},{field:"enableCircuitBreaker",label:"启用熔断器",type:"switch",span:12,tabKey:"loadbalance",show:e=>e.serviceType===H.STATIC,defaultValue:"N",tips:"启用后，当服务节点故障率过高时自动熔断，避免大量请求打到故障节点",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"healthCheckEnabled",label:"启用健康检查",type:"switch",span:24,tabKey:"health",show:e=>e.serviceType===H.STATIC,defaultValue:"N",tips:"启用后，网关会定期检查后端节点的健康状态，自动剔除不健康的节点",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"healthCheckPath",label:"检查路径",type:"input",placeholder:"/health",span:12,tabKey:"health",show:e=>e.serviceType===H.STATIC&&e.healthCheckEnabled==="Y",defaultValue:"/health",tips:"健康检查请求的URL路径，通常是后端服务提供的健康检查接口",rules:[{required:!0,message:"请输入健康检查路径",trigger:["blur","input"],validator:(e,l,u)=>u.healthCheckEnabled==="Y"&&(!l||l.trim()==="")?new Error("请输入健康检查路径"):!0}]},{field:"healthCheckMethod",label:"检查方法",type:"select",placeholder:"请选择检查方法",span:12,tabKey:"health",show:e=>e.serviceType===H.STATIC&&e.healthCheckEnabled==="Y",defaultValue:"GET",tips:"健康检查使用的HTTP方法，通常使用GET或HEAD方法",options:[{label:"GET",value:"GET"},{label:"POST",value:"POST"},{label:"HEAD",value:"HEAD"}],rules:[{required:!0,message:"请选择健康检查方法",trigger:["blur","change"],validator:(e,l,u)=>u.healthCheckEnabled==="Y"&&(!l||l==="")?new Error("请选择健康检查方法"):!0}]},{field:"healthCheckIntervalSeconds",label:"检查间隔(秒)",type:"number",placeholder:"30",span:12,tabKey:"health",show:e=>e.serviceType===H.STATIC&&e.healthCheckEnabled==="Y",defaultValue:30,tips:"两次健康检查之间的时间间隔（秒）。范围1-300秒",props:{min:1,max:300},rules:[{required:!0,message:"请输入检查间隔",trigger:["blur","change"],validator:(e,l,u)=>u.healthCheckEnabled==="Y"&&(l==null||l==="")?new Error("请输入检查间隔"):!0}]},{field:"healthCheckTimeoutMs",label:"检查超时(ms)",type:"number",placeholder:"5000",span:12,tabKey:"health",show:e=>e.serviceType===H.STATIC&&e.healthCheckEnabled==="Y",defaultValue:5e3,tips:"健康检查请求的超时时间（毫秒），超时则视为检查失败。范围100-30000ms",props:{min:100,max:3e4},rules:[{required:!0,message:"请输入检查超时",trigger:["blur","change"],validator:(e,l,u)=>u.healthCheckEnabled==="Y"&&(l==null||l==="")?new Error("请输入检查超时"):!0}]},{field:"healthyThreshold",label:"健康阈值",type:"number",placeholder:"2",span:12,tabKey:"health",show:e=>e.serviceType===H.STATIC&&e.healthCheckEnabled==="Y",defaultValue:2,tips:"连续成功检查次数达到此值时，节点从 unhealthy 转为 healthy。范围1-10",props:{min:1,max:10},rules:[{required:!0,message:"请输入健康阈值",trigger:["blur","change"],validator:(e,l,u)=>u.healthCheckEnabled==="Y"&&(l==null||l==="")?new Error("请输入健康阈值"):!0}]},{field:"unhealthyThreshold",label:"不健康阈值",type:"number",placeholder:"3",span:12,tabKey:"health",show:e=>e.serviceType===H.STATIC&&e.healthCheckEnabled==="Y",defaultValue:3,tips:"连续失败检查次数达到此值时，节点从 healthy 转为 unhealthy。范围1-10",props:{min:1,max:10},rules:[{required:!0,message:"请输入不健康阈值",trigger:["blur","change"],validator:(e,l,u)=>u.healthCheckEnabled==="Y"&&(l==null||l==="")?new Error("请输入不健康阈值"):!0}]},{field:"expectedStatusCodes",label:"期望状态码",type:"input",placeholder:"200,201,204",span:24,tabKey:"health",show:e=>e.serviceType===H.STATIC&&e.healthCheckEnabled==="Y",defaultValue:"200",tips:"健康检查视为成功的HTTP状态码，支持逗号分隔多个值（如：200,201,204）或JSON数组格式",rules:[{required:!0,message:"请输入期望状态码",trigger:["blur","input"],validator:(e,l,u)=>u.healthCheckEnabled==="Y"&&(!l||l.trim()==="")?new Error("请输入期望状态码"):!0}]},{field:"discoveryType",label:"发现类型",type:"select",placeholder:"请选择服务发现类型",span:12,tabKey:"discovery",show:e=>e.serviceType===H.DISCOVERY,disabled:!0,defaultValue:"REGISTRY",tips:"服务发现类型，当前仅支持从服务注册中心发现服务实例",options:[{label:"服务注册",value:"REGISTRY"}]},{field:"serviceMetadata",label:"服务元数据",type:"textarea",placeholder:"{}",span:24,tabKey:"discovery",show:!1,props:{rows:5},tips:"服务元数据，包含从服务注册中心选择的服务信息（JSON格式）"},{field:"serviceSelection",label:"注册服务",type:"custom",span:24,tabKey:"discovery",show:e=>e.serviceType===H.DISCOVERY,tips:"从服务注册中心选择一个可用的服务，选择后会自动填充服务元数据",render:(e,l)=>{var t;const u=((t=l==null?void 0:l.selectedService)==null?void 0:t.value)||null,V=l==null?void 0:l.openServiceSelection,A=l==null?void 0:l.getLoadBalanceStrategyLabel;return u?P("div",{class:"selected-service-card"},[P("div",{class:"service-header"},[P("div",{class:"service-title"},[P(ee,{size:20,class:"service-icon",style:{color:"var(--n-color-primary)",marginRight:"8px"}},{default:()=>P(be)}),P("span",{class:"service-name",style:{fontSize:"16px",fontWeight:600,marginRight:"8px"}},u.serviceName),P($,{size:"small",type:"success"},{default:()=>"已选择"})]),P(ie,{quaternary:!0,type:"primary",size:"small",onClick:()=>V==null?void 0:V()},{default:()=>[P(ee,{style:{marginRight:"4px"}},{default:()=>P(nt)}),"重新选择"]})]),P("div",{class:"service-details"},[P("div",{class:"detail-row"},[P("div",{class:"detail-item"},[P("span",{class:"detail-label"},"服务分组："),P($,{size:"small",type:"info"},{default:()=>u.groupName})]),P("div",{class:"detail-item"},[P("span",{class:"detail-label"},"通信协议："),P($,{size:"small",type:u.protocolType==="HTTPS"?"success":"default"},{default:()=>u.protocolType})])]),P("div",{class:"detail-row"},[P("div",{class:"detail-item"},[P("span",{class:"detail-label"},"上下文路径："),P(Le,{code:!0},{default:()=>u.contextPath||"/"})]),P("div",{class:"detail-item"},[P("span",{class:"detail-label"},"负载均衡："),P(Le,{depth:2},{default:()=>(A==null?void 0:A(u.loadBalanceStrategy))||u.loadBalanceStrategy})])]),u.instances&&u.instances.length>0?P("div",{class:"detail-row"},[P("div",{class:"detail-item"},[P("span",{class:"detail-label"},"服务实例："),P($,{size:"small",type:"warning"},{default:()=>`${u.instances.length} 个实例`})]),P("div",{class:"detail-item"},[P("span",{class:"detail-label"},"服务状态："),P($,{size:"small",type:u.activeFlag==="Y"?"success":"error"},{default:()=>u.activeFlag==="Y"?"运行中":"已停用"})])]):null])]):P("div",{class:"service-selection-empty"},[P(ie,{type:"primary",size:"small",onClick:()=>V==null?void 0:V()},{default:()=>[P(ee,{style:{marginRight:"8px"}},{default:()=>P(ue)}),"选择注册服务"]})])}},{field:"discoveryConfig",label:"发现配置",type:"textarea",placeholder:"{}",span:24,tabKey:"discovery",show:!1,props:{rows:5}},{field:"activeFlag",label:"启用状态",type:"switch",span:12,tabKey:"other",defaultValue:"Y",tips:"控制服务定义是否启用，禁用的服务不会被加载到网关",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"noteText",label:"备注信息",type:"textarea",placeholder:"请输入备注信息",span:24,tabKey:"other",tips:"服务的额外备注信息，用于记录配置说明或其他相关信息",props:{rows:4}},{field:"addTime",label:"创建时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"addWho",label:"创建人",type:"input",span:12,tabKey:"other",disabled:!0},{field:"editTime",label:"修改时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"editWho",label:"修改人",type:"input",span:12,tabKey:"other",disabled:!0}]};return{moduleId:s,loading:m,serviceList:r,pageInfo:y,searchFormConfig:p,serviceFormConfig:i,gridConfig:{columns:[{field:"serviceDefinitionId",title:"服务定义ID",visible:!1,width:0},{field:"serviceName",title:"服务名称",sortable:!0,align:"center",showOverflow:"tooltip",width:200},{field:"serviceDesc",title:"服务描述",align:"center",showOverflow:"tooltip",width:200},{field:"serviceType",title:"服务类型",align:"center",slots:{default:"serviceType"},width:120},{field:"loadBalanceStrategy",title:"负载均衡策略",align:"center",slots:{default:"loadBalanceStrategy"},width:150},{field:"nodeCount",title:"服务节点",align:"center",formatter:()=>"0",width:100},{field:"sessionAffinity",title:"会话亲和性",align:"center",slots:{default:"sessionAffinity"},width:120},{field:"maxRetries",title:"最大重试",align:"center",width:100},{field:"enableCircuitBreaker",title:"熔断器",align:"center",slots:{default:"enableCircuitBreaker"},width:100},{field:"healthCheckEnabled",title:"健康检查",align:"center",slots:{default:"healthCheckEnabled"},width:120},{field:"healthCheckPath",title:"检查路径",align:"center",showOverflow:"tooltip",width:150},{field:"activeFlag",title:"状态",align:"center",slots:{default:"activeFlag"},width:100},{field:"addTime",title:"创建时间",sortable:!0,align:"center",showOverflow:!0,formatter:({cellValue:e})=>e?pe(e,"YYYY-MM-DD HH:mm:ss"):"",width:180},{field:"addWho",title:"创建人",align:"center",showOverflow:!0,width:120},{field:"editTime",title:"修改时间",sortable:!0,align:"center",showOverflow:!0,formatter:({cellValue:e})=>e?pe(e,"YYYY-MM-DD HH:mm:ss"):"",width:180},{field:"editWho",title:"修改人",align:"center",showOverflow:!0,width:120}],showCheckbox:!0,paginationConfig:{show:!0,pageInfo:y,align:"right"},menuConfig:{enabled:!0,showCopyRow:!0,showCopyCell:!0,customMenus:[{code:"edit",name:"编辑",prefixIcon:"vxe-icon-edit"},{code:"manageNodes",name:"节点管理",prefixIcon:"vxe-icon-setting"},{code:"delete",name:"删除",prefixIcon:"vxe-icon-delete"}]},height:"100%",rowId:"serviceDefinitionId"},resetPagination:()=>{y.value=void 0},updatePagination:e=>{y.value?Object.assign(y.value,e):y.value=e},setServiceList:e=>{r.value=e},addServiceToList:e=>{r.value.push(e)},updateServiceInList:e=>{const l=r.value.findIndex(u=>u.serviceDefinitionId===e.serviceDefinitionId);l>=0&&Object.assign(r.value[l],e)},removeServiceFromList:e=>{const l=r.value.findIndex(u=>u.serviceDefinitionId===e);l>=0&&r.value.splice(l,1)},removeServicesFromList:e=>{r.value=r.value.filter(l=>!e.includes(l.serviceDefinitionId))}}}function va(s,m){const r=re(),y=Ue(),p=ha(),{loading:i,serviceList:g,pageInfo:h,setServiceList:I,updatePagination:E,addServiceToList:x,updateServiceInList:M,removeServiceFromList:F,removeServicesFromList:L}=p,e=async o=>{var f,v,T;i.value=!0;try{let K=o;!K&&((f=m==null?void 0:m.value)!=null&&f.getFormData)&&(K=m.value.getFormData()||{});const q=K?Object.fromEntries(Object.entries(K).filter(([,G])=>G!==""&&G!==null&&G!==void 0)):{},ae={...q,...q.proxyConfigId===void 0&&s?{proxyConfigId:s}:{},...ze((v=h.value)==null?void 0:v.pageIndex,(T=h.value)==null?void 0:T.pageSize)},Q=await ft(ae);if(Q.oK){if(Q.bizData){const G=JSON.parse(Q.bizData),b=Array.isArray(G)?G:[];I(b)}if(Q.pageQueryData){const G=JSON.parse(Q.pageQueryData);E(G)}}else r.error(Q.errMsg||"查询服务定义列表失败")}catch{r.error("加载服务定义列表失败")}finally{i.value=!1}};return{model:p,loadServiceList:e,handleSearch:async o=>{await e(o)},handleReset:async()=>{p.resetPagination(),await e()},handlePageChange:async({currentPage:o,pageSize:f})=>{E({pageIndex:o,pageSize:f}),await e()},addService:async o=>{i.value=!0;try{const f=await ht(o);if(J(f)){const v=B(f,"服务定义创建成功");if(r.success(v),f.bizData){const T=JSON.parse(f.bizData);x(T)}else await e();return!0}else{const v=B(f,"新增服务定义失败");return r.error(v),!1}}catch{return r.error("新增服务定义失败"),!1}finally{i.value=!1}},editService:async(o,f)=>{i.value=!0;try{const v=await Te({...f,serviceDefinitionId:o});if(J(v)){const T=B(v,"服务定义更新成功");if(r.success(T),v.bizData){const K=JSON.parse(v.bizData);M(K)}else await e();return!0}else{const T=B(v,"更新服务定义失败");return r.error(T),!1}}catch{return r.error("更新服务定义失败"),!1}finally{i.value=!1}},deleteService:async o=>{const f=g.value.find(T=>T.serviceDefinitionId===o);if(!f)return r.error("未找到要删除的服务定义"),!1;if(!await y.warning({title:"确认删除",subtitle:"此操作不可恢复，请谨慎操作",content:`确定要删除服务定义 "${f.serviceName||f.serviceDefinitionId}" 吗？`,icon:me,headerStyle:"gradient",positiveText:"确定删除",negativeText:"取消",width:500}))return!1;i.value=!0;try{const T=await He(o,"default");return T.oK?(r.success(B(T,"删除服务定义成功")),F(o),g.value.length===0&&h.value&&h.value.pageIndex>1?(E({pageIndex:h.value.pageIndex-1}),await e()):await e(),!0):(r.error(B(T,"删除服务定义失败")),!1)}catch{return r.error("删除服务定义失败"),!1}finally{i.value=!1}},batchDeleteServices:async o=>{if(await y.warning({title:"确认批量删除",subtitle:"此操作不可恢复，请谨慎操作",content:`确定要删除选中的 ${o.length} 个服务定义吗？`,icon:me,headerStyle:"gradient",positiveText:"确定删除",negativeText:"取消",width:500})){i.value=!0;try{let v=0,T=0;for(const K of o)try{(await He(K,"default")).oK?v++:T++}catch{T++}v>0?(r.success(`成功删除 ${v} 个服务定义${T>0?`，失败 ${T} 个`:""}`),L(o.slice(0,v)),await e()):r.error(`删除失败，共 ${T} 个`)}catch{r.error("批量删除失败")}finally{i.value=!1}}},toggleServiceStatus:async o=>{const f=o.activeFlag==="Y"?"N":"Y",v=f==="Y"?"启用":"禁用";try{const T=await Te({serviceDefinitionId:o.serviceDefinitionId,tenantId:"default",activeFlag:f});T.oK?(r.success(`${v}成功`),M({...o,activeFlag:f}),await e()):r.error(T.errMsg||`${v}失败`)}catch{r.error(`${v}失败`)}},batchToggleServiceStatus:async(o,f)=>{const v=f==="Y"?"启用":"禁用";try{const T=o.map(ae=>Te({serviceDefinitionId:ae,tenantId:"default",activeFlag:f})),q=(await Promise.all(T)).filter(ae=>ae.oK).length;q===o.length?r.success(`成功${v} ${q} 个服务定义`):r.warning(`${v}了 ${q}/${o.length} 个服务定义`),await e()}catch{r.error(`批量${v}失败`)}}}}function ya(s,m,r){const y=re(),p=_(null),i=_(!1),g=va(s,m),h=_(!1),I=_("create"),E=_(null),x=_(!1),M=_(""),F=b=>{const D=Y=>{if(typeof Y=="string"&&Y)try{return JSON.parse(Y)}catch{return Y}return Y},k={...b};return["discoveryConfig","healthCheckHeaders","loadBalancerConfig"].forEach(Y=>{const Z=D(b[Y]);Z&&typeof Z=="object"&&!Array.isArray(Z)&&(Object.keys(Z).forEach(le=>{k[`${Y}.${le}`]=Z[le]}),delete k[Y])}),k.serviceMetadata&&typeof k.serviceMetadata=="string"||(k.serviceMetadata&&typeof k.serviceMetadata=="object"?k.serviceMetadata=JSON.stringify(k.serviceMetadata):k.serviceMetadata=void 0),k},L=b=>{const D=["discoveryConfig","healthCheckHeaders","loadBalancerConfig"],k={};if(D.forEach(z=>{const Y={};Object.keys(b).forEach(Z=>{if(Z.startsWith(`${z}.`)){const le=Z.replace(`${z}.`,"");Y[le]=b[Z]}}),Object.keys(Y).length>0&&(k[z]=JSON.stringify(Y))}),b.serviceMetadata)if(typeof b.serviceMetadata=="string")try{JSON.parse(b.serviceMetadata),k.serviceMetadata=b.serviceMetadata}catch{k.serviceMetadata="{}"}else typeof b.serviceMetadata=="object"?k.serviceMetadata=JSON.stringify(b.serviceMetadata):k.serviceMetadata="{}";else k.serviceMetadata=void 0;return Object.keys(b).forEach(z=>{!D.some(Y=>z.startsWith(`${Y}.`))&&z!=="serviceMetadata"&&(k[z]=b[z])}),k},e=(b=!0)=>s?!0:(b&&y.warning("请先选择网关实例"),!1),l=()=>{e()&&(I.value="create",E.value=null,p.value=null,h.value=!0)},u=async b=>{if(e())try{const D=await Fe(b.serviceDefinitionId,"default");if(J(D)){const k=JSON.parse(D.bizData),z=F(k);I.value="edit",E.value=z,h.value=!0}else y.error(B(D,"获取服务定义详情失败"))}catch{y.error("获取服务定义详情失败")}},V=async b=>{if(e())try{const D=await Fe(b.serviceDefinitionId,"default");if(J(D)){const k=JSON.parse(D.bizData),Y={...F(k),serviceDefinitionId:void 0,serviceName:`${k.serviceName}_copy`,activeFlag:"Y"};I.value="create",E.value=Y,h.value=!0}else y.error(B(D,"获取服务定义详情失败"))}catch{y.error("获取服务定义详情失败")}},A=b=>{e()&&(M.value=b.serviceDefinitionId,x.value=!0)},t=()=>{h.value=!1,E.value=null,p.value=null},d=async b=>{if(b&&I.value!=="view"){if(!e())return!1;if(b.serviceType===1){if(p.value)n(b);else if(!b.serviceMetadata)return y.warning("请选择注册服务"),!1}try{const k={...L(b),tenantId:"default",proxyConfigId:s||b.proxyConfigId};let z=!1;I.value==="create"?z=await g.addService(k):I.value==="edit"&&E.value&&(z=await g.editService(E.value.serviceDefinitionId,k)),z&&t()}catch{y.error("操作失败")}}},w=b=>{p.value=b,console.log("已选择服务:",b.serviceName)},n=b=>{if(p.value){const D={serviceName:p.value.serviceName,serviceGroupId:p.value.serviceGroupId,groupName:p.value.groupName,protocolType:p.value.protocolType,contextPath:p.value.contextPath,loadBalanceStrategy:p.value.loadBalanceStrategy,healthCheckUrl:p.value.healthCheckUrl,instances:p.value.instances||[]},k=JSON.stringify(D);return b&&(b.serviceMetadata=k),console.log("已更新服务元数据:",D),k}else{b&&(b.serviceMetadata=void 0);return}},c=()=>{i.value=!0,console.log("打开服务选择弹窗")},o=b=>({ROUND_ROBIN:"轮询算法",RANDOM:"随机算法",IP_HASH:"IP哈希算法",LEAST_CONN:"最少连接算法",LEAST_CONNECTIONS:"最少连接算法",WEIGHTED_ROUND_ROBIN:"加权轮询算法",CONSISTENT_HASH:"一致性哈希算法"})[b]||b,f=async b=>{e()&&await g.deleteService(b.serviceDefinitionId)},v=async()=>{var k,z,Y,Z;if(!e())return;if(!(r!=null&&r.value)){y.warning("Grid 引用未设置");return}const b=((z=(k=r.value).getCheckboxRecords)==null?void 0:z.call(k))||((Z=(Y=r.value).getSelectRecords)==null?void 0:Z.call(Y))||[];if(b.length===0){y.warning("请选择要删除的服务定义");return}const D=b.map(le=>le.serviceDefinitionId);await g.batchDeleteServices(D)},T=async b=>{if(!e())return;const D=b?{...b,...s?{proxyConfigId:s}:{}}:s?{proxyConfigId:s}:void 0;await g.handleSearch(D)},K=async(b,D)=>{var k,z,Y,Z,le,_e,ke,Oe,Ee,Me;switch(b){case"add":l();break;case"delete":{if(!(r!=null&&r.value)){y.warning("Grid 引用未设置");return}const ne=((z=(k=r.value).getCheckboxRecords)==null?void 0:z.call(k))||((Z=(Y=r.value).getSelectRecords)==null?void 0:Z.call(Y))||[];if(ne.length===0){y.warning("请选择要删除的服务定义");return}const ce=ne.map(Xe=>Xe.serviceDefinitionId);await g.batchDeleteServices(ce);break}case"manageNodes":{if(!(r!=null&&r.value)){y.warning("Grid 引用未设置");return}const ne=(_e=(le=r.value).getCurrentRecord)==null?void 0:_e.call(le);if(ne){A(ne);return}const ce=((Oe=(ke=r.value).getCheckboxRecords)==null?void 0:Oe.call(ke))||((Me=(Ee=r.value).getSelectRecords)==null?void 0:Me.call(Ee))||[];if(ce.length===0){y.warning("请先点击选择要管理的服务定义");return}if(ce.length>1){y.warning("请选择单个服务定义进行节点管理");return}A(ce[0]);break}case"search":{await T(D);break}}},q=({code:b,row:D})=>{if(D)switch(b){case"edit":u(D);break;case"manageNodes":A(D);break;case"copy":V(D);break;case"delete":f(D);break}},ae=()=>{g.loadServiceList()},Q=async()=>{s?await g.loadServiceList({proxyConfigId:s}):await g.loadServiceList()};s&&We(()=>{g.loadServiceList({proxyConfigId:s})});const G=g.model.serviceFormConfig.fields.map(b=>{if(b.field==="serviceSelection"&&b.render){const D=b.render;return{...b,render:k=>D(k,{selectedService:p,openServiceSelection:c,getLoadBalanceStrategyLabel:o})}}return b});return{service:{...g,model:{...g.model,serviceFormConfig:{...g.model.serviceFormConfig,fields:G}}},formDialogVisible:h,formDialogMode:I,currentEditService:E,showNodeDialog:x,currentServiceId:M,selectedService:p,serviceSelectionVisible:i,openAddDialog:l,openEditDialog:u,openCopyDialog:V,openNodeDialog:A,closeFormDialog:t,handleFormSubmit:d,handleDelete:f,handleBatchDelete:v,handleSearch:T,handleToolbarClick:K,handleMenuClick:q,refresh:ae,loadServiceList:Q,handleServiceSelect:w,updateServiceMetadata:n,openServiceSelection:c,getLoadBalanceStrategyLabel:o}}const ga={class:"service-definition-list",id:"hub0022-service-definition-list"},ba=he({name:"ServiceDefinitionList",__name:"ServiceDefinitionList",props:{gatewayInstanceId:{default:void 0}},setup(s){const m=s,r=_(),y=_(),{service:p,formDialogVisible:i,formDialogMode:g,currentEditService:h,showNodeDialog:I,currentServiceId:E,selectedService:x,serviceSelectionVisible:M,handleFormSubmit:F,handleToolbarClick:L,handleMenuClick:e,handleServiceSelect:l}=ya(m.gatewayInstanceId,r,y),u=fe(()=>m.gatewayInstanceId,(t,d)=>{t&&t!==d?p.loadServiceList({proxyConfigId:t}):!t&&d&&(p.model.serviceList.value=[])},{immediate:!1});we(()=>{u()});function V(t){if(!m.gatewayInstanceId)return;const d=t?{...t,...m.gatewayInstanceId?{proxyConfigId:m.gatewayInstanceId}:{}}:m.gatewayInstanceId?{proxyConfigId:m.gatewayInstanceId}:void 0;p.handleSearch(d)}function A(t){return{[U.ROUND_ROBIN]:"轮询",[U.RANDOM]:"随机",[U.IP_HASH]:"IP哈希",[U.LEAST_CONN]:"最少连接",[U.WEIGHTED_ROUND_ROBIN]:"加权轮询",[U.CONSISTENT_HASH]:"一致性哈希"}[t]||t}return(t,d)=>(j(),te("div",ga,[S(a(Ce),{direction:"vertical","default-size":"80px"},{1:C(()=>[S(Re,ge({ref_key:"searchFormRef",ref:r,"module-id":a(p).model.moduleId},a(p).model.searchFormConfig,{onSearch:V,onToolbarClick:a(L)}),null,16,["module-id","onToolbarClick"])]),2:C(()=>[S(a(Be),ge({ref_key:"gridRef",ref:y,"module-id":a(p).model.moduleId,data:a(p).model.serviceList,loading:a(p).model.loading},a(p).model.gridConfig,{onPageChange:a(p).handlePageChange,onMenuClick:a(e)}),{serviceType:C(({row:w})=>[S(a($),{type:w.serviceType===0?"info":"success",size:"small"},{default:C(()=>[W(R(w.serviceType===0?"静态配置":"服务发现"),1)]),_:2},1032,["type"])]),loadBalanceStrategy:C(({row:w})=>[S(a($),{type:"default",size:"small"},{default:C(()=>[W(R(A(w.loadBalanceStrategy)),1)]),_:2},1024)]),sessionAffinity:C(({row:w})=>[S(a($),{type:w.sessionAffinity==="Y"?"success":"default",size:"small"},{default:C(()=>[W(R(w.sessionAffinity==="Y"?"启用":"未启用"),1)]),_:2},1032,["type"])]),enableCircuitBreaker:C(({row:w})=>[S(a($),{type:w.enableCircuitBreaker==="Y"?"warning":"default",size:"small"},{default:C(()=>[W(R(w.enableCircuitBreaker==="Y"?"启用":"未启用"),1)]),_:2},1032,["type"])]),healthCheckEnabled:C(({row:w})=>[S(a($),{type:w.healthCheckEnabled==="Y"?"success":"default",size:"small"},{default:C(()=>[W(R(w.healthCheckEnabled==="Y"?"已启用":"未启用"),1)]),_:2},1032,["type"])]),activeFlag:C(({row:w})=>[S(a($),{type:w.activeFlag==="Y"?"success":"error",size:"small"},{default:C(()=>[W(R(w.activeFlag==="Y"?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1},16,["module-id","data","loading","onPageChange","onMenuClick"])]),_:1}),S(xe,{visible:a(i),"onUpdate:visible":d[0]||(d[0]=w=>ye(i)?i.value=w:null),mode:a(g),title:a(g)==="create"?"新增服务定义":a(g)==="edit"?"编辑服务定义":"查看服务定义详情",to:"#hub0022-service-definition-list","form-fields":a(p).model.serviceFormConfig.fields,"form-tabs":a(p).model.serviceFormConfig.tabs,"initial-data":a(h)||void 0,"auto-close-on-confirm":!1,"confirm-loading":a(p).model.loading.value,onSubmit:a(F)},null,8,["visible","mode","title","form-fields","form-tabs","initial-data","confirm-loading","onSubmit"]),S(fa,{show:a(M),"onUpdate:show":d[1]||(d[1]=w=>ye(M)?M.value=w:null),currentService:a(x),onSelect:a(l)},null,8,["show","currentService","onSelect"]),S(a(Ht),{visible:a(I),"onUpdate:visible":d[2]||(d[2]=w=>ye(I)?I.value=w:null),"service-definition-id":a(E),title:"服务节点管理",width:1200,to:"#hub0022-service-definition-list"},null,8,["visible","service-definition-id"])]))}}),ma=ve(ba,[["__scopeId","data-v-c8e775a9"]]),wa={class:"left-panel"},Ae="proxy-management",Ta=he({name:"ProxyManagement",__name:"ProxyManagement",setup(s){const m=_(""),r=Ie(()=>m.value||"");function y(p,i){m.value=p}return(p,i)=>(j(),te("div",{class:"proxy-management",id:Ae},[S(a(Ce),{direction:"horizontal","default-size":.25,max:.4},{1:C(()=>[O("div",wa,[S(a(Et),{"parent-module-id":Ae,onSelect:y})])]),2:C(()=>[(j(),oe(ma,{"gateway-instance-id":r.value,key:`service-${r.value}`},null,8,["gateway-instance-id"]))]),_:1})]))}}),qa=ve(Ta,[["__scopeId","data-v-adc92ac8"]]);export{qa as default};
