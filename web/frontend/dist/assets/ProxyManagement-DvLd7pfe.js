import{G as be}from"./GPane-MizfBz4X.js";import{G as me}from"./GDataFormModal-CVDITwbR.js";import{g as $e,c as Fe,G as we,S as Te}from"./SearchForm-YJ2LWOI7.js";import{G as We}from"./GTree-C7sZ9wlf.js";import{af as Be,T as ee,j as ae,r as O,i as Z,m as Q,z as B,A as le,d2 as De,a7 as ie,av as ue,B as Y,aO as W,d as oe,q as Ke,c as te,o as J,f as K,h as Ue,b as C,e as r,w as I,J as pe,G as Ge,cq as Le,I as qe,g as de,ab as je,_ as se,aa as re,am as fe,K as $,t as R,cr as ge,cF as Je}from"./index-talhFt-3.js";import{A as Se}from"./AddOutline-_WyjpAxi.js";import{S as he}from"./ServerOutline-DmIbDkrR.js";import{R as Ve}from"./RefreshOutline-CA3DFaJQ.js";import{G as He}from"./GModal-CCcCEJqk.js";import"./GPagination.vue_vue_type_style_index_0_scoped_2c35df38_lang-Ds-H5BDS.js";import{u as Ae}from"./useGDialog-DyYy8db0.js";import{C as Xe}from"./CreateOutline-5HZeJ_Zc.js";import{T as Ye}from"./TrashOutline-B0_nSqhO.js";import{W as ve}from"./WarningOutline-DmMvjmvd.js";import{u as Ze,g as Qe}from"./useServiceService-DRiH148Z.js";import{C as et}from"./CloseOutline-Dpm_uP78.js";import{S as H,L as z}from"./types-BgPBDzuW.js";import"./index-Do6tdfLc.js";import"./Select-B2cdGhy0.js";import"./DownloadOutline-BSXu5v1r.js";import"./Upload-CvnZ1nba.js";import"./download-C2161hUv.js";import"./DocumentOutline-BjVf7Dk_.js";import"./CopyOutline-BYxst-d8.js";import"./Checkbox-kG9momXt.js";import"./ContractOutline-BiyZGpf6.js";import"./GDialog-CQwmJXZh.js";const q=Be("/gateway/hub0022");async function tt(o){return q.post("/queryAllGatewayInstances",o)}async function at(o){return q.post("/getProxyConfigsByInstance",{gatewayInstanceId:o})}async function rt(o){return q.post("/addProxyConfig",o)}async function lt(o){return q.post("/editProxyConfig",o)}async function it(o){return q.post("/queryServiceDefinitions",o)}async function ke(o,y){return q.post("/getServiceDefinition",{serviceDefinitionId:o,tenantId:y})}async function ot(o){return q.post("/addServiceDefinition",o)}async function ye(o){return q.post("/editServiceDefinition",o)}async function _e(o,y){return q.post("/deleteServiceDefinition",{serviceDefinitionId:o,tenantId:y})}async function st(o){return q.post("/queryServiceNodes",o)}async function Oe(o,y){return q.post("/getServiceNode",{serviceNodeId:o,tenantId:y})}async function nt(o){return q.post("/addServiceNode",o)}async function ct(o){return q.post("/editServiceNode",o)}async function dt(o,y){return q.post("/deleteServiceNode",{serviceNodeId:o,tenantId:y})}async function ut(o){return q.post("/batchDeleteServiceNodes",{serviceNodeIds:o,tenantId:"default"})}var k=(o=>(o.HTTP="http",o.WEBSOCKET="websocket",o.TCP="tcp",o.UDP="udp",o))(k||{});function pt(){const o="hub0022",y=O(!1),i=O([]),h=O(1),u=O(20),l=O(0),b=O(""),c=ae(()=>i.value.map(e=>({key:e.gatewayInstanceId,label:S(e),instance:e})));function S(e){const s=e.tlsEnabled==="Y"?e.httpsPort:e.httpPort;return`${e.instanceName||"未命名"} (${e.bindAddress||"-"}:${s||"-"})`}function E(e){i.value=e}function N(e){y.value=e}function F(e){h.value=e}function V(e){u.value=e}function D(e){b.value=e}function t(e){l.value=e}function a(){h.value=1}function d(){b.value=""}const M={enabled:!0,showCopyNode:!0,customMenus:[{code:"addProxy",name:"代理配置",prefixIcon:()=>ee(Z,{size:14},{default:()=>ee(Se)})}]},n={tabs:[{key:"basic",label:"基本信息"},{key:"http",label:"HTTP配置",show:e=>e.proxyType===k.HTTP},{key:"websocket",label:"WebSocket配置",show:e=>e.proxyType===k.WEBSOCKET},{key:"tcp",label:"TCP配置",show:e=>e.proxyType===k.TCP},{key:"udp",label:"UDP配置",show:e=>e.proxyType===k.UDP},{key:"custom",label:"其它"}],fields:[{field:"proxyConfigId",label:"代理配置ID",type:"input",span:12,tabKey:"basic",primary:!0,show:!1},{field:"gatewayInstanceId",label:"网关实例ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"tenantId",label:"租户ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"proxyName",label:"代理名称",type:"input",placeholder:"请输入代理名称",span:12,tabKey:"basic",required:!0,tips:"代理配置的唯一标识名称，用于区分不同的代理配置",rules:[{required:!0,message:"请输入代理名称",trigger:["blur","input"]},{max:50,message:"代理名称不能超过50个字符",trigger:["blur","input"]}]},{field:"proxyType",label:"代理类型",type:"select",placeholder:"请选择代理类型",span:12,tabKey:"basic",required:!0,defaultValue:k.HTTP,tips:"选择代理协议类型：HTTP(支持HTTP/HTTPS协议)、WebSocket(支持WebSocket协议)、TCP(支持TCP协议)、UDP(支持UDP协议)",options:[{label:"HTTP",value:k.HTTP},{label:"WebSocket",value:k.WEBSOCKET},{label:"TCP",value:k.TCP},{label:"UDP",value:k.UDP}],rules:[{required:!0,message:"请选择代理类型",trigger:["blur","change"]}]},{field:"configPriority",label:"配置优先级",type:"number",placeholder:"请输入配置优先级",span:12,tabKey:"basic",required:!0,defaultValue:100,tips:"配置优先级，数值越小优先级越高。当存在多个代理配置时，优先级高的配置会优先匹配",props:{min:0,max:999},rules:[{required:!0,message:"请输入优先级",trigger:["blur","change"],validator:(e,s)=>{if(s==null||s==="")return new Error("请输入优先级");const _=Number(s);return isNaN(_)?new Error("优先级必须是数字"):_<0||_>999?new Error("优先级必须是0-999之间的数字"):!0}}]},{field:"activeFlag",label:"状态",type:"switch",span:12,tabKey:"basic",defaultValue:"Y",tips:"代理配置的启用状态。启用后配置才会生效，禁用后代理将不会处理请求",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"noteText",label:"备注",type:"textarea",placeholder:"请输入备注信息",span:24,tabKey:"basic",tips:"代理配置的备注说明，用于记录配置的用途、注意事项等信息",props:{rows:3}},{field:"proxyConfig.httpVersion",label:"HTTP版本",type:"select",placeholder:"请选择HTTP版本",span:12,tabKey:"http",show:e=>e.proxyType===k.HTTP,defaultValue:"1.1",tips:"HTTP协议版本，HTTP/1.0 或 HTTP/1.1。HTTP/1.1 支持连接复用、管道化等特性，性能更好",options:[{label:"HTTP/1.0",value:"1.0"},{label:"HTTP/1.1",value:"1.1"}]},{field:"proxyConfig.connectTimeout",label:"连接超时（秒）",type:"number",placeholder:"请输入连接超时",span:12,tabKey:"http",show:e=>e.proxyType===k.HTTP,defaultValue:30,tips:"建立TCP连接的超时时间，超过此时间未建立连接则请求失败",props:{min:1}},{field:"proxyConfig.keepAlive",label:"保持连接",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===k.HTTP,defaultValue:!0,tips:"是否启用HTTP Keep-Alive连接复用。启用后可以复用TCP连接，提高性能，减少连接建立开销"},{field:"proxyConfig.maxIdleConns",label:"最大空闲连接数",type:"number",placeholder:"请输入最大空闲连接数",span:12,tabKey:"http",show:e=>e.proxyType===k.HTTP,defaultValue:100,tips:"连接池中保持的最大空闲连接数。空闲连接可以被复用，提高性能，但会占用内存资源",props:{min:0}},{field:"proxyConfig.idleConnTimeout",label:"空闲连接超时（秒）",type:"number",placeholder:"请输入空闲连接超时",span:12,tabKey:"http",show:e=>e.proxyType===k.HTTP,required:!0,defaultValue:90,tips:"连接池中空闲连接的最大保持时间，超过此时间的空闲连接会被关闭释放资源",props:{min:1,max:7200},rules:[{required:!0,message:"请输入空闲连接超时时间",trigger:["blur","change"],type:"number",validator:(e,s)=>s==null?new Error("请输入空闲连接超时时间"):s<1?new Error("空闲连接超时时间必须大于0秒"):s>7200?new Error("空闲连接超时时间不能超过7200秒"):!0}]},{field:"proxyConfig.timeout",label:"总超时时间（秒）",type:"number",placeholder:"请输入超时时间",span:12,tabKey:"http",show:e=>e.proxyType===k.HTTP,required:!0,defaultValue:60,tips:"请求的总超时时间（包括连接、发送、读取），超过此时间未完成则请求失败",props:{min:1,max:3600},rules:[{required:!0,message:"请输入超时时间",trigger:["blur","change"],type:"number",validator:(e,s)=>s==null?new Error("请输入超时时间"):s<1?new Error("超时时间必须大于0秒"):s>3600?new Error("超时时间不能超过3600秒"):!0}]},{field:"proxyConfig.sendTimeout",label:"发送超时（秒）",type:"number",placeholder:"请输入发送超时",span:12,tabKey:"http",show:e=>e.proxyType===k.HTTP,defaultValue:60,tips:"发送请求数据的超时时间，超过此时间未发送完成则请求失败",props:{min:1}},{field:"proxyConfig.readTimeout",label:"读取超时（秒）",type:"number",placeholder:"请输入读取超时",span:12,tabKey:"http",show:e=>e.proxyType===k.HTTP,defaultValue:60,tips:"读取响应数据的超时时间，超过此时间未读取完成则请求失败",props:{min:1}},{field:"proxyConfig.retryCount",label:"重试次数",type:"number",placeholder:"请输入重试次数",span:12,tabKey:"http",show:e=>e.proxyType===k.HTTP,defaultValue:0,tips:"请求失败时的自动重试次数。设置为0表示不重试",props:{min:0}},{field:"proxyConfig.retryTimeout",label:"重试超时（秒）",type:"number",placeholder:"请输入重试超时",span:12,tabKey:"http",show:e=>e.proxyType===k.HTTP,required:!0,defaultValue:30,tips:"每次重试的超时时间，如果单次重试超过此时间则重试失败，继续下一次重试",props:{min:1,max:300},rules:[{required:!0,message:"请输入重试超时时间",trigger:["blur","change"],type:"number",validator:(e,s)=>s==null?new Error("请输入重试超时时间"):s<1?new Error("重试超时时间必须大于0秒"):s>300?new Error("重试超时时间不能超过300秒"):!0}]},{field:"proxyConfig.proxyBuffering",label:"代理缓冲",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===k.HTTP,defaultValue:!0,tips:"是否启用代理缓冲。启用后会在代理层缓冲请求和响应，可以优化传输性能"},{field:"proxyConfig.bufferSize",label:"缓冲区大小（字节）",type:"number",placeholder:"请输入缓冲区大小",span:12,tabKey:"http",show:e=>e.proxyType===k.HTTP,defaultValue:4096,tips:"默认缓冲区大小，用于临时存储请求和响应数据",props:{min:0}},{field:"proxyConfig.maxBufferSize",label:"最大缓冲区大小（字节）",type:"number",placeholder:"请输入最大缓冲区大小",span:12,tabKey:"http",show:e=>e.proxyType===k.HTTP,defaultValue:65536,tips:"缓冲区的最大大小限制，防止缓冲区无限增长导致内存溢出",props:{min:0}},{field:"proxyConfig.copyResponseBody",label:"复制响应体",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===k.HTTP,defaultValue:!1,tips:"是否复制完整的响应体到内存。启用后可以多次读取响应，但会占用更多内存"},{field:"proxyConfig.followRedirects",label:"跟随重定向",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===k.HTTP,defaultValue:!1,tips:"是否自动跟随HTTP重定向响应（3xx状态码）。启用后会自动跳转到重定向地址"},{field:"proxyConfig.preserveHost",label:"保留原始Host",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===k.HTTP,defaultValue:!1,tips:"是否保留客户端原始Host请求头。启用后目标服务器会看到原始Host，而不是代理服务器的地址"},{field:"proxyConfig.addXForwardedFor",label:"添加X-Forwarded-For",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===k.HTTP,defaultValue:!0,tips:"是否添加X-Forwarded-For请求头，用于标识客户端的真实IP地址，方便目标服务器获取客户端信息"},{field:"proxyConfig.addXRealIP",label:"添加X-Real-IP",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===k.HTTP,defaultValue:!0,tips:"是否添加X-Real-IP请求头，用于标识客户端的真实IP地址，是X-Forwarded-For的简化版本"},{field:"proxyConfig.addXForwardedProto",label:"添加X-Forwarded-Proto",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===k.HTTP,defaultValue:!0,tips:"是否添加X-Forwarded-Proto请求头，用于标识客户端使用的协议（http或https）"},{field:"proxyConfig.tlsInsecureSkipVerify",label:"跳过TLS证书验证",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===k.HTTP,defaultValue:!1,tips:"是否跳过TLS证书验证（仅用于测试环境）。生产环境建议关闭以确保安全性"},{field:"proxyConfig.tlsMinVersion",label:"最小TLS版本",type:"select",placeholder:"请选择最小TLS版本",span:12,tabKey:"http",show:e=>e.proxyType===k.HTTP,defaultValue:"1.2",tips:"支持的最小TLS协议版本。低于此版本的连接将被拒绝，建议使用TLS 1.2或更高版本",options:[{label:"TLS 1.0",value:"1.0"},{label:"TLS 1.1",value:"1.1"},{label:"TLS 1.2",value:"1.2"},{label:"TLS 1.3",value:"1.3"}]},{field:"proxyConfig.tlsMaxVersion",label:"最大TLS版本",type:"select",placeholder:"请选择最大TLS版本",span:12,tabKey:"http",show:e=>e.proxyType===k.HTTP,defaultValue:"1.3",tips:"支持的最大TLS协议版本。高于此版本的连接将降级到此版本",options:[{label:"TLS 1.0",value:"1.0"},{label:"TLS 1.1",value:"1.1"},{label:"TLS 1.2",value:"1.2"},{label:"TLS 1.3",value:"1.3"}]},{field:"proxyConfig.tlsServerName",label:"TLS服务器名称",type:"input",placeholder:"请输入TLS服务器名称（可选）",span:12,tabKey:"http",show:e=>e.proxyType===k.HTTP,tips:"TLS SNI（Server Name Indication）服务器名称，用于指定要连接的服务器主机名，通常与证书域名匹配"},{field:"proxyConfig.pingInterval",label:"Ping间隔（秒）",type:"number",placeholder:"请输入Ping间隔",span:12,tabKey:"websocket",show:e=>e.proxyType===k.WEBSOCKET,defaultValue:30,tips:"WebSocket连接心跳检测的Ping消息发送间隔，用于保持连接活跃并检测连接状态",props:{min:1}},{field:"proxyConfig.pongTimeout",label:"Pong超时（秒）",type:"number",placeholder:"请输入Pong超时",span:12,tabKey:"websocket",show:e=>e.proxyType===k.WEBSOCKET,defaultValue:10,tips:"发送Ping消息后等待Pong响应的超时时间，超过此时间未收到Pong则视为连接断开",props:{min:1}},{field:"proxyConfig.maxMessageSize",label:"最大消息大小（字节）",type:"number",placeholder:"请输入最大消息大小",span:12,tabKey:"websocket",show:e=>e.proxyType===k.WEBSOCKET,defaultValue:32768,tips:"WebSocket单条消息的最大大小限制，超过此大小的消息将被拒绝，防止内存溢出",props:{min:0}},{field:"proxyConfig.enableCompression",label:"启用压缩",type:"switch",span:12,tabKey:"websocket",show:e=>e.proxyType===k.WEBSOCKET,defaultValue:!1,tips:"是否启用WebSocket消息压缩（permessage-deflate）。启用后可以减少网络传输量，但会增加CPU开销"},{field:"proxyConfig.connectTimeout",label:"连接超时（秒）",type:"number",placeholder:"请输入连接超时",span:12,tabKey:"tcp",show:e=>e.proxyType===k.TCP,defaultValue:5,tips:"建立TCP连接的超时时间，超过此时间未建立连接则连接失败",props:{min:1}},{field:"proxyConfig.keepAlive",label:"保持连接",type:"switch",span:12,tabKey:"tcp",show:e=>e.proxyType===k.TCP,defaultValue:!0,tips:"是否启用TCP Keep-Alive机制。启用后会定期发送探测包保持TCP连接活跃，及时发现断开的连接"},{field:"proxyConfig.bufferSize",label:"缓冲区大小（字节）",type:"number",placeholder:"请输入缓冲区大小",span:12,tabKey:"udp",show:e=>e.proxyType===k.UDP,defaultValue:4096,tips:"UDP数据包接收缓冲区大小，影响可以接收的最大UDP数据包大小",props:{min:1}},{field:"customConfig",label:"自定义配置",type:"textarea",placeholder:"{}",span:24,tabKey:"custom",tips:"自定义配置项（JSON格式），用于存储额外的配置参数，可根据实际需求扩展使用",props:{rows:5}},{field:"addTime",label:"创建时间",type:"datetime",span:12,tabKey:"custom",disabled:!0},{field:"addWho",label:"创建人",type:"input",span:12,tabKey:"custom",disabled:!0},{field:"editTime",label:"修改时间",type:"datetime",span:12,tabKey:"custom",disabled:!0},{field:"editWho",label:"修改人",type:"input",span:12,tabKey:"custom",disabled:!0}]};return{moduleId:o,loading:y,instanceList:i,currentPage:h,pageSize:u,totalCount:l,filterKeyword:b,treeData:c,treeMenuConfig:M,proxyFormConfig:n,getInstanceLabel:S,setInstanceList:E,setLoading:N,setCurrentPage:F,setPageSize:V,setTotalCount:t,setFilterKeyword:D,resetPage:a,clearFilter:d}}function ft(o){const y=Q(),{loading:i,currentPage:h,pageSize:u,filterKeyword:l,setInstanceList:b,setTotalCount:c,setLoading:S,resetPage:E}=o;async function N(){try{S(!0);const F=await tt({activeFlag:"Y",instanceName:l.value.trim()||void 0,pageIndex:h.value,pageSize:u.value});if(B(F)){const V=le(F,[]);b(Array.isArray(V)?V:[]);try{const D=De(F);c(D.totalCount||0)}catch(D){console.warn("解析分页信息失败:",D),c(0)}}else y.error(F.errMsg||"获取网关实例列表失败"),b([]),c(0)}catch(F){console.error("加载网关实例失败:",F),y.error("加载网关实例失败"),b([]),c(0)}finally{S(!1)}}return{loadGatewayInstances:N}}function ht(){const o=Q(),y=pt(),i=ft(y),h=O(!1),u=O("create"),l=O(null),b=O(!1),c=O(""),S=ie(y.filterKeyword,()=>{y.resetPage(),i.loadGatewayInstances()});ue(()=>{S()});const E=p=>{const m=x=>{if(typeof x=="string"&&x)try{return JSON.parse(x)}catch{return x}return x},f={...p},v=m(p.proxyConfig);v&&typeof v=="object"&&!Array.isArray(v)&&(Object.keys(v).forEach(x=>{f[`proxyConfig.${x}`]=v[x]}),delete f.proxyConfig);const w=m(p.customConfig);if(w&&typeof w=="object")try{f.customConfig=JSON.stringify(w,null,2)}catch{f.customConfig="{}"}else f.customConfig="{}";return f},N=p=>{const m={};Object.keys(p).forEach(v=>{v.startsWith("proxyConfig.")||(m[v]=p[v])});const f={};if(Object.keys(p).forEach(v=>{if(v.startsWith("proxyConfig.")){const w=v.replace("proxyConfig.","");f[w]=p[v]}}),Object.keys(f).length>0?m.proxyConfig=JSON.stringify(f):m.proxyConfig="{}",p.customConfig)if(typeof p.customConfig=="string")try{JSON.parse(p.customConfig),m.customConfig=p.customConfig}catch{m.customConfig="{}"}else typeof p.customConfig=="object"?m.customConfig=JSON.stringify(p.customConfig):m.customConfig="{}";else m.customConfig="{}";return m},F=async()=>{const p=c.value;if(p)try{const m=await at(p);if(B(m)){const f=le(m,null);f?(l.value=f,u.value="edit"):(l.value=null,u.value="create")}else l.value=null,u.value="create"}catch{l.value=null,u.value="create"}},V=async p=>{c.value=p.gatewayInstanceId,await F(),h.value=!0},D=()=>{if(u.value==="create")return{gatewayInstanceId:c.value,proxyType:"http",configPriority:100,activeFlag:"Y"};if(l.value)return E(l.value)},t=async p=>{if(!p||u.value==="view")return!1;try{b.value=!0;const f={...N(p),tenantId:"default",gatewayInstanceId:c.value||p.gatewayInstanceId};let v=!1;if(u.value==="create"){const w=await rt(f);B(w)?(o.success(Y(w,"创建代理配置成功")),v=!0):o.error(Y(w,"创建代理配置失败"))}else if(u.value==="edit"&&l.value){const w=await lt({...f,proxyConfigId:l.value.proxyConfigId});B(w)?(o.success(Y(w,"更新代理配置成功")),v=!0):o.error(Y(w,"更新代理配置失败"))}return v&&await F(),v}catch{return o.error("操作失败"),!1}finally{b.value=!1}};function a({option:p}){return p.instance?ee(Z,{size:16,color:"var(--g-primary)",style:{marginRight:"6px",flexShrink:0}},{default:()=>ee(he)}):null}function d({option:p}){return ee("span",{class:"tree-node-label",style:{display:"inline-block",padding:"1px 4px",borderRadius:"4px",transition:"background-color 0.2s"}},p.label)}function M({option:p}){const m=p;return m.instance?ee(W,{type:m.instance.healthStatus==="Y"?"success":"warning",size:"small",style:{marginLeft:"8px",flexShrink:0}},{default:()=>m.instance.healthStatus==="Y"?"健康":"异常"}):null}function n(p,m,f){const v=m;v.instance&&f("select",v.instance.gatewayInstanceId,v.instance)}function e({currentPage:p,pageSize:m}){y.setCurrentPage(p),y.setPageSize(m),i.loadGatewayInstances()}function s(){i.loadGatewayInstances()}async function _({code:p,node:m}){if(!m)return;const f=m;if(!f.instance)return;const v=f.instance;switch(p){case"addProxy":await V(v);break}}return{model:y,service:i,proxyFormDialogVisible:h,proxyFormDialogMode:u,currentEditProxy:l,proxySubmitting:b,getProxyFormInitialData:D,renderNodePrefix:a,renderNodeLabel:d,renderNodeSuffix:M,handleTreeSelect:n,handlePageChange:e,handleRefresh:s,handleMenuClick:_,handleProxyFormSubmit:t}}const vt={class:"gateway-instance-tree"},yt={class:"instance-tree-header"},gt={class:"instance-header"},bt={class:"instance-filter"},mt={class:"instance-tree-container"},wt={key:0,class:"instance-pagination"},Tt=oe({name:"GatewayInstanceTree",__name:"GatewayInstanceTree",props:{parentModuleId:{default:"proxy-management"}},emits:["select"],setup(o,{expose:y,emit:i}){const h=o,u=i,l=ht();return Ke(()=>{l.service.loadGatewayInstances()}),y({refresh:l.service.loadGatewayInstances,resetPage:l.model.resetPage,clearFilter:l.model.clearFilter}),(b,c)=>(J(),te("div",vt,[K("div",yt,[K("div",gt,[C(r(Z),{size:"20",color:"var(--g-primary)"},{default:I(()=>[C(r(he))]),_:1}),c[3]||(c[3]=K("span",null,"网关实例列表",-1)),c[4]||(c[4]=K("div",{class:"flex-spacer"},null,-1)),C(r(pe),{text:"",size:"small",onClick:r(l).handleRefresh,disabled:r(l).model.loading.value,loading:r(l).model.loading.value},{icon:I(()=>[C(r(Z),{component:r(Ve)},null,8,["component"])]),_:1},8,["onClick","disabled","loading"])]),K("div",bt,[C(r(Ge),{value:r(l).model.filterKeyword.value,"onUpdate:value":c[0]||(c[0]=S=>r(l).model.filterKeyword.value=S),placeholder:"搜索实例名称、地址或端口",clearable:"",size:"small"},{prefix:I(()=>[C(r(Z),{component:r(Le)},null,8,["component"])]),_:1},8,["value"])])]),K("div",mt,[C(r(qe),{show:r(l).model.loading.value},{default:I(()=>[r(l).model.treeData.value.length>0?(J(),de(r(We),{key:0,data:r(l).model.treeData.value,"show-icon":!0,"block-line":!0,"node-height":32,"show-line":!0,ellipsis:!0,"ellipsis-line-clamp":1,"ellipsis-tooltip":!0,"module-id":r(l).model.moduleId,"menu-config":r(l).model.treeMenuConfig,"render-prefix":r(l).renderNodePrefix,"render-label":r(l).renderNodeLabel,"render-suffix":r(l).renderNodeSuffix,onSelect:c[1]||(c[1]=(S,E)=>r(l).handleTreeSelect(S,E,u)),onMenuClick:r(l).handleMenuClick},null,8,["data","module-id","menu-config","render-prefix","render-label","render-suffix","onMenuClick"])):(J(),de(r(je),{key:1,description:"暂无可用的网关实例",style:{padding:"40px 0"}},{icon:I(()=>[C(r(Z),{size:"40",color:"var(--g-primary)"},{default:I(()=>[C(r(he))]),_:1})]),_:1}))]),_:1},8,["show"])]),r(l).model.totalCount.value>0?(J(),te("div",wt,[C(r($e),{"current-page":r(l).model.currentPage.value,"page-size":r(l).model.pageSize.value,total:r(l).model.totalCount.value,layouts:["PrevPage","NextPage"],align:"center",onPageChange:r(l).handlePageChange},null,8,["current-page","page-size","total","onPageChange"])])):Ue("",!0),C(me,{visible:r(l).proxyFormDialogVisible.value,"onUpdate:visible":c[2]||(c[2]=S=>r(l).proxyFormDialogVisible.value=S),mode:r(l).proxyFormDialogMode.value,title:r(l).proxyFormDialogMode.value==="create"?"新增代理配置":r(l).proxyFormDialogMode.value==="edit"?"编辑代理配置":"查看代理配置详情",to:`#${h.parentModuleId}`,"form-fields":r(l).model.proxyFormConfig.fields,"form-tabs":r(l).model.proxyFormConfig.tabs,"initial-data":r(l).getProxyFormInitialData(),"auto-close-on-confirm":!1,"confirm-loading":r(l).proxySubmitting.value,onSubmit:r(l).handleProxyFormSubmit},null,8,["visible","mode","title","to","form-fields","form-tabs","initial-data","confirm-loading","onSubmit"])]))}}),St=se(Tt,[["__scopeId","data-v-f8fbd456"]]);function Ct(){const o="hub0022:manageNodes",y=O(!1),i=O([]),h=O();return{moduleId:o,loading:y,nodeList:i,pageInfo:h,searchFormConfig:{fields:[{field:"nodeHost",label:"节点主机",type:"input",placeholder:"请输入节点主机地址",span:6,clearable:!0},{field:"healthStatus",label:"健康状态",type:"select",placeholder:"请选择健康状态",span:6,clearable:!0,options:[{label:"全部",value:""},{label:"健康",value:"Y"},{label:"不健康",value:"N"}]},{field:"activeFlag",label:"在线状态",type:"select",placeholder:"请选择在线状态",span:6,clearable:!0,options:[{label:"全部",value:""},{label:"在线",value:"Y"},{label:"离线",value:"N"}]}],toolbarButtons:[{key:"add",label:"新建节点",icon:Se,type:"primary",tooltip:"新建服务节点"},{key:"edit",label:"编辑",icon:Xe,type:"default",tooltip:"编辑选中的服务节点"},{key:"delete",label:"删除",icon:Ye,type:"error",tooltip:"批量删除选中的服务节点"}],showSearchButton:!0,showResetButton:!0},nodeFormConfig:{tabs:[{key:"basic",label:"基本信息"},{key:"metadata",label:"元数据配置"},{key:"other",label:"其他配置"}],fields:[{field:"serviceNodeId",label:"服务节点ID",type:"input",span:12,tabKey:"basic",primary:!0,show:!1},{field:"nodeId",label:"节点ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"serviceDefinitionId",label:"服务定义ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"tenantId",label:"租户ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"nodeProtocol",label:"节点协议",type:"select",placeholder:"请选择协议",span:12,tabKey:"basic",required:!0,defaultValue:"HTTP",props:{onUpdateValue:(t,a)=>{if(a&&a.nodeHost&&a.nodePort!==void 0&&t){const d=t.toLowerCase();a.nodeUrl=`${d}://${a.nodeHost}:${a.nodePort}`}}},options:[{label:"HTTP",value:"HTTP"},{label:"HTTPS",value:"HTTPS"}],rules:[{required:!0,message:"请选择节点协议",trigger:["blur","change"]}]},{field:"nodeHost",label:"节点主机",type:"input",placeholder:"请输入主机地址",span:12,tabKey:"basic",required:!0,props:{onUpdateValue:(t,a)=>{if(a&&t&&a.nodePort!==void 0&&a.nodeProtocol){const d=a.nodeProtocol.toLowerCase();a.nodeUrl=`${d}://${t}:${a.nodePort}`}}},rules:[{required:!0,message:"请输入节点主机地址",trigger:["blur","input"]},{pattern:/^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$|^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])$/,message:"请输入有效的IP地址或域名",trigger:["blur","input"]}]},{field:"nodePort",label:"节点端口",type:"number",placeholder:"请输入端口",span:12,tabKey:"basic",required:!0,props:{min:1,max:65535,onUpdateValue:(t,a)=>{if(a&&a.nodeHost&&t!==void 0&&a.nodeProtocol){const d=a.nodeProtocol.toLowerCase();a.nodeUrl=`${d}://${a.nodeHost}:${t}`}}},rules:[{required:!0,type:"number",message:"请输入节点端口",trigger:["blur","change"]}]},{field:"nodeWeight",label:"节点权重",type:"number",placeholder:"权重值",span:12,tabKey:"basic",required:!0,defaultValue:100,props:{min:1,max:1e3},rules:[{required:!0,type:"number",message:"请输入节点权重",trigger:["blur","change"]}]},{field:"nodeUrl",label:"节点URL",type:"input",placeholder:"输入完整URL或由上方字段自动生成",span:24,tabKey:"basic",required:!0,tips:"支持直接输入完整URL(如 https://www.example.com)，将自动解析为协议、主机和端口",props:{onUpdateValue:(t,a)=>{if(a&&t&&(t.startsWith("http://")||t.startsWith("https://")))try{const d=new URL(t);a.nodeProtocol=d.protocol==="https:"?"HTTPS":"HTTP",a.nodeHost=d.hostname,d.port?a.nodePort=parseInt(d.port,10):a.nodePort=d.protocol==="https:"?443:80}catch(d){console.warn("URL解析失败:",d)}}},rules:[{required:!0,message:"请输入节点URL",trigger:["blur","input"]},{validator:(t,a)=>{if(a&&(a.startsWith("http://")||a.startsWith("https://")))try{return new URL(a),!0}catch{return new Error("请输入有效的URL格式")}return!0},trigger:["blur","input"]}]},{field:"healthStatus",label:"健康状态",type:"switch",span:12,tabKey:"basic",defaultValue:"Y",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"activeFlag",label:"在线状态",type:"switch",span:12,tabKey:"basic",defaultValue:"Y",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"noteText",label:"备注信息",type:"textarea",placeholder:"请输入备注信息",span:24,tabKey:"basic",props:{rows:4}},{field:"nodeMetadata",label:"节点元数据",type:"textarea",placeholder:"{}",span:24,tabKey:"metadata",props:{rows:8},rules:[{validator:(t,a)=>{if(a&&typeof a=="string"&&a.trim())try{return JSON.parse(a),!0}catch{return new Error("请输入有效的JSON格式")}return!0},trigger:["blur"]}]},{field:"addTime",label:"创建时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"addWho",label:"创建人",type:"input",span:12,tabKey:"other",disabled:!0},{field:"editTime",label:"修改时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"editWho",label:"修改人",type:"input",span:12,tabKey:"other",disabled:!0}]},gridConfig:{columns:[{field:"serviceNodeId",title:"服务节点ID",visible:!1},{field:"tenantId",title:"租户ID",visible:!1},{field:"serviceDefinitionId",title:"服务定义ID",visible:!1},{field:"nodeId",title:"节点ID",sortable:!0,align:"center",showOverflow:!0,width:150},{field:"nodeUrl",title:"节点地址",sortable:!0,align:"left",showOverflow:!0,width:250},{field:"nodeHost",title:"节点主机",sortable:!0,align:"center",showOverflow:!0,width:150},{field:"nodePort",title:"节点端口",sortable:!0,align:"center",width:100},{field:"nodeProtocol",title:"协议",align:"center",width:80,slots:{default:"nodeProtocol"}},{field:"nodeWeight",title:"权重",align:"center",width:80},{field:"healthStatus",title:"健康状态",align:"center",width:100,slots:{default:"healthStatus"}},{field:"activeFlag",title:"在线状态",align:"center",width:100,slots:{default:"activeFlag"}},{field:"lastHealthCheckTime",title:"最后检查时间",align:"center",showOverflow:!0,formatter:({cellValue:t})=>t?re(t,"YYYY-MM-DD HH:mm:ss"):"-",width:180},{field:"noteText",title:"备注",align:"left",showOverflow:!0,width:150},{field:"addTime",title:"创建时间",sortable:!0,align:"center",showOverflow:!0,formatter:({cellValue:t})=>t?re(t,"YYYY-MM-DD HH:mm:ss"):"",width:180},{field:"addWho",title:"创建人",align:"center",showOverflow:!0,width:120},{field:"editTime",title:"修改时间",sortable:!0,align:"center",showOverflow:!0,formatter:({cellValue:t})=>t?re(t,"YYYY-MM-DD HH:mm:ss"):"",width:180},{field:"editWho",title:"修改人",align:"center",showOverflow:!0,width:120}],showCheckbox:!0,paginationConfig:{show:!0,pageInfo:h,align:"right"},menuConfig:{enabled:!0,showCopyRow:!0,showCopyCell:!0,customMenus:[{code:"edit",name:"编辑",prefixIcon:"vxe-icon-edit"},{code:"delete",name:"删除",prefixIcon:"vxe-icon-delete"}]},height:"100%",rowId:"serviceNodeId"},resetPagination:()=>{h.value=void 0},updatePagination:t=>{h.value?Object.assign(h.value,t):h.value=t},setNodeList:t=>{i.value=t},addNodeToList:t=>{i.value.push(t)},updateNodeInList:t=>{const a=i.value.findIndex(d=>d.serviceNodeId===t.serviceNodeId);a>=0&&(i.value[a]=t)},removeNodeFromList:t=>{const a=i.value.findIndex(d=>d.serviceNodeId===t);a>=0&&i.value.splice(a,1)},removeNodesFromList:t=>{i.value=i.value.filter(a=>!t.includes(a.serviceNodeId))}}}var ze=(o=>(o[o.OFFLINE=0]="OFFLINE",o[o.ONLINE=1]="ONLINE",o[o.MAINTENANCE=2]="MAINTENANCE",o))(ze||{});function It(o,y){const i=Q(),h=Ae(),u=Ct(),{loading:l,nodeList:b,pageInfo:c,setNodeList:S,updatePagination:E,addNodeToList:N,updateNodeInList:F,removeNodeFromList:V,removeNodesFromList:D}=u,t=async m=>{var f,v,w;l.value=!0;try{let x=m;!x&&((f=y==null?void 0:y.value)!=null&&f.getFormData)&&(x=y.value.getFormData()||{});const U=x?Object.fromEntries(Object.entries(x).filter(([,T])=>T!==""&&T!==null&&T!==void 0)):{},j=(o==null?void 0:o.value)||U.serviceDefinitionId;if(!j){i.error("serviceDefinitionId不能为空");return}const g={serviceDefinitionId:j,...U,...Fe((v=c.value)==null?void 0:v.pageIndex,(w=c.value)==null?void 0:w.pageSize)},P=await st(g);if(B(P)){const T=le(P,[]);S(Array.isArray(T)?T:[]);const L=De(P);L&&Object.keys(L).length>0&&E(L)}else i.error(Y(P,"查询服务节点列表失败"))}catch{i.error("加载服务节点列表失败")}finally{l.value=!1}};return{model:u,loadNodeList:t,handleSearch:async m=>{u.resetPagination(),await t(m)},handleReset:async()=>{u.resetPagination(),await t()},handlePageChange:async({currentPage:m,pageSize:f})=>{E({pageIndex:m,pageSize:f}),await t()},handleRefresh:async()=>{await t()},addNode:async m=>{l.value=!0;try{const f=await nt(m);return B(f)?(i.success(Y(f,"新增服务节点成功")),await t(),!0):(i.error(Y(f,"新增服务节点失败")),!1)}catch{return i.error("新增服务节点失败"),!1}finally{l.value=!1}},editNode:async m=>{l.value=!0;try{const f=await ct(m);return B(f)?(i.success(Y(f,"编辑服务节点成功")),await t(),!0):(i.error(Y(f,"编辑服务节点失败")),!1)}catch{return i.error("编辑服务节点失败"),!1}finally{l.value=!1}},deleteNode:async m=>{const f=b.value.find(w=>w.serviceNodeId===m);if(!f)return i.error("未找到要删除的服务节点"),!1;if(!await h.warning({title:"确认删除",subtitle:"此操作不可恢复，请谨慎操作",content:`确定要删除服务节点 "${f.nodeUrl||f.nodeHost||m}" 吗？`,icon:ve,headerStyle:"gradient",positiveText:"确定删除",negativeText:"取消",width:500}))return!1;l.value=!0;try{const w=await dt(m,"default");return B(w)?(i.success(Y(w,"删除服务节点成功")),V(m),b.value.length===0&&c.value&&c.value.pageIndex>1?(E({pageIndex:c.value.pageIndex-1}),await t()):await t(),!0):(i.error(Y(w,"删除服务节点失败")),!1)}catch{return i.error("删除服务节点失败"),!1}finally{l.value=!1}},batchDeleteNodes:async m=>{if(!await h.warning({title:"确认批量删除",subtitle:"此操作不可恢复，请谨慎操作",content:`确定要删除选中的 ${m.length} 个服务节点吗？`,icon:ve,headerStyle:"gradient",positiveText:"确定删除",negativeText:"取消",width:500}))return!1;l.value=!0;try{const v=await ut(m);return B(v)?(i.success(Y(v,"批量删除服务节点成功")),D(m),await t(),!0):(i.error(Y(v,"批量删除服务节点失败")),!1)}catch{return i.error("批量删除服务节点失败"),!1}finally{l.value=!1}}}}function xt(o,y,i){const h=Q(),u=It(y,i),l=O(!1),b=O("create"),c=O(null),S=e=>{const s=p=>{if(typeof p=="string"&&p)try{return JSON.parse(p)}catch{return p}return p},_={...e};if(e.nodeMetadata){const p=s(e.nodeMetadata);if(p&&typeof p=="object")try{_.nodeMetadata=JSON.stringify(p,null,2)}catch{_.nodeMetadata="{}"}else _.nodeMetadata=e.nodeMetadata||"{}"}else _.nodeMetadata="{}";return _},E=e=>{const s={...e};if(e.nodeMetadata)if(typeof e.nodeMetadata=="string")try{JSON.parse(e.nodeMetadata),s.nodeMetadata=e.nodeMetadata}catch{s.nodeMetadata="{}"}else typeof e.nodeMetadata=="object"?s.nodeMetadata=JSON.stringify(e.nodeMetadata):s.nodeMetadata="{}";else s.nodeMetadata="{}";return e.nodePort!==void 0&&(s.nodePort=Number(e.nodePort)),e.nodeWeight!==void 0&&(s.nodeWeight=Number(e.nodeWeight)),e.nodeStatus!==void 0&&(s.nodeStatus=Number(e.nodeStatus)),s},N=()=>{b.value="create",c.value=null,l.value=!0},F=async e=>{if(e.serviceNodeId)try{const s=await Oe(e.serviceNodeId,"default");if(B(s)){const _=le(s,null);if(_){b.value="edit",c.value=S(_),l.value=!0;return}}}catch{}b.value="edit",c.value=S(e),l.value=!0},V=async e=>{if(e.serviceNodeId)try{const s=await Oe(e.serviceNodeId,"default");if(B(s)){const _=le(s,null);if(_){b.value="view",c.value=S(_),l.value=!0;return}}}catch{}b.value="view",c.value=S(e),l.value=!0},D=()=>{l.value=!1,c.value=null},t=()=>{if(b.value==="create")return{serviceDefinitionId:(y==null?void 0:y.value)||"",nodeUrl:"http://192.168.1.0:8080",nodeHost:"192.168.1.0",nodePort:8080,nodeProtocol:"HTTP",nodeWeight:100,healthStatus:"Y",activeFlag:"Y",nodeStatus:ze.ONLINE,nodeMetadata:"{}",noteText:""};if(c.value)return c.value},a=async e=>{var s;if(!e||b.value==="view")return!1;try{const _=E(e);if(!_.serviceDefinitionId&&(y!=null&&y.value)&&(_.serviceDefinitionId=y.value),!_.serviceDefinitionId)return h.error("服务定义ID不能为空"),!1;let p=!1;return b.value==="create"?p=await u.addNode(_):b.value==="edit"&&((s=c.value)!=null&&s.serviceNodeId)&&(_.serviceNodeId=c.value.serviceNodeId,p=await u.editNode(_)),p&&D(),p}catch{return h.error("操作失败"),!1}},d=async(e,s)=>{var _,p,m,f;switch(e){case"add":N();break;case"edit":{if(!(o!=null&&o.value)){h.warning("Grid 引用未设置");return}const v=(p=(_=o.value).getCurrentRecord)==null?void 0:p.call(_);if(!v){h.warning("请先点击选择要编辑的服务节点");return}await F(v);break}case"delete":{if(!(o!=null&&o.value)){h.warning("Grid 引用未设置");return}const v=(f=(m=o.value).getCurrentRecord)==null?void 0:f.call(m);if(!v){h.warning("请先点击选择要删除的服务节点");return}await u.deleteNode(v.serviceNodeId);break}case"search":{await n(s);break}}},M=async({code:e,row:s})=>{if(s)switch(e){case"edit":await F(s);break;case"delete":await u.deleteNode(s.serviceNodeId);break}},n=async e=>{await u.handleSearch(e)};return{service:u,formDialogVisible:l,formDialogMode:b,currentEditNode:c,getFormInitialData:t,openAddDialog:N,openEditDialog:F,openViewDialog:V,closeFormDialog:D,handleFormSubmit:a,handleToolbarClick:d,handleMenuClick:M,handleSearch:n}}const Pt={class:"service-node-list-modal",id:"hub0022-service-node-list"},Nt=oe({name:"ServiceNodeListModal",__name:"ServiceNodeListModal",props:{visible:{type:Boolean,default:!1},title:{default:"服务节点管理"},width:{default:1200},to:{type:[String,Boolean],default:void 0},serviceDefinitionId:{default:void 0}},emits:["update:visible","close","refresh"],setup(o,{emit:y}){const i=o,h=y,u=O(),l=O(),b=O(i.visible),c=ie(()=>i.visible,s=>{b.value=s}),S=O(i.serviceDefinitionId),E=ie(()=>i.serviceDefinitionId,s=>{S.value=s,b.value&&s&&N.handleRefresh()});ue(()=>{c(),E()});const{service:N,formDialogVisible:F,formDialogMode:V,getFormInitialData:D,handleFormSubmit:t,handleToolbarClick:a,handleMenuClick:d,handleSearch:M}=xt(l,S,u),n=s=>{b.value=s,h("update:visible",s),s?(h("refresh"),S.value&&N.handleRefresh()):h("close")},e=()=>{b.value||(F.value=!1,V.value="create",N.model.nodeList.value=[],N.model.resetPagination())};return(s,_)=>(J(),de(r(He),{visible:b.value,title:i.title||"服务节点管理",width:i.width||1200,to:i.to,"show-footer":!1,"onUpdate:visible":n,onAfterLeave:e},{default:I(()=>[K("div",Pt,[C(r(be),{direction:"vertical","no-resize":!0},{1:I(()=>[C(Te,fe({ref_key:"searchFormRef",ref:u,"module-id":r(N).model.moduleId},r(N).model.searchFormConfig,{onSearch:r(M),onToolbarClick:r(a)}),null,16,["module-id","onSearch","onToolbarClick"])]),2:I(()=>[C(r(we),fe({ref_key:"gridRef",ref:l,"module-id":r(N).model.moduleId,data:r(N).model.nodeList,loading:r(N).model.loading},r(N).model.gridConfig,{onPageChange:r(N).handlePageChange,onMenuClick:r(d)}),{nodeProtocol:I(({row:p})=>[C(r(W),{type:p.nodeProtocol==="HTTPS"?"success":"info",size:"small"},{default:I(()=>[$(R(p.nodeProtocol),1)]),_:2},1032,["type"])]),healthStatus:I(({row:p})=>[C(r(W),{type:p.healthStatus==="Y"?"success":"error",size:"small"},{default:I(()=>[$(R(p.healthStatus==="Y"?"健康":"不健康"),1)]),_:2},1032,["type"])]),nodeStatus:I(({row:p})=>[C(r(W),{type:p.nodeStatus===1?"success":p.nodeStatus===0?"error":"warning",size:"small"},{default:I(()=>[$(R(p.nodeStatus===1?"在线":p.nodeStatus===0?"下线":"维护"),1)]),_:2},1032,["type"])]),activeFlag:I(({row:p})=>[C(r(W),{type:p.activeFlag==="Y"?"success":"default",size:"small"},{default:I(()=>[$(R(p.activeFlag==="Y"?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1},16,["module-id","data","loading","onPageChange","onMenuClick"])]),_:1}),C(me,{visible:r(F),"onUpdate:visible":_[0]||(_[0]=p=>ge(F)?F.value=p:null),mode:r(V),title:r(V)==="create"?"新增服务节点":r(V)==="edit"?"编辑服务节点":"查看服务节点详情",to:"#hub0022-service-node-list","form-fields":r(N).model.nodeFormConfig.fields,"form-tabs":r(N).model.nodeFormConfig.tabs,"initial-data":r(D)(),"auto-close-on-confirm":!1,"confirm-loading":r(N).model.loading.value,onSubmit:r(t)},null,8,["visible","mode","title","form-fields","form-tabs","initial-data","confirm-loading","onSubmit"])])]),_:1},8,["visible","title","width","to"]))}}),kt=se(Nt,[["__scopeId","data-v-f9b087ea"]]),_t={class:"service-selector-modal-content"},Ot={class:"search-section"},Et={class:"grid-section"},Ee="hub0042-selector",Mt=oe({__name:"ServiceSelectorModal",props:{visible:{type:Boolean},to:{default:"body"}},emits:["update:visible","select","close"],setup(o,{emit:y}){const i=o,h=y,u=Q(),l=O(),b=O(),c=O(null),S=Ze(l),E={fields:[{field:"serviceName",label:"服务名称",type:"input",placeholder:"请输入服务名称",span:6,clearable:!0},{field:"groupName",label:"分组名称",type:"input",placeholder:"请输入分组名称",span:6,clearable:!0},{field:"namespaceId",label:"命名空间",type:"input",placeholder:"请输入命名空间",span:6,clearable:!0},{field:"activeFlag",label:"状态",type:"select",placeholder:"请选择状态",span:6,clearable:!0,options:[{label:"全部",value:""},{label:"启用",value:"Y"},{label:"禁用",value:"N"}]}]},N={columns:[{type:"radio",width:50,fixed:"left"},{field:"serviceName",title:"服务名称",minWidth:180,sortable:!0},{field:"namespaceId",title:"命名空间",minWidth:120},{field:"groupName",title:"分组",minWidth:120},{field:"serviceType",title:"类型",minWidth:100},{field:"activeFlag",title:"状态",minWidth:80,slots:{default:"activeFlag"}},{field:"addTime",title:"创建时间",minWidth:160,formatter:({cellValue:n})=>re(n)}],rowConfig:{keyField:"serviceName",isHover:!0,isCurrent:!0},radioConfig:{highlight:!0,trigger:"row"},pagerConfig:{enabled:!0,pageSize:10,pageSizes:[10,20,50]}},F=ae({get:()=>i.visible,set:n=>h("update:visible",n)}),V=ie(()=>i.visible,n=>{var e;n?(c.value=null,S.loadServices({tenantId:"default"})):(c.value=null,(e=l.value)!=null&&e.resetForm&&l.value.resetForm())});ue(()=>{V()});function D(){S.handleSearch()}function t(n){S.handlePageChange(n.currentPage,n.pageSize)}function a({row:n}){var e;c.value=n,(e=b.value)!=null&&e.setRadioRow&&b.value.setRadioRow(n)}function d(){var s,_;const e=((_=(s=b.value)==null?void 0:s.getRadioRecord)==null?void 0:_.call(s))||c.value;if(!e){u.warning("请选择一个服务");return}h("select",e),M()}function M(){h("update:visible",!1),h("close")}return(n,e)=>(J(),de(r(He),{visible:F.value,"onUpdate:visible":e[0]||(e[0]=s=>F.value=s),title:"选择注册服务","header-icon":r(Le),width:1200,"mask-closable":!1,"show-fullscreen-toggle":!1,to:o.to,onClose:M,onCancel:M,onConfirm:d,"show-confirm":!0,"show-cancel":!0,"confirm-text":"确认选择","cancel-text":"取消"},{default:I(()=>[K("div",_t,[K("div",Ot,[C(Te,{ref_key:"searchFormRef",ref:l,"module-id":Ee,fields:E.fields,"show-search-button":!0,"show-reset-button":!0,onSearch:D},null,8,["fields"])]),K("div",Et,[C(r(we),{ref_key:"gridRef",ref:b,"module-id":Ee,data:r(S).model.serviceList,loading:r(S).model.loading,columns:N.columns,height:400,"show-overflow":!0,stripe:!0,border:!0,"row-config":N.rowConfig,"radio-config":N.radioConfig,"pager-config":N.pagerConfig,"page-info":r(S).model.pageInfo,onPageChange:t,onRowClick:a},{activeFlag:I(({row:s})=>[C(r(W),{type:s.activeFlag==="Y"?"success":"default",size:"small"},{default:I(()=>[$(R(s.activeFlag==="Y"?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1},8,["data","loading","columns","row-config","radio-config","pager-config","page-info"])])])]),_:1},8,["visible","header-icon","to"]))}}),Ft=se(Mt,[["__scopeId","data-v-1b01a4eb"]]),Dt={class:"service-selector"},Kt={key:0,class:"selected-service-card"},Lt={class:"service-info"},Vt={class:"service-header"},Ht={class:"service-avatar"},At={class:"avatar-circle"},Yt={class:"service-main-info"},zt={class:"service-name"},Rt={class:"service-tags"},$t={class:"service-status"},Wt={class:"service-details"},Bt={class:"detail-row"},Ut={class:"detail-item"},Gt={class:"detail-value"},qt={class:"detail-item"},jt={class:"detail-value"},Jt={class:"detail-item"},Xt={class:"service-actions"},Zt={key:1,class:"empty-selector"},Qt=oe({__name:"ServiceSelector",props:{modelValue:{default:null},to:{default:"body"}},emits:["update:modelValue","change"],setup(o,{emit:y}){const i=o,h=y,u=Q(),l=O(!1),b=O(!1),c=O(null),S=ae(()=>{if(!i.modelValue)return null;if(typeof i.modelValue=="string")try{return JSON.parse(i.modelValue)}catch{return null}return i.modelValue}),E=ae(()=>c.value),N=ae(()=>{var n;return((n=S.value)==null?void 0:n.protocolType)||"http"}),F=n=>{if(!n)return"?";const e=n.charAt(0).toUpperCase();return/^[A-Z]$/.test(e)?e:n.charAt(0)},V=async n=>{if(!n||!n.namespaceId||!n.groupName||!n.serviceName){c.value=null;return}try{b.value=!0;const e=await Qe(n.namespaceId,n.groupName,n.serviceName);if(B(e)){const s=le(e,void 0);s?c.value=s:(console.warn("服务数据解析失败"),c.value=null)}else console.warn("获取服务失败:",Y(e,"获取服务失败")),c.value={tenantId:n.tenantId,namespaceId:n.namespaceId,groupName:n.groupName,serviceName:n.serviceName,activeFlag:"Y"}}catch(e){console.error("加载服务失败:",e),c.value=null}finally{b.value=!1}},D=ie(()=>i.modelValue,n=>{if(!n){c.value=null;return}const e=S.value;if(e){const s=c.value;(!s||s.namespaceId!==e.namespaceId||s.groupName!==e.groupName||s.serviceName!==e.serviceName)&&V(e)}},{immediate:!0});ue(()=>{D()});const t=()=>{l.value=!0},a=()=>{l.value=!1},d=()=>{c.value=null,h("update:modelValue",null),h("change",null),u.info("已清除服务选择")},M=n=>{c.value=n;const e={tenantId:n.tenantId||"default",namespaceId:n.namespaceId,groupName:n.groupName||"DEFAULT_GROUP",serviceName:n.serviceName,discoveryType:"servicecenter",protocolType:"http"};h("update:modelValue",e),h("change",e),u.success(`已选择服务：${n.serviceName}`),a()};return(n,e)=>(J(),te("div",Dt,[E.value?(J(),te("div",Kt,[K("div",Lt,[K("div",Vt,[K("div",Ht,[K("div",At,R(F(E.value.serviceName)),1)]),K("div",Yt,[K("div",zt,R(E.value.serviceName),1),K("div",Rt,[C(r(W),{type:"info",size:"small"},{default:I(()=>[$(R(E.value.namespaceId),1)]),_:1}),C(r(W),{type:"primary",size:"small"},{default:I(()=>[$(R(E.value.groupName),1)]),_:1})])]),K("div",$t,[C(r(W),{type:E.value.activeFlag==="Y"?"success":"error",size:"small"},{default:I(()=>[$(R(E.value.activeFlag==="Y"?"启用":"禁用"),1)]),_:1},8,["type"])])]),K("div",Wt,[K("div",Bt,[K("div",Ut,[e[1]||(e[1]=K("span",{class:"detail-label"},"服务类型",-1)),K("span",Gt,R(E.value.serviceType||"internal"),1)]),K("div",qt,[e[2]||(e[2]=K("span",{class:"detail-label"},"节点数",-1)),K("span",jt,R(E.value.nodes?E.value.nodes.length:"0"),1)]),K("div",Jt,[e[3]||(e[3]=K("span",{class:"detail-label"},"协议",-1)),C(r(W),{type:"warning",size:"small"},{default:I(()=>[$(R(N.value),1)]),_:1})])])]),K("div",Xt,[C(r(pe),{onClick:t,size:"small",secondary:""},{icon:I(()=>[C(r(Z),null,{default:I(()=>[C(r(Ve))]),_:1})]),default:I(()=>[e[4]||(e[4]=$(" 重新选择 ",-1))]),_:1}),C(r(pe),{onClick:d,size:"small",type:"error",secondary:""},{icon:I(()=>[C(r(Z),null,{default:I(()=>[C(r(et))]),_:1})]),default:I(()=>[e[5]||(e[5]=$(" 清除 ",-1))]),_:1})])])])):(J(),te("div",Zt,[C(r(pe),{onClick:t,dashed:"",block:"",size:"large",class:"select-btn"},{icon:I(()=>[C(r(Z),null,{default:I(()=>[C(r(he))]),_:1})]),default:I(()=>[e[6]||(e[6]=$(" 点击选择注册服务 ",-1))]),_:1})])),C(Ft,{visible:l.value,"onUpdate:visible":e[0]||(e[0]=s=>l.value=s),to:o.to,onSelect:M,onClose:a},null,8,["visible","to"])]))}}),ea=se(Qt,[["__scopeId","data-v-9d297009"]]);function ta(){const o="hub0022",y=O(!1),i=O([]),h=O(),u={fields:[{field:"serviceName",label:"服务名称",type:"input",placeholder:"请输入服务名称",span:6,clearable:!0},{field:"serviceType",label:"服务类型",type:"select",placeholder:"请选择服务类型",span:6,clearable:!0,options:[{label:"静态配置",value:H.STATIC},{label:"服务发现",value:H.DISCOVERY}]},{field:"loadBalanceStrategy",label:"负载均衡策略",type:"select",placeholder:"请选择负载均衡策略",span:6,clearable:!0,options:[{label:"轮询算法",value:z.ROUND_ROBIN},{label:"随机算法",value:z.RANDOM},{label:"IP哈希算法",value:z.IP_HASH},{label:"最少连接算法",value:z.LEAST_CONN},{label:"加权轮询算法",value:z.WEIGHTED_ROUND_ROBIN},{label:"一致性哈希算法",value:z.CONSISTENT_HASH}]},{field:"activeFlag",label:"状态",type:"select",placeholder:"请选择状态",span:6,options:[{label:"全部",value:""},{label:"启用",value:"Y"},{label:"禁用",value:"N"}]}],toolbarButtons:[{key:"add",label:"新增服务",icon:Se,type:"primary",tooltip:"新增服务定义"},{key:"delete",label:"删除",icon:Ye,type:"error",tooltip:"批量删除选中的服务定义"},{key:"manageNodes",label:"节点管理",icon:Je,type:"default",tooltip:"管理服务节点"}],showSearchButton:!0,showResetButton:!0},l={tabs:[{key:"basic",label:"基本信息"},{key:"loadbalance",label:"负载均衡",show:t=>t.serviceType===H.STATIC},{key:"health",label:"健康检查",show:t=>t.serviceType===H.STATIC},{key:"discovery",label:"服务发现",show:t=>t.serviceType===H.DISCOVERY},{key:"other",label:"其他配置"}],fields:[{field:"serviceDefinitionId",label:"服务定义ID",type:"input",span:12,tabKey:"basic",primary:!0,show:!1},{field:"tenantId",label:"租户ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"proxyConfigId",label:"代理配置ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"serviceName",label:"服务名称",type:"input",placeholder:"请输入服务名称",span:12,tabKey:"basic",required:!0,tips:"服务的唯一标识名称，用于区分不同的后端服务，长度2-50个字符",rules:[{required:!0,message:"请输入服务名称",trigger:["blur","input"]},{min:2,max:50,message:"服务名称长度在2-50个字符",trigger:["blur","input"]}]},{field:"serviceType",label:"服务类型",type:"select",placeholder:"请选择服务类型",span:12,tabKey:"basic",required:!0,defaultValue:H.STATIC,tips:"静态配置：手动配置服务节点地址；服务发现：从服务注册中心自动发现服务实例",options:[{label:"静态配置",value:H.STATIC},{label:"服务发现",value:H.DISCOVERY}],rules:[{required:!0,message:"请选择服务类型",trigger:["blur","change"],validator:(t,a)=>a==null||a===""?new Error("请选择服务类型"):typeof a=="number"&&(a===0||a===1)?!0:new Error("请选择有效的服务类型")}]},{field:"serviceDesc",label:"服务描述",type:"textarea",placeholder:"请输入服务描述",span:24,tabKey:"basic",tips:"服务的详细描述信息，用于说明服务的用途和功能",props:{rows:3}},{field:"loadBalanceStrategy",label:"负载均衡策略",type:"select",placeholder:"请选择负载均衡策略",span:12,tabKey:"loadbalance",required:!0,show:t=>t.serviceType===H.STATIC,defaultValue:z.ROUND_ROBIN,tips:"轮询：按顺序依次分发请求；随机：随机选择节点；IP哈希：根据客户端IP哈希选择节点；最少连接：选择连接数最少的节点；加权轮询：根据节点权重轮询；一致性哈希：保证相同请求路由到同一节点",options:[{label:"轮询算法",value:z.ROUND_ROBIN},{label:"随机算法",value:z.RANDOM},{label:"IP哈希算法",value:z.IP_HASH},{label:"最少连接算法",value:z.LEAST_CONN},{label:"加权轮询算法",value:z.WEIGHTED_ROUND_ROBIN},{label:"一致性哈希算法",value:z.CONSISTENT_HASH}],rules:[{required:!0,message:"请选择负载均衡策略",trigger:["blur","change"],validator:(t,a,d)=>d.serviceType===H.STATIC&&(a==null||a==="")?new Error("请选择负载均衡策略"):!0}]},{field:"sessionAffinity",label:"会话亲和性",type:"switch",span:12,tabKey:"loadbalance",show:t=>t.serviceType===H.STATIC,defaultValue:"N",tips:"启用后，同一客户端的请求会尽量路由到同一个后端节点，保证会话状态的一致性",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"stickySession",label:"粘性会话",type:"switch",span:12,tabKey:"loadbalance",show:t=>t.serviceType===H.STATIC,defaultValue:"N",tips:"启用后，通过Cookie等方式强制将同一会话的请求路由到固定的后端节点",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"maxRetries",label:"最大重试次数",type:"number",placeholder:"3",span:12,tabKey:"loadbalance",show:t=>t.serviceType===H.STATIC,defaultValue:3,tips:"当请求失败时，最多重试的次数。范围0-10，0表示不重试",props:{min:0,max:10},rules:[{required:!0,message:"请输入最大重试次数",trigger:["blur","change"],validator:(t,a)=>{if(a==null||a==="")return new Error("请输入最大重试次数");const d=Number(a);return isNaN(d)||d<0||d>10?new Error("重试次数必须在0-10之间"):!0}}]},{field:"retryTimeoutMs",label:"重试超时时间(ms)",type:"number",placeholder:"5000",span:12,tabKey:"loadbalance",show:t=>t.serviceType===H.STATIC,defaultValue:5e3,tips:"每次重试请求的超时时间（毫秒）。范围100-60000ms",props:{min:100,max:6e4},rules:[{required:!0,message:"请输入重试超时时间",trigger:["blur","change"],validator:(t,a)=>{if(a==null||a==="")return new Error("请输入重试超时时间");const d=Number(a);return isNaN(d)||d<100||d>6e4?new Error("超时时间必须在100-60000毫秒之间"):!0}}]},{field:"enableCircuitBreaker",label:"启用熔断器",type:"switch",span:12,tabKey:"loadbalance",show:t=>t.serviceType===H.STATIC,defaultValue:"N",tips:"启用后，当服务节点故障率过高时自动熔断，避免大量请求打到故障节点",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"healthCheckEnabled",label:"启用健康检查",type:"switch",span:24,tabKey:"health",show:t=>t.serviceType===H.STATIC,defaultValue:"N",tips:"启用后，网关会定期检查后端节点的健康状态，自动剔除不健康的节点",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"healthCheckPath",label:"检查路径",type:"input",placeholder:"/health",span:12,tabKey:"health",show:t=>t.serviceType===H.STATIC&&t.healthCheckEnabled==="Y",defaultValue:"/health",tips:"健康检查请求的URL路径，通常是后端服务提供的健康检查接口",rules:[{required:!0,message:"请输入健康检查路径",trigger:["blur","input"],validator:(t,a,d)=>d.healthCheckEnabled==="Y"&&(!a||a.trim()==="")?new Error("请输入健康检查路径"):!0}]},{field:"healthCheckMethod",label:"检查方法",type:"select",placeholder:"请选择检查方法",span:12,tabKey:"health",show:t=>t.serviceType===H.STATIC&&t.healthCheckEnabled==="Y",defaultValue:"GET",tips:"健康检查使用的HTTP方法，通常使用GET或HEAD方法",options:[{label:"GET",value:"GET"},{label:"POST",value:"POST"},{label:"HEAD",value:"HEAD"}],rules:[{required:!0,message:"请选择健康检查方法",trigger:["blur","change"],validator:(t,a,d)=>d.healthCheckEnabled==="Y"&&(!a||a==="")?new Error("请选择健康检查方法"):!0}]},{field:"healthCheckIntervalSeconds",label:"检查间隔(秒)",type:"number",placeholder:"30",span:12,tabKey:"health",show:t=>t.serviceType===H.STATIC&&t.healthCheckEnabled==="Y",defaultValue:30,tips:"两次健康检查之间的时间间隔（秒）。范围1-300秒",props:{min:1,max:300},rules:[{required:!0,message:"请输入检查间隔",trigger:["blur","change"],validator:(t,a,d)=>d.healthCheckEnabled==="Y"&&(a==null||a==="")?new Error("请输入检查间隔"):!0}]},{field:"healthCheckTimeoutMs",label:"检查超时(ms)",type:"number",placeholder:"5000",span:12,tabKey:"health",show:t=>t.serviceType===H.STATIC&&t.healthCheckEnabled==="Y",defaultValue:5e3,tips:"健康检查请求的超时时间（毫秒），超时则视为检查失败。范围100-30000ms",props:{min:100,max:3e4},rules:[{required:!0,message:"请输入检查超时",trigger:["blur","change"],validator:(t,a,d)=>d.healthCheckEnabled==="Y"&&(a==null||a==="")?new Error("请输入检查超时"):!0}]},{field:"healthyThreshold",label:"健康阈值",type:"number",placeholder:"2",span:12,tabKey:"health",show:t=>t.serviceType===H.STATIC&&t.healthCheckEnabled==="Y",defaultValue:2,tips:"连续成功检查次数达到此值时，节点从 unhealthy 转为 healthy。范围1-10",props:{min:1,max:10},rules:[{required:!0,message:"请输入健康阈值",trigger:["blur","change"],validator:(t,a,d)=>d.healthCheckEnabled==="Y"&&(a==null||a==="")?new Error("请输入健康阈值"):!0}]},{field:"unhealthyThreshold",label:"不健康阈值",type:"number",placeholder:"3",span:12,tabKey:"health",show:t=>t.serviceType===H.STATIC&&t.healthCheckEnabled==="Y",defaultValue:3,tips:"连续失败检查次数达到此值时，节点从 healthy 转为 unhealthy。范围1-10",props:{min:1,max:10},rules:[{required:!0,message:"请输入不健康阈值",trigger:["blur","change"],validator:(t,a,d)=>d.healthCheckEnabled==="Y"&&(a==null||a==="")?new Error("请输入不健康阈值"):!0}]},{field:"expectedStatusCodes",label:"期望状态码",type:"input",placeholder:"200,201,204",span:24,tabKey:"health",show:t=>t.serviceType===H.STATIC&&t.healthCheckEnabled==="Y",defaultValue:"200",tips:"健康检查视为成功的HTTP状态码，支持逗号分隔多个值（如：200,201,204）或JSON数组格式",rules:[{required:!0,message:"请输入期望状态码",trigger:["blur","input"],validator:(t,a,d)=>d.healthCheckEnabled==="Y"&&(!a||a.trim()==="")?new Error("请输入期望状态码"):!0}]},{field:"discoveryType",label:"发现类型",type:"select",placeholder:"请选择服务发现类型",span:12,tabKey:"discovery",show:t=>t.serviceType===H.DISCOVERY,disabled:!0,defaultValue:"REGISTRY",tips:"服务发现类型，当前仅支持从服务注册中心发现服务实例",options:[{label:"服务注册",value:"REGISTRY"}]},{field:"serviceMetadata",label:"服务元数据",type:"textarea",placeholder:"{}",span:24,tabKey:"discovery",show:!1,props:{rows:5},tips:"服务元数据，包含从服务注册中心选择的服务信息（JSON格式）"},{field:"serviceSelection",label:"注册服务",type:"custom",span:24,tabKey:"discovery",show:t=>t.serviceType===H.DISCOVERY,tips:"从服务注册中心选择一个可用的服务，选择后会自动填充服务元数据",render:(t,a)=>{var e;const d=((e=a==null?void 0:a.selectedService)==null?void 0:e.value)||null,M=a==null?void 0:a.onServiceChange,n=(a==null?void 0:a.to)||"body";return ee(ea,{modelValue:d,to:n,"onUpdate:modelValue":s=>{M==null||M(s)},onChange:s=>{M==null||M(s)}})}},{field:"discoveryConfig",label:"发现配置",type:"textarea",placeholder:"{}",span:24,tabKey:"discovery",show:!1,props:{rows:5}},{field:"activeFlag",label:"启用状态",type:"switch",span:12,tabKey:"other",defaultValue:"Y",tips:"控制服务定义是否启用，禁用的服务不会被加载到网关",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"noteText",label:"备注信息",type:"textarea",placeholder:"请输入备注信息",span:24,tabKey:"other",tips:"服务的额外备注信息，用于记录配置说明或其他相关信息",props:{rows:4}},{field:"addTime",label:"创建时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"addWho",label:"创建人",type:"input",span:12,tabKey:"other",disabled:!0},{field:"editTime",label:"修改时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"editWho",label:"修改人",type:"input",span:12,tabKey:"other",disabled:!0}]};return{moduleId:o,loading:y,serviceList:i,pageInfo:h,searchFormConfig:u,serviceFormConfig:l,gridConfig:{columns:[{field:"serviceDefinitionId",title:"服务定义ID",visible:!1,width:0},{field:"serviceName",title:"服务名称",sortable:!0,align:"center",showOverflow:"tooltip",width:200},{field:"serviceDesc",title:"服务描述",align:"center",showOverflow:"tooltip",width:200},{field:"serviceType",title:"服务类型",align:"center",slots:{default:"serviceType"},width:120},{field:"loadBalanceStrategy",title:"负载均衡策略",align:"center",slots:{default:"loadBalanceStrategy"},width:150},{field:"nodeCount",title:"服务节点",align:"center",formatter:()=>"0",width:100},{field:"sessionAffinity",title:"会话亲和性",align:"center",slots:{default:"sessionAffinity"},width:120},{field:"maxRetries",title:"最大重试",align:"center",width:100},{field:"enableCircuitBreaker",title:"熔断器",align:"center",slots:{default:"enableCircuitBreaker"},width:100},{field:"healthCheckEnabled",title:"健康检查",align:"center",slots:{default:"healthCheckEnabled"},width:120},{field:"healthCheckPath",title:"检查路径",align:"center",showOverflow:"tooltip",width:150},{field:"activeFlag",title:"状态",align:"center",slots:{default:"activeFlag"},width:100},{field:"addTime",title:"创建时间",sortable:!0,align:"center",showOverflow:!0,formatter:({cellValue:t})=>t?re(t,"YYYY-MM-DD HH:mm:ss"):"",width:180},{field:"addWho",title:"创建人",align:"center",showOverflow:!0,width:120},{field:"editTime",title:"修改时间",sortable:!0,align:"center",showOverflow:!0,formatter:({cellValue:t})=>t?re(t,"YYYY-MM-DD HH:mm:ss"):"",width:180},{field:"editWho",title:"修改人",align:"center",showOverflow:!0,width:120}],showCheckbox:!0,paginationConfig:{show:!0,pageInfo:h,align:"right"},menuConfig:{enabled:!0,showCopyRow:!0,showCopyCell:!0,customMenus:[{code:"edit",name:"编辑",prefixIcon:"vxe-icon-edit"},{code:"manageNodes",name:"节点管理",prefixIcon:"vxe-icon-setting"},{code:"delete",name:"删除",prefixIcon:"vxe-icon-delete"}]},height:"100%",rowId:"serviceDefinitionId"},resetPagination:()=>{h.value=void 0},updatePagination:t=>{h.value?Object.assign(h.value,t):h.value=t},setServiceList:t=>{i.value=t},addServiceToList:t=>{i.value.push(t)},updateServiceInList:t=>{const a=i.value.findIndex(d=>d.serviceDefinitionId===t.serviceDefinitionId);a>=0&&Object.assign(i.value[a],t)},removeServiceFromList:t=>{const a=i.value.findIndex(d=>d.serviceDefinitionId===t);a>=0&&i.value.splice(a,1)},removeServicesFromList:t=>{i.value=i.value.filter(a=>!t.includes(a.serviceDefinitionId))}}}function aa(o,y){const i=Q(),h=Ae(),u=ta(),{loading:l,serviceList:b,pageInfo:c,setServiceList:S,updatePagination:E,addServiceToList:N,updateServiceInList:F,removeServiceFromList:V,removeServicesFromList:D}=u,t=async f=>{var v,w,x;l.value=!0;try{let U=f;!U&&((v=y==null?void 0:y.value)!=null&&v.getFormData)&&(U=y.value.getFormData()||{});const j=U?Object.fromEntries(Object.entries(U).filter(([,T])=>T!==""&&T!==null&&T!==void 0)):{},g={...j,...j.proxyConfigId===void 0&&o?{proxyConfigId:o}:{},...Fe((w=c.value)==null?void 0:w.pageIndex,(x=c.value)==null?void 0:x.pageSize)},P=await it(g);if(P.oK){if(P.bizData){const T=JSON.parse(P.bizData),L=Array.isArray(T)?T:[];S(L)}if(P.pageQueryData){const T=JSON.parse(P.pageQueryData);E(T)}}else i.error(P.errMsg||"查询服务定义列表失败")}catch{i.error("加载服务定义列表失败")}finally{l.value=!1}};return{model:u,loadServiceList:t,handleSearch:async f=>{await t(f)},handleReset:async()=>{u.resetPagination(),await t()},handlePageChange:async({currentPage:f,pageSize:v})=>{E({pageIndex:f,pageSize:v}),await t()},addService:async f=>{l.value=!0;try{const v=await ot(f);if(B(v)){const w=Y(v,"服务定义创建成功");if(i.success(w),v.bizData){const x=JSON.parse(v.bizData);N(x)}else await t();return!0}else{const w=Y(v,"新增服务定义失败");return i.error(w),!1}}catch{return i.error("新增服务定义失败"),!1}finally{l.value=!1}},editService:async(f,v)=>{l.value=!0;try{const w=await ye({...v,serviceDefinitionId:f});if(B(w)){const x=Y(w,"服务定义更新成功");if(i.success(x),w.bizData){const U=JSON.parse(w.bizData);F(U)}else await t();return!0}else{const x=Y(w,"更新服务定义失败");return i.error(x),!1}}catch{return i.error("更新服务定义失败"),!1}finally{l.value=!1}},deleteService:async f=>{const v=b.value.find(x=>x.serviceDefinitionId===f);if(!v)return i.error("未找到要删除的服务定义"),!1;if(!await h.warning({title:"确认删除",subtitle:"此操作不可恢复，请谨慎操作",content:`确定要删除服务定义 "${v.serviceName||v.serviceDefinitionId}" 吗？`,icon:ve,headerStyle:"gradient",positiveText:"确定删除",negativeText:"取消",width:500}))return!1;l.value=!0;try{const x=await _e(f,"default");return x.oK?(i.success(Y(x,"删除服务定义成功")),V(f),b.value.length===0&&c.value&&c.value.pageIndex>1?(E({pageIndex:c.value.pageIndex-1}),await t()):await t(),!0):(i.error(Y(x,"删除服务定义失败")),!1)}catch{return i.error("删除服务定义失败"),!1}finally{l.value=!1}},batchDeleteServices:async f=>{if(await h.warning({title:"确认批量删除",subtitle:"此操作不可恢复，请谨慎操作",content:`确定要删除选中的 ${f.length} 个服务定义吗？`,icon:ve,headerStyle:"gradient",positiveText:"确定删除",negativeText:"取消",width:500})){l.value=!0;try{let w=0,x=0;for(const U of f)try{(await _e(U,"default")).oK?w++:x++}catch{x++}w>0?(i.success(`成功删除 ${w} 个服务定义${x>0?`，失败 ${x} 个`:""}`),D(f.slice(0,w)),await t()):i.error(`删除失败，共 ${x} 个`)}catch{i.error("批量删除失败")}finally{l.value=!1}}},toggleServiceStatus:async f=>{const v=f.activeFlag==="Y"?"N":"Y",w=v==="Y"?"启用":"禁用";try{const x=await ye({serviceDefinitionId:f.serviceDefinitionId,tenantId:"default",activeFlag:v});x.oK?(i.success(`${w}成功`),F({...f,activeFlag:v}),await t()):i.error(x.errMsg||`${w}失败`)}catch{i.error(`${w}失败`)}},batchToggleServiceStatus:async(f,v)=>{const w=v==="Y"?"启用":"禁用";try{const x=f.map(g=>ye({serviceDefinitionId:g,tenantId:"default",activeFlag:v})),j=(await Promise.all(x)).filter(g=>g.oK).length;j===f.length?i.success(`成功${w} ${j} 个服务定义`):i.warning(`${w}了 ${j}/${f.length} 个服务定义`),await t()}catch{i.error(`批量${w}失败`)}}}}function ra(o,y,i){const h=Q(),u=O(null),l=aa(o,y),b=O(!1),c=O("create"),S=O(null),E=O(!1),N=O(""),F=g=>{const P=A=>{if(typeof A=="string"&&A)try{return JSON.parse(A)}catch{return A}return A},T={...g};return["discoveryConfig","healthCheckHeaders","loadBalancerConfig"].forEach(A=>{const G=P(g[A]);G&&typeof G=="object"&&!Array.isArray(G)&&(Object.keys(G).forEach(X=>{T[`${A}.${X}`]=G[X]}),delete T[A])}),T.serviceMetadata&&typeof T.serviceMetadata=="string"||(T.serviceMetadata&&typeof T.serviceMetadata=="object"?T.serviceMetadata=JSON.stringify(T.serviceMetadata):T.serviceMetadata=void 0),T},V=g=>{const P=["discoveryConfig","healthCheckHeaders","loadBalancerConfig"],T={};if(P.forEach(L=>{const A={};Object.keys(g).forEach(G=>{if(G.startsWith(`${L}.`)){const X=G.replace(`${L}.`,"");A[X]=g[G]}}),Object.keys(A).length>0&&(T[L]=JSON.stringify(A))}),g.serviceMetadata)if(typeof g.serviceMetadata=="string")try{JSON.parse(g.serviceMetadata),T.serviceMetadata=g.serviceMetadata}catch{T.serviceMetadata="{}"}else typeof g.serviceMetadata=="object"?T.serviceMetadata=JSON.stringify(g.serviceMetadata):T.serviceMetadata="{}";else T.serviceMetadata=void 0;return Object.keys(g).forEach(L=>{!P.some(A=>L.startsWith(`${A}.`))&&L!=="serviceMetadata"&&(T[L]=g[L])}),T},D=(g=!0)=>o?!0:(g&&h.warning("请先选择网关实例"),!1),t=()=>{D()&&(c.value="create",S.value=null,u.value=null,b.value=!0)},a=async g=>{if(D())try{const P=await ke(g.serviceDefinitionId,"default");if(B(P)){const T=JSON.parse(P.bizData),L=F(T);c.value="edit",S.value=L,b.value=!0}else h.error(Y(P,"获取服务定义详情失败"))}catch{h.error("获取服务定义详情失败")}},d=async g=>{if(D())try{const P=await ke(g.serviceDefinitionId,"default");if(B(P)){const T=JSON.parse(P.bizData),A={...F(T),serviceDefinitionId:void 0,serviceName:`${T.serviceName}_copy`,activeFlag:"Y"};c.value="create",S.value=A,b.value=!0}else h.error(Y(P,"获取服务定义详情失败"))}catch{h.error("获取服务定义详情失败")}},M=g=>{D()&&(N.value=g.serviceDefinitionId,E.value=!0)},n=()=>{b.value=!1,S.value=null,u.value=null},e=async g=>{if(g&&c.value!=="view"){if(!D())return!1;if(g.serviceType===1){if(u.value)_(g);else if(!g.serviceMetadata)return h.warning("请选择注册服务"),!1}try{const T={...V(g),tenantId:"default",proxyConfigId:o||g.proxyConfigId};let L=!1;c.value==="create"?L=await l.addService(T):c.value==="edit"&&S.value&&(L=await l.editService(S.value.serviceDefinitionId,T)),L&&n()}catch{h.error("操作失败")}}},s=g=>{u.value=g,g?console.log("已选择服务:",g.serviceName):console.log("已清除服务选择")},_=g=>{if(u.value){const P={tenantId:u.value.tenantId||"default",namespaceId:u.value.namespaceId,groupName:u.value.groupName||"DEFAULT_GROUP",serviceName:u.value.serviceName,discoveryType:"servicecenter",protocolType:u.value.protocolType||"http"},T=JSON.stringify(P);return g&&(g.serviceMetadata=T),console.log("已更新服务元数据（registry_utils.go 兼容格式）:",P),T}else{g&&(g.serviceMetadata=void 0);return}},p=async g=>{D()&&await l.deleteService(g.serviceDefinitionId)},m=async()=>{var T,L,A,G;if(!D())return;if(!(i!=null&&i.value)){h.warning("Grid 引用未设置");return}const g=((L=(T=i.value).getCheckboxRecords)==null?void 0:L.call(T))||((G=(A=i.value).getSelectRecords)==null?void 0:G.call(A))||[];if(g.length===0){h.warning("请选择要删除的服务定义");return}const P=g.map(X=>X.serviceDefinitionId);await l.batchDeleteServices(P)},f=async g=>{if(!D())return;const P=g?{...g,...o?{proxyConfigId:o}:{}}:o?{proxyConfigId:o}:void 0;await l.handleSearch(P)},v=async(g,P)=>{var T,L,A,G,X,Ce,Ie,xe,Pe,Ne;switch(g){case"add":t();break;case"delete":{if(!(i!=null&&i.value)){h.warning("Grid 引用未设置");return}const ne=((L=(T=i.value).getCheckboxRecords)==null?void 0:L.call(T))||((G=(A=i.value).getSelectRecords)==null?void 0:G.call(A))||[];if(ne.length===0){h.warning("请选择要删除的服务定义");return}const ce=ne.map(Re=>Re.serviceDefinitionId);await l.batchDeleteServices(ce);break}case"manageNodes":{if(!(i!=null&&i.value)){h.warning("Grid 引用未设置");return}const ne=(Ce=(X=i.value).getCurrentRecord)==null?void 0:Ce.call(X);if(ne){M(ne);return}const ce=((xe=(Ie=i.value).getCheckboxRecords)==null?void 0:xe.call(Ie))||((Ne=(Pe=i.value).getSelectRecords)==null?void 0:Ne.call(Pe))||[];if(ce.length===0){h.warning("请先点击选择要管理的服务定义");return}if(ce.length>1){h.warning("请选择单个服务定义进行节点管理");return}M(ce[0]);break}case"search":{await f(P);break}}},w=({code:g,row:P})=>{if(P)switch(g){case"edit":a(P);break;case"manageNodes":M(P);break;case"copy":d(P);break;case"delete":p(P);break}},x=()=>{l.loadServiceList()},U=async()=>{o?await l.loadServiceList({proxyConfigId:o}):await l.loadServiceList()};o&&Ke(()=>{l.loadServiceList({proxyConfigId:o})});const j=l.model.serviceFormConfig.fields.map(g=>{if(g.field==="serviceSelection"&&g.render){const P=g.render;return{...g,render:T=>P(T,{selectedService:u,onServiceChange:s,to:"#hub0022-service-definition-list"})}}return g});return{service:{...l,model:{...l.model,serviceFormConfig:{...l.model.serviceFormConfig,fields:j}}},formDialogVisible:b,formDialogMode:c,currentEditService:S,showNodeDialog:E,currentServiceId:N,selectedService:u,openAddDialog:t,openEditDialog:a,openCopyDialog:d,openNodeDialog:M,closeFormDialog:n,handleFormSubmit:e,handleDelete:p,handleBatchDelete:m,handleSearch:f,handleToolbarClick:v,handleMenuClick:w,refresh:x,loadServiceList:U,handleServiceChange:s,updateServiceMetadata:_}}const la={class:"service-definition-list",id:"hub0022-service-definition-list"},ia=oe({name:"ServiceDefinitionList",__name:"ServiceDefinitionList",props:{gatewayInstanceId:{default:void 0}},setup(o){const y=o,i=O(),h=O(),{service:u,formDialogVisible:l,formDialogMode:b,currentEditService:c,showNodeDialog:S,currentServiceId:E,handleFormSubmit:N,handleToolbarClick:F,handleMenuClick:V}=ra(y.gatewayInstanceId,i,h),D=ie(()=>y.gatewayInstanceId,(d,M)=>{d&&d!==M?u.loadServiceList({proxyConfigId:d}):!d&&M&&(u.model.serviceList.value=[])},{immediate:!1});ue(()=>{D()});function t(d){if(!y.gatewayInstanceId)return;const M=d?{...d,...y.gatewayInstanceId?{proxyConfigId:y.gatewayInstanceId}:{}}:y.gatewayInstanceId?{proxyConfigId:y.gatewayInstanceId}:void 0;u.handleSearch(M)}function a(d){return{[z.ROUND_ROBIN]:"轮询",[z.RANDOM]:"随机",[z.IP_HASH]:"IP哈希",[z.LEAST_CONN]:"最少连接",[z.WEIGHTED_ROUND_ROBIN]:"加权轮询",[z.CONSISTENT_HASH]:"一致性哈希"}[d]||d}return(d,M)=>(J(),te("div",la,[C(r(be),{direction:"vertical","default-size":"80px"},{1:I(()=>[C(Te,fe({ref_key:"searchFormRef",ref:i,"module-id":r(u).model.moduleId},r(u).model.searchFormConfig,{onSearch:t,onToolbarClick:r(F)}),null,16,["module-id","onToolbarClick"])]),2:I(()=>[C(r(we),fe({ref_key:"gridRef",ref:h,"module-id":r(u).model.moduleId,data:r(u).model.serviceList,loading:r(u).model.loading},r(u).model.gridConfig,{onPageChange:r(u).handlePageChange,onMenuClick:r(V)}),{serviceType:I(({row:n})=>[C(r(W),{type:n.serviceType===0?"info":"success",size:"small"},{default:I(()=>[$(R(n.serviceType===0?"静态配置":"服务发现"),1)]),_:2},1032,["type"])]),loadBalanceStrategy:I(({row:n})=>[C(r(W),{type:"default",size:"small"},{default:I(()=>[$(R(a(n.loadBalanceStrategy)),1)]),_:2},1024)]),sessionAffinity:I(({row:n})=>[C(r(W),{type:n.sessionAffinity==="Y"?"success":"default",size:"small"},{default:I(()=>[$(R(n.sessionAffinity==="Y"?"启用":"未启用"),1)]),_:2},1032,["type"])]),enableCircuitBreaker:I(({row:n})=>[C(r(W),{type:n.enableCircuitBreaker==="Y"?"warning":"default",size:"small"},{default:I(()=>[$(R(n.enableCircuitBreaker==="Y"?"启用":"未启用"),1)]),_:2},1032,["type"])]),healthCheckEnabled:I(({row:n})=>[C(r(W),{type:n.healthCheckEnabled==="Y"?"success":"default",size:"small"},{default:I(()=>[$(R(n.healthCheckEnabled==="Y"?"已启用":"未启用"),1)]),_:2},1032,["type"])]),activeFlag:I(({row:n})=>[C(r(W),{type:n.activeFlag==="Y"?"success":"error",size:"small"},{default:I(()=>[$(R(n.activeFlag==="Y"?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1},16,["module-id","data","loading","onPageChange","onMenuClick"])]),_:1}),C(me,{visible:r(l),"onUpdate:visible":M[0]||(M[0]=n=>ge(l)?l.value=n:null),mode:r(b),title:r(b)==="create"?"新增服务定义":r(b)==="edit"?"编辑服务定义":"查看服务定义详情",to:"#hub0022-service-definition-list","form-fields":r(u).model.serviceFormConfig.fields,"form-tabs":r(u).model.serviceFormConfig.tabs,"initial-data":r(c)||void 0,"auto-close-on-confirm":!1,"confirm-loading":r(u).model.loading.value,onSubmit:r(N)},null,8,["visible","mode","title","form-fields","form-tabs","initial-data","confirm-loading","onSubmit"]),C(r(kt),{visible:r(S),"onUpdate:visible":M[1]||(M[1]=n=>ge(S)?S.value=n:null),"service-definition-id":r(E),title:"服务节点管理",width:1200,to:"#hub0022-service-definition-list"},null,8,["visible","service-definition-id"])]))}}),oa=se(ia,[["__scopeId","data-v-ffee8dd0"]]),sa={class:"left-panel"},Me="proxy-management",na=oe({name:"ProxyManagement",__name:"ProxyManagement",setup(o){const y=O(""),i=ae(()=>y.value||"");function h(u,l){y.value=u}return(u,l)=>(J(),te("div",{class:"proxy-management",id:Me},[C(r(be),{direction:"horizontal","default-size":.25,max:.4},{1:I(()=>[K("div",sa,[C(r(St),{"parent-module-id":Me,onSelect:h})])]),2:I(()=>[(J(),de(oa,{"gateway-instance-id":i.value,key:`service-${i.value}`},null,8,["gateway-instance-id"]))]),_:1})]))}}),La=se(na,[["__scopeId","data-v-adc92ac8"]]);export{La as default};
