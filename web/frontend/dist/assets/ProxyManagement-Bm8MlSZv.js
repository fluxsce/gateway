import{G as Te}from"./GPane-w_mkAzRd.js";import{G as we}from"./GDataFormModal-B5dffEod.js";import{g as Ze,c as Re,G as Se,S as Ce}from"./SearchForm-C0DQDEEE.js";import{G as Qe}from"./GTree-DZWHLqrX.js";import{af as et,T as le,j as ie,r as E,i as ee,m as re,z as W,A as ne,d4 as ze,a7 as se,av as pe,B as Y,aO as B,d as ce,q as Ue,c as ae,o as J,f as V,h as $e,b as I,e as r,w as N,J as fe,G as tt,cq as We,I as at,g as ue,ab as rt,_ as de,aa as oe,am as ve,K as U,t as z,cr as me,aQ as lt,cF as Ke}from"./index-DVVs4J_g.js";import{A as Ie}from"./AddOutline-D7WMths6.js";import{S as he}from"./ServerOutline-BkLyZQ8B.js";import{R as Be}from"./RefreshOutline-ZMKO-4DG.js";import{G as Ge}from"./GModal-xYfXS7HF.js";import"./GPagination.vue_vue_type_style_index_0_scoped_2c35df38_lang-rwsE82tp.js";import{u as qe}from"./useGDialog-DWN8tM1R.js";import{C as it}from"./CreateOutline-DNze2007.js";import{T as Je}from"./TrashOutline-dLMtYZFW.js";import{W as ye}from"./WarningOutline-CPh7mSpG.js";import{u as ot,g as nt}from"./useServiceService-BMbo4H4r.js";import{C as st}from"./CloseOutline-CI2J8g02.js";import{S as A,L as $}from"./types-BgPBDzuW.js";import"./index-CkZRWLYS.js";import"./Select-DNy4pOft.js";import"./DownloadOutline-CFQ2kwN6.js";import"./Upload-KD8QX-hv.js";import"./download-C2161hUv.js";import"./DocumentOutline-CUl-N0py.js";import"./CopyOutline-FboIzOGU.js";import"./Checkbox-3N_QcxT8.js";import"./ContractOutline-keSydpIS.js";import"./GDialog-0ZeiOrqn.js";const q=et("/gateway/hub0022");async function ct(o){return q.post("/queryAllGatewayInstances",o)}async function dt(o){return q.post("/getProxyConfigsByInstance",{gatewayInstanceId:o})}async function ut(o){return q.post("/addProxyConfig",o)}async function pt(o){return q.post("/editProxyConfig",o)}async function ft(o){return q.post("/queryServiceDefinitions",o)}async function ge(o,g){return q.post("/getServiceDefinition",{serviceDefinitionId:o,tenantId:g})}async function vt(o){return q.post("/addServiceDefinition",o)}async function be(o){return q.post("/editServiceDefinition",o)}async function Ve(o,g){return q.post("/deleteServiceDefinition",{serviceDefinitionId:o,tenantId:g})}async function ht(o){return q.post("/queryServiceNodes",o)}async function He(o,g){return q.post("/getServiceNode",{serviceNodeId:o,tenantId:g})}async function yt(o){return q.post("/addServiceNode",o)}async function gt(o){return q.post("/editServiceNode",o)}async function bt(o,g){return q.post("/deleteServiceNode",{serviceNodeId:o,tenantId:g})}async function mt(o){return q.post("/batchDeleteServiceNodes",{serviceNodeIds:o,tenantId:"default"})}var M=(o=>(o.HTTP="http",o.WEBSOCKET="websocket",o.TCP="tcp",o.UDP="udp",o))(M||{});function Tt(){const o="hub0022",g=E(!1),l=E([]),p=E(1),c=E(20),i=E(0),b=E(""),u=ie(()=>l.value.map(e=>({key:e.gatewayInstanceId,label:C(e),instance:e})));function C(e){const n=e.tlsEnabled==="Y"?e.httpsPort:e.httpPort;return`${e.instanceName||"未命名"} (${e.bindAddress||"-"}:${n||"-"})`}function k(e){l.value=e}function _(e){g.value=e}function F(e){p.value=e}function H(e){c.value=e}function L(e){b.value=e}function t(e){i.value=e}function a(){p.value=1}function d(){b.value=""}const D={enabled:!0,showCopyNode:!0,customMenus:[{code:"addProxy",name:"代理配置",prefixIcon:()=>le(ee,{size:14},{default:()=>le(Ie)})}]},s={tabs:[{key:"basic",label:"基本信息"},{key:"http",label:"HTTP配置",show:e=>e.proxyType===M.HTTP},{key:"websocket",label:"WebSocket配置",show:e=>e.proxyType===M.WEBSOCKET},{key:"tcp",label:"TCP配置",show:e=>e.proxyType===M.TCP},{key:"udp",label:"UDP配置",show:e=>e.proxyType===M.UDP},{key:"custom",label:"其它"}],fields:[{field:"proxyConfigId",label:"代理配置ID",type:"input",span:12,tabKey:"basic",primary:!0,show:!1},{field:"gatewayInstanceId",label:"网关实例ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"tenantId",label:"租户ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"proxyName",label:"代理名称",type:"input",placeholder:"请输入代理名称",span:12,tabKey:"basic",required:!0,tips:"代理配置的唯一标识名称，用于区分不同的代理配置",rules:[{required:!0,message:"请输入代理名称",trigger:["blur","input"]},{max:50,message:"代理名称不能超过50个字符",trigger:["blur","input"]}]},{field:"proxyType",label:"代理类型",type:"select",placeholder:"请选择代理类型",span:12,tabKey:"basic",required:!0,defaultValue:M.HTTP,tips:"选择代理协议类型：HTTP(支持HTTP/HTTPS协议)、WebSocket(支持WebSocket协议)、TCP(支持TCP协议)、UDP(支持UDP协议)",options:[{label:"HTTP",value:M.HTTP},{label:"WebSocket",value:M.WEBSOCKET},{label:"TCP",value:M.TCP},{label:"UDP",value:M.UDP}],rules:[{required:!0,message:"请选择代理类型",trigger:["blur","change"]}]},{field:"configPriority",label:"配置优先级",type:"number",placeholder:"请输入配置优先级",span:12,tabKey:"basic",required:!0,defaultValue:100,tips:"配置优先级，数值越小优先级越高。当存在多个代理配置时，优先级高的配置会优先匹配",props:{min:0,max:999},rules:[{required:!0,message:"请输入优先级",trigger:["blur","change"],validator:(e,n)=>{if(n==null||n==="")return new Error("请输入优先级");const O=Number(n);return isNaN(O)?new Error("优先级必须是数字"):O<0||O>999?new Error("优先级必须是0-999之间的数字"):!0}}]},{field:"activeFlag",label:"状态",type:"switch",span:12,tabKey:"basic",defaultValue:"Y",tips:"代理配置的启用状态。启用后配置才会生效，禁用后代理将不会处理请求",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"noteText",label:"备注",type:"textarea",placeholder:"请输入备注信息",span:24,tabKey:"basic",tips:"代理配置的备注说明，用于记录配置的用途、注意事项等信息",props:{rows:3}},{field:"proxyConfig.httpVersion",label:"HTTP版本",type:"select",placeholder:"请选择HTTP版本",span:12,tabKey:"http",show:e=>e.proxyType===M.HTTP,defaultValue:"1.1",tips:"HTTP协议版本，HTTP/1.0 或 HTTP/1.1。HTTP/1.1 支持连接复用、管道化等特性，性能更好",options:[{label:"HTTP/1.0",value:"1.0"},{label:"HTTP/1.1",value:"1.1"}]},{field:"proxyConfig.connectTimeout",label:"连接超时（秒）",type:"number",placeholder:"请输入连接超时",span:12,tabKey:"http",show:e=>e.proxyType===M.HTTP,defaultValue:30,tips:"建立TCP连接的超时时间，超过此时间未建立连接则请求失败",props:{min:1}},{field:"proxyConfig.keepAlive",label:"保持连接",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===M.HTTP,defaultValue:!0,tips:"是否启用HTTP Keep-Alive连接复用。启用后可以复用TCP连接，提高性能，减少连接建立开销"},{field:"proxyConfig.maxIdleConns",label:"最大空闲连接数",type:"number",placeholder:"请输入最大空闲连接数",span:12,tabKey:"http",show:e=>e.proxyType===M.HTTP,defaultValue:100,tips:"连接池中保持的最大空闲连接数。空闲连接可以被复用，提高性能，但会占用内存资源",props:{min:0}},{field:"proxyConfig.idleConnTimeout",label:"空闲连接超时（秒）",type:"number",placeholder:"请输入空闲连接超时",span:12,tabKey:"http",show:e=>e.proxyType===M.HTTP,required:!0,defaultValue:90,tips:"连接池中空闲连接的最大保持时间，超过此时间的空闲连接会被关闭释放资源",props:{min:1,max:7200},rules:[{required:!0,message:"请输入空闲连接超时时间",trigger:["blur","change"],type:"number",validator:(e,n)=>n==null?new Error("请输入空闲连接超时时间"):n<1?new Error("空闲连接超时时间必须大于0秒"):n>7200?new Error("空闲连接超时时间不能超过7200秒"):!0}]},{field:"proxyConfig.timeout",label:"总超时时间（秒）",type:"number",placeholder:"请输入超时时间",span:12,tabKey:"http",show:e=>e.proxyType===M.HTTP,required:!0,defaultValue:60,tips:"请求的总超时时间（包括连接、发送、读取），超过此时间未完成则请求失败",props:{min:1,max:3600},rules:[{required:!0,message:"请输入超时时间",trigger:["blur","change"],type:"number",validator:(e,n)=>n==null?new Error("请输入超时时间"):n<1?new Error("超时时间必须大于0秒"):n>3600?new Error("超时时间不能超过3600秒"):!0}]},{field:"proxyConfig.sendTimeout",label:"发送超时（秒）",type:"number",placeholder:"请输入发送超时",span:12,tabKey:"http",show:e=>e.proxyType===M.HTTP,defaultValue:60,tips:"发送请求数据的超时时间，超过此时间未发送完成则请求失败",props:{min:1}},{field:"proxyConfig.readTimeout",label:"读取超时（秒）",type:"number",placeholder:"请输入读取超时",span:12,tabKey:"http",show:e=>e.proxyType===M.HTTP,defaultValue:60,tips:"读取响应数据的超时时间，超过此时间未读取完成则请求失败",props:{min:1}},{field:"proxyConfig.retryCount",label:"重试次数",type:"number",placeholder:"请输入重试次数",span:12,tabKey:"http",show:e=>e.proxyType===M.HTTP,defaultValue:0,tips:"请求失败时的自动重试次数。设置为0表示不重试",props:{min:0}},{field:"proxyConfig.retryTimeout",label:"重试超时（秒）",type:"number",placeholder:"请输入重试超时",span:12,tabKey:"http",show:e=>e.proxyType===M.HTTP,required:!0,defaultValue:30,tips:"每次重试的超时时间，如果单次重试超过此时间则重试失败，继续下一次重试",props:{min:1,max:300},rules:[{required:!0,message:"请输入重试超时时间",trigger:["blur","change"],type:"number",validator:(e,n)=>n==null?new Error("请输入重试超时时间"):n<1?new Error("重试超时时间必须大于0秒"):n>300?new Error("重试超时时间不能超过300秒"):!0}]},{field:"proxyConfig.proxyBuffering",label:"代理缓冲",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===M.HTTP,defaultValue:!0,tips:"是否启用代理缓冲。启用后会在代理层缓冲请求和响应，可以优化传输性能"},{field:"proxyConfig.bufferSize",label:"缓冲区大小（字节）",type:"number",placeholder:"请输入缓冲区大小",span:12,tabKey:"http",show:e=>e.proxyType===M.HTTP,defaultValue:4096,tips:"默认缓冲区大小，用于临时存储请求和响应数据",props:{min:0}},{field:"proxyConfig.maxBufferSize",label:"最大缓冲区大小（字节）",type:"number",placeholder:"请输入最大缓冲区大小",span:12,tabKey:"http",show:e=>e.proxyType===M.HTTP,defaultValue:65536,tips:"缓冲区的最大大小限制，防止缓冲区无限增长导致内存溢出",props:{min:0}},{field:"proxyConfig.copyResponseBody",label:"复制响应体",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===M.HTTP,defaultValue:!1,tips:"是否复制完整的响应体到内存。启用后可以多次读取响应，但会占用更多内存"},{field:"proxyConfig.followRedirects",label:"跟随重定向",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===M.HTTP,defaultValue:!1,tips:"是否自动跟随HTTP重定向响应（3xx状态码）。启用后会自动跳转到重定向地址"},{field:"proxyConfig.preserveHost",label:"保留原始Host",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===M.HTTP,defaultValue:!1,tips:"是否保留客户端原始Host请求头。启用后目标服务器会看到原始Host，而不是代理服务器的地址"},{field:"proxyConfig.addXForwardedFor",label:"添加X-Forwarded-For",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===M.HTTP,defaultValue:!0,tips:"是否添加X-Forwarded-For请求头，用于标识客户端的真实IP地址，方便目标服务器获取客户端信息"},{field:"proxyConfig.addXRealIP",label:"添加X-Real-IP",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===M.HTTP,defaultValue:!0,tips:"是否添加X-Real-IP请求头，用于标识客户端的真实IP地址，是X-Forwarded-For的简化版本"},{field:"proxyConfig.addXForwardedProto",label:"添加X-Forwarded-Proto",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===M.HTTP,defaultValue:!0,tips:"是否添加X-Forwarded-Proto请求头，用于标识客户端使用的协议（http或https）"},{field:"proxyConfig.tlsInsecureSkipVerify",label:"跳过TLS证书验证",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===M.HTTP,defaultValue:!1,tips:"是否跳过TLS证书验证（仅用于测试环境）。生产环境建议关闭以确保安全性"},{field:"proxyConfig.tlsMinVersion",label:"最小TLS版本",type:"select",placeholder:"请选择最小TLS版本",span:12,tabKey:"http",show:e=>e.proxyType===M.HTTP,defaultValue:"1.2",tips:"支持的最小TLS协议版本。低于此版本的连接将被拒绝，建议使用TLS 1.2或更高版本",options:[{label:"TLS 1.0",value:"1.0"},{label:"TLS 1.1",value:"1.1"},{label:"TLS 1.2",value:"1.2"},{label:"TLS 1.3",value:"1.3"}]},{field:"proxyConfig.tlsMaxVersion",label:"最大TLS版本",type:"select",placeholder:"请选择最大TLS版本",span:12,tabKey:"http",show:e=>e.proxyType===M.HTTP,defaultValue:"1.3",tips:"支持的最大TLS协议版本。高于此版本的连接将降级到此版本",options:[{label:"TLS 1.0",value:"1.0"},{label:"TLS 1.1",value:"1.1"},{label:"TLS 1.2",value:"1.2"},{label:"TLS 1.3",value:"1.3"}]},{field:"proxyConfig.tlsServerName",label:"TLS服务器名称",type:"input",placeholder:"请输入TLS服务器名称（可选）",span:12,tabKey:"http",show:e=>e.proxyType===M.HTTP,tips:"TLS SNI（Server Name Indication）服务器名称，用于指定要连接的服务器主机名，通常与证书域名匹配"},{field:"proxyConfig.pingInterval",label:"Ping间隔（秒）",type:"number",placeholder:"请输入Ping间隔",span:12,tabKey:"websocket",show:e=>e.proxyType===M.WEBSOCKET,defaultValue:30,tips:"WebSocket连接心跳检测的Ping消息发送间隔，用于保持连接活跃并检测连接状态",props:{min:1}},{field:"proxyConfig.pongTimeout",label:"Pong超时（秒）",type:"number",placeholder:"请输入Pong超时",span:12,tabKey:"websocket",show:e=>e.proxyType===M.WEBSOCKET,defaultValue:10,tips:"发送Ping消息后等待Pong响应的超时时间，超过此时间未收到Pong则视为连接断开",props:{min:1}},{field:"proxyConfig.maxMessageSize",label:"最大消息大小（字节）",type:"number",placeholder:"请输入最大消息大小",span:12,tabKey:"websocket",show:e=>e.proxyType===M.WEBSOCKET,defaultValue:32768,tips:"WebSocket单条消息的最大大小限制，超过此大小的消息将被拒绝，防止内存溢出",props:{min:0}},{field:"proxyConfig.enableCompression",label:"启用压缩",type:"switch",span:12,tabKey:"websocket",show:e=>e.proxyType===M.WEBSOCKET,defaultValue:!1,tips:"是否启用WebSocket消息压缩（permessage-deflate）。启用后可以减少网络传输量，但会增加CPU开销"},{field:"proxyConfig.connectTimeout",label:"连接超时（秒）",type:"number",placeholder:"请输入连接超时",span:12,tabKey:"tcp",show:e=>e.proxyType===M.TCP,defaultValue:5,tips:"建立TCP连接的超时时间，超过此时间未建立连接则连接失败",props:{min:1}},{field:"proxyConfig.keepAlive",label:"保持连接",type:"switch",span:12,tabKey:"tcp",show:e=>e.proxyType===M.TCP,defaultValue:!0,tips:"是否启用TCP Keep-Alive机制。启用后会定期发送探测包保持TCP连接活跃，及时发现断开的连接"},{field:"proxyConfig.bufferSize",label:"缓冲区大小（字节）",type:"number",placeholder:"请输入缓冲区大小",span:12,tabKey:"udp",show:e=>e.proxyType===M.UDP,defaultValue:4096,tips:"UDP数据包接收缓冲区大小，影响可以接收的最大UDP数据包大小",props:{min:1}},{field:"customConfig",label:"自定义配置",type:"textarea",placeholder:"{}",span:24,tabKey:"custom",tips:"自定义配置项（JSON格式），用于存储额外的配置参数，可根据实际需求扩展使用",props:{rows:5}},{field:"addTime",label:"创建时间",type:"datetime",span:12,tabKey:"custom",disabled:!0},{field:"addWho",label:"创建人",type:"input",span:12,tabKey:"custom",disabled:!0},{field:"editTime",label:"修改时间",type:"datetime",span:12,tabKey:"custom",disabled:!0},{field:"editWho",label:"修改人",type:"input",span:12,tabKey:"custom",disabled:!0}]};return{moduleId:o,loading:g,instanceList:l,currentPage:p,pageSize:c,totalCount:i,filterKeyword:b,treeData:u,treeMenuConfig:D,proxyFormConfig:s,getInstanceLabel:C,setInstanceList:k,setLoading:_,setCurrentPage:F,setPageSize:H,setTotalCount:t,setFilterKeyword:L,resetPage:a,clearFilter:d}}function wt(o){const g=re(),{loading:l,currentPage:p,pageSize:c,filterKeyword:i,setInstanceList:b,setTotalCount:u,setLoading:C,resetPage:k}=o;async function _(){try{C(!0);const F=await ct({activeFlag:"Y",instanceName:i.value.trim()||void 0,pageIndex:p.value,pageSize:c.value});if(W(F)){const H=ne(F,[]);b(Array.isArray(H)?H:[]);try{const L=ze(F);u(L.totalCount||0)}catch(L){console.warn("解析分页信息失败:",L),u(0)}}else g.error(F.errMsg||"获取网关实例列表失败"),b([]),u(0)}catch(F){console.error("加载网关实例失败:",F),g.error("加载网关实例失败"),b([]),u(0)}finally{C(!1)}}return{loadGatewayInstances:_}}function St(){const o=re(),g=Tt(),l=wt(g),p=E(!1),c=E("create"),i=E(null),b=E(!1),u=E(""),C=se(g.filterKeyword,()=>{g.resetPage(),l.loadGatewayInstances()});pe(()=>{C()});const k=f=>{const m=x=>{if(typeof x=="string"&&x)try{return JSON.parse(x)}catch{return x}return x},v={...f},y=m(f.proxyConfig);y&&typeof y=="object"&&!Array.isArray(y)&&(Object.keys(y).forEach(x=>{v[`proxyConfig.${x}`]=y[x]}),delete v.proxyConfig);const w=m(f.customConfig);if(w&&typeof w=="object")try{v.customConfig=JSON.stringify(w,null,2)}catch{v.customConfig="{}"}else v.customConfig="{}";return v},_=f=>{const m={};Object.keys(f).forEach(y=>{y.startsWith("proxyConfig.")||(m[y]=f[y])});const v={};if(Object.keys(f).forEach(y=>{if(y.startsWith("proxyConfig.")){const w=y.replace("proxyConfig.","");v[w]=f[y]}}),Object.keys(v).length>0?m.proxyConfig=JSON.stringify(v):m.proxyConfig="{}",f.customConfig)if(typeof f.customConfig=="string")try{JSON.parse(f.customConfig),m.customConfig=f.customConfig}catch{m.customConfig="{}"}else typeof f.customConfig=="object"?m.customConfig=JSON.stringify(f.customConfig):m.customConfig="{}";else m.customConfig="{}";return m},F=async()=>{const f=u.value;if(f)try{const m=await dt(f);if(W(m)){const v=ne(m,null);v?(i.value=v,c.value="edit"):(i.value=null,c.value="create")}else i.value=null,c.value="create"}catch{i.value=null,c.value="create"}},H=async f=>{u.value=f.gatewayInstanceId,await F(),p.value=!0},L=()=>{if(c.value==="create")return{gatewayInstanceId:u.value,proxyType:"http",configPriority:100,activeFlag:"Y"};if(i.value)return k(i.value)},t=async f=>{if(!f||c.value==="view")return!1;try{b.value=!0;const v={..._(f),tenantId:"default",gatewayInstanceId:u.value||f.gatewayInstanceId};let y=!1;if(c.value==="create"){const w=await ut(v);W(w)?(o.success(Y(w,"创建代理配置成功")),y=!0):o.error(Y(w,"创建代理配置失败"))}else if(c.value==="edit"&&i.value){const w=await pt({...v,proxyConfigId:i.value.proxyConfigId});W(w)?(o.success(Y(w,"更新代理配置成功")),y=!0):o.error(Y(w,"更新代理配置失败"))}return y&&await F(),y}catch{return o.error("操作失败"),!1}finally{b.value=!1}};function a({option:f}){return f.instance?le(ee,{size:16,color:"var(--g-primary)",style:{marginRight:"6px",flexShrink:0}},{default:()=>le(he)}):null}function d({option:f}){return le("span",{class:"tree-node-label",style:{display:"inline-block",padding:"1px 4px",borderRadius:"4px",transition:"background-color 0.2s"}},f.label)}function D({option:f}){const m=f;return m.instance?le(B,{type:m.instance.healthStatus==="Y"?"success":"warning",size:"small",style:{marginLeft:"8px",flexShrink:0}},{default:()=>m.instance.healthStatus==="Y"?"健康":"异常"}):null}function s(f,m,v){const y=m;y.instance&&v("select",y.instance.gatewayInstanceId,y.instance)}function e({currentPage:f,pageSize:m}){g.setCurrentPage(f),g.setPageSize(m),l.loadGatewayInstances()}function n(){l.loadGatewayInstances()}async function O({code:f,node:m}){if(!m)return;const v=m;if(!v.instance)return;const y=v.instance;switch(f){case"addProxy":await H(y);break}}return{model:g,service:l,proxyFormDialogVisible:p,proxyFormDialogMode:c,currentEditProxy:i,proxySubmitting:b,getProxyFormInitialData:L,renderNodePrefix:a,renderNodeLabel:d,renderNodeSuffix:D,handleTreeSelect:s,handlePageChange:e,handleRefresh:n,handleMenuClick:O,handleProxyFormSubmit:t}}const Ct={class:"gateway-instance-tree"},It={class:"instance-tree-header"},Nt={class:"instance-header"},xt={class:"instance-filter"},Pt={class:"instance-tree-container"},kt={key:0,class:"instance-pagination"},_t=ce({name:"GatewayInstanceTree",__name:"GatewayInstanceTree",props:{parentModuleId:{default:"proxy-management"}},emits:["select"],setup(o,{expose:g,emit:l}){const p=o,c=l,i=St();return Ue(()=>{i.service.loadGatewayInstances()}),g({refresh:i.service.loadGatewayInstances,resetPage:i.model.resetPage,clearFilter:i.model.clearFilter}),(b,u)=>(J(),ae("div",Ct,[V("div",It,[V("div",Nt,[I(r(ee),{size:"20",color:"var(--g-primary)"},{default:N(()=>[I(r(he))]),_:1}),u[3]||(u[3]=V("span",null,"网关实例列表",-1)),u[4]||(u[4]=V("div",{class:"flex-spacer"},null,-1)),I(r(fe),{text:"",size:"small",onClick:r(i).handleRefresh,disabled:r(i).model.loading.value,loading:r(i).model.loading.value},{icon:N(()=>[I(r(ee),{component:r(Be)},null,8,["component"])]),_:1},8,["onClick","disabled","loading"])]),V("div",xt,[I(r(tt),{value:r(i).model.filterKeyword.value,"onUpdate:value":u[0]||(u[0]=C=>r(i).model.filterKeyword.value=C),placeholder:"搜索实例名称、地址或端口",clearable:"",size:"small"},{prefix:N(()=>[I(r(ee),{component:r(We)},null,8,["component"])]),_:1},8,["value"])])]),V("div",Pt,[I(r(at),{show:r(i).model.loading.value},{default:N(()=>[r(i).model.treeData.value.length>0?(J(),ue(r(Qe),{key:0,data:r(i).model.treeData.value,"show-icon":!0,"block-line":!0,"node-height":32,"show-line":!0,ellipsis:!0,"ellipsis-line-clamp":1,"ellipsis-tooltip":!0,"module-id":r(i).model.moduleId,"menu-config":r(i).model.treeMenuConfig,"render-prefix":r(i).renderNodePrefix,"render-label":r(i).renderNodeLabel,"render-suffix":r(i).renderNodeSuffix,onSelect:u[1]||(u[1]=(C,k)=>r(i).handleTreeSelect(C,k,c)),onMenuClick:r(i).handleMenuClick},null,8,["data","module-id","menu-config","render-prefix","render-label","render-suffix","onMenuClick"])):(J(),ue(r(rt),{key:1,description:"暂无可用的网关实例",style:{padding:"40px 0"}},{icon:N(()=>[I(r(ee),{size:"40",color:"var(--g-primary)"},{default:N(()=>[I(r(he))]),_:1})]),_:1}))]),_:1},8,["show"])]),r(i).model.totalCount.value>0?(J(),ae("div",kt,[I(r(Ze),{"current-page":r(i).model.currentPage.value,"page-size":r(i).model.pageSize.value,total:r(i).model.totalCount.value,layouts:["PrevPage","NextPage"],align:"center",onPageChange:r(i).handlePageChange},null,8,["current-page","page-size","total","onPageChange"])])):$e("",!0),I(we,{visible:r(i).proxyFormDialogVisible.value,"onUpdate:visible":u[2]||(u[2]=C=>r(i).proxyFormDialogVisible.value=C),mode:r(i).proxyFormDialogMode.value,title:r(i).proxyFormDialogMode.value==="create"?"新增代理配置":r(i).proxyFormDialogMode.value==="edit"?"编辑代理配置":"查看代理配置详情",to:`#${p.parentModuleId}`,"form-fields":r(i).model.proxyFormConfig.fields,"form-tabs":r(i).model.proxyFormConfig.tabs,"initial-data":r(i).getProxyFormInitialData(),"auto-close-on-confirm":!1,"confirm-loading":r(i).proxySubmitting.value,onSubmit:r(i).handleProxyFormSubmit},null,8,["visible","mode","title","to","form-fields","form-tabs","initial-data","confirm-loading","onSubmit"])]))}}),Mt=de(_t,[["__scopeId","data-v-f8fbd456"]]);function Ot(){const o="hub0022:manageNodes",g=E(!1),l=E([]),p=E();return{moduleId:o,loading:g,nodeList:l,pageInfo:p,searchFormConfig:{fields:[{field:"nodeHost",label:"节点主机",type:"input",placeholder:"请输入节点主机地址",span:6,clearable:!0},{field:"healthStatus",label:"健康状态",type:"select",placeholder:"请选择健康状态",span:6,clearable:!0,options:[{label:"全部",value:""},{label:"健康",value:"Y"},{label:"不健康",value:"N"}]},{field:"activeFlag",label:"在线状态",type:"select",placeholder:"请选择在线状态",span:6,clearable:!0,options:[{label:"全部",value:""},{label:"在线",value:"Y"},{label:"离线",value:"N"}]}],toolbarButtons:[{key:"add",label:"新建节点",icon:Ie,type:"primary",tooltip:"新建服务节点"},{key:"edit",label:"编辑",icon:it,type:"default",tooltip:"编辑选中的服务节点"},{key:"delete",label:"删除",icon:Je,type:"error",tooltip:"批量删除选中的服务节点"}],showSearchButton:!0,showResetButton:!0},nodeFormConfig:{tabs:[{key:"basic",label:"基本信息"},{key:"metadata",label:"元数据配置"},{key:"other",label:"其他配置"}],fields:[{field:"serviceNodeId",label:"服务节点ID",type:"input",span:12,tabKey:"basic",primary:!0,show:!1},{field:"nodeId",label:"节点ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"serviceDefinitionId",label:"服务定义ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"tenantId",label:"租户ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"nodeProtocol",label:"节点协议",type:"select",placeholder:"请选择协议",span:12,tabKey:"basic",required:!0,defaultValue:"HTTP",props:{onUpdateValue:(t,a)=>{if(a&&a.nodeHost&&a.nodePort!==void 0&&t){const d=t.toLowerCase();a.nodeUrl=`${d}://${a.nodeHost}:${a.nodePort}`}}},options:[{label:"HTTP",value:"HTTP"},{label:"HTTPS",value:"HTTPS"}],rules:[{required:!0,message:"请选择节点协议",trigger:["blur","change"]}]},{field:"nodeHost",label:"节点主机",type:"input",placeholder:"请输入主机地址",span:12,tabKey:"basic",required:!0,props:{onUpdateValue:(t,a)=>{if(a&&t&&a.nodePort!==void 0&&a.nodeProtocol){const d=a.nodeProtocol.toLowerCase();a.nodeUrl=`${d}://${t}:${a.nodePort}`}}},rules:[{required:!0,message:"请输入节点主机地址",trigger:["blur","input"]},{pattern:/^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$|^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])$/,message:"请输入有效的IP地址或域名",trigger:["blur","input"]}]},{field:"nodePort",label:"节点端口",type:"number",placeholder:"请输入端口",span:12,tabKey:"basic",required:!0,props:{min:1,max:65535,onUpdateValue:(t,a)=>{if(a&&a.nodeHost&&t!==void 0&&a.nodeProtocol){const d=a.nodeProtocol.toLowerCase();a.nodeUrl=`${d}://${a.nodeHost}:${t}`}}},rules:[{required:!0,type:"number",message:"请输入节点端口",trigger:["blur","change"]}]},{field:"nodeWeight",label:"节点权重",type:"number",placeholder:"权重值",span:12,tabKey:"basic",required:!0,defaultValue:100,props:{min:1,max:1e3},rules:[{required:!0,type:"number",message:"请输入节点权重",trigger:["blur","change"]}]},{field:"nodeUrl",label:"节点URL",type:"input",placeholder:"输入完整URL或由上方字段自动生成",span:24,tabKey:"basic",required:!0,tips:"支持直接输入完整URL(如 https://www.example.com)，将自动解析为协议、主机和端口",props:{onUpdateValue:(t,a)=>{if(a&&t&&(t.startsWith("http://")||t.startsWith("https://")))try{const d=new URL(t);a.nodeProtocol=d.protocol==="https:"?"HTTPS":"HTTP",a.nodeHost=d.hostname,d.port?a.nodePort=parseInt(d.port,10):a.nodePort=d.protocol==="https:"?443:80}catch(d){console.warn("URL解析失败:",d)}}},rules:[{required:!0,message:"请输入节点URL",trigger:["blur","input"]},{validator:(t,a)=>{if(a&&(a.startsWith("http://")||a.startsWith("https://")))try{return new URL(a),!0}catch{return new Error("请输入有效的URL格式")}return!0},trigger:["blur","input"]}]},{field:"healthStatus",label:"健康状态",type:"switch",span:12,tabKey:"basic",defaultValue:"Y",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"activeFlag",label:"在线状态",type:"switch",span:12,tabKey:"basic",defaultValue:"Y",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"noteText",label:"备注信息",type:"textarea",placeholder:"请输入备注信息",span:24,tabKey:"basic",props:{rows:4}},{field:"nodeMetadata",label:"节点元数据",type:"textarea",placeholder:"{}",span:24,tabKey:"metadata",props:{rows:8},rules:[{validator:(t,a)=>{if(a&&typeof a=="string"&&a.trim())try{return JSON.parse(a),!0}catch{return new Error("请输入有效的JSON格式")}return!0},trigger:["blur"]}]},{field:"addTime",label:"创建时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"addWho",label:"创建人",type:"input",span:12,tabKey:"other",disabled:!0},{field:"editTime",label:"修改时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"editWho",label:"修改人",type:"input",span:12,tabKey:"other",disabled:!0}]},gridConfig:{columns:[{field:"serviceNodeId",title:"服务节点ID",visible:!1},{field:"tenantId",title:"租户ID",visible:!1},{field:"serviceDefinitionId",title:"服务定义ID",visible:!1},{field:"nodeId",title:"节点ID",sortable:!0,align:"center",showOverflow:!0,width:150},{field:"nodeUrl",title:"节点地址",sortable:!0,align:"left",showOverflow:!0,width:250},{field:"nodeHost",title:"节点主机",sortable:!0,align:"center",showOverflow:!0,width:150},{field:"nodePort",title:"节点端口",sortable:!0,align:"center",width:100},{field:"nodeProtocol",title:"协议",align:"center",width:80,slots:{default:"nodeProtocol"}},{field:"nodeWeight",title:"权重",align:"center",width:80},{field:"healthStatus",title:"健康状态",align:"center",width:100,slots:{default:"healthStatus"}},{field:"activeFlag",title:"在线状态",align:"center",width:100,slots:{default:"activeFlag"}},{field:"lastHealthCheckTime",title:"最后检查时间",align:"center",showOverflow:!0,formatter:({cellValue:t})=>t?oe(t,"YYYY-MM-DD HH:mm:ss"):"-",width:180},{field:"noteText",title:"备注",align:"left",showOverflow:!0,width:150},{field:"addTime",title:"创建时间",sortable:!0,align:"center",showOverflow:!0,formatter:({cellValue:t})=>t?oe(t,"YYYY-MM-DD HH:mm:ss"):"",width:180},{field:"addWho",title:"创建人",align:"center",showOverflow:!0,width:120},{field:"editTime",title:"修改时间",sortable:!0,align:"center",showOverflow:!0,formatter:({cellValue:t})=>t?oe(t,"YYYY-MM-DD HH:mm:ss"):"",width:180},{field:"editWho",title:"修改人",align:"center",showOverflow:!0,width:120}],showCheckbox:!0,paginationConfig:{show:!0,pageInfo:p,align:"right"},menuConfig:{enabled:!0,showCopyRow:!0,showCopyCell:!0,customMenus:[{code:"edit",name:"编辑",prefixIcon:"vxe-icon-edit"},{code:"delete",name:"删除",prefixIcon:"vxe-icon-delete"}]},height:"100%",rowId:"serviceNodeId"},resetPagination:()=>{p.value=void 0},updatePagination:t=>{p.value?Object.assign(p.value,t):p.value=t},setNodeList:t=>{l.value=t},addNodeToList:t=>{l.value.push(t)},updateNodeInList:t=>{const a=l.value.findIndex(d=>d.serviceNodeId===t.serviceNodeId);a>=0&&(l.value[a]=t)},removeNodeFromList:t=>{const a=l.value.findIndex(d=>d.serviceNodeId===t);a>=0&&l.value.splice(a,1)},removeNodesFromList:t=>{l.value=l.value.filter(a=>!t.includes(a.serviceNodeId))}}}var je=(o=>(o[o.OFFLINE=0]="OFFLINE",o[o.ONLINE=1]="ONLINE",o[o.MAINTENANCE=2]="MAINTENANCE",o))(je||{});function Et(o,g){const l=re(),p=qe(),c=Ot(),{loading:i,nodeList:b,pageInfo:u,setNodeList:C,updatePagination:k,addNodeToList:_,updateNodeInList:F,removeNodeFromList:H,removeNodesFromList:L}=c,t=async m=>{var v,y,w;i.value=!0;try{let x=m;!x&&((v=g==null?void 0:g.value)!=null&&v.getFormData)&&(x=g.value.getFormData()||{});const G=x?Object.fromEntries(Object.entries(x).filter(([,T])=>T!==""&&T!==null&&T!==void 0)):{},j=(o==null?void 0:o.value)||G.serviceDefinitionId;if(!j){l.error("serviceDefinitionId不能为空");return}const X={serviceDefinitionId:j,...G,...Re((y=u.value)==null?void 0:y.pageIndex,(w=u.value)==null?void 0:w.pageSize)},h=await ht(X);if(W(h)){const T=ne(h,[]);C(Array.isArray(T)?T:[]);const S=ze(h);S&&Object.keys(S).length>0&&k(S)}else l.error(Y(h,"查询服务节点列表失败"))}catch{l.error("加载服务节点列表失败")}finally{i.value=!1}};return{model:c,loadNodeList:t,handleSearch:async m=>{c.resetPagination(),await t(m)},handleReset:async()=>{c.resetPagination(),await t()},handlePageChange:async({currentPage:m,pageSize:v})=>{k({pageIndex:m,pageSize:v}),await t()},handleRefresh:async()=>{await t()},addNode:async m=>{i.value=!0;try{const v=await yt(m);return W(v)?(l.success(Y(v,"新增服务节点成功")),await t(),!0):(l.error(Y(v,"新增服务节点失败")),!1)}catch{return l.error("新增服务节点失败"),!1}finally{i.value=!1}},editNode:async m=>{i.value=!0;try{const v=await gt(m);return W(v)?(l.success(Y(v,"编辑服务节点成功")),await t(),!0):(l.error(Y(v,"编辑服务节点失败")),!1)}catch{return l.error("编辑服务节点失败"),!1}finally{i.value=!1}},deleteNode:async m=>{const v=b.value.find(w=>w.serviceNodeId===m);if(!v)return l.error("未找到要删除的服务节点"),!1;if(!await p.warning({title:"确认删除",subtitle:"此操作不可恢复，请谨慎操作",content:`确定要删除服务节点 "${v.nodeUrl||v.nodeHost||m}" 吗？`,icon:ye,headerStyle:"gradient",positiveText:"确定删除",negativeText:"取消",width:500}))return!1;i.value=!0;try{const w=await bt(m,"default");return W(w)?(l.success(Y(w,"删除服务节点成功")),H(m),b.value.length===0&&u.value&&u.value.pageIndex>1?(k({pageIndex:u.value.pageIndex-1}),await t()):await t(),!0):(l.error(Y(w,"删除服务节点失败")),!1)}catch{return l.error("删除服务节点失败"),!1}finally{i.value=!1}},batchDeleteNodes:async m=>{if(!await p.warning({title:"确认批量删除",subtitle:"此操作不可恢复，请谨慎操作",content:`确定要删除选中的 ${m.length} 个服务节点吗？`,icon:ye,headerStyle:"gradient",positiveText:"确定删除",negativeText:"取消",width:500}))return!1;i.value=!0;try{const y=await mt(m);return W(y)?(l.success(Y(y,"批量删除服务节点成功")),L(m),await t(),!0):(l.error(Y(y,"批量删除服务节点失败")),!1)}catch{return l.error("批量删除服务节点失败"),!1}finally{i.value=!1}}}}function Ft(o,g,l){const p=re(),c=Et(g,l),i=E(!1),b=E("create"),u=E(null),C=e=>{const n=f=>{if(typeof f=="string"&&f)try{return JSON.parse(f)}catch{return f}return f},O={...e};if(e.nodeMetadata){const f=n(e.nodeMetadata);if(f&&typeof f=="object")try{O.nodeMetadata=JSON.stringify(f,null,2)}catch{O.nodeMetadata="{}"}else O.nodeMetadata=e.nodeMetadata||"{}"}else O.nodeMetadata="{}";return O},k=e=>{const n={...e};if(e.nodeMetadata)if(typeof e.nodeMetadata=="string")try{JSON.parse(e.nodeMetadata),n.nodeMetadata=e.nodeMetadata}catch{n.nodeMetadata="{}"}else typeof e.nodeMetadata=="object"?n.nodeMetadata=JSON.stringify(e.nodeMetadata):n.nodeMetadata="{}";else n.nodeMetadata="{}";return e.nodePort!==void 0&&(n.nodePort=Number(e.nodePort)),e.nodeWeight!==void 0&&(n.nodeWeight=Number(e.nodeWeight)),e.nodeStatus!==void 0&&(n.nodeStatus=Number(e.nodeStatus)),n},_=()=>{b.value="create",u.value=null,i.value=!0},F=async e=>{if(e.serviceNodeId)try{const n=await He(e.serviceNodeId,"default");if(W(n)){const O=ne(n,null);if(O){b.value="edit",u.value=C(O),i.value=!0;return}}}catch{}b.value="edit",u.value=C(e),i.value=!0},H=async e=>{if(e.serviceNodeId)try{const n=await He(e.serviceNodeId,"default");if(W(n)){const O=ne(n,null);if(O){b.value="view",u.value=C(O),i.value=!0;return}}}catch{}b.value="view",u.value=C(e),i.value=!0},L=()=>{i.value=!1,u.value=null},t=()=>{if(b.value==="create")return{serviceDefinitionId:(g==null?void 0:g.value)||"",nodeUrl:"http://192.168.1.0:8080",nodeHost:"192.168.1.0",nodePort:8080,nodeProtocol:"HTTP",nodeWeight:100,healthStatus:"Y",activeFlag:"Y",nodeStatus:je.ONLINE,nodeMetadata:"{}",noteText:""};if(u.value)return u.value},a=async e=>{var n;if(!e||b.value==="view")return!1;try{const O=k(e);if(!O.serviceDefinitionId&&(g!=null&&g.value)&&(O.serviceDefinitionId=g.value),!O.serviceDefinitionId)return p.error("服务定义ID不能为空"),!1;let f=!1;return b.value==="create"?f=await c.addNode(O):b.value==="edit"&&((n=u.value)!=null&&n.serviceNodeId)&&(O.serviceNodeId=u.value.serviceNodeId,f=await c.editNode(O)),f&&L(),f}catch{return p.error("操作失败"),!1}},d=async(e,n)=>{var O,f,m,v;switch(e){case"add":_();break;case"edit":{if(!(o!=null&&o.value)){p.warning("Grid 引用未设置");return}const y=(f=(O=o.value).getCurrentRecord)==null?void 0:f.call(O);if(!y){p.warning("请先点击选择要编辑的服务节点");return}await F(y);break}case"delete":{if(!(o!=null&&o.value)){p.warning("Grid 引用未设置");return}const y=(v=(m=o.value).getCurrentRecord)==null?void 0:v.call(m);if(!y){p.warning("请先点击选择要删除的服务节点");return}await c.deleteNode(y.serviceNodeId);break}case"search":{await s(n);break}}},D=async({code:e,row:n})=>{if(n)switch(e){case"edit":await F(n);break;case"delete":await c.deleteNode(n.serviceNodeId);break}},s=async e=>{await c.handleSearch(e)};return{service:c,formDialogVisible:i,formDialogMode:b,currentEditNode:u,getFormInitialData:t,openAddDialog:_,openEditDialog:F,openViewDialog:H,closeFormDialog:L,handleFormSubmit:a,handleToolbarClick:d,handleMenuClick:D,handleSearch:s}}const Dt={class:"service-node-list-modal",id:"hub0022-service-node-list"},Lt=ce({name:"ServiceNodeListModal",__name:"ServiceNodeListModal",props:{visible:{type:Boolean,default:!1},title:{default:"服务节点管理"},width:{default:1200},to:{type:[String,Boolean],default:void 0},serviceDefinitionId:{default:void 0}},emits:["update:visible","close","refresh"],setup(o,{emit:g}){const l=o,p=g,c=E(),i=E(),b=E(l.visible),u=se(()=>l.visible,n=>{b.value=n}),C=E(l.serviceDefinitionId),k=se(()=>l.serviceDefinitionId,n=>{C.value=n,b.value&&n&&_.handleRefresh()});pe(()=>{u(),k()});const{service:_,formDialogVisible:F,formDialogMode:H,getFormInitialData:L,handleFormSubmit:t,handleToolbarClick:a,handleMenuClick:d,handleSearch:D}=Ft(i,C,c),s=n=>{b.value=n,p("update:visible",n),n?(p("refresh"),C.value&&_.handleRefresh()):p("close")},e=()=>{b.value||(F.value=!1,H.value="create",_.model.nodeList.value=[],_.model.resetPagination())};return(n,O)=>(J(),ue(r(Ge),{visible:b.value,title:l.title||"服务节点管理",width:l.width||1200,to:l.to,"show-footer":!1,"onUpdate:visible":s,onAfterLeave:e},{default:N(()=>[V("div",Dt,[I(r(Te),{direction:"vertical","no-resize":!0},{1:N(()=>[I(Ce,ve({ref_key:"searchFormRef",ref:c,"module-id":r(_).model.moduleId},r(_).model.searchFormConfig,{onSearch:r(D),onToolbarClick:r(a)}),null,16,["module-id","onSearch","onToolbarClick"])]),2:N(()=>[I(r(Se),ve({ref_key:"gridRef",ref:i,"module-id":r(_).model.moduleId,data:r(_).model.nodeList,loading:r(_).model.loading},r(_).model.gridConfig,{onPageChange:r(_).handlePageChange,onMenuClick:r(d)}),{nodeProtocol:N(({row:f})=>[I(r(B),{type:f.nodeProtocol==="HTTPS"?"success":"info",size:"small"},{default:N(()=>[U(z(f.nodeProtocol),1)]),_:2},1032,["type"])]),healthStatus:N(({row:f})=>[I(r(B),{type:f.healthStatus==="Y"?"success":"error",size:"small"},{default:N(()=>[U(z(f.healthStatus==="Y"?"健康":"不健康"),1)]),_:2},1032,["type"])]),nodeStatus:N(({row:f})=>[I(r(B),{type:f.nodeStatus===1?"success":f.nodeStatus===0?"error":"warning",size:"small"},{default:N(()=>[U(z(f.nodeStatus===1?"在线":f.nodeStatus===0?"下线":"维护"),1)]),_:2},1032,["type"])]),activeFlag:N(({row:f})=>[I(r(B),{type:f.activeFlag==="Y"?"success":"default",size:"small"},{default:N(()=>[U(z(f.activeFlag==="Y"?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1},16,["module-id","data","loading","onPageChange","onMenuClick"])]),_:1}),I(we,{visible:r(F),"onUpdate:visible":O[0]||(O[0]=f=>me(F)?F.value=f:null),mode:r(H),title:r(H)==="create"?"新增服务节点":r(H)==="edit"?"编辑服务节点":"查看服务节点详情",to:"#hub0022-service-node-list","form-fields":r(_).model.nodeFormConfig.fields,"form-tabs":r(_).model.nodeFormConfig.tabs,"initial-data":r(L)(),"auto-close-on-confirm":!1,"confirm-loading":r(_).model.loading.value,onSubmit:r(t)},null,8,["visible","mode","title","form-fields","form-tabs","initial-data","confirm-loading","onSubmit"])])]),_:1},8,["visible","title","width","to"]))}}),Kt=de(Lt,[["__scopeId","data-v-f9b087ea"]]),Vt={class:"service-selector-modal-content"},Ht={class:"search-section"},At={class:"grid-section"},Ae="hub0042-selector",Yt=ce({__name:"ServiceSelectorModal",props:{visible:{type:Boolean},to:{default:"body"}},emits:["update:visible","select","close"],setup(o,{emit:g}){const l=o,p=g,c=re(),i=E(),b=E(),u=E(null),C=ot(i),k={fields:[{field:"serviceName",label:"服务名称",type:"input",placeholder:"请输入服务名称",span:6,clearable:!0},{field:"groupName",label:"分组名称",type:"input",placeholder:"请输入分组名称",span:6,clearable:!0},{field:"namespaceId",label:"命名空间",type:"input",placeholder:"请输入命名空间",span:6,clearable:!0},{field:"activeFlag",label:"状态",type:"select",placeholder:"请选择状态",span:6,clearable:!0,options:[{label:"全部",value:""},{label:"启用",value:"Y"},{label:"禁用",value:"N"}]}]},_={columns:[{type:"radio",width:50,fixed:"left"},{field:"serviceName",title:"服务名称",minWidth:180,sortable:!0,fixed:"left"},{field:"namespaceId",title:"命名空间",minWidth:120},{field:"groupName",title:"分组",minWidth:120},{field:"serviceType",title:"服务类型",minWidth:100},{field:"nodeCount",title:"节点数",minWidth:80,align:"center",formatter:({cellValue:s})=>s??0},{field:"healthyNodeCount",title:"健康节点",minWidth:90,align:"center",formatter:({cellValue:s})=>s??0},{field:"unhealthyNodeCount",title:"不健康节点",minWidth:100,align:"center",formatter:({cellValue:s})=>s??0},{field:"serviceDescription",title:"服务描述",minWidth:180,showOverflow:"tooltip"},{field:"activeFlag",title:"状态",minWidth:80,align:"center",slots:{default:"activeFlag"}},{field:"addTime",title:"创建时间",minWidth:160,formatter:({cellValue:s})=>oe(s)}],rowConfig:{keyField:"serviceName",isHover:!0,isCurrent:!0},radioConfig:{highlight:!0,trigger:"row"},pagerConfig:{enabled:!0,pageSize:10,pageSizes:[10,20,50]}},F=ie({get:()=>l.visible,set:s=>p("update:visible",s)}),H=se(()=>l.visible,s=>{var e;s?(u.value=null,C.loadServices({tenantId:"default"})):(u.value=null,(e=i.value)!=null&&e.resetForm&&i.value.resetForm())});pe(()=>{H()});function L(){C.handleSearch()}function t(s){C.handlePageChange(s.currentPage,s.pageSize)}function a({row:s}){var e;u.value=s,(e=b.value)!=null&&e.setRadioRow&&b.value.setRadioRow(s)}function d(){var n,O;const e=((O=(n=b.value)==null?void 0:n.getRadioRecord)==null?void 0:O.call(n))||u.value;if(!e){c.warning("请选择一个服务");return}p("select",e),D()}function D(){p("update:visible",!1),p("close")}return(s,e)=>(J(),ue(r(Ge),{visible:F.value,"onUpdate:visible":e[0]||(e[0]=n=>F.value=n),title:"选择注册服务","header-icon":r(We),width:1200,"mask-closable":!1,"show-fullscreen-toggle":!1,to:o.to,onClose:D,onCancel:D,onConfirm:d,"show-confirm":!0,"show-cancel":!0,"confirm-text":"确认选择","cancel-text":"取消"},{default:N(()=>[V("div",Vt,[V("div",Ht,[I(Ce,{ref_key:"searchFormRef",ref:i,"module-id":Ae,fields:k.fields,"show-search-button":!0,"show-reset-button":!0,onSearch:L},null,8,["fields"])]),V("div",At,[I(r(Se),{ref_key:"gridRef",ref:b,"module-id":Ae,data:r(C).model.serviceList,loading:r(C).model.loading,columns:_.columns,height:400,"show-overflow":!0,stripe:!0,border:!0,"row-config":_.rowConfig,"radio-config":_.radioConfig,"pager-config":_.pagerConfig,"page-info":r(C).model.pageInfo,onPageChange:t,onRowClick:a},{activeFlag:N(({row:n})=>[I(r(B),{type:n.activeFlag==="Y"?"success":"default",size:"small"},{default:N(()=>[U(z(n.activeFlag==="Y"?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1},8,["data","loading","columns","row-config","radio-config","pager-config","page-info"])])])]),_:1},8,["visible","header-icon","to"]))}}),Rt=de(Yt,[["__scopeId","data-v-276f24e8"]]),zt={class:"service-selector"},Ut={key:0,class:"selected-service-card"},$t={class:"service-info"},Wt={class:"service-header"},Bt={class:"service-avatar"},Gt={class:"avatar-circle"},qt={class:"service-main-info"},Jt={class:"service-name"},jt={class:"service-tags"},Xt={class:"service-status"},Zt={class:"service-details"},Qt={class:"detail-row"},ea={class:"detail-item"},ta={class:"detail-value"},aa={class:"detail-item"},ra={class:"detail-value"},la={class:"detail-item"},ia={class:"service-actions"},oa={key:1,class:"empty-selector"},na=ce({__name:"ServiceSelector",props:{modelValue:{default:null},to:{default:"body"}},emits:["update:modelValue","change"],setup(o,{emit:g}){const l=o,p=g,c=re(),i=E(!1),b=E(!1),u=E(null),C=ie(()=>{if(!l.modelValue)return null;if(typeof l.modelValue=="string")try{return JSON.parse(l.modelValue)}catch{return null}return l.modelValue}),k=ie(()=>u.value),_=ie(()=>{var s;return((s=C.value)==null?void 0:s.protocolType)||"http"}),F=s=>{if(!s)return"?";const e=s.charAt(0).toUpperCase();return/^[A-Z]$/.test(e)?e:s.charAt(0)},H=async s=>{if(!s||!s.namespaceId||!s.groupName||!s.serviceName){u.value=null;return}try{b.value=!0;const e=await nt(s.namespaceId,s.groupName,s.serviceName);if(W(e)){const n=ne(e,void 0);n?u.value=n:(console.warn("服务数据解析失败"),u.value=null)}else console.warn("获取服务失败:",Y(e,"获取服务失败")),u.value={tenantId:s.tenantId,namespaceId:s.namespaceId,groupName:s.groupName,serviceName:s.serviceName,activeFlag:"Y"}}catch(e){console.error("加载服务失败:",e),u.value=null}finally{b.value=!1}},L=se(()=>l.modelValue,s=>{if(!s){u.value=null;return}const e=C.value;if(e){const n=u.value;(!n||n.namespaceId!==e.namespaceId||n.groupName!==e.groupName||n.serviceName!==e.serviceName)&&H(e)}},{immediate:!0});pe(()=>{L()});const t=()=>{i.value=!0},a=()=>{i.value=!1},d=()=>{u.value=null,p("update:modelValue",null),p("change",null),c.info("已清除服务选择")},D=s=>{u.value=s;const e={tenantId:s.tenantId||"default",namespaceId:s.namespaceId,groupName:s.groupName||"DEFAULT_GROUP",serviceName:s.serviceName,discoveryType:"INTERNAL",protocolType:"http"};p("update:modelValue",e),p("change",e),c.success(`已选择服务：${s.serviceName}`),a()};return(s,e)=>(J(),ae("div",zt,[k.value?(J(),ae("div",Ut,[V("div",$t,[V("div",Wt,[V("div",Bt,[V("div",Gt,z(F(k.value.serviceName)),1)]),V("div",qt,[V("div",Jt,z(k.value.serviceName),1),V("div",jt,[I(r(B),{type:"info",size:"small"},{default:N(()=>[U(z(k.value.namespaceId),1)]),_:1}),I(r(B),{type:"primary",size:"small"},{default:N(()=>[U(z(k.value.groupName),1)]),_:1})])]),V("div",Xt,[I(r(B),{type:k.value.activeFlag==="Y"?"success":"error",size:"small"},{default:N(()=>[U(z(k.value.activeFlag==="Y"?"启用":"禁用"),1)]),_:1},8,["type"])])]),V("div",Zt,[V("div",Qt,[V("div",ea,[e[1]||(e[1]=V("span",{class:"detail-label"},"服务类型",-1)),V("span",ta,z(k.value.serviceType||"INTERNAL"),1)]),V("div",aa,[e[2]||(e[2]=V("span",{class:"detail-label"},"节点数",-1)),V("span",ra,[U(z(k.value.nodeCount??0)+" ",1),k.value.healthyNodeCount!==void 0||k.value.unhealthyNodeCount!==void 0?(J(),ae(lt,{key:0},[U(" (健康: "+z(k.value.healthyNodeCount??0)+", 不健康: "+z(k.value.unhealthyNodeCount??0)+") ",1)],64)):$e("",!0)])]),V("div",la,[e[3]||(e[3]=V("span",{class:"detail-label"},"协议",-1)),I(r(B),{type:"warning",size:"small"},{default:N(()=>[U(z(_.value),1)]),_:1})])])]),V("div",ia,[I(r(fe),{onClick:t,size:"small",secondary:""},{icon:N(()=>[I(r(ee),null,{default:N(()=>[I(r(Be))]),_:1})]),default:N(()=>[e[4]||(e[4]=U(" 重新选择 ",-1))]),_:1}),I(r(fe),{onClick:d,size:"small",type:"error",secondary:""},{icon:N(()=>[I(r(ee),null,{default:N(()=>[I(r(st))]),_:1})]),default:N(()=>[e[5]||(e[5]=U(" 清除 ",-1))]),_:1})])])])):(J(),ae("div",oa,[I(r(fe),{onClick:t,dashed:"",block:"",size:"large",class:"select-btn"},{icon:N(()=>[I(r(ee),null,{default:N(()=>[I(r(he))]),_:1})]),default:N(()=>[e[6]||(e[6]=U(" 点击选择注册服务 ",-1))]),_:1})])),I(Rt,{visible:i.value,"onUpdate:visible":e[0]||(e[0]=n=>i.value=n),to:o.to,onSelect:D,onClose:a},null,8,["visible","to"])]))}}),sa=de(na,[["__scopeId","data-v-07d1691d"]]);function ca(){const o="hub0022",g=E(!1),l=E([]),p=E(),c={fields:[{field:"serviceName",label:"服务名称",type:"input",placeholder:"请输入服务名称",span:6,clearable:!0},{field:"serviceType",label:"服务类型",type:"select",placeholder:"请选择服务类型",span:6,clearable:!0,options:[{label:"静态配置",value:A.STATIC},{label:"服务发现",value:A.DISCOVERY}]},{field:"loadBalanceStrategy",label:"负载均衡策略",type:"select",placeholder:"请选择负载均衡策略",span:6,clearable:!0,options:[{label:"轮询算法",value:$.ROUND_ROBIN},{label:"随机算法",value:$.RANDOM},{label:"IP哈希算法",value:$.IP_HASH},{label:"最少连接算法",value:$.LEAST_CONN},{label:"加权轮询算法",value:$.WEIGHTED_ROUND_ROBIN},{label:"一致性哈希算法",value:$.CONSISTENT_HASH}]},{field:"activeFlag",label:"状态",type:"select",placeholder:"请选择状态",span:6,options:[{label:"全部",value:""},{label:"启用",value:"Y"},{label:"禁用",value:"N"}]}],toolbarButtons:[{key:"add",label:"新增服务",icon:Ie,type:"primary",tooltip:"新增服务定义"},{key:"view",label:"查看详情",icon:Ke,type:"info",tooltip:"查看选中服务的详细信息"},{key:"delete",label:"删除",icon:Je,type:"error",tooltip:"批量删除选中的服务定义"},{key:"manageNodes",label:"节点管理",icon:Ke,type:"default",tooltip:"管理服务节点"}],showSearchButton:!0,showResetButton:!0},i={tabs:[{key:"basic",label:"基本信息"},{key:"loadbalance",label:"负载均衡",show:t=>t.serviceType===A.STATIC},{key:"health",label:"健康检查",show:t=>t.serviceType===A.STATIC},{key:"discovery",label:"服务发现",show:t=>t.serviceType===A.DISCOVERY},{key:"other",label:"其他配置"}],fields:[{field:"serviceDefinitionId",label:"服务定义ID",type:"input",span:12,tabKey:"basic",primary:!0,show:!1},{field:"tenantId",label:"租户ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"proxyConfigId",label:"代理配置ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"serviceName",label:"服务名称",type:"input",placeholder:"请输入服务名称",span:12,tabKey:"basic",required:!0,tips:"服务的唯一标识名称，用于区分不同的后端服务，长度2-50个字符",rules:[{required:!0,message:"请输入服务名称",trigger:["blur","input"]},{min:2,max:50,message:"服务名称长度在2-50个字符",trigger:["blur","input"]}]},{field:"serviceType",label:"服务类型",type:"select",placeholder:"请选择服务类型",span:12,tabKey:"basic",required:!0,defaultValue:A.STATIC,tips:"静态配置：手动配置服务节点地址；服务发现：从服务注册中心自动发现服务实例",options:[{label:"静态配置",value:A.STATIC},{label:"服务发现",value:A.DISCOVERY}],rules:[{required:!0,message:"请选择服务类型",trigger:["blur","change"],validator:(t,a)=>a==null||a===""?new Error("请选择服务类型"):typeof a=="number"&&(a===0||a===1)?!0:new Error("请选择有效的服务类型")}]},{field:"serviceDesc",label:"服务描述",type:"textarea",placeholder:"请输入服务描述",span:24,tabKey:"basic",tips:"服务的详细描述信息，用于说明服务的用途和功能",props:{rows:3}},{field:"loadBalanceStrategy",label:"负载均衡策略",type:"select",placeholder:"请选择负载均衡策略",span:12,tabKey:"loadbalance",required:!0,show:t=>t.serviceType===A.STATIC,defaultValue:$.ROUND_ROBIN,tips:"轮询：按顺序依次分发请求；随机：随机选择节点；IP哈希：根据客户端IP哈希选择节点；最少连接：选择连接数最少的节点；加权轮询：根据节点权重轮询；一致性哈希：保证相同请求路由到同一节点",options:[{label:"轮询算法",value:$.ROUND_ROBIN},{label:"随机算法",value:$.RANDOM},{label:"IP哈希算法",value:$.IP_HASH},{label:"最少连接算法",value:$.LEAST_CONN},{label:"加权轮询算法",value:$.WEIGHTED_ROUND_ROBIN},{label:"一致性哈希算法",value:$.CONSISTENT_HASH}],rules:[{required:!0,message:"请选择负载均衡策略",trigger:["blur","change"],validator:(t,a,d)=>d.serviceType===A.STATIC&&(a==null||a==="")?new Error("请选择负载均衡策略"):!0}]},{field:"sessionAffinity",label:"会话亲和性",type:"switch",span:12,tabKey:"loadbalance",show:t=>t.serviceType===A.STATIC,defaultValue:"N",tips:"启用后，同一客户端的请求会尽量路由到同一个后端节点，保证会话状态的一致性",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"stickySession",label:"粘性会话",type:"switch",span:12,tabKey:"loadbalance",show:t=>t.serviceType===A.STATIC,defaultValue:"N",tips:"启用后，通过Cookie等方式强制将同一会话的请求路由到固定的后端节点",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"maxRetries",label:"最大重试次数",type:"number",placeholder:"3",span:12,tabKey:"loadbalance",show:t=>t.serviceType===A.STATIC,defaultValue:3,tips:"当请求失败时，最多重试的次数。范围0-10，0表示不重试",props:{min:0,max:10},rules:[{required:!0,message:"请输入最大重试次数",trigger:["blur","change"],validator:(t,a)=>{if(a==null||a==="")return new Error("请输入最大重试次数");const d=Number(a);return isNaN(d)||d<0||d>10?new Error("重试次数必须在0-10之间"):!0}}]},{field:"retryTimeoutMs",label:"重试超时时间(ms)",type:"number",placeholder:"5000",span:12,tabKey:"loadbalance",show:t=>t.serviceType===A.STATIC,defaultValue:5e3,tips:"每次重试请求的超时时间（毫秒）。范围100-60000ms",props:{min:100,max:6e4},rules:[{required:!0,message:"请输入重试超时时间",trigger:["blur","change"],validator:(t,a)=>{if(a==null||a==="")return new Error("请输入重试超时时间");const d=Number(a);return isNaN(d)||d<100||d>6e4?new Error("超时时间必须在100-60000毫秒之间"):!0}}]},{field:"enableCircuitBreaker",label:"启用熔断器",type:"switch",span:12,tabKey:"loadbalance",show:t=>t.serviceType===A.STATIC,defaultValue:"N",tips:"启用后，当服务节点故障率过高时自动熔断，避免大量请求打到故障节点",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"healthCheckEnabled",label:"启用健康检查",type:"switch",span:24,tabKey:"health",show:t=>t.serviceType===A.STATIC,defaultValue:"N",tips:"启用后，网关会定期检查后端节点的健康状态，自动剔除不健康的节点",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"healthCheckPath",label:"检查路径",type:"input",placeholder:"/health",span:12,tabKey:"health",show:t=>t.serviceType===A.STATIC&&t.healthCheckEnabled==="Y",defaultValue:"/health",tips:"健康检查请求的URL路径，通常是后端服务提供的健康检查接口",rules:[{required:!0,message:"请输入健康检查路径",trigger:["blur","input"],validator:(t,a,d)=>d.healthCheckEnabled==="Y"&&(!a||a.trim()==="")?new Error("请输入健康检查路径"):!0}]},{field:"healthCheckMethod",label:"检查方法",type:"select",placeholder:"请选择检查方法",span:12,tabKey:"health",show:t=>t.serviceType===A.STATIC&&t.healthCheckEnabled==="Y",defaultValue:"GET",tips:"健康检查使用的HTTP方法，通常使用GET或HEAD方法",options:[{label:"GET",value:"GET"},{label:"POST",value:"POST"},{label:"HEAD",value:"HEAD"}],rules:[{required:!0,message:"请选择健康检查方法",trigger:["blur","change"],validator:(t,a,d)=>d.healthCheckEnabled==="Y"&&(!a||a==="")?new Error("请选择健康检查方法"):!0}]},{field:"healthCheckIntervalSeconds",label:"检查间隔(秒)",type:"number",placeholder:"30",span:12,tabKey:"health",show:t=>t.serviceType===A.STATIC&&t.healthCheckEnabled==="Y",defaultValue:30,tips:"两次健康检查之间的时间间隔（秒）。范围1-300秒",props:{min:1,max:300},rules:[{required:!0,message:"请输入检查间隔",trigger:["blur","change"],validator:(t,a,d)=>d.healthCheckEnabled==="Y"&&(a==null||a==="")?new Error("请输入检查间隔"):!0}]},{field:"healthCheckTimeoutMs",label:"检查超时(ms)",type:"number",placeholder:"5000",span:12,tabKey:"health",show:t=>t.serviceType===A.STATIC&&t.healthCheckEnabled==="Y",defaultValue:5e3,tips:"健康检查请求的超时时间（毫秒），超时则视为检查失败。范围100-30000ms",props:{min:100,max:3e4},rules:[{required:!0,message:"请输入检查超时",trigger:["blur","change"],validator:(t,a,d)=>d.healthCheckEnabled==="Y"&&(a==null||a==="")?new Error("请输入检查超时"):!0}]},{field:"healthyThreshold",label:"健康阈值",type:"number",placeholder:"2",span:12,tabKey:"health",show:t=>t.serviceType===A.STATIC&&t.healthCheckEnabled==="Y",defaultValue:2,tips:"连续成功检查次数达到此值时，节点从 unhealthy 转为 healthy。范围1-10",props:{min:1,max:10},rules:[{required:!0,message:"请输入健康阈值",trigger:["blur","change"],validator:(t,a,d)=>d.healthCheckEnabled==="Y"&&(a==null||a==="")?new Error("请输入健康阈值"):!0}]},{field:"unhealthyThreshold",label:"不健康阈值",type:"number",placeholder:"3",span:12,tabKey:"health",show:t=>t.serviceType===A.STATIC&&t.healthCheckEnabled==="Y",defaultValue:3,tips:"连续失败检查次数达到此值时，节点从 healthy 转为 unhealthy。范围1-10",props:{min:1,max:10},rules:[{required:!0,message:"请输入不健康阈值",trigger:["blur","change"],validator:(t,a,d)=>d.healthCheckEnabled==="Y"&&(a==null||a==="")?new Error("请输入不健康阈值"):!0}]},{field:"expectedStatusCodes",label:"期望状态码",type:"input",placeholder:"200,201,204",span:24,tabKey:"health",show:t=>t.serviceType===A.STATIC&&t.healthCheckEnabled==="Y",defaultValue:"200",tips:"健康检查视为成功的HTTP状态码，支持逗号分隔多个值（如：200,201,204）或JSON数组格式",rules:[{required:!0,message:"请输入期望状态码",trigger:["blur","input"],validator:(t,a,d)=>d.healthCheckEnabled==="Y"&&(!a||a.trim()==="")?new Error("请输入期望状态码"):!0}]},{field:"discoveryType",label:"发现类型",type:"select",placeholder:"请选择服务发现类型",span:12,tabKey:"discovery",show:t=>t.serviceType===A.DISCOVERY,disabled:!0,defaultValue:"REGISTRY",tips:"服务发现类型，当前仅支持从服务注册中心发现服务实例",options:[{label:"服务注册",value:"REGISTRY"}]},{field:"protocolType",label:"服务协议",type:"select",placeholder:"请选择服务协议",span:12,tabKey:"discovery",show:t=>t.serviceType===A.DISCOVERY,required:!0,defaultValue:"http",tips:"访问后端服务使用的协议类型",options:[{label:"HTTP",value:"http"},{label:"HTTPS",value:"https"}],rules:[{required:!0,message:"请选择服务协议",trigger:["blur","change"],validator:(t,a,d)=>d.serviceType===A.DISCOVERY&&(!a||a==="")?new Error("请选择服务协议"):!0}]},{field:"serviceMetadata",label:"服务元数据",type:"textarea",placeholder:"{}",span:24,tabKey:"discovery",show:!1,props:{rows:5},tips:"服务元数据，包含从服务注册中心选择的服务信息（JSON格式）"},{field:"serviceSelection",label:"注册服务",type:"custom",span:24,tabKey:"discovery",show:t=>t.serviceType===A.DISCOVERY,tips:"从服务注册中心选择一个可用的服务，选择后会自动填充服务元数据",render:(t,a)=>{var e;const d=((e=a==null?void 0:a.selectedService)==null?void 0:e.value)||null,D=a==null?void 0:a.onServiceChange,s=(a==null?void 0:a.to)||"body";return le(sa,{modelValue:d,to:s,"onUpdate:modelValue":n=>{D==null||D(n)},onChange:n=>{D==null||D(n)}})}},{field:"discoveryConfig",label:"发现配置",type:"textarea",placeholder:"{}",span:24,tabKey:"discovery",show:!1,props:{rows:5}},{field:"activeFlag",label:"启用状态",type:"switch",span:12,tabKey:"other",defaultValue:"Y",tips:"控制服务定义是否启用，禁用的服务不会被加载到网关",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"noteText",label:"备注信息",type:"textarea",placeholder:"请输入备注信息",span:24,tabKey:"other",tips:"服务的额外备注信息，用于记录配置说明或其他相关信息",props:{rows:4}},{field:"addTime",label:"创建时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"addWho",label:"创建人",type:"input",span:12,tabKey:"other",disabled:!0},{field:"editTime",label:"修改时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"editWho",label:"修改人",type:"input",span:12,tabKey:"other",disabled:!0}]};return{moduleId:o,loading:g,serviceList:l,pageInfo:p,searchFormConfig:c,serviceFormConfig:i,gridConfig:{columns:[{field:"serviceDefinitionId",title:"服务定义ID",visible:!1,width:0},{field:"serviceName",title:"服务名称",sortable:!0,align:"center",showOverflow:"tooltip",width:200},{field:"serviceDesc",title:"服务描述",align:"center",showOverflow:"tooltip",width:200},{field:"serviceType",title:"服务类型",align:"center",slots:{default:"serviceType"},width:120},{field:"loadBalanceStrategy",title:"负载均衡策略",align:"center",slots:{default:"loadBalanceStrategy"},width:150},{field:"nodeCount",title:"服务节点",align:"center",formatter:()=>"0",width:100},{field:"sessionAffinity",title:"会话亲和性",align:"center",slots:{default:"sessionAffinity"},width:120},{field:"maxRetries",title:"最大重试",align:"center",width:100},{field:"enableCircuitBreaker",title:"熔断器",align:"center",slots:{default:"enableCircuitBreaker"},width:100},{field:"healthCheckEnabled",title:"健康检查",align:"center",slots:{default:"healthCheckEnabled"},width:120},{field:"healthCheckPath",title:"检查路径",align:"center",showOverflow:"tooltip",width:150},{field:"activeFlag",title:"状态",align:"center",slots:{default:"activeFlag"},width:100},{field:"addTime",title:"创建时间",sortable:!0,align:"center",showOverflow:!0,formatter:({cellValue:t})=>t?oe(t,"YYYY-MM-DD HH:mm:ss"):"",width:180},{field:"addWho",title:"创建人",align:"center",showOverflow:!0,width:120},{field:"editTime",title:"修改时间",sortable:!0,align:"center",showOverflow:!0,formatter:({cellValue:t})=>t?oe(t,"YYYY-MM-DD HH:mm:ss"):"",width:180},{field:"editWho",title:"修改人",align:"center",showOverflow:!0,width:120}],showCheckbox:!0,paginationConfig:{show:!0,pageInfo:p,align:"right"},menuConfig:{enabled:!0,showCopyRow:!0,showCopyCell:!0,customMenus:[{code:"view",name:"查看详情",prefixIcon:"vxe-icon-eye-fill"},{code:"edit",name:"编辑",prefixIcon:"vxe-icon-edit"},{code:"manageNodes",name:"节点管理",prefixIcon:"vxe-icon-setting"},{code:"delete",name:"删除",prefixIcon:"vxe-icon-delete"}]},height:"100%",rowId:"serviceDefinitionId"},resetPagination:()=>{p.value=void 0},updatePagination:t=>{p.value?Object.assign(p.value,t):p.value=t},setServiceList:t=>{l.value=t},addServiceToList:t=>{l.value.push(t)},updateServiceInList:t=>{const a=l.value.findIndex(d=>d.serviceDefinitionId===t.serviceDefinitionId);a>=0&&Object.assign(l.value[a],t)},removeServiceFromList:t=>{const a=l.value.findIndex(d=>d.serviceDefinitionId===t);a>=0&&l.value.splice(a,1)},removeServicesFromList:t=>{l.value=l.value.filter(a=>!t.includes(a.serviceDefinitionId))}}}function da(o,g){const l=re(),p=qe(),c=ca(),{loading:i,serviceList:b,pageInfo:u,setServiceList:C,updatePagination:k,addServiceToList:_,updateServiceInList:F,removeServiceFromList:H,removeServicesFromList:L}=c,t=async v=>{var y,w,x;i.value=!0;try{let G=v;!G&&((y=g==null?void 0:g.value)!=null&&y.getFormData)&&(G=g.value.getFormData()||{});const j=G?Object.fromEntries(Object.entries(G).filter(([,T])=>T!==""&&T!==null&&T!==void 0)):{},X={...j,...j.proxyConfigId===void 0&&o?{proxyConfigId:o}:{},...Re((w=u.value)==null?void 0:w.pageIndex,(x=u.value)==null?void 0:x.pageSize)},h=await ft(X);if(h.oK){if(h.bizData){const T=JSON.parse(h.bizData),S=Array.isArray(T)?T:[];C(S)}if(h.pageQueryData){const T=JSON.parse(h.pageQueryData);k(T)}}else l.error(h.errMsg||"查询服务定义列表失败")}catch{l.error("加载服务定义列表失败")}finally{i.value=!1}};return{model:c,loadServiceList:t,handleSearch:async v=>{await t(v)},handleReset:async()=>{c.resetPagination(),await t()},handlePageChange:async({currentPage:v,pageSize:y})=>{k({pageIndex:v,pageSize:y}),await t()},addService:async v=>{i.value=!0;try{const y=await vt(v);if(W(y)){const w=Y(y,"服务定义创建成功");if(l.success(w),y.bizData){const x=JSON.parse(y.bizData);_(x)}else await t();return!0}else{const w=Y(y,"新增服务定义失败");return l.error(w),!1}}catch{return l.error("新增服务定义失败"),!1}finally{i.value=!1}},editService:async(v,y)=>{i.value=!0;try{const w=await be({...y,serviceDefinitionId:v});if(W(w)){const x=Y(w,"服务定义更新成功");if(l.success(x),w.bizData){const G=JSON.parse(w.bizData);F(G)}else await t();return!0}else{const x=Y(w,"更新服务定义失败");return l.error(x),!1}}catch{return l.error("更新服务定义失败"),!1}finally{i.value=!1}},deleteService:async v=>{const y=b.value.find(x=>x.serviceDefinitionId===v);if(!y)return l.error("未找到要删除的服务定义"),!1;if(!await p.warning({title:"确认删除",subtitle:"此操作不可恢复，请谨慎操作",content:`确定要删除服务定义 "${y.serviceName||y.serviceDefinitionId}" 吗？`,icon:ye,headerStyle:"gradient",positiveText:"确定删除",negativeText:"取消",width:500}))return!1;i.value=!0;try{const x=await Ve(v,"default");return x.oK?(l.success(Y(x,"删除服务定义成功")),H(v),b.value.length===0&&u.value&&u.value.pageIndex>1?(k({pageIndex:u.value.pageIndex-1}),await t()):await t(),!0):(l.error(Y(x,"删除服务定义失败")),!1)}catch{return l.error("删除服务定义失败"),!1}finally{i.value=!1}},batchDeleteServices:async v=>{if(await p.warning({title:"确认批量删除",subtitle:"此操作不可恢复，请谨慎操作",content:`确定要删除选中的 ${v.length} 个服务定义吗？`,icon:ye,headerStyle:"gradient",positiveText:"确定删除",negativeText:"取消",width:500})){i.value=!0;try{let w=0,x=0;for(const G of v)try{(await Ve(G,"default")).oK?w++:x++}catch{x++}w>0?(l.success(`成功删除 ${w} 个服务定义${x>0?`，失败 ${x} 个`:""}`),L(v.slice(0,w)),await t()):l.error(`删除失败，共 ${x} 个`)}catch{l.error("批量删除失败")}finally{i.value=!1}}},toggleServiceStatus:async v=>{const y=v.activeFlag==="Y"?"N":"Y",w=y==="Y"?"启用":"禁用";try{const x=await be({serviceDefinitionId:v.serviceDefinitionId,tenantId:"default",activeFlag:y});x.oK?(l.success(`${w}成功`),F({...v,activeFlag:y}),await t()):l.error(x.errMsg||`${w}失败`)}catch{l.error(`${w}失败`)}},batchToggleServiceStatus:async(v,y)=>{const w=y==="Y"?"启用":"禁用";try{const x=v.map(X=>be({serviceDefinitionId:X,tenantId:"default",activeFlag:y})),j=(await Promise.all(x)).filter(X=>X.oK).length;j===v.length?l.success(`成功${w} ${j} 个服务定义`):l.warning(`${w}了 ${j}/${v.length} 个服务定义`),await t()}catch{l.error(`批量${w}失败`)}}}}function ua(o,g,l){const p=re(),c=E(null),i=da(o,g),b=E(!1),u=E("create"),C=E(null),k=E(!1),_=E(""),F=h=>{const T=P=>{if(typeof P=="string"&&P)try{return JSON.parse(P)}catch{return P}return P},S={...h};if(["discoveryConfig","healthCheckHeaders","loadBalancerConfig"].forEach(P=>{const R=T(h[P]);R&&typeof R=="object"&&!Array.isArray(R)&&(Object.keys(R).forEach(Z=>{S[`${P}.${Z}`]=R[Z]}),delete S[P])}),S.serviceMetadata&&typeof S.serviceMetadata=="string")try{const P=JSON.parse(S.serviceMetadata);P.protocolType&&(S.protocolType=P.protocolType)}catch{}else S.serviceMetadata&&typeof S.serviceMetadata=="object"?(S.serviceMetadata.protocolType&&(S.protocolType=S.serviceMetadata.protocolType),S.serviceMetadata=JSON.stringify(S.serviceMetadata)):S.serviceMetadata=void 0;return S.protocolType||(S.protocolType="http"),S},H=h=>{const T=["discoveryConfig","healthCheckHeaders","loadBalancerConfig"],S={};if(T.forEach(K=>{const P={};Object.keys(h).forEach(R=>{if(R.startsWith(`${K}.`)){const Z=R.replace(`${K}.`,"");P[Z]=h[R]}}),Object.keys(P).length>0&&(S[K]=JSON.stringify(P))}),h.serviceMetadata)if(typeof h.serviceMetadata=="string")try{JSON.parse(h.serviceMetadata),S.serviceMetadata=h.serviceMetadata}catch{S.serviceMetadata="{}"}else typeof h.serviceMetadata=="object"?S.serviceMetadata=JSON.stringify(h.serviceMetadata):S.serviceMetadata="{}";else S.serviceMetadata=void 0;return Object.keys(h).forEach(K=>{!T.some(P=>K.startsWith(`${P}.`))&&K!=="serviceMetadata"&&(S[K]=h[K])}),S},L=(h=!0)=>o?!0:(h&&p.warning("请先选择网关实例"),!1),t=()=>{L()&&(u.value="create",C.value=null,c.value=null,b.value=!0)},a=async h=>{if(L())try{const T=await ge(h.serviceDefinitionId,"default");if(W(T)){const S=JSON.parse(T.bizData),K=F(S);if(K.serviceType===1&&K.serviceMetadata)try{const P=typeof K.serviceMetadata=="string"?JSON.parse(K.serviceMetadata):K.serviceMetadata;c.value={tenantId:P.tenantId||"default",namespaceId:P.namespaceId,groupName:P.groupName||"DEFAULT_GROUP",serviceName:P.serviceName,discoveryType:"INTERNAL",protocolType:P.protocolType||"http"}}catch{c.value=null}else c.value=null;u.value="edit",C.value=K,b.value=!0}else p.error(Y(T,"获取服务定义详情失败"))}catch{p.error("获取服务定义详情失败")}},d=async h=>{if(L())try{const T=await ge(h.serviceDefinitionId,"default");if(W(T)){const S=JSON.parse(T.bizData),K=F(S);if(K.serviceType===1&&K.serviceMetadata)try{const P=typeof K.serviceMetadata=="string"?JSON.parse(K.serviceMetadata):K.serviceMetadata;c.value={tenantId:P.tenantId||"default",namespaceId:P.namespaceId,groupName:P.groupName||"DEFAULT_GROUP",serviceName:P.serviceName,discoveryType:"INTERNAL",protocolType:P.protocolType||"http"}}catch{c.value=null}else c.value=null;u.value="view",C.value=K,b.value=!0}else p.error(Y(T,"获取服务定义详情失败"))}catch{p.error("获取服务定义详情失败")}},D=async h=>{if(L())try{const T=await ge(h.serviceDefinitionId,"default");if(W(T)){const S=JSON.parse(T.bizData),P={...F(S),serviceDefinitionId:void 0,serviceName:`${S.serviceName}_copy`,activeFlag:"Y"};if(P.serviceType===1&&P.serviceMetadata)try{const R=typeof P.serviceMetadata=="string"?JSON.parse(P.serviceMetadata):P.serviceMetadata;c.value={tenantId:R.tenantId||"default",namespaceId:R.namespaceId,groupName:R.groupName||"DEFAULT_GROUP",serviceName:R.serviceName,discoveryType:"INTERNAL",protocolType:R.protocolType||"http"}}catch{c.value=null}else c.value=null;u.value="create",C.value=P,b.value=!0}else p.error(Y(T,"获取服务定义详情失败"))}catch{p.error("获取服务定义详情失败")}},s=h=>{L()&&(_.value=h.serviceDefinitionId,k.value=!0)},e=()=>{b.value=!1,C.value=null,c.value=null},n=async h=>{if(h&&u.value!=="view"){if(!L())return!1;if(h.serviceType===1){if(c.value)f(h);else if(!h.serviceMetadata)return p.warning("请选择注册服务"),!1}try{const S={...H(h),tenantId:"default",proxyConfigId:o||h.proxyConfigId};let K=!1;u.value==="create"?K=await i.addService(S):u.value==="edit"&&C.value&&(K=await i.editService(C.value.serviceDefinitionId,S)),K&&e()}catch{p.error("操作失败")}}},O=h=>{c.value=h,h?console.log("已选择服务:",h.serviceName):console.log("已清除服务选择")},f=h=>{if(c.value){const T={tenantId:c.value.tenantId||"default",namespaceId:c.value.namespaceId,groupName:c.value.groupName||"DEFAULT_GROUP",serviceName:c.value.serviceName,discoveryType:"INTERNAL",protocolType:(h==null?void 0:h.protocolType)||"http"},S=JSON.stringify(T);return h&&(h.serviceMetadata=S),console.log("已更新服务元数据（registry_utils.go 兼容格式）:",T),S}else{h&&(h.serviceMetadata=void 0);return}},m=async h=>{L()&&await i.deleteService(h.serviceDefinitionId)},v=async()=>{var S,K,P,R;if(!L())return;if(!(l!=null&&l.value)){p.warning("Grid 引用未设置");return}const h=((K=(S=l.value).getCheckboxRecords)==null?void 0:K.call(S))||((R=(P=l.value).getSelectRecords)==null?void 0:R.call(P))||[];if(h.length===0){p.warning("请选择要删除的服务定义");return}const T=h.map(Z=>Z.serviceDefinitionId);await i.batchDeleteServices(T)},y=async h=>{if(!L())return;const T=h?{...h,...o?{proxyConfigId:o}:{}}:o?{proxyConfigId:o}:void 0;await i.handleSearch(T)},w=async(h,T)=>{var S,K,P,R,Z,Ne,xe,Pe,ke,_e,Me,Oe,Ee,Fe,De,Le;switch(h){case"add":t();break;case"delete":{if(!(l!=null&&l.value)){p.warning("Grid 引用未设置");return}const te=((K=(S=l.value).getCheckboxRecords)==null?void 0:K.call(S))||((R=(P=l.value).getSelectRecords)==null?void 0:R.call(P))||[];if(te.length===0){p.warning("请选择要删除的服务定义");return}const Q=te.map(Xe=>Xe.serviceDefinitionId);await i.batchDeleteServices(Q);break}case"view":{if(!(l!=null&&l.value)){p.warning("Grid 引用未设置");return}const te=(Ne=(Z=l.value).getCurrentRecord)==null?void 0:Ne.call(Z);if(te){d(te);return}const Q=((Pe=(xe=l.value).getCheckboxRecords)==null?void 0:Pe.call(xe))||((_e=(ke=l.value).getSelectRecords)==null?void 0:_e.call(ke))||[];if(Q.length===0){p.warning("请先点击选择要查看的服务定义");return}if(Q.length>1){p.warning("请选择单个服务定义进行查看");return}d(Q[0]);break}case"manageNodes":{if(!(l!=null&&l.value)){p.warning("Grid 引用未设置");return}const te=(Oe=(Me=l.value).getCurrentRecord)==null?void 0:Oe.call(Me);if(te){s(te);return}const Q=((Fe=(Ee=l.value).getCheckboxRecords)==null?void 0:Fe.call(Ee))||((Le=(De=l.value).getSelectRecords)==null?void 0:Le.call(De))||[];if(Q.length===0){p.warning("请先点击选择要管理的服务定义");return}if(Q.length>1){p.warning("请选择单个服务定义进行节点管理");return}s(Q[0]);break}case"search":{await y(T);break}}},x=({code:h,row:T})=>{if(T)switch(h){case"view":d(T);break;case"edit":a(T);break;case"manageNodes":s(T);break;case"copy":D(T);break;case"delete":m(T);break}},G=()=>{i.loadServiceList()},j=async()=>{o?await i.loadServiceList({proxyConfigId:o}):await i.loadServiceList()};o&&Ue(()=>{i.loadServiceList({proxyConfigId:o})});const X=i.model.serviceFormConfig.fields.map(h=>{if(h.field==="serviceSelection"&&h.render){const T=h.render;return{...h,render:S=>T(S,{selectedService:c,onServiceChange:O,to:"#hub0022-service-definition-list"})}}return h});return{service:{...i,model:{...i.model,serviceFormConfig:{...i.model.serviceFormConfig,fields:X}}},formDialogVisible:b,formDialogMode:u,currentEditService:C,showNodeDialog:k,currentServiceId:_,selectedService:c,openAddDialog:t,openEditDialog:a,openViewDialog:d,openCopyDialog:D,openNodeDialog:s,closeFormDialog:e,handleFormSubmit:n,handleDelete:m,handleBatchDelete:v,handleSearch:y,handleToolbarClick:w,handleMenuClick:x,refresh:G,loadServiceList:j,handleServiceChange:O,updateServiceMetadata:f}}const pa={class:"service-definition-list",id:"hub0022-service-definition-list"},fa=ce({name:"ServiceDefinitionList",__name:"ServiceDefinitionList",props:{gatewayInstanceId:{default:void 0}},setup(o){const g=o,l=E(),p=E(),{service:c,formDialogVisible:i,formDialogMode:b,currentEditService:u,showNodeDialog:C,currentServiceId:k,handleFormSubmit:_,handleToolbarClick:F,handleMenuClick:H}=ua(g.gatewayInstanceId,l,p),L=se(()=>g.gatewayInstanceId,(d,D)=>{d&&d!==D?c.loadServiceList({proxyConfigId:d}):!d&&D&&(c.model.serviceList.value=[])},{immediate:!1});pe(()=>{L()});function t(d){if(!g.gatewayInstanceId)return;const D=d?{...d,...g.gatewayInstanceId?{proxyConfigId:g.gatewayInstanceId}:{}}:g.gatewayInstanceId?{proxyConfigId:g.gatewayInstanceId}:void 0;c.handleSearch(D)}function a(d){return{[$.ROUND_ROBIN]:"轮询",[$.RANDOM]:"随机",[$.IP_HASH]:"IP哈希",[$.LEAST_CONN]:"最少连接",[$.WEIGHTED_ROUND_ROBIN]:"加权轮询",[$.CONSISTENT_HASH]:"一致性哈希"}[d]||d}return(d,D)=>(J(),ae("div",pa,[I(r(Te),{direction:"vertical","default-size":"80px"},{1:N(()=>[I(Ce,ve({ref_key:"searchFormRef",ref:l,"module-id":r(c).model.moduleId},r(c).model.searchFormConfig,{onSearch:t,onToolbarClick:r(F)}),null,16,["module-id","onToolbarClick"])]),2:N(()=>[I(r(Se),ve({ref_key:"gridRef",ref:p,"module-id":r(c).model.moduleId,data:r(c).model.serviceList,loading:r(c).model.loading},r(c).model.gridConfig,{onPageChange:r(c).handlePageChange,onMenuClick:r(H)}),{serviceType:N(({row:s})=>[I(r(B),{type:s.serviceType===0?"info":"success",size:"small"},{default:N(()=>[U(z(s.serviceType===0?"静态配置":"服务发现"),1)]),_:2},1032,["type"])]),loadBalanceStrategy:N(({row:s})=>[I(r(B),{type:"default",size:"small"},{default:N(()=>[U(z(a(s.loadBalanceStrategy)),1)]),_:2},1024)]),sessionAffinity:N(({row:s})=>[I(r(B),{type:s.sessionAffinity==="Y"?"success":"default",size:"small"},{default:N(()=>[U(z(s.sessionAffinity==="Y"?"启用":"未启用"),1)]),_:2},1032,["type"])]),enableCircuitBreaker:N(({row:s})=>[I(r(B),{type:s.enableCircuitBreaker==="Y"?"warning":"default",size:"small"},{default:N(()=>[U(z(s.enableCircuitBreaker==="Y"?"启用":"未启用"),1)]),_:2},1032,["type"])]),healthCheckEnabled:N(({row:s})=>[I(r(B),{type:s.healthCheckEnabled==="Y"?"success":"default",size:"small"},{default:N(()=>[U(z(s.healthCheckEnabled==="Y"?"已启用":"未启用"),1)]),_:2},1032,["type"])]),activeFlag:N(({row:s})=>[I(r(B),{type:s.activeFlag==="Y"?"success":"error",size:"small"},{default:N(()=>[U(z(s.activeFlag==="Y"?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1},16,["module-id","data","loading","onPageChange","onMenuClick"])]),_:1}),I(we,{visible:r(i),"onUpdate:visible":D[0]||(D[0]=s=>me(i)?i.value=s:null),mode:r(b),title:r(b)==="create"?"新增服务定义":r(b)==="edit"?"编辑服务定义":"查看服务定义详情",to:"#hub0022-service-definition-list","form-fields":r(c).model.serviceFormConfig.fields,"form-tabs":r(c).model.serviceFormConfig.tabs,"initial-data":r(u)||void 0,"auto-close-on-confirm":!1,"confirm-loading":r(c).model.loading.value,onSubmit:r(_)},null,8,["visible","mode","title","form-fields","form-tabs","initial-data","confirm-loading","onSubmit"]),I(r(Kt),{visible:r(C),"onUpdate:visible":D[1]||(D[1]=s=>me(C)?C.value=s:null),"service-definition-id":r(k),title:"服务节点管理",width:1200,to:"#hub0022-service-definition-list"},null,8,["visible","service-definition-id"])]))}}),va=de(fa,[["__scopeId","data-v-ffee8dd0"]]),ha={class:"left-panel"},Ye="proxy-management",ya=ce({name:"ProxyManagement",__name:"ProxyManagement",setup(o){const g=E(""),l=ie(()=>g.value||"");function p(c,i){g.value=c}return(c,i)=>(J(),ae("div",{class:"proxy-management",id:Ye},[I(r(Te),{direction:"horizontal","default-size":.25,max:.4},{1:N(()=>[V("div",ha,[I(r(Mt),{"parent-module-id":Ye,onSelect:p})])]),2:N(()=>[(J(),ue(va,{"gateway-instance-id":l.value,key:`service-${l.value}`},null,8,["gateway-instance-id"]))]),_:1})]))}}),$a=de(ya,[["__scopeId","data-v-adc92ac8"]]);export{$a as default};
