import{u as ue,G as oe}from"./GDataFormModal-ujK6EWMq.js";import{c as Ce,G as we,S as Se}from"./SearchForm-BrJVyB-j.js";import{G as ke}from"./GPane-wUfMyun8.js";import{r as f,T as R,ab as re,j as pe,m as fe,z as O,A as ge,B as S,d as Ae,b as Te,e as w,w as P,f as t,cj as N,o as j,am as ce,aO as W,K as q,t as Q,h as de,_ as Le}from"./index-5EEl7uBB.js";import{N as Ve,I as De,U as xe,A as Fe,D as Pe,C as Me,a as Ne,R as Oe}from"./RateLimitConfigFormModal-Bd8RYJ9S.js";/* empty css                                                                    */import{g as Ye,r as Ee,s as Ge,a as Ke,d as He,e as ze,b as Be,q as Ue,c as _e,f as $e}from"./index-iCutsX69.js";import{D as Je,W as Re}from"./WarningOutline-DrWbb0Pb.js";import{K as je}from"./KeyOutline-C8Z0p9xB.js";import{A as We,T as qe}from"./TrashOutline-B_Fdd9Cw.js";import{C as Qe}from"./CreateOutline-BLyYB2je.js";import{G as Xe}from"./GlobeOutline-DkYcM-KD.js";import{R as Ze}from"./RefreshOutline-Dv7r-Rd6.js";import{S as et,P as tt}from"./StopCircleOutline-D4o9A_Dy.js";import{C as at}from"./CheckmarkCircleOutline-BPwXujVq.js";import{A as lt}from"./AlertCircleOutline-CLAs_bJn.js";import"./GDialog-bShGBhcX.js";import"./Scrollbar-OdgpPYnU.js";import"./CloseOutline-DdMvPTyN.js";import"./GModal-ChRg2nWo.js";import"./DownloadOutline-k4HyeYDj.js";import"./OptionsOutline-B8PF3uz2.js";import"./DatePicker-DFmKMzO1.js";import"./Select-CXtu4E1G.js";import"./Upload-Wspc5QQu.js";import"./download-C2161hUv.js";import"./Grid-D9pJ1pfL.js";import"./InputNumber-B4XP-lw5.js";import"./Switch-f5gQ9wHB.js";import"./index-DR_R-bYe.js";import"./InformationCircleOutline-PSlRY60z.js";import"./prop-BjyUHhTu.js";import"./Alert-BtoujAf6.js";function nt(){const I="hub0020",u=f(!1),p=f([]),c=f(),d={fields:[{field:"instanceName",label:"实例名称",type:"input",placeholder:"请输入实例名称",span:6,clearable:!0},{field:"healthStatus",label:"健康状态",type:"select",placeholder:"请选择状态",span:6,clearable:!0,options:[{label:"全部",value:""},{label:"健康",value:"Y"},{label:"不健康",value:"N"}]},{field:"activeFlag",label:"活动状态",type:"select",placeholder:"请选择状态",span:6,clearable:!0,options:[{label:"全部",value:""},{label:"活动",value:"Y"},{label:"非活动",value:"N"}]}],toolbarButtons:[{key:"add",label:"新建实例",icon:We,type:"primary",tooltip:"新建网关实例"},{key:"edit",label:"编辑",icon:Qe,tooltip:"编辑选中的实例"},{key:"delete",label:"删除",icon:qe,type:"error",tooltip:"删除选中的实例"}],showSearchButton:!0,showResetButton:!0},k={tabs:[{key:"basic",label:"基本信息"},{key:"tls",label:"TLS配置"},{key:"performance",label:"性能配置"},{key:"other",label:"其它"}],fields:[{field:"instanceName",label:"实例名称",type:"input",placeholder:"请输入实例名称",span:12,tabKey:"basic",required:!0},{field:"bindAddress",label:"绑定地址",type:"input",placeholder:"如: 0.0.0.0",span:12,tabKey:"basic",defaultValue:"0.0.0.0",tips:"服务器绑定的网络地址，0.0.0.0表示监听所有网络接口"},{field:"httpPort",label:"HTTP端口",type:"number",placeholder:"如: 8080",span:12,tabKey:"basic",defaultValue:8080,props:{min:1,max:65535}},{field:"httpsPort",label:"HTTPS端口",type:"number",placeholder:"如: 8443",span:12,tabKey:"basic",defaultValue:8443,tips:"HTTPS服务监听的端口号，范围1-65535，需要启用TLS后生效",props:{min:1,max:65535}},{field:"activeFlag",label:"自动启动",type:"switch",span:12,tabKey:"basic",defaultValue:"Y",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"instanceDesc",label:"实例描述",type:"textarea",placeholder:"请输入实例描述",span:24,tabKey:"basic",props:{rows:3}},{field:"tls-config-group",label:"TLS安全配置",type:"fieldset",tabKey:"tls",children:[{field:"certStorageType",label:"证书存储类型",type:"select",span:12,defaultValue:"DATABASE",show:!1,options:[{label:"文件存储",value:"FILE"},{label:"数据库存储",value:"DATABASE"}]},{field:"tlsEnabled",label:"启用TLS",type:"switch",span:12,defaultValue:"N",tips:"启用HTTPS/TLS加密传输，保护数据传输安全",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"certPassword",label:"证书密码",type:"input",placeholder:"请输入证书密码(可选)",span:12,tips:"如果私钥文件已加密，需要提供密码进行解密",props:{type:"password",showPasswordOn:"click"}},{field:"tlsVersion",label:"TLS版本",type:"select",placeholder:"选择支持的TLS版本",span:12,defaultValue:["1.2"],tips:"选择支持的TLS协议版本，建议至少启用TLS 1.2，TLS 1.0和1.1已不安全",props:{multiple:!0,maxTagCount:2},options:[{label:"TLS 1.0",value:"1.0"},{label:"TLS 1.1",value:"1.1"},{label:"TLS 1.2",value:"1.2"},{label:"TLS 1.3",value:"1.3"}]},{field:"enableHttp2",label:"启用HTTP/2",type:"switch",span:12,defaultValue:"Y",tips:"启用HTTP/2协议，支持多路复用、头部压缩等特性，提升性能（需要TLS支持）",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"tlsCipherSuites",label:"TLS密码套件",type:"input",placeholder:"多个密码套件用逗号分隔，如: TLS_AES_256_GCM_SHA384,TLS_CHACHA20_POLY1305_SHA256，留空使用默认配置",span:24,tips:"指定允许的TLS密码套件，留空使用系统默认的安全配置，建议使用强加密套件",clearable:!0},{field:"certFileList",label:"证书文件",type:"file",span:12,props:{title:"证书文件",titleIcon:Je,titleIconColor:"#18a058",showDownload:!0,config:{accept:".crt,.pem,.cer",max:1,maxSize:10*1024*1024,mode:"text",uploadText:"点击或拖拽上传证书",uploadDescription:"支持 .crt, .pem, .cer"}}},{field:"keyFileList",label:"私钥文件",type:"file",span:12,props:{title:"私钥文件",titleIcon:je,titleIconColor:"#f0a020",showDownload:!0,config:{accept:".key,.pem",max:1,maxSize:10*1024*1024,mode:"text",uploadText:"点击或拖拽上传私钥",uploadDescription:"支持 .key, .pem"}}}]},{field:"performance-config-group",label:"性能配置",type:"fieldset",tabKey:"performance",children:[{field:"maxConnections",label:"最大连接数",type:"number",placeholder:"10000",span:12,defaultValue:1e4,tips:"同时处理的最大并发连接数，超过此值的新连接将被拒绝",props:{min:100,max:1e5}},{field:"maxWorkers",label:"最大工作协程数",type:"number",placeholder:"1000",span:12,defaultValue:1e3,tips:"用于处理请求的最大工作协程数，影响并发处理能力",props:{min:100,max:1e4}},{field:"readTimeoutMs",label:"读取超时(ms)",type:"number",placeholder:"30000",span:12,defaultValue:3e4,tips:"从客户端读取请求头的最大时间，超时则关闭连接",props:{min:1e3,max:3e5}},{field:"writeTimeoutMs",label:"写入超时(ms)",type:"number",placeholder:"30000",span:12,defaultValue:3e4,tips:"向客户端写入响应的最大时间，超时则关闭连接",props:{min:1e3,max:3e5}},{field:"idleTimeoutMs",label:"空闲超时(ms)",type:"number",placeholder:"60000",span:12,defaultValue:6e4,tips:"保持连接空闲的最大时间，超时则关闭连接（用于HTTP Keep-Alive）",props:{min:1e3,max:6e5}},{field:"maxHeaderBytes",label:"最大请求头大小(字节)",type:"number",placeholder:"1048576",span:12,defaultValue:1048576,tips:"限制单个请求头的最大字节数，防止恶意请求头过大，对应 http.Server.MaxHeaderBytes",props:{min:1024,max:10485760}}]},{field:"keepalive-config-group",label:"Keep-Alive配置",type:"fieldset",tabKey:"performance",children:[{field:"keepAliveEnabled",label:"HTTP Keep-Alive",type:"switch",span:12,defaultValue:"Y",tips:"启用HTTP Keep-Alive，允许在同一个TCP连接上发送多个HTTP请求，提高性能",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"tcpKeepAliveEnabled",label:"TCP Keep-Alive",type:"switch",span:12,defaultValue:"Y",tips:"启用TCP Keep-Alive，定期发送探测包检测连接是否存活，自动清理僵尸连接",props:{checkedValue:"Y",uncheckedValue:"N"}}]},{field:"noteText",label:"备注",type:"textarea",placeholder:"请输入备注信息",span:24,tabKey:"other",props:{rows:3}},{field:"addTime",label:"创建时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"addWho",label:"创建人",type:"input",span:12,tabKey:"other",disabled:!0},{field:"editTime",label:"修改时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"editWho",label:"修改人",type:"input",span:12,tabKey:"other",disabled:!0}]},b={fields:[{field:"logConfigId",label:"日志配置ID",type:"input",span:12,show:!1},{field:"tenantId",label:"租户ID",type:"input",span:12,show:!1},{field:"configName",label:"日志配置名称",type:"input",placeholder:"请输入日志配置名称",span:12,required:!0},{field:"logFormat",label:"日志格式",type:"select",placeholder:"选择日志格式",span:12,defaultValue:"JSON",options:[{label:"JSON格式",value:"JSON"},{label:"文本格式",value:"TEXT"},{label:"CSV格式",value:"CSV"}]},{field:"configDesc",label:"日志配置描述",type:"textarea",placeholder:"请输入日志配置描述",span:24,props:{rows:2}},{field:"content-control-group",label:"日志内容控制",type:"fieldset",props:{titleSize:300},children:[{field:"recordRequestBody",label:"记录请求体",type:"switch",span:12,defaultValue:"N",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"recordResponseBody",label:"记录响应体",type:"switch",span:12,defaultValue:"N",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"recordHeaders",label:"记录请求头",type:"switch",span:12,defaultValue:"Y",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"maxBodySizeBytes",label:"最大报文大小(字节)",type:"number",placeholder:"1048576",span:12,defaultValue:1048576,props:{min:0}}]},{field:"output-target-group",label:"日志输出目标",type:"fieldset",props:{titleSize:300},children:[{field:"outputTargets",label:"输出目标",type:"select",placeholder:"选择日志输出目标",span:24,defaultValue:"DATABASE",options:[{label:"文件输出",value:"FILE"},{label:"数据库输出",value:"DATABASE"},{label:"MongoDB输出",value:"MONGODB"},{label:"Elasticsearch输出",value:"ELASTICSEARCH"},{label:"ClickHouse输出",value:"CLICKHOUSE"}]},{field:"fileConfig.filePath",label:"文件路径",type:"input",placeholder:"./logs/gateway.log",span:12,defaultValue:"./logs/gateway.log",show:r=>{const m=r.outputTargets||"";return typeof m=="string"&&m.includes("FILE")}},{field:"logRetentionDays",label:"文件保留天数",type:"number",placeholder:"30",span:12,defaultValue:30,props:{min:1},show:r=>{const m=r.outputTargets||"";return typeof m=="string"&&m.includes("FILE")}}]},{field:"async-processing-group",label:"异步和批量处理",type:"fieldset",props:{titleSize:300},children:[{field:"enableAsyncLogging",label:"启用异步日志",type:"switch",span:12,defaultValue:"Y",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"asyncQueueSize",label:"异步队列大小",type:"number",placeholder:"1000",span:12,defaultValue:1e3,props:{min:1}},{field:"batchSize",label:"批处理大小",type:"number",placeholder:"100",span:12,defaultValue:100,props:{min:1}},{field:"asyncFlushIntervalMs",label:"异步刷新间隔(ms)",type:"number",placeholder:"5000",span:12,defaultValue:5e3,props:{min:100,max:6e4}},{field:"enableBatchProcessing",label:"启用批量处理",type:"switch",span:12,defaultValue:"Y",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"batchTimeoutMs",label:"批处理超时(ms)",type:"number",placeholder:"1000",span:12,defaultValue:1e3,props:{min:1e3,max:3e5}}]},{field:"sensitive-data-group",label:"敏感数据处理",type:"fieldset",props:{titleSize:300},children:[{field:"enableSensitiveDataMasking",label:"启用敏感数据脱敏",type:"switch",span:12,defaultValue:"N",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"maskingPattern",label:"脱敏模式",type:"select",placeholder:"选择脱敏模式",span:12,defaultValue:"****",options:[{label:"替换为*",value:"****"},{label:"替换为[MASKED]",value:"[MASKED]"},{label:"保留前后字符",value:"KEEP_EDGE"},{label:"自定义规则",value:"CUSTOM"}]},{field:"sensitiveFields",label:"敏感字段",type:"custom",span:24,defaultValue:[],render:r=>R(Ve,{value:r.sensitiveFields||[],"onUpdate:value":m=>{r.sensitiveFields=m},placeholder:"添加敏感字段"})}]}]},h={columns:[{field:"gatewayInstanceId",title:"实例ID",sortable:!0,align:"center",showOverflow:!0},{field:"instanceName",title:"实例名称",sortable:!0,align:"center",showOverflow:!0},{field:"instanceDesc",title:"实例描述",align:"center",showOverflow:"tooltip"},{field:"bindAddress",title:"绑定地址",align:"center",showOverflow:!0},{field:"httpPort",title:"HTTP端口",align:"center"},{field:"httpsPort",title:"HTTPS端口",align:"center"},{field:"tlsEnabled",title:"TLS",align:"center",slots:{default:"tlsEnabled"}},{field:"maxConnections",title:"最大连接数",align:"center",formatter:({cellValue:r})=>r?r.toLocaleString():"0"},{field:"healthStatus",title:"健康状态",align:"center",slots:{default:"healthStatus"}},{field:"activeFlag",title:"活动状态",align:"center",slots:{default:"activeFlag"}},{field:"addTime",title:"创建时间",sortable:!0,showOverflow:!0,formatter:({cellValue:r})=>r?re(r,"YYYY-MM-DD HH:mm:ss"):""},{field:"addWho",title:"创建人",showOverflow:!0},{field:"editTime",title:"修改时间",sortable:!0,showOverflow:!0,formatter:({cellValue:r})=>r?re(r,"YYYY-MM-DD HH:mm:ss"):""},{field:"editWho",title:"修改人",showOverflow:!0}],showCheckbox:!0,paginationConfig:{show:!0,pageInfo:c,align:"right"},menuConfig:{enabled:!0,showCopyRow:!0,showCopyCell:!0,customMenus:[{code:"view",name:"查看详情",prefixIcon:"vxe-icon-eye-fill"},{code:"edit",name:"编辑",prefixIcon:"vxe-icon-edit"},{code:"delete",name:"删除",prefixIcon:"vxe-icon-delete"},{code:"start",name:"启动",prefixIcon:"vxe-icon-caret-right"},{code:"stop",name:"停止",prefixIcon:"vxe-icon-square"},{code:"globalConfig",name:"全局配置",prefixIcon:"vxe-icon-setting",children:[{code:"ipAccessControl",name:"IP访问控制",prefixIcon:"vxe-icon-lock"},{code:"userAgentAccessControl",name:"User-Agent访问控制",prefixIcon:"vxe-icon-user"},{code:"apiAccessControl",name:"API访问控制",prefixIcon:"vxe-icon-link"},{code:"domainAccessControl",name:"域名访问控制",prefixIcon:()=>R(pe,{size:12},{default:()=>R(Xe)})},{code:"corsConfig",name:"跨域配置",prefixIcon:"vxe-icon-link"},{code:"authConfig",name:"认证配置",prefixIcon:"vxe-icon-setting"},{code:"rateLimitConfig",name:"限流配置",prefixIcon:"vxe-icon-setting"}]},{code:"logConfig",name:"日志配置",prefixIcon:"vxe-icon-setting"},{code:"reload",name:"网关重载",prefixIcon:"vxe-icon-refresh"}]},height:"100%"},L=()=>{c.value=void 0},V=r=>{c.value?Object.assign(c.value,r):c.value=r},A=r=>{p.value=r},M=()=>{p.value=[]},Y=r=>{p.value.unshift(r)},C=(r,m,T)=>{const x=p.value.findIndex(F=>F.gatewayInstanceId===r&&F.tenantId===m);x!==-1&&Object.assign(p.value[x],T)},D=(r,m)=>{const T=p.value.findIndex(x=>x.gatewayInstanceId===r&&x.tenantId===m);T!==-1&&p.value.splice(T,1)};return{moduleId:I,loading:u,instanceList:p,pageInfo:c,searchFormConfig:d,instanceFormConfig:k,logConfigFormConfig:b,gridConfig:h,resetPagination:L,updatePagination:V,setInstanceList:A,clearInstanceList:M,addInstanceToList:Y,updateInstanceInList:C,removeInstanceFromList:D,removeInstancesFromList:r=>{r.forEach(m=>{D(m.gatewayInstanceId,m.tenantId)})}}}function st(I){const u=fe(),p=ue(),c=nt(),{loading:d,instanceList:k,pageInfo:b,setInstanceList:h,updatePagination:L,addInstanceToList:V,updateInstanceInList:A,removeInstanceFromList:M,removeInstancesFromList:Y}=c,C=async n=>{var o,s,y;d.value=!0;try{let v=n;!v&&((o=I==null?void 0:I.value)!=null&&o.getFormData)&&(v=I.value.getFormData()||{});const U={...v?Object.fromEntries(Object.entries(v).filter(([,i])=>i!==""&&i!==null&&i!==void 0)):{},...Ce((s=b.value)==null?void 0:s.pageIndex,(y=b.value)==null?void 0:y.pageSize)},g=await Ue(U);if(g.oK){if(g.bizData){const i=JSON.parse(g.bizData),$=Array.isArray(i)?i:[];h($)}if(g.pageQueryData){const i=JSON.parse(g.pageQueryData);L(i)}}else u.error(g.errMsg||"查询实例列表失败")}catch{u.error("加载实例列表失败")}finally{d.value=!1}};return{model:c,loadInstances:C,handleSearch:async n=>{await C(n)},handleReset:async()=>{c.resetPagination(),await C()},handlePageChange:async({currentPage:n,pageSize:o})=>{L({pageIndex:n,pageSize:o}),await C()},handleRefresh:async()=>{await C()},addInstance:async n=>{d.value=!0;try{const o={...n,tlsVersion:Array.isArray(n.tlsVersion)?n.tlsVersion.join(","):n.tlsVersion};delete o.logConfig;const s=await Be(o);if(O(s)){const y=S(s,"网关实例创建成功");if(u.success(y),s.bizData){const v=JSON.parse(s.bizData);V(v)}else await C();return!0}else{const y=S(s,"新增实例失败");return u.error(y),!1}}catch{return u.error("新增实例失败"),!1}finally{d.value=!1}},editInstance:async n=>{d.value=!0;try{const o={...n,tlsVersion:Array.isArray(n.tlsVersion)?n.tlsVersion.join(","):n.tlsVersion};delete o.logConfig;const s=await ze(o);if(O(s)){const y=S(s,"网关实例更新成功");if(u.success(y),s.bizData){const v=JSON.parse(s.bizData);A(v.gatewayInstanceId,v.tenantId,v)}else{const v=k.value.find(K=>K.gatewayInstanceId===n.gatewayInstanceId);v&&A(n.gatewayInstanceId,v.tenantId,o)}return!0}else{const y=S(s,"编辑实例失败");return u.error(y),!1}}catch{return u.error("编辑实例失败"),!1}finally{d.value=!1}},deleteInstance:async n=>{if(!await p.warning({title:"确认删除",subtitle:"此操作不可恢复，请谨慎操作",content:`确定要删除实例 "${n.instanceName}" 吗？`,icon:Re,headerStyle:"gradient",positiveText:"确定删除",negativeText:"取消",width:500}))return!1;d.value=!0;try{const s=await He(n.gatewayInstanceId,n.tenantId);if(O(s)){const y=S(s,"删除实例成功");return u.success(y),M(n.gatewayInstanceId,n.tenantId),k.value.length===0&&b.value&&b.value.pageIndex>1&&(L({pageIndex:b.value.pageIndex-1}),await C()),!0}else{const y=S(s,"删除实例失败");return u.error(y),!1}}catch{return u.error("删除实例失败"),!1}finally{d.value=!1}},startInstance:async n=>{d.value=!0;try{const o=await Ke(n.gatewayInstanceId,n.tenantId);if(O(o)){const s=S(o,"实例启动成功");return u.success(s),A(n.gatewayInstanceId,n.tenantId,{healthStatus:"Y"}),!0}else{const s=S(o,"启动失败");return u.error(s),!1}}catch{return u.error("启动失败"),!1}finally{d.value=!1}},stopInstance:async n=>{d.value=!0;try{const o=await Ge(n.gatewayInstanceId,n.tenantId);if(O(o)){const s=S(o,"实例停止成功");return u.success(s),A(n.gatewayInstanceId,n.tenantId,{healthStatus:"N"}),!0}else{const s=S(o,"停止失败");return u.error(s),!1}}catch{return u.error("停止失败"),!1}finally{d.value=!1}},reloadInstance:async n=>{d.value=!0;try{const o=await Ee(n.gatewayInstanceId,n.tenantId);if(O(o)){const s=S(o,"网关重载成功");return u.success(s),await C(),!0}else{const s=S(o,"网关重载失败");return u.error(s),!1}}catch{return u.error("网关重载失败"),!1}finally{d.value=!1}},getInstanceDetail:async(n,o)=>{try{const s=await Ye(n,o);return O(s)?ge(s,null):(u.error(S(s,"获取实例详情失败")),null)}catch{return u.error("获取实例详情失败"),null}}}}function it(I,u){const p=fe(),c=ue(),d=st(u),k=f(!1),b=f("create"),h=f(null),L=f(!1),V=f(!1),A=f(""),M=f(!1),Y=f("edit"),C=f(null),D=f(!1),H=f(!1),r=f(""),m=async a=>{r.value=a.gatewayInstanceId,H.value=!0},T=f(!1),x=f(""),F=async a=>{x.value=a.gatewayInstanceId,T.value=!0},z=f(!1),E=f(""),B=async a=>{E.value=a.gatewayInstanceId,z.value=!0},G=f(!1),n=f(""),o=async a=>{n.value=a.gatewayInstanceId,G.value=!0},s=f(!1),y=f(""),v=async a=>{y.value=a.gatewayInstanceId,s.value=!0},K=f(!1),U=f(""),g=async a=>{U.value=a.gatewayInstanceId,K.value=!0},i=f(!1),$=f(""),X=async a=>{$.value=a.gatewayInstanceId,i.value=!0},Z=()=>{b.value="create",h.value=null,k.value=!0},J=async a=>{try{const e=await d.getInstanceDetail(a.gatewayInstanceId,a.tenantId);if(!e){p.error("获取实例详情失败");return}const l={...e};e.certContent?l.certFileList=[{id:"cert-file",name:e.certFilePath||"certificate.pem",content:e.certContent,status:"finished"}]:l.certFileList=[],e.keyContent?l.keyFileList=[{id:"key-file",name:e.keyFilePath||"private-key.pem",content:e.keyContent,status:"finished"}]:l.keyFileList=[],b.value="edit",h.value=l,k.value=!0}catch{p.error("获取实例详情失败")}},ee=()=>{k.value=!1,h.value=null},te=async a=>{try{const e=await d.getInstanceDetail(a.gatewayInstanceId,a.tenantId);if(!e){p.error("获取实例详情失败");return}const l={...e};e.certContent?l.certFileList=[{id:"cert-file",name:e.certFilePath||"certificate.pem",content:e.certContent,status:"finished"}]:l.certFileList=[],e.keyContent?l.keyFileList=[{id:"key-file",name:e.keyFilePath||"private-key.pem",content:e.keyContent,status:"finished"}]:l.keyFileList=[],b.value="view",h.value=l,k.value=!0}catch{p.error("获取实例详情失败")}},me=async a=>{await d.handleSearch(a)},ye=async a=>{if(a&&b.value!=="view"){L.value=!0;try{const e={...a};if(e.certFileList&&Array.isArray(e.certFileList)&&e.certFileList.length>0){const l=e.certFileList[0];l&&(l.content&&(e.certContent=l.content),l.name&&(e.certFilePath=l.name))}else b.value==="edit"&&h.value&&h.value.certFilePath&&!e.certFilePath&&(e.certFilePath=h.value.certFilePath);if(delete e.certFileList,e.keyFileList&&Array.isArray(e.keyFileList)&&e.keyFileList.length>0){const l=e.keyFileList[0];l&&(l.content&&(e.keyContent=l.content),l.name&&(e.keyFilePath=l.name))}else b.value==="edit"&&h.value&&h.value.keyFilePath&&!e.keyFilePath&&(e.keyFilePath=h.value.keyFilePath);if(delete e.keyFileList,b.value==="create")await d.addInstance(e)&&ee();else if(b.value==="edit"){if(!h.value)return;await d.editInstance({...e,gatewayInstanceId:h.value.gatewayInstanceId})&&ee()}}finally{L.value=!1}}},be=async(a,e)=>{switch(a){case"add":Z();break;case"edit":{if(!(I!=null&&I.value)){p.warning("Grid 引用未设置");return}const l=I.value.getCurrentRecord();if(!l){p.warning("请先点击选择要编辑的实例");return}await J(l);break}case"delete":{if(!(I!=null&&I.value)){p.warning("Grid 引用未设置");return}const l=I.value.getCurrentRecord();if(!l){p.warning("请先点击选择要删除的实例");return}await d.deleteInstance(l);break}case"search":{await d.handleSearch(e);break}}},he=a=>{A.value=a.gatewayInstanceId,V.value=!0},ae=async a=>{Y.value="edit";try{if(!a.logConfigId){p.warning("该实例尚未配置日志，请先创建日志配置");return}const e=await $e(a.logConfigId);if(O(e)){const l=ge(e,{});if(l.sensitiveFields){if(typeof l.sensitiveFields=="string")try{l.sensitiveFields=JSON.parse(l.sensitiveFields)}catch{l.sensitiveFields=l.sensitiveFields.split(",").map(_=>_.trim()).filter(Boolean)}}else l.sensitiveFields=[];C.value=l,M.value=!0}else{const l=S(e,"获取日志配置失败");p.error(l)}}catch(e){p.error("获取日志配置失败"),console.error("Error fetching log config:",e)}},le=()=>{M.value=!1,C.value=null},ve=async a=>{if(a&&Y.value!=="view"){D.value=!0;try{if(!a.logConfigId){p.error("日志配置信息不完整");return}const e={...a};e.sensitiveFields&&Array.isArray(e.sensitiveFields)&&(e.sensitiveFields=JSON.stringify(e.sensitiveFields));const l=await _e(e);if(O(l)){const _=S(l,"日志配置保存成功");p.success(_),le()}else{const _=S(l,"保存日志配置失败");p.error(_)}}catch(e){p.error("保存日志配置失败"),console.error("Error saving log config:",e)}finally{D.value=!1}}},Ie=()=>{V.value=!1,A.value=""},ne=async a=>{await c.warning({title:"确认启动",subtitle:"启动后将开始处理请求",content:`确定要启动实例"${a.instanceName}"吗？`,icon:tt,headerStyle:"gradient",positiveText:"确定启动",negativeText:"取消",width:500})&&d.startInstance(a)},se=async a=>{await c.warning({title:"确认停止",subtitle:"停止后将无法处理请求",content:`确定要停止实例"${a.instanceName}"吗？`,icon:et,headerStyle:"gradient",positiveText:"确定停止",negativeText:"取消",width:500})&&d.stopInstance(a)},ie=async a=>{await c.warning({title:"确认网关重载",subtitle:"重载将重新加载配置",content:`确定要对实例"${a.instanceName}"执行网关重载操作吗？`,icon:Ze,headerStyle:"gradient",positiveText:"确定重载",negativeText:"取消",width:500})&&d.reloadInstance(a)};return{service:d,formDialogVisible:k,formDialogMode:b,currentEditInstance:h,submitting:L,openAddDialog:Z,openEditDialog:J,openViewDialog:te,handleFormSubmit:ye,configDialogVisible:V,currentConfigInstanceId:A,openConfigDialog:he,closeConfigDialog:Ie,logConfigDialogVisible:M,logConfigDialogMode:Y,currentLogConfig:C,logConfigSubmitting:D,openLogConfigDialog:ae,closeLogConfigDialog:le,handleLogConfigSubmit:ve,ipAccessControlDialogVisible:H,ipAccessControlSecurityConfigId:r,openIpAccessControlDialog:m,userAgentAccessControlDialogVisible:T,userAgentAccessControlSecurityConfigId:x,openUserAgentAccessControlDialog:F,apiAccessControlDialogVisible:z,apiAccessControlSecurityConfigId:E,openApiAccessControlDialog:B,domainAccessControlDialogVisible:G,domainAccessControlSecurityConfigId:n,openDomainAccessControlDialog:o,corsConfigDialogVisible:s,corsConfigGatewayInstanceId:y,openCorsConfigDialog:v,authConfigDialogVisible:K,authConfigGatewayInstanceId:U,openAuthConfigDialog:g,rateLimitConfigDialogVisible:i,rateLimitConfigGatewayInstanceId:$,openRateLimitConfigDialog:X,handleToolbarClick:be,handleMenuClick:async({code:a,row:e})=>{if(e)switch(a){case"view":await te(e);break;case"edit":await J(e);break;case"delete":await d.deleteInstance(e);break;case"start":ne(e);break;case"stop":se(e);break;case"ipAccessControl":await m(e);break;case"userAgentAccessControl":await F(e);break;case"apiAccessControl":await B(e);break;case"domainAccessControl":await o(e);break;case"corsConfig":await v(e);break;case"authConfig":await g(e);break;case"rateLimitConfig":await X(e);break;case"logConfig":ae(e);break;case"reload":ie(e);break}},handleSearch:me,handleStartInstance:ne,handleStopInstance:se,handleReloadInstance:ie}}const ot=["id"],rt=Ae({name:"GatewayInstanceManager",__name:"GatewayInstanceManager",setup(I){const u=f(),p=f(),{service:c,formDialogVisible:d,formDialogMode:k,currentEditInstance:b,submitting:h,handleFormSubmit:L,logConfigDialogVisible:V,logConfigDialogMode:A,currentLogConfig:M,logConfigSubmitting:Y,handleLogConfigSubmit:C,ipAccessControlDialogVisible:D,ipAccessControlSecurityConfigId:H,userAgentAccessControlDialogVisible:r,userAgentAccessControlSecurityConfigId:m,apiAccessControlDialogVisible:T,apiAccessControlSecurityConfigId:x,domainAccessControlDialogVisible:F,domainAccessControlSecurityConfigId:z,corsConfigDialogVisible:E,corsConfigGatewayInstanceId:B,authConfigDialogVisible:G,authConfigGatewayInstanceId:n,rateLimitConfigDialogVisible:o,rateLimitConfigGatewayInstanceId:s,handleToolbarClick:y,handleMenuClick:v,handleSearch:K}=it(p,u);return(U,g)=>(j(),Te("div",{class:"gateway-instance-manager",id:t(c).model.moduleId},[w(t(ke),{direction:"vertical","default-size":"80px"},{1:P(()=>[w(Se,ce({ref_key:"searchFormRef",ref:u,"module-id":t(c).model.moduleId},t(c).model.searchFormConfig,{onSearch:t(K),onToolbarClick:t(y)}),null,16,["module-id","onSearch","onToolbarClick"])]),2:P(()=>[w(t(we),ce({ref_key:"gridRef",ref:p,"module-id":t(c).model.moduleId,data:t(c).model.instanceList,loading:t(c).model.loading},t(c).model.gridConfig,{onPageChange:t(c).handlePageChange,onMenuClick:t(v)}),{tlsEnabled:P(({row:i})=>[w(t(W),{type:i.tlsEnabled==="Y"?"success":"default",size:"small"},{default:P(()=>[q(Q(i.tlsEnabled==="Y"?"启用":"禁用"),1)]),_:2},1032,["type"])]),healthStatus:P(({row:i})=>[w(t(W),{type:i.healthStatus==="Y"?"success":"error",size:"small"},{icon:P(()=>[w(t(pe),null,{default:P(()=>[i.healthStatus==="Y"?(j(),de(t(at),{key:0})):(j(),de(t(lt),{key:1}))]),_:2},1024)]),default:P(()=>[q(" "+Q(i.healthStatus==="Y"?"在线":"离线"),1)]),_:2},1032,["type"])]),activeFlag:P(({row:i})=>[w(t(W),{type:i.activeFlag==="Y"?"success":"default",size:"small"},{default:P(()=>[q(Q(i.activeFlag==="Y"?"活动":"非活动"),1)]),_:2},1032,["type"])]),_:1},16,["module-id","data","loading","onPageChange","onMenuClick"])]),_:1}),w(oe,{visible:t(d),"onUpdate:visible":g[0]||(g[0]=i=>N(d)?d.value=i:null),mode:t(k),title:t(k)==="create"?"新增实例":t(k)==="edit"?"编辑实例":"查看实例详情",to:`#${t(c).model.moduleId}`,"form-fields":t(c).model.instanceFormConfig.fields,"form-tabs":t(c).model.instanceFormConfig.tabs,"initial-data":t(b)||void 0,"auto-close-on-confirm":!1,"confirm-loading":t(h),onSubmit:t(L)},null,8,["visible","mode","title","to","form-fields","form-tabs","initial-data","confirm-loading","onSubmit"]),w(oe,{visible:t(V),"onUpdate:visible":g[1]||(g[1]=i=>N(V)?V.value=i:null),mode:t(A),title:t(A)==="edit"?"编辑日志配置":"查看日志配置",to:`#${t(c).model.moduleId}`,"form-fields":t(c).model.logConfigFormConfig.fields,"initial-data":t(M)||void 0,"auto-close-on-confirm":!1,"confirm-loading":t(Y),onSubmit:t(C)},null,8,["visible","mode","title","to","form-fields","initial-data","confirm-loading","onSubmit"]),w(De,{visible:t(D),"onUpdate:visible":g[2]||(g[2]=i=>N(D)?D.value=i:null),"module-id":"hub0020:ipAccessControl","security-config-id":t(H),title:"IP访问控制配置",width:1200,to:`#${t(c).model.moduleId}`},null,8,["visible","security-config-id","to"]),w(xe,{visible:t(r),"onUpdate:visible":g[3]||(g[3]=i=>N(r)?r.value=i:null),"module-id":"hub0020:userAgentAccessControl","security-config-id":t(m),title:"User-Agent访问控制配置",width:1200,to:`#${t(c).model.moduleId}`},null,8,["visible","security-config-id","to"]),w(Fe,{visible:t(T),"onUpdate:visible":g[4]||(g[4]=i=>N(T)?T.value=i:null),"module-id":"hub0020:apiAccessControl","security-config-id":t(x),title:"API访问控制配置",width:1200,to:`#${t(c).model.moduleId}`},null,8,["visible","security-config-id","to"]),w(Pe,{visible:t(F),"onUpdate:visible":g[5]||(g[5]=i=>N(F)?F.value=i:null),"module-id":"hub0020:domainAccessControl","security-config-id":t(z),title:"域名访问控制配置",width:1200,to:`#${t(c).model.moduleId}`},null,8,["visible","security-config-id","to"]),w(Me,{visible:t(E),"onUpdate:visible":g[6]||(g[6]=i=>N(E)?E.value=i:null),"gateway-instance-id":t(B),width:800,to:`#${t(c).model.moduleId}`,"module-id":"hub0020:corsConfig"},null,8,["visible","gateway-instance-id","to"]),w(Ne,{visible:t(G),"onUpdate:visible":g[7]||(g[7]=i=>N(G)?G.value=i:null),"gateway-instance-id":t(n),width:800,to:`#${t(c).model.moduleId}`,"module-id":"hub0020:authConfig"},null,8,["visible","gateway-instance-id","to"]),w(Oe,{visible:t(o),"onUpdate:visible":g[8]||(g[8]=i=>N(o)?o.value=i:null),"gateway-instance-id":t(s),width:800,to:`#${t(c).model.moduleId}`,"module-id":"hub0020:rateLimitConfig"},null,8,["visible","gateway-instance-id","to"])],8,ot))}}),Ut=Le(rt,[["__scopeId","data-v-6ad2d1ed"]]);export{Ut as default};
