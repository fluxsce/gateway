import{d as we,u as Me,a as ve,c as oe,o as q,b as r,e,N as ke,w as d,f as o,n as xe,r as M,g as he,h as ge,i as z,t as m,j as pe,s as Ie,_ as ye,k as le,l as Te,m as Se,p as _e,q as Le,v as n,x as be,y as T,z as ie,A as ce,B as de,C as Pe,D as Fe,E as Ae,F as De,G as Re,H as X,I as Ne,J as qe,K as ae,L as ze,M as Ve}from"./index-bKVtVsSX.js";import{G as Ke}from"./GPane-L7gHnozL.js";import{P as Ue,L as Be}from"./PersonOutline-DwEpE-FZ.js";import{S as $e,P as Oe,D as Ge}from"./ShieldOutline-BoMVAof0.js";import{K as Ee}from"./KeyOutline-qjP39VOy.js";import{S as Ye,P as Xe}from"./ShieldCheckmarkOutline-BbNelKar.js";const We={class:"language-switcher"},je={class:"current-language"},Je=we({__name:"LanguageSwitcher",setup(V){const f=Me(),i=M(!1),K=pe(()=>f.language);function S(){const p=ve.find(k=>k.locale===K.value);return p?p.name:"Unknown"}const L=ve.map(p=>({key:p.locale,label:p.name}));async function C(p){if(p!==K.value){i.value=!0;try{f.updateSettings({language:p}),await Ie(p)}finally{i.value=!1}}}return(p,k)=>(q(),oe("div",We,[r(e(ke),{trigger:"click",options:e(L),onSelect:C},{default:d(()=>[o("div",{class:xe(["language-selector",{"is-loading":i.value}])},[i.value?(q(),he(e(z),{key:0,size:"16",class:"loading-icon"},{default:d(()=>[...k[0]||(k[0]=[o("i",{class:"fas fa-circle-notch fa-spin"},null,-1)])]),_:1})):ge("",!0),o("span",je,m(S()),1),r(e(z),{size:"12"},{default:d(()=>[...k[1]||(k[1]=[o("i",{class:"fas fa-chevron-down"},null,-1)])]),_:1})],2)]),_:1},8,["options"])]))}}),He=ye(Je,[["__scopeId","data-v-a1344b7f"]]),ue={login(V){return le({url:"/gateway/user/login",method:"post",data:V})},getCaptcha(){return le({url:"/gateway/user/captcha",method:"post",params:{t:new Date().getTime()}})},getVersion(){return le({url:"/gateway/user/version",method:"get"})}};function Qe(){const V=Te(),f=Se(),{t:i}=_e("hub0001"),{t:K}=_e("common"),S=M(null),L=M(null),C=M(!1),p=M(!1),k=M(""),W=M(""),j=M(0),O=M(""),P=M(!1),F=M(60),A=M(""),J=be({userId:"",password:"",captchaCode:"",rememberMe:!1}),x=be({phone:"",code:"",rememberMe:!1}),G=pe(()=>({userId:[{required:!0,message:i("validation.userIdRequired"),trigger:"blur"},{min:3,max:20,message:i("validation.userIdLength"),trigger:"blur"}],password:[{required:!0,message:i("validation.passwordRequired"),trigger:"blur"},{min:6,max:32,message:i("validation.passwordLength"),trigger:"blur"}],captchaCode:[{required:!0,message:i("validation.captchaRequired"),trigger:"blur"},{len:6,message:i("validation.captchaLength"),trigger:"blur"}]})),ne=pe(()=>({phone:[{required:!0,message:i("validation.phoneRequired"),trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:i("validation.phoneFormat"),trigger:"blur"}],code:[{required:!0,message:i("validation.codeRequired"),trigger:"blur"},{len:6,message:i("validation.codeLength"),trigger:"blur"}]})),H=async l=>new Promise(s=>{requestAnimationFrame(()=>{try{const a=document.createElement("canvas"),t=a.getContext("2d");if(!t){s("");return}a.width=140,a.height=50;const y=t.createLinearGradient(0,0,a.width,a.height);y.addColorStop(0,"#f8f9fa"),y.addColorStop(.3,"#e9ecef"),y.addColorStop(.7,"#dee2e6"),y.addColorStop(1,"#ced4da"),t.fillStyle=y,t.fillRect(0,0,a.width,a.height);for(let h=0;h<100;h++)t.fillStyle=`rgba(${Math.random()*50+200}, ${Math.random()*50+200}, ${Math.random()*50+200}, 0.1)`,t.fillRect(Math.random()*a.width,Math.random()*a.height,2,2);t.strokeStyle="rgba(78, 67, 118, 0.4)",t.lineWidth=2;for(let h=0;h<5;h++){t.beginPath();const _=Math.random()*a.width,b=Math.random()*a.height,w=Math.random()*a.width,u=Math.random()*a.height,Y=Math.random()*a.width,I=Math.random()*a.height,re=Math.random()*a.width,Ce=Math.random()*a.height;t.moveTo(_,b),t.bezierCurveTo(w,u,Y,I,re,Ce),t.stroke()}t.strokeStyle="rgba(78, 67, 118, 0.3)",t.lineWidth=1.5;for(let h=0;h<3;h++){t.beginPath(),t.moveTo(0,a.height/2+Math.sin(h)*10);for(let _=0;_<=a.width;_+=5){const b=a.height/2+Math.sin((_+h*50)*.02)*15+Math.random()*10-5;t.lineTo(_,b)}t.stroke()}const g=["circle","rect","triangle","star"];for(let h=0;h<15;h++){const _=g[Math.floor(Math.random()*g.length)],b=Math.random()*a.width,w=Math.random()*a.height,u=Math.random()*8+2;switch(t.fillStyle=`rgba(78, 67, 118, ${Math.random()*.3+.1})`,t.beginPath(),_){case"circle":t.arc(b,w,u,0,2*Math.PI);break;case"rect":t.rect(b-u/2,w-u/2,u,u);break;case"triangle":t.moveTo(b,w-u),t.lineTo(b-u,w+u),t.lineTo(b+u,w+u),t.closePath();break;case"star":t.moveTo(b,w-u),t.lineTo(b+u/3,w+u/3),t.lineTo(b-u,w),t.lineTo(b+u,w),t.lineTo(b-u/3,w+u/3),t.closePath();break}t.fill()}const N=l.split(""),te=["#4e4376","#5a4e8c","#6b5b95","#7b68a2","#8b789f","#9b88b2"],me=["bold 24px Georgia",'bold 22px "Times New Roman"',"bold 26px Arial","bold 23px Verdana"];N.forEach((h,_)=>{const b=15+_*20,w=a.height/2+(Math.random()-.5)*8;t.font=me[Math.floor(Math.random()*me.length)],t.textAlign="center",t.textBaseline="middle";const u=(Math.random()-.5)*.6;t.save(),t.translate(b,w),t.rotate(u),t.fillStyle="rgba(0, 0, 0, 0.3)",t.fillText(h,2,2),t.strokeStyle="rgba(255, 255, 255, 0.8)",t.lineWidth=3,t.strokeText(h,0,0),t.fillStyle=te[_%te.length],t.fillText(h,0,0),t.shadowColor=te[_%te.length],t.shadowBlur=3,t.fillText(h,0,0),t.restore()});const fe=t.getImageData(0,0,a.width,a.height),$=fe.data;for(let h=0;h<a.height;h++)for(let _=0;_<a.width;_++){const b=Math.sin(_*.1)*2,w=Math.min(Math.max(h+b,0),a.height-1);if(w!==h){const u=(h*a.width+_)*4,Y=(Math.floor(w)*a.width+_)*4;if(Y<$.length&&u<$.length)for(let I=0;I<4;I++){const re=$[u+I];$[u+I]=$[Y+I],$[Y+I]=re}}}t.putImageData(fe,0,0),n.debug("复杂验证码Canvas生成完成"),s(a.toDataURL("image/png"))}catch(a){n.error("Canvas验证码生成失败:",a),s("")}})});let U=null;const c=async()=>{U&&clearTimeout(U),U=setTimeout(async()=>{try{n.info("开始刷新验证码");const l=await ue.getCaptcha();if(n.debug("验证码API响应:",l),ie(l)){const s=ce(l,null);if(s){if(W.value=s.code,k.value=s.captchaId,j.value=s.expireAt,n.info("验证码数据更新成功",{captchaId:s.captchaId,hasCode:!!s.code}),s.code){const a=async()=>{try{const t=await H(s.code);O.value=t,n.debug("验证码Canvas生成并更新完成")}catch(t){n.error("Canvas生成异常:",t),O.value=""}};"requestIdleCallback"in window?requestIdleCallback(a,{timeout:3e3}):setTimeout(a,500)}}else n.warn("验证码数据解析失败",l)}else n.warn("验证码响应无效",l)}catch(l){n.error("刷新验证码失败:",l)}finally{U=null}},300)},E=async()=>{if(S.value)try{n.info("开始表单验证"),await S.value.validate(),n.info("表单验证通过"),await Q(J)}catch(l){n.warn("表单验证失败:",l)}},Q=async l=>{var s,a;C.value=!0,n.info("开始执行登录",{userId:l.userId});try{const t={...l,captchaId:k.value},y=await ue.login(t);if(!ie(y)){const N=de(y,i("login.loginFailed"));return f.error(N),n.warn("登录失败",{errMsg:y.errMsg,popMsg:y.popMsg}),c(),!1}const g=ce(y,{});if(g&&g.userId){n.info("登录返回的用户对象:",g),await T.user.setLoginState(g.userId,g.userName,g.realName,g.tenantId,{avatar:g.avatar,email:g.email,mobile:g.mobile,deptId:g.deptId,tenantAdminFlag:g.tenantAdminFlag,timeout:g.timeout,remember:l.rememberMe}),g.permissions&&(T.user.setPermissions(g.permissions),n.info("权限信息已设置到用户 store",{modules:((s=g.permissions.modules)==null?void 0:s.length)||0,buttons:((a=g.permissions.buttons)==null?void 0:a.length)||0})),n.info("设置后的store用户信息",{userId:T.user.userId,userName:T.user.displayName,isAuthenticated:T.user.isAuthenticated});const N=de(y,i("login.loginSuccess"));return f.success(N),n.info("登录成功",{userId:g.userId}),T.global.setPageTitle("首页"),V.push({path:"/dashboard"}),!0}else{const N=de(y,i("login.loginFailed"));return f.error(N),n.warn("登录失败 - 数据解析异常",{errMsg:y.errMsg,popMsg:y.popMsg}),c(),!1}}catch(t){return n.error("登录请求异常:",t),f.error(t.message||i("login.networkError")),c(),!1}finally{C.value=!1}},v=async()=>{if(!x.phone){f.error(i("validation.phoneRequired"));return}if(!/^1[3-9]\d{9}$/.test(x.phone)){f.error(i("validation.phoneFormat"));return}P.value=!0,n.info("发送手机验证码",{phone:x.phone});try{await new Promise(s=>setTimeout(s,500)),f.success(i("login.codeSent")),n.info("验证码发送成功"),F.value=60;const l=setInterval(()=>{F.value--,F.value<=0&&(clearInterval(l),P.value=!1)},1e3)}catch(l){n.error("验证码发送失败:",l),f.error(i("login.codeSendFailed")),P.value=!1}},D=async()=>{if(L.value)try{n.info("开始手机登录表单验证"),await L.value.validate(),await R()}catch(l){n.warn("手机登录表单验证失败:",l)}},R=async()=>{p.value=!0,n.info("开始执行手机登录",{phone:x.phone});try{return!0}catch(l){return n.error("手机登录失败:",l),f.error(l.message||i("login.loginFailed")),!1}finally{p.value=!1}},se=()=>{n.info("尝试微信登录"),f.info(i("login.wechatRedirect"))},B=()=>{n.info("跳转到忘记密码页面"),V.push({path:"/hub0001/forgot-password"})},Z=()=>{T.user.isAuthenticated&&(n.info("用户已登录，重定向到首页"),window.location.href="/dashboard")},ee=async()=>{try{n.info("开始获取系统版本信息");const l=await ue.getVersion();if(ie(l)){const s=ce(l,{version:""});s&&s.version?(A.value=s.version||"",T.global.setAppVersion(A.value),n.info("版本信息获取成功",{version:A.value})):n.warn("版本信息数据解析失败",l)}else n.warn("版本信息响应无效",l)}catch(l){n.error("获取版本信息失败:",l),A.value=""}};return Le(()=>{n.info("LoginAuth组件挂载，开始初始化"),Z(),ee(),requestAnimationFrame(()=>{setTimeout(()=>{c()},200)})}),{formRef:S,phoneFormRef:L,formData:J,phoneFormData:x,rules:G,phoneRules:ne,loading:C,phoneLoading:p,captchaCode:W,captchaUrl:O,captchaExpireAt:j,codeSending:P,countdown:F,appVersion:A,handleLogin:E,handlePhoneLogin:D,sendVerificationCode:v,handleWechatLogin:se,refreshCaptcha:c,goToForgotPassword:B,tCommon:K,t:i}}const Ze={class:"login-view"},et={class:"global-language-switch"},tt={class:"welcome-area"},at={class:"welcome-content"},ot={class:"title"},nt={class:"subtitle"},st={class:"features"},rt={class:"feature-item"},lt={class:"feature-icon"},it={class:"feature-text"},ct={class:"feature-item"},dt={class:"feature-icon"},ut={class:"feature-text"},ht={class:"feature-item"},gt={class:"feature-icon"},pt={class:"feature-text"},mt={class:"form-area"},ft={class:"form-container"},vt={class:"form-header"},_t={class:"captcha-area"},bt=["src"],wt={key:1,class:"captcha-loading"},yt={class:"form-options"},Ct={class:"verification-area"},Mt={class:"form-footer"},kt={class:"copyright"},xt=we({__name:"LoginView",setup(V){const f=M("account");let i=null;const K=Q=>{i&&clearTimeout(i),requestAnimationFrame(()=>{i=setTimeout(()=>{f.value=Q,i=null,Ve(()=>{})},50)})},{formRef:S,phoneFormRef:L,formData:C,phoneFormData:p,rules:k,phoneRules:W,loading:j,phoneLoading:O,captchaUrl:P,codeSending:F,countdown:A,appVersion:J,handleLogin:x,handlePhoneLogin:G,sendVerificationCode:ne,refreshCaptcha:H,goToForgotPassword:U,t:c,tCommon:E}=Qe();return(Q,v)=>{const D=Re,R=De,se=Ne,B=qe,Z=Ae,ee=Fe,l=Pe;return q(),oe("div",Ze,[o("div",et,[r(He)]),r(e(Ke),{direction:"horizontal","no-resize":!0,defaultSize:"50%",class:"login-pane"},{1:d(()=>[o("div",tt,[v[7]||(v[7]=o("div",{class:"logo-area"},[o("img",{src:ze,alt:"Logo"}),o("h3",{class:"logo-text"},"FLUX Datahub Gateway")],-1)),o("div",at,[o("h1",ot,m(e(c)("login.welcomeTitle")),1),o("p",nt,m(e(c)("login.welcomeSubtitle")),1),o("div",st,[o("div",rt,[o("div",lt,[r(e(Ye))]),o("div",it,[o("h3",null,m(e(c)("login.featureSecurityTitle")),1),o("p",null,m(e(c)("login.featureSecurityDesc")),1)])]),o("div",ct,[o("div",dt,[r(e(Ge))]),o("div",ut,[o("h3",null,m(e(c)("login.featureAnalyticsTitle")),1),o("p",null,m(e(c)("login.featureAnalyticsDesc")),1)])]),o("div",ht,[o("div",gt,[r(e(Xe))]),o("div",pt,[o("h3",null,m(e(c)("login.featureCollaborationTitle")),1),o("p",null,m(e(c)("login.featureCollaborationDesc")),1)])])])])])]),2:d(()=>[o("div",mt,[o("div",ft,[o("div",vt,[o("h2",null,m(e(c)("login.loginTitle")||e(c)("login.title")),1),o("p",null,m(e(c)("login.loginSubtitle")||e(c)("login.subtitle")),1)]),r(l,{value:f.value,"onUpdate:value":[v[6]||(v[6]=s=>f.value=s),K],animated:!1,"justify-content":"space-evenly",size:"small",class:"login-tabs",type:"line"},{default:d(()=>[r(ee,{name:"account",tab:e(c)("login.accountLogin")},{default:d(()=>[f.value==="account"?(q(),he(Z,{key:0,ref_key:"formRef",ref:S,model:e(C),rules:e(k),size:"large",class:"login-form"},{default:d(()=>[r(R,{path:"userId"},{default:d(()=>[r(D,{value:e(C).userId,"onUpdate:value":v[0]||(v[0]=s=>e(C).userId=s),placeholder:e(c)("login.userId"),onKeyup:X(e(x),["enter"])},{prefix:d(()=>[r(e(z),null,{default:d(()=>[r(e(Ue))]),_:1})]),_:1},8,["value","placeholder","onKeyup"])]),_:1}),r(R,{path:"password"},{default:d(()=>[r(D,{value:e(C).password,"onUpdate:value":v[1]||(v[1]=s=>e(C).password=s),type:"password","show-password-on":"mousedown",placeholder:e(c)("login.password"),onKeyup:X(e(x),["enter"])},{prefix:d(()=>[r(e(z),null,{default:d(()=>[r(e(Be))]),_:1})]),_:1},8,["value","placeholder","onKeyup"])]),_:1}),r(R,{path:"captcha"},{default:d(()=>[o("div",_t,[r(D,{value:e(C).captchaCode,"onUpdate:value":v[2]||(v[2]=s=>e(C).captchaCode=s),placeholder:e(c)("login.captcha"),onKeyup:X(e(x),["enter"])},{prefix:d(()=>[r(e(z),null,{default:d(()=>[r(e($e))]),_:1})]),_:1},8,["value","placeholder","onKeyup"]),o("div",{class:"captcha-img",onClick:v[3]||(v[3]=(...s)=>e(H)&&e(H)(...s))},[e(P)?(q(),oe("img",{key:0,src:e(P),alt:"Captcha"},null,8,bt)):(q(),oe("div",wt,[r(se,{size:"small"})]))])])]),_:1}),o("div",yt,[r(B,{text:"",onClick:e(U),class:"forgot-btn"},{default:d(()=>[ae(m(e(c)("login.forgotPassword")),1)]),_:1},8,["onClick"])]),r(B,{type:"primary",size:"large",block:"",loading:e(j),onClick:e(x),class:"login-btn"},{default:d(()=>[ae(m(e(c)("login.loginButton")),1)]),_:1},8,["loading","onClick"])]),_:1},8,["model","rules"])):ge("",!0)]),_:1},8,["tab"]),r(ee,{name:"phone",tab:e(c)("login.phoneLogin")},{default:d(()=>[f.value==="phone"?(q(),he(Z,{key:0,ref_key:"phoneFormRef",ref:L,model:e(p),rules:e(W),size:"large",class:"login-form"},{default:d(()=>[r(R,{path:"phone"},{default:d(()=>[r(D,{value:e(p).phone,"onUpdate:value":v[4]||(v[4]=s=>e(p).phone=s),placeholder:e(c)("login.phoneNumber"),onKeyup:X(e(G),["enter"])},{prefix:d(()=>[r(e(z),null,{default:d(()=>[r(e(Oe))]),_:1})]),_:1},8,["value","placeholder","onKeyup"])]),_:1}),r(R,{path:"code"},{default:d(()=>[o("div",Ct,[r(D,{value:e(p).code,"onUpdate:value":v[5]||(v[5]=s=>e(p).code=s),placeholder:e(c)("login.verificationCode"),onKeyup:X(e(G),["enter"])},{prefix:d(()=>[r(e(z),null,{default:d(()=>[r(e(Ee))]),_:1})]),_:1},8,["value","placeholder","onKeyup"]),r(B,{class:"verification-btn",disabled:e(F),onClick:e(ne)},{default:d(()=>[ae(m(e(F)?`${e(A)}s`:e(c)("login.sendCode")),1)]),_:1},8,["disabled","onClick"])])]),_:1}),r(B,{type:"primary",size:"large",block:"",loading:e(O),onClick:e(G),class:"login-btn"},{default:d(()=>[ae(m(e(c)("login.loginButton")),1)]),_:1},8,["loading","onClick"])]),_:1},8,["model","rules"])):ge("",!0)]),_:1},8,["tab"])]),_:1},8,["value"]),o("div",Mt,[o("p",kt," © "+m(new Date().getFullYear())+" "+m(e(E)("common.companyName"))+". "+m(e(E)("common.copyright"))+" "+m(e(E)("common.version"))+": "+m(e(J)),1)])])])]),_:1})])}}}),At=ye(xt,[["__scopeId","data-v-e85123e3"]]);export{At as default};
