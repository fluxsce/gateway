import{G as ce}from"./GDataFormModal-B5dffEod.js";import{c as de,G as ue,S as pe,N as we,a as D}from"./SearchForm-C0DQDEEE.js";import{G as ve}from"./GPane-w_mkAzRd.js";import{af as Te,r as x,ad as $,aa as z,m as j,z as V,B as A,A as M,d4 as fe,d as te,a7 as le,av as Ce,g as Ne,w as C,e as s,o as G,f as T,b,am as Y,aO as q,K as U,t as O,cr as Z,_ as ae,c as ee,a9 as E,i as H,h as Ie,J as ke}from"./index-DVVs4J_g.js";import{G as xe}from"./GModal-xYfXS7HF.js";import{N as ge}from"./GPagination.vue_vue_type_style_index_0_scoped_2c35df38_lang-rwsE82tp.js";import{u as he}from"./useGDialog-DWN8tM1R.js";import{A as me}from"./AddOutline-D7WMths6.js";import{T as be}from"./TrashOutline-dLMtYZFW.js";import{S as Le}from"./ServerOutline-BkLyZQ8B.js";import{P as ye,R as _e}from"./RefreshCircleOutline-DnVi9X8G.js";import{S as Se}from"./StopCircleOutline-Cm3D8hbW.js";import{L as Pe}from"./LinkOutline-BYR1ho2B.js";import{A as Ke,a as Fe}from"./ArrowUpOutline-trxeN2kB.js";import{S as Ve}from"./StopOutline-C2MLV-hU.js";import{R as Oe}from"./RefreshOutline-ZMKO-4DG.js";import{P as Be}from"./PlayCircleOutline-CwNOIKX9.js";import{W as Ae}from"./WarningOutline-CPh7mSpG.js";import"./index-CkZRWLYS.js";import"./Select-DNy4pOft.js";import"./DownloadOutline-CFQ2kwN6.js";import"./Upload-KD8QX-hv.js";import"./download-C2161hUv.js";import"./DocumentOutline-CUl-N0py.js";import"./ContractOutline-keSydpIS.js";import"./CloseOutline-CI2J8g02.js";import"./GDialog-0ZeiOrqn.js";const B=Te("/gateway/hub0061"),Me=async i=>B.post("/queryStaticServers",i),De=async i=>B.post("/getStaticServer",{tunnelStaticServerId:i}),Ee=async i=>B.post("/createStaticServer",i),He=async i=>B.post("/updateStaticServer",i),se=async i=>B.post("/deleteStaticServer",{tunnelStaticServerId:i}),Ue=async()=>B.post("/getStaticServerStats",{}),qe=async i=>B.post("/startStaticServer",{tunnelStaticServerId:i}),$e=async i=>B.post("/stopStaticServer",{tunnelStaticServerId:i}),ze=async i=>B.post("/reloadStaticServer",{tunnelStaticServerId:i}),Ge=async i=>B.post("/queryStaticNodes",i),Ye=async i=>B.post("/getStaticNode",{tunnelStaticNodeId:i}),je=async i=>B.post("/createStaticNode",i),We=async i=>B.post("/updateStaticNode",i),ne=async i=>B.post("/deleteStaticNode",{tunnelStaticNodeId:i}),W=[{label:"活跃",value:"active",type:"success"},{label:"非活跃",value:"inactive",type:"warning"},{label:"错误",value:"error",type:"error"}],re=[{label:"TCP",value:"tcp"},{label:"UDP",value:"udp"}],R=[{label:"健康",value:"healthy",type:"success"},{label:"不健康",value:"unhealthy",type:"error"},{label:"未知",value:"unknown",type:"default"}];function Re(){const i="hub0061:static-nodes",o=x(!1),r=x([]),l=x(),c={fields:[{field:"nodeName",label:"节点名称",type:"input",placeholder:"请输入节点名称",span:6,clearable:!0},{field:"targetAddress",label:"目标地址",type:"input",placeholder:"请输入目标地址",span:6,clearable:!0},{field:"nodeStatus",label:"节点状态",type:"select",placeholder:"请选择节点状态",span:6,clearable:!0,options:[{label:"全部",value:""},...W.map(e=>({label:e.label,value:e.value}))]},{field:"healthCheckStatus",label:"健康状态",type:"select",placeholder:"请选择健康状态",span:6,clearable:!0,options:[{label:"全部",value:""},...R.map(e=>({label:e.label,value:e.value}))]}],toolbarButtons:[{key:"add",label:"新增节点",icon:me,type:"primary",tooltip:"新增静态节点"},{key:"delete",label:"删除",icon:be,type:"error",tooltip:"批量删除选中的节点"}],showSearchButton:!0,showResetButton:!0},g=e=>{const a=W.find(f=>f.value===e);return(a==null?void 0:a.label)||e},v=e=>{const a=W.find(f=>f.value===e);return(a==null?void 0:a.type)||"default"},N=e=>{const a=re.find(f=>f.value===e);return(a==null?void 0:a.label)||e},m=e=>{if(!e)return"未知";const a=R.find(f=>f.value===e);return(a==null?void 0:a.label)||e},k=e=>{if(!e)return"default";const a=R.find(f=>f.value===e);return(a==null?void 0:a.type)||"default"},S={columns:[{field:"tunnelStaticNodeId",title:"节点ID",visible:!1,width:0},{field:"nodeName",title:"节点名称",align:"center",showOverflow:"tooltip",width:160},{field:"targetAddress",title:"目标地址",align:"center",showOverflow:"tooltip",width:140},{field:"targetPort",title:"目标端口",align:"center",width:100},{field:"proxyType",title:"代理类型",align:"center",width:100,slots:{default:"proxyType"}},{field:"nodeStatus",title:"节点状态",align:"center",width:100,slots:{default:"nodeStatus"}},{field:"healthCheckStatus",title:"健康状态",align:"center",width:100,slots:{default:"healthCheckStatus"}},{field:"currentConnectionCount",title:"当前连接",align:"center",width:100},{field:"totalConnectionCount",title:"总连接数",align:"center",width:100},{field:"totalBytesReceived",title:"接收流量",align:"center",width:100,formatter:({row:e})=>$(e.totalBytesReceived)},{field:"totalBytesSent",title:"发送流量",align:"center",width:100,formatter:({row:e})=>$(e.totalBytesSent)},{field:"failureCount",title:"失败次数",align:"center",width:100},{field:"lastHealthCheck",title:"最后检查",align:"center",formatter:({row:e})=>z(e.lastHealthCheck),width:160},{field:"activeFlag",title:"状态",align:"center",width:80,slots:{default:"activeFlag"}},{field:"nodeDescription",title:"描述",align:"center",showOverflow:"tooltip",width:160},{field:"addTime",title:"创建时间",align:"center",formatter:({row:e})=>z(e.addTime),width:160}],showCheckbox:!0,paginationConfig:{show:!0,pageInfo:l,align:"right"},menuConfig:{enabled:!0,showCopyRow:!0,customMenus:[{code:"view",name:"查看详情",prefixIcon:"vxe-icon-eye-fill"},{code:"edit",name:"编辑",prefixIcon:"vxe-icon-edit"},{code:"delete",name:"删除",prefixIcon:"vxe-icon-delete"}]}};function L(e){r.value=e}function _(e){o.value=e}function P(){l.value=void 0}function F(e){l.value?Object.assign(l.value,e):l.value=e}function K(e){r.value.push(e)}function y(e,a,f){const w=r.value.findIndex(n=>n.tunnelStaticNodeId===e&&(!a||n.tenantId===a));w!==-1&&Object.assign(r.value[w],f)}function h(e){const a=r.value.findIndex(f=>f.tunnelStaticNodeId===e);a>=0&&r.value.splice(a,1)}function d(e){r.value=r.value.filter(a=>!e.includes(a.tunnelStaticNodeId))}const p=[{key:"basic",label:"基本信息"},{key:"advanced",label:"高级配置",show:!1},{key:"other",label:"其他信息"}],t=[{field:"tunnelStaticNodeId",label:"节点ID",type:"input",span:12,primary:!0,show:!1},{field:"tunnelStaticServerId",label:"服务器ID",type:"input",span:12,show:!1},{field:"nodeName",label:"节点名称",type:"input",placeholder:"请输入节点名称",span:12,tabKey:"basic",required:!0,tips:"用于标识此后端节点的唯一名称，建议使用有意义的命名便于管理",rules:[{required:!0,message:"请输入节点名称",trigger:["blur","input"]},{max:100,message:"节点名称不能超过100个字符",trigger:["blur","input"]}]},{field:"targetAddress",label:"目标地址",type:"input",placeholder:"请输入后端服务地址（IP或域名）",span:12,tabKey:"basic",required:!0,tips:"后端服务的 IP 地址或域名。支持内网地址如 192.168.1.100 或域名如 backend.local",rules:[{required:!0,message:"请输入目标地址",trigger:["blur","input"]}]},{field:"targetPort",label:"目标端口",type:"number",placeholder:"请输入后端服务端口",span:12,tabKey:"basic",required:!0,defaultValue:80,tips:"后端服务监听的端口号（1-65535）。如 SSH 服务通常是 22，HTTP 是 80",props:{min:1,max:65535,precision:0},rules:[{required:!0,type:"number",message:"请输入目标端口",trigger:["blur","change"]}]},{field:"proxyType",label:"代理类型",type:"select",placeholder:"请选择代理类型",span:12,tabKey:"basic",required:!0,defaultValue:"tcp",tips:"TCP：适用于大多数场景如 SSH、数据库连接；UDP：适用于 DNS、游戏等场景。需与服务器类型一致",options:re.map(e=>({label:e.label,value:e.value})),rules:[{required:!0,message:"请选择代理类型",trigger:["blur","change"]}]},{field:"activeFlag",label:"启用状态",type:"switch",span:12,tabKey:"basic",defaultValue:"Y",tips:"禁用后此节点将不会被负载均衡选中，不会接收新的连接请求",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"nodeDescription",label:"节点描述",type:"input",placeholder:"请输入节点描述",span:24,tabKey:"basic",props:{type:"textarea",rows:2,maxlength:500,showCount:!0}},{field:"maxConnections",label:"最大连接数",type:"number",placeholder:"请输入最大连接数，0表示不限制",span:12,tabKey:"advanced",defaultValue:0,show:!1,tips:"此节点允许的最大并发连接数。0 表示不限制",props:{min:0,precision:0}},{field:"connectionTimeout",label:"连接超时(秒)",type:"number",placeholder:"请输入连接超时时间",span:12,tabKey:"advanced",defaultValue:30,show:!1,tips:"连接到此节点的超时时间",props:{min:1,precision:0}},{field:"readTimeout",label:"读取超时(秒)",type:"number",placeholder:"请输入读取超时时间",span:12,tabKey:"advanced",defaultValue:60,show:!1,tips:"从此节点读取数据的超时时间",props:{min:1,precision:0}},{field:"writeTimeout",label:"写入超时(秒)",type:"number",placeholder:"请输入写入超时时间",span:12,tabKey:"advanced",defaultValue:60,show:!1,tips:"向此节点写入数据的超时时间",props:{min:1,precision:0}},{field:"retryCount",label:"重试次数",type:"number",placeholder:"请输入重试次数",span:12,tabKey:"advanced",defaultValue:3,show:!1,tips:"连接失败时的重试次数",props:{min:0,precision:0}},{field:"retryInterval",label:"重试间隔(秒)",type:"number",placeholder:"请输入重试间隔",span:12,tabKey:"advanced",defaultValue:1,show:!1,tips:"重试之间的等待时间",props:{min:0,precision:0}},{field:"compression",label:"启用压缩",type:"switch",span:12,tabKey:"advanced",defaultValue:"N",show:!1,tips:"启用后将压缩传输数据，可减少带宽占用但增加 CPU 开销",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"encryption",label:"启用加密",type:"switch",span:12,tabKey:"advanced",defaultValue:"N",show:!1,tips:"启用后将加密传输数据，提高安全性",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"secretKey",label:"加密密钥",type:"input",placeholder:"请输入加密密钥",span:24,tabKey:"advanced",show:!1,tips:"用于数据加密的密钥",props:{type:"password",showPasswordOn:"click"}},{field:"noteText",label:"备注信息",type:"input",placeholder:"请输入备注信息",span:24,tabKey:"other",props:{type:"textarea",rows:3,maxlength:500,showCount:!0}},{field:"addTime",label:"创建时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"addWho",label:"创建人",type:"input",span:12,tabKey:"other",disabled:!0},{field:"editTime",label:"修改时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"editWho",label:"修改人",type:"input",span:12,tabKey:"other",disabled:!0}];return{moduleId:i,loading:o,nodeList:r,pageInfo:l,searchFormConfig:c,gridConfig:S,formFields:t,formTabs:p,getNodeStatusLabel:g,getNodeStatusTagType:v,getProxyTypeLabel:N,getHealthCheckStatusLabel:m,getHealthCheckStatusTagType:k,setNodeList:L,setLoading:_,resetPagination:P,updatePagination:F,addNodeToList:K,updateNodeInList:y,removeNodeFromList:h,removeNodesFromList:d}}function Je(i,o){const r=j(),l=()=>typeof i=="string"?i:i==null?void 0:i.value,c=Re(),{addNodeToList:g,updateNodeInList:v,removeNodeFromList:N,removeNodesFromList:m}=c,k=async y=>{var h,d,p;try{c.setLoading(!0);let t=y;!t&&((h=o==null?void 0:o.value)!=null&&h.getFormData)&&(t=o.value.getFormData()||{});const e=t?Object.fromEntries(Object.entries(t).filter(([,n])=>n!==""&&n!==null&&n!==void 0)):{},a=l(),f={...e,tunnelStaticServerId:a,...de((d=c.pageInfo.value)==null?void 0:d.pageIndex,(p=c.pageInfo.value)==null?void 0:p.pageSize)},w=await Ge(f);if(V(w)){const n=M(w,[])||[];c.setNodeList(n);const u=fe(w);u&&Object.keys(u).length>0?c.updatePagination(u):c.resetPagination()}else r.error(A(w,"加载节点列表失败")),c.setNodeList([]),c.resetPagination()}catch(t){console.error("加载节点列表失败:",t),r.error(t.message||"加载节点列表失败"),c.setNodeList([]),c.resetPagination()}finally{c.setLoading(!1)}},S=async y=>{try{const h=await Ye(y);return V(h)?M(h):(r.error(A(h,"获取节点详情失败")),null)}catch(h){return console.error("获取节点详情失败:",h),r.error(h.message||"获取节点详情失败"),null}},L=async y=>{try{c.setLoading(!0);const h={...y,tenantId:"default",tunnelStaticServerId:l()},d=await je(h);if(V(d)){r.success("新增节点成功");const p=M(d,null);return p?g(p):await k(),!0}else return r.error(A(d,"新增节点失败")),!1}catch(h){return console.error("新增节点失败:",h),r.error(h.message||"新增节点失败"),!1}finally{c.setLoading(!1)}},_=async(y,h)=>{try{c.setLoading(!0);const d={...h,tunnelStaticNodeId:y,tenantId:"default"},p=await We(d);if(V(p)){r.success("编辑节点成功");const t=M(p,null);return t?v(t.tunnelStaticNodeId,t.tenantId,t):await k(),!0}else return r.error(A(p,"编辑节点失败")),!1}catch(d){return console.error("编辑节点失败:",d),r.error(d.message||"编辑节点失败"),!1}finally{c.setLoading(!1)}};return{model:c,loadNodeList:k,getNodeDetail:S,addNode:L,editNode:_,deleteNode:async y=>{try{c.setLoading(!0);const h=await ne(y);return V(h)?(r.success("删除节点成功"),N(y),c.nodeList.value.length===0&&c.pageInfo.value&&c.pageInfo.value.pageIndex>1&&(c.updatePagination({pageIndex:c.pageInfo.value.pageIndex-1}),await k()),!0):(r.error(A(h,"删除节点失败")),!1)}catch(h){return console.error("删除节点失败:",h),r.error(h.message||"删除节点失败"),!1}finally{c.setLoading(!1)}},deleteNodes:async y=>{try{c.setLoading(!0);const d=(await Promise.all(y.map(p=>ne(p)))).filter(p=>V(p)).length;return d===y.length?(r.success(`成功删除 ${d} 个节点`),m(y),c.nodeList.value.length===0&&c.pageInfo.value&&c.pageInfo.value.pageIndex>1&&(c.updatePagination({pageIndex:c.pageInfo.value.pageIndex-1}),await k()),!0):(r.warning(`部分删除成功：${d}/${y.length}`),await k(),!1)}catch(h){return console.error("批量删除节点失败:",h),r.error(h.message||"批量删除节点失败"),!1}finally{c.setLoading(!1)}},toggleNodeStatus:async y=>{const h=y.activeFlag==="Y"?"N":"Y";return await _(y.tunnelStaticNodeId,{...y,activeFlag:h})}}}function Xe(i,o,r){const l=j(),c=he(),g=Je(o||"",r),v=x(!1),N=x("create"),m=x(null),k=(e=!0)=>(typeof o=="string"?o:o==null?void 0:o.value)?!0:(e&&l.warning("请先选择静态服务器"),!1),S=async e=>{g.model.resetPagination(),await g.loadNodeList(e)},L=async({currentPage:e,pageSize:a})=>{g.model.updatePagination({pageIndex:e,pageSize:a}),await g.loadNodeList()},_=async(e,a)=>{switch(e){case"add":P();break;case"delete":{if(!(i!=null&&i.value)){l.warning("Grid 引用未设置");return}const f=i.value.getCurrentRecord();if(!f){l.warning("请先点击选择要删除的节点");return}await p(f);break}case"search":{await S(a);break}default:console.warn("未知的工具栏按钮:",e)}},P=()=>{k()&&(N.value="create",m.value=null,v.value=!0)},F=async e=>{if(!e.tunnelStaticNodeId){l.warning("节点ID不能为空");return}try{const a=await g.getNodeDetail(e.tunnelStaticNodeId);a?(N.value="edit",m.value=a,v.value=!0):(N.value="edit",m.value=e,v.value=!0)}catch{N.value="edit",m.value=e,v.value=!0}},K=async e=>{if(!e.tunnelStaticNodeId){l.warning("节点ID不能为空");return}try{const a=await g.getNodeDetail(e.tunnelStaticNodeId);a?(N.value="view",m.value=a,v.value=!0):(N.value="view",m.value=e,v.value=!0)}catch{N.value="view",m.value=e,v.value=!0}},y=()=>{v.value=!1,m.value=null},h=async e=>{if(e){if(N.value==="view"){y();return}if(!k())return!1;try{const a={tunnelStaticNodeId:e.tunnelStaticNodeId,tunnelStaticServerId:e.tunnelStaticServerId||(typeof o=="string"?o:o==null?void 0:o.value),nodeName:e.nodeName,nodeDescription:e.nodeDescription,targetAddress:e.targetAddress,targetPort:e.targetPort,proxyType:e.proxyType,maxConnections:e.maxConnections,connectionTimeout:e.connectionTimeout,readTimeout:e.readTimeout,writeTimeout:e.writeTimeout,retryCount:e.retryCount,retryInterval:e.retryInterval,compression:e.compression,encryption:e.encryption,secretKey:e.secretKey,activeFlag:e.activeFlag,noteText:e.noteText};let f=!1;N.value==="create"?f=await g.addNode(a):N.value==="edit"&&m.value&&(f=await g.editNode(m.value.tunnelStaticNodeId,a)),f&&y()}catch(a){console.error("提交节点配置失败:",a),l.error(a.message||"提交失败，请重试")}}},d=async({menu:e,row:a})=>{switch(e.code){case"view":await K(a);break;case"edit":await F(a);break;case"toggle-status":await t(a);break;case"delete":await p(a);break;default:console.warn("未知的菜单项:",e.code)}},p=async e=>{await c.warning({title:"确认删除",content:`确定要删除节点"${e.nodeName}"吗？此操作不可恢复。`,positiveText:"删除",negativeText:"取消"})&&await g.deleteNode(e.tunnelStaticNodeId)},t=async e=>{await g.toggleNodeStatus(e)};return{service:g,formDialogVisible:v,formDialogMode:N,currentEditNode:m,handleSearch:S,handlePageChange:L,handleToolbarClick:_,handleMenuClick:d,openAddDialog:P,openEditDialog:F,openViewDialog:K,closeFormDialog:y,handleFormSubmit:h,handleDelete:p,handleToggleStatus:t}}const ie="hub0061-static-nodes",Qe=te({name:"StaticNodeListModal",__name:"StaticNodeListModal",props:{visible:{type:Boolean,default:!1},title:{default:""},width:{default:1400},to:{type:[String,Boolean],default:void 0},tunnelStaticServerId:{default:""},serverName:{default:""}},emits:["update:visible","close","refresh"],setup(i,{emit:o}){const r=i,l=o,c=x(),g=x(),v=x(r.visible),N=le(()=>r.visible,a=>{v.value=a}),m=x(r.tunnelStaticServerId),k=le(()=>r.tunnelStaticServerId,a=>{m.value=a});Ce(()=>{N(),k()});const{service:S,formDialogVisible:L,formDialogMode:_,currentEditNode:P,handleFormSubmit:F,handleToolbarClick:K,handleMenuClick:y,handleSearch:h,handlePageChange:d,handleToggleStatus:p}=Xe(g,m,c),t=a=>{v.value=a,l("update:visible",a),a?(l("refresh"),S.loadNodeList()):l("close")},e=()=>{v.value||(L.value=!1,_.value="create",P.value=null,S.model.nodeList.value=[],S.model.resetPagination())};return(a,f)=>(G(),Ne(s(xe),{visible:v.value,title:r.title||`静态节点管理 - ${r.serverName||""}`,width:r.width||1400,to:r.to,"show-footer":!1,"onUpdate:visible":t,onAfterLeave:e},{default:C(()=>[T("div",{class:"static-node-list-modal",id:ie},[b(s(ve),{direction:"vertical","no-resize":!0},{1:C(()=>[b(pe,Y({ref_key:"searchFormRef",ref:c,"module-id":s(S).model.moduleId},s(S).model.searchFormConfig,{onSearch:s(h),onToolbarClick:s(K)}),null,16,["module-id","onSearch","onToolbarClick"])]),2:C(()=>[b(s(ue),Y({ref_key:"gridRef",ref:g,"module-id":s(S).model.moduleId,data:s(S).model.nodeList,loading:s(S).model.loading},s(S).model.gridConfig,{onPageChange:s(d),onMenuClick:f[0]||(f[0]=({code:w,row:n})=>s(y)({menu:{code:w},row:n}))}),{proxyType:C(({row:w})=>[b(s(q),{type:w.proxyType==="tcp"?"primary":"info",size:"small"},{default:C(()=>[U(O(s(S).model.getProxyTypeLabel(w.proxyType)),1)]),_:2},1032,["type"])]),nodeStatus:C(({row:w})=>[b(s(q),{type:s(S).model.getNodeStatusTagType(w.nodeStatus),size:"small"},{default:C(()=>[U(O(s(S).model.getNodeStatusLabel(w.nodeStatus)),1)]),_:2},1032,["type"])]),healthCheckStatus:C(({row:w})=>[b(s(q),{type:s(S).model.getHealthCheckStatusTagType(w.healthCheckStatus),size:"small"},{default:C(()=>[U(O(s(S).model.getHealthCheckStatusLabel(w.healthCheckStatus)),1)]),_:2},1032,["type"])]),activeFlag:C(({row:w})=>[b(s(ge),{value:w.activeFlag==="Y","onUpdate:value":()=>s(p)(w),size:"small"},null,8,["value","onUpdate:value"])]),_:1},16,["module-id","data","loading","onPageChange"])]),_:1}),b(ce,{visible:s(L),"onUpdate:visible":f[1]||(f[1]=w=>Z(L)?L.value=w:null),mode:s(_),title:s(_)==="create"?"新增静态节点":s(_)==="edit"?"编辑静态节点":"查看静态节点详情",to:`#${ie}`,"form-fields":s(S).model.formFields,"form-tabs":s(S).model.formTabs,"initial-data":s(P)||void 0,"auto-close-on-confirm":!1,"confirm-loading":s(S).model.loading.value,onSubmit:s(F)},null,8,["visible","mode","title","to","form-fields","form-tabs","initial-data","confirm-loading","onSubmit"])])]),_:1},8,["visible","title","width","to"]))}}),Ze=ae(Qe,[["__scopeId","data-v-dc465933"]]),et={class:"static-server-stats"},tt={class:"stat-content"},at={class:"stat-icon total"},lt={class:"stat-info"},st={class:"stat-value"},nt={class:"stat-content"},rt={class:"stat-icon running"},it={class:"stat-info"},ot={class:"stat-value"},ct={class:"stat-content"},dt={class:"stat-icon stopped"},ut={class:"stat-info"},pt={class:"stat-value"},vt={class:"stat-content"},ft={class:"stat-icon connections"},gt={class:"stat-info"},ht={class:"stat-value"},mt={class:"stat-content"},bt={class:"stat-icon received"},yt={class:"stat-info"},St={class:"stat-value"},wt={class:"stat-content"},Tt={class:"stat-icon sent"},Ct={class:"stat-info"},Nt={class:"stat-value"},It=te({__name:"StaticServerStats",props:{statistics:{}},setup(i){const o=r=>{if(!r||r===0)return"0 B";const l=1024,c=["B","KB","MB","GB","TB"],g=Math.floor(Math.log(r)/Math.log(l));return Math.round(r/Math.pow(l,g)*100)/100+" "+c[g]};return(r,l)=>(G(),ee("div",et,[b(s(we),{cols:6,"x-gap":8,"y-gap":8,responsive:"screen"},{default:C(()=>[b(s(D),null,{default:C(()=>[b(s(E),{class:"stat-card",hoverable:""},{default:C(()=>[T("div",tt,[T("div",at,[b(s(H),{size:"18",component:s(Le)},null,8,["component"])]),T("div",lt,[T("div",st,O(i.statistics.totalServers||0),1),l[0]||(l[0]=T("div",{class:"stat-label"},"总服务数",-1))])])]),_:1})]),_:1}),b(s(D),null,{default:C(()=>[b(s(E),{class:"stat-card",hoverable:""},{default:C(()=>[T("div",nt,[T("div",rt,[b(s(H),{size:"18",component:s(ye)},null,8,["component"])]),T("div",it,[T("div",ot,O(i.statistics.runningServers||0),1),l[1]||(l[1]=T("div",{class:"stat-label"},"运行中",-1))])])]),_:1})]),_:1}),b(s(D),null,{default:C(()=>[b(s(E),{class:"stat-card",hoverable:""},{default:C(()=>[T("div",ct,[T("div",dt,[b(s(H),{size:"18",component:s(Se)},null,8,["component"])]),T("div",ut,[T("div",pt,O(i.statistics.stoppedServers||0),1),l[2]||(l[2]=T("div",{class:"stat-label"},"已停止",-1))])])]),_:1})]),_:1}),b(s(D),null,{default:C(()=>[b(s(E),{class:"stat-card",hoverable:""},{default:C(()=>[T("div",vt,[T("div",ft,[b(s(H),{size:"18",component:s(Pe)},null,8,["component"])]),T("div",gt,[T("div",ht,O(i.statistics.totalConnections||0),1),l[3]||(l[3]=T("div",{class:"stat-label"},"总连接数",-1))])])]),_:1})]),_:1}),b(s(D),null,{default:C(()=>[b(s(E),{class:"stat-card",hoverable:""},{default:C(()=>[T("div",mt,[T("div",bt,[b(s(H),{size:"18",component:s(Ke)},null,8,["component"])]),T("div",yt,[T("div",St,O(o(i.statistics.totalBytesReceived)),1),l[4]||(l[4]=T("div",{class:"stat-label"},"接收流量",-1))])])]),_:1})]),_:1}),b(s(D),null,{default:C(()=>[b(s(E),{class:"stat-card",hoverable:""},{default:C(()=>[T("div",wt,[T("div",Tt,[b(s(H),{size:"18",component:s(Fe)},null,8,["component"])]),T("div",Ct,[T("div",Nt,O(o(i.statistics.totalBytesSent)),1),l[5]||(l[5]=T("div",{class:"stat-label"},"发送流量",-1))])])]),_:1})]),_:1})]),_:1})]))}}),kt=ae(It,[["__scopeId","data-v-2ed12491"]]),J=[{label:"TCP",value:"tcp"},{label:"UDP",value:"udp"}],X=[{label:"运行中",value:"running",type:"success"},{label:"已停止",value:"stopped",type:"warning"},{label:"错误",value:"error",type:"error"}],oe=[{label:"轮询",value:"roundrobin"},{label:"最少连接",value:"leastconn"},{label:"随机",value:"random"}],xt=[{label:"TCP",value:"tcp"},{label:"HTTP",value:"http"},{label:"HTTPS",value:"https"}];function Lt(){const i="hub0061:static-server",o=x(!1),r=x([]),l=x(),c={fields:[{field:"serverName",label:"服务名称",type:"input",placeholder:"请输入服务名称",span:6,clearable:!0},{field:"listenAddress",label:"监听地址",type:"input",placeholder:"请输入监听地址",span:6,clearable:!0},{field:"serverType",label:"服务类型",type:"select",placeholder:"请选择服务类型",span:6,clearable:!0,options:[{label:"全部",value:""},...J.map(t=>({label:t.label,value:t.value}))]},{field:"serverStatus",label:"服务状态",type:"select",placeholder:"请选择服务状态",span:6,clearable:!0,options:[{label:"全部",value:""},...X.map(t=>({label:t.label,value:t.value}))]}],toolbarButtons:[{key:"add",label:"新增服务",icon:me,type:"primary",tooltip:"新增静态服务"},{key:"start",label:"启动",icon:ye,type:"success",tooltip:"启动选中的服务"},{key:"stop",label:"停止",icon:Ve,type:"warning",tooltip:"停止选中的服务"},{key:"reload",label:"重载",icon:Oe,type:"info",tooltip:"重载选中的服务配置"},{key:"delete",label:"删除",icon:be,type:"error",tooltip:"删除选中的服务"}],showSearchButton:!0,showResetButton:!0},g=t=>{const e=X.find(a=>a.value===t);return(e==null?void 0:e.label)||t},v=t=>{const e=X.find(a=>a.value===t);return(e==null?void 0:e.type)||"default"},N=t=>{const e=J.find(a=>a.value===t);return(e==null?void 0:e.label)||t},m=t=>{if(!t)return"-";const e=oe.find(a=>a.value===t);return(e==null?void 0:e.label)||t},k={columns:[{field:"tunnelStaticServerId",title:"服务ID",visible:!1,width:0},{field:"serverName",title:"服务名称",align:"center",showOverflow:"tooltip",width:180},{field:"listenAddress",title:"监听地址",align:"center",width:140,slots:{default:"listenAddress"}},{field:"serverType",title:"服务类型",align:"center",width:100,slots:{default:"serverType"}},{field:"serverStatus",title:"服务状态",align:"center",width:100,slots:{default:"serverStatus"}},{field:"nodeCount",title:"节点数",align:"center",width:80,slots:{default:"nodeCount"}},{field:"currentConnectionCount",title:"当前连接",align:"center",width:100},{field:"totalConnectionCount",title:"总连接数",align:"center",width:100},{field:"totalBytesReceived",title:"接收流量",align:"center",width:100,formatter:({row:t})=>$(t.totalBytesReceived)},{field:"totalBytesSent",title:"发送流量",align:"center",width:100,formatter:({row:t})=>$(t.totalBytesSent)},{field:"loadBalanceType",title:"负载均衡",align:"center",width:100,formatter:({row:t})=>m(t.loadBalanceType)},{field:"maxConnections",title:"最大连接",align:"center",width:100},{field:"activeFlag",title:"状态",align:"center",width:80,slots:{default:"activeFlag"}},{field:"serverDescription",title:"描述",align:"center",showOverflow:"tooltip",width:160},{field:"startTime",title:"启动时间",align:"center",formatter:({row:t})=>z(t.startTime),width:160},{field:"addTime",title:"创建时间",align:"center",formatter:({row:t})=>z(t.addTime),width:160}],showCheckbox:!0,paginationConfig:{show:!0,pageInfo:l,align:"right"},menuConfig:{enabled:!0,showCopyRow:!0,customMenus:[{code:"view",name:"查看详情",prefixIcon:"vxe-icon-eye-fill"},{code:"edit",name:"编辑",prefixIcon:"vxe-icon-edit"},{code:"nodes",name:"管理节点",prefixIcon:"vxe-icon-setting"},{code:"start",name:"启动",prefixIcon:"vxe-icon-caret-right"},{code:"stop",name:"停止",prefixIcon:"vxe-icon-square"},{code:"reload",name:"重载配置",prefixIcon:"vxe-icon-refresh"},{code:"delete",name:"删除",prefixIcon:"vxe-icon-delete"}]}};function S(t){r.value=t}function L(t){o.value=t}function _(){l.value=void 0}function P(t){l.value?Object.assign(l.value,t):l.value=t}function F(t){r.value.push(t)}function K(t,e,a){const f=r.value.findIndex(w=>w.tunnelStaticServerId===t&&(!e||w.tenantId===e));f!==-1&&Object.assign(r.value[f],a)}function y(t){const e=r.value.findIndex(a=>a.tunnelStaticServerId===t);e>=0&&r.value.splice(e,1)}function h(t){r.value=r.value.filter(e=>!t.includes(e.tunnelStaticServerId))}const d=[{key:"basic",label:"基本信息"},{key:"network",label:"网络配置"},{key:"loadbalance",label:"负载均衡"},{key:"tls",label:"TLS配置",show:!1},{key:"other",label:"其他信息"}],p=[{field:"tunnelStaticServerId",label:"服务ID",type:"input",span:12,primary:!0,show:!1},{field:"serverName",label:"服务名称",type:"input",placeholder:"请输入服务名称",span:12,tabKey:"basic",required:!0,tips:"用于标识此静态代理服务的唯一名称，建议使用有意义的命名便于管理",rules:[{required:!0,message:"请输入服务名称",trigger:["blur","input"]},{max:100,message:"服务名称不能超过100个字符",trigger:["blur","input"]}]},{field:"serverType",label:"服务类型",type:"select",placeholder:"请选择服务类型",span:12,tabKey:"basic",required:!0,defaultValue:"tcp",tips:"TCP：适用于大多数场景如 SSH、数据库连接；UDP：适用于 DNS、游戏等场景",options:J.map(t=>({label:t.label,value:t.value})),rules:[{required:!0,message:"请选择服务类型",trigger:["blur","change"]}]},{field:"listenAddress",label:"监听地址",type:"input",placeholder:"请输入监听地址，如: 0.0.0.0",span:12,tabKey:"basic",required:!0,defaultValue:"0.0.0.0",tips:"代理服务监听的IP地址。0.0.0.0 表示监听所有网卡，127.0.0.1 仅本机访问",rules:[{required:!0,message:"请输入监听地址",trigger:["blur","input"]}]},{field:"listenPort",label:"监听端口",type:"number",placeholder:"请输入监听端口",span:12,tabKey:"basic",required:!0,tips:"代理服务监听的端口号（1-65535）。请确保端口未被占用，修改后需要重载配置",props:{min:1,max:65535,precision:0},rules:[{required:!0,type:"number",message:"请输入监听端口",trigger:["blur","change"]}]},{field:"activeFlag",label:"启用状态",type:"switch",span:12,tabKey:"basic",defaultValue:"Y",tips:"禁用后服务将不会接受新的连接请求",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"serverDescription",label:"服务描述",type:"input",placeholder:"请输入服务描述",span:24,tabKey:"basic",props:{type:"textarea",rows:2,maxlength:500,showCount:!0}},{field:"connectionTimeout",label:"连接超时(秒)",type:"number",placeholder:"请输入连接超时时间",span:12,tabKey:"network",defaultValue:30,tips:"建立到后端节点的连接超时时间。超时后将尝试下一个节点或返回错误",props:{min:1,precision:0}},{field:"maxConnections",label:"最大连接数",type:"number",placeholder:"请输入最大连接数，0表示不限制",span:12,tabKey:"network",defaultValue:0,show:!1,tips:"服务允许的最大并发连接数。0 表示不限制，建议根据服务器性能设置",props:{min:0,precision:0}},{field:"readTimeout",label:"读取超时(秒)",type:"number",placeholder:"请输入读取超时时间",span:12,tabKey:"network",defaultValue:60,show:!1,tips:"从连接读取数据的超时时间。对于长连接场景（如 SSH）建议设置较大值",props:{min:1,precision:0}},{field:"writeTimeout",label:"写入超时(秒)",type:"number",placeholder:"请输入写入超时时间",span:12,tabKey:"network",defaultValue:60,show:!1,tips:"向连接写入数据的超时时间。对于长连接场景（如 SSH）建议设置较大值",props:{min:1,precision:0}},{field:"logLevel",label:"日志级别",type:"select",placeholder:"请选择日志级别",span:12,tabKey:"network",defaultValue:"info",show:!1,tips:"服务的日志记录级别。Debug 记录最详细，Error 只记录错误",options:[{label:"Debug",value:"debug"},{label:"Info",value:"info"},{label:"Warn",value:"warn"},{label:"Error",value:"error"}]},{field:"loadBalanceType",label:"负载均衡类型",type:"select",placeholder:"请选择负载均衡类型",span:12,tabKey:"loadbalance",defaultValue:"roundrobin",tips:"轮询：依次选择节点，适合节点性能相近场景；最少连接：选择当前连接最少的节点，适合请求处理时间不均匀场景；随机：随机选择节点",options:oe.map(t=>({label:t.label,value:t.value}))},{field:"healthCheckType",label:"健康检查类型",type:"select",placeholder:"请选择健康检查类型",span:12,tabKey:"loadbalance",clearable:!0,tips:"TCP：尝试建立 TCP 连接验证节点可达性；HTTP/HTTPS：发送 HTTP 请求检查响应状态码（2xx/3xx 为健康）",options:xt.map(t=>({label:t.label,value:t.value}))},{field:"healthCheckUrl",label:"健康检查URL",type:"input",placeholder:"请输入健康检查URL，如: /health",span:24,tabKey:"loadbalance",tips:"HTTP/HTTPS 健康检查的请求路径。留空时使用节点地址和端口的根路径。支持完整 URL 或相对路径",show:t=>t.healthCheckType==="http"||t.healthCheckType==="https"},{field:"healthCheckInterval",label:"检查间隔(秒)",type:"number",placeholder:"请输入健康检查间隔",span:12,tabKey:"loadbalance",defaultValue:30,tips:"健康检查的执行间隔。建议不低于 5 秒，避免对后端节点造成过大压力",show:t=>!!t.healthCheckType,props:{min:5,precision:0}},{field:"healthCheckTimeout",label:"检查超时(秒)",type:"number",placeholder:"请输入健康检查超时",span:12,tabKey:"loadbalance",defaultValue:5,tips:"单次健康检查的超时时间。超时后节点将被标记为不健康",show:t=>!!t.healthCheckType,props:{min:1,precision:0}},{field:"healthCheckMaxFailures",label:"最大失败次数",type:"number",placeholder:"请输入最大失败次数",span:12,tabKey:"loadbalance",defaultValue:3,show:!1,tips:"连续健康检查失败达到此次数后，节点将被标记为不健康并从负载均衡中移除",props:{min:1,precision:0}},{field:"tlsEnable",label:"启用TLS",type:"switch",span:12,tabKey:"tls",defaultValue:"N",show:!1,tips:"启用后代理服务将使用 TLS 加密传输。需要配置有效的证书和私钥",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"tlsCertFile",label:"证书文件路径",type:"input",placeholder:"请输入TLS证书文件路径",span:24,tabKey:"tls",show:!1,tips:"TLS 证书文件的绝对路径，支持 PEM 格式"},{field:"tlsKeyFile",label:"私钥文件路径",type:"input",placeholder:"请输入TLS私钥文件路径",span:24,tabKey:"tls",show:!1,tips:"TLS 私钥文件的绝对路径，支持 PEM 格式"},{field:"tlsCaFile",label:"CA证书路径",type:"input",placeholder:"请输入CA证书文件路径（可选）",span:24,tabKey:"tls",show:!1,tips:"CA 证书文件路径，用于客户端证书验证（双向 TLS）。留空表示不验证客户端证书"},{field:"noteText",label:"备注信息",type:"input",placeholder:"请输入备注信息",span:24,tabKey:"other",props:{type:"textarea",rows:3,maxlength:500,showCount:!0}},{field:"addTime",label:"创建时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"addWho",label:"创建人",type:"input",span:12,tabKey:"other",disabled:!0},{field:"editTime",label:"修改时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"editWho",label:"修改人",type:"input",span:12,tabKey:"other",disabled:!0}];return{moduleId:i,loading:o,serverList:r,pageInfo:l,searchFormConfig:c,gridConfig:k,formFields:p,formTabs:d,getServerStatusLabel:g,getServerStatusTagType:v,getServerTypeLabel:N,getLoadBalanceLabel:m,setServerList:S,setLoading:L,resetPagination:_,updatePagination:P,addServerToList:F,updateServerInList:K,removeServerFromList:y,removeServersFromList:h}}function _t(i){const o=j(),r=he(),l=Lt(),{addServerToList:c,updateServerInList:g,removeServerFromList:v,removeServersFromList:N}=l,m=async d=>{var p,t,e;try{l.setLoading(!0);let a=d;!a&&((p=i==null?void 0:i.value)!=null&&p.getFormData)&&(a=i.value.getFormData()||{});const w={...a?Object.fromEntries(Object.entries(a).filter(([,u])=>u!==""&&u!==null&&u!==void 0)):{},...de((t=l.pageInfo.value)==null?void 0:t.pageIndex,(e=l.pageInfo.value)==null?void 0:e.pageSize)},n=await Me(w);if(V(n)){const u=M(n,[])||[];l.setServerList(u);const I=fe(n);I&&Object.keys(I).length>0?l.updatePagination(I):l.resetPagination()}else o.error(A(n,"加载服务列表失败")),l.setServerList([]),l.resetPagination()}catch(a){console.error("加载服务列表失败:",a),o.error(a.message||"加载服务列表失败"),l.setServerList([]),l.resetPagination()}finally{l.setLoading(!1)}},k=async d=>{try{const p=await De(d);return V(p)?M(p):(o.error(A(p,"获取服务详情失败")),null)}catch(p){return console.error("获取服务详情失败:",p),o.error(p.message||"获取服务详情失败"),null}},S=async d=>{try{l.setLoading(!0);const p={...d,tenantId:"default"},t=await Ee(p);if(V(t)){o.success("新增服务成功");const e=M(t,null);return e?c(e):await m(),!0}else return o.error(A(t,"新增服务失败")),!1}catch(p){return console.error("新增服务失败:",p),o.error(p.message||"新增服务失败"),!1}finally{l.setLoading(!1)}},L=async(d,p)=>{try{l.setLoading(!0);const t={...p,tunnelStaticServerId:d,tenantId:"default"},e=await He(t);if(V(e)){o.success("编辑服务成功");const a=M(e,null);return a?g(a.tunnelStaticServerId,a.tenantId,a):await m(),!0}else return o.error(A(e,"编辑服务失败")),!1}catch(t){return console.error("编辑服务失败:",t),o.error(t.message||"编辑服务失败"),!1}finally{l.setLoading(!1)}};return{model:l,loadServerList:m,getServerDetail:k,addServer:S,editServer:L,deleteServer:async d=>{if(!await r.warning({title:"确认删除",subtitle:"此操作不可恢复，请谨慎操作",content:`确定要删除静态服务 "${d.serverName}" 吗？`,icon:Ae,headerStyle:"gradient",positiveText:"确定删除",negativeText:"取消",width:500}))return!1;try{l.setLoading(!0);const t=await se(d.tunnelStaticServerId);return V(t)?(o.success("删除服务成功"),v(d.tunnelStaticServerId),l.serverList.value.length===0&&l.pageInfo.value&&l.pageInfo.value.pageIndex>1&&(l.updatePagination({pageIndex:l.pageInfo.value.pageIndex-1}),await m()),!0):(o.error(A(t,"删除服务失败")),!1)}catch(t){return console.error("删除服务失败:",t),o.error(t.message||"删除服务失败"),!1}finally{l.setLoading(!1)}},deleteServers:async d=>{try{l.setLoading(!0);const t=(await Promise.all(d.map(e=>se(e)))).filter(e=>V(e)).length;return t===d.length?(o.success(`成功删除 ${t} 个服务`),N(d),l.serverList.value.length===0&&l.pageInfo.value&&l.pageInfo.value.pageIndex>1&&(l.updatePagination({pageIndex:l.pageInfo.value.pageIndex-1}),await m()),!0):(o.warning(`部分删除成功：${t}/${d.length}`),await m(),!1)}catch(p){return console.error("批量删除服务失败:",p),o.error(p.message||"批量删除服务失败"),!1}finally{l.setLoading(!1)}},toggleServerStatus:async d=>{const p=d.activeFlag==="Y"?"N":"Y";return await L(d.tunnelStaticServerId,{...d,activeFlag:p})},startServer:async d=>{if(!await r.warning({title:"确认启动",subtitle:"启动后将开始监听客户端连接",content:`确定要启动静态服务 "${d.serverName}" 吗？`,icon:Be,headerStyle:"gradient",positiveText:"确定启动",negativeText:"取消",width:500}))return!1;try{l.setLoading(!0);const t=await qe(d.tunnelStaticServerId);if(V(t)){o.success("服务启动成功");const e=M(t,null);return e?g(e.tunnelStaticServerId,e.tenantId,e):await m(),!0}else return o.error(A(t,"服务启动失败")),!1}catch(t){return console.error("服务启动失败:",t),o.error(t.message||"服务启动失败"),!1}finally{l.setLoading(!1)}},stopServer:async d=>{if(!await r.warning({title:"确认停止",subtitle:"停止后将断开所有客户端连接",content:`确定要停止静态服务 "${d.serverName}" 吗？`,icon:Se,headerStyle:"gradient",positiveText:"确定停止",negativeText:"取消",width:500}))return!1;try{l.setLoading(!0);const t=await $e(d.tunnelStaticServerId);if(V(t)){o.success("服务停止成功");const e=M(t,null);return e?g(e.tunnelStaticServerId,e.tenantId,e):await m(),!0}else return o.error(A(t,"服务停止失败")),!1}catch(t){return console.error("服务停止失败:",t),o.error(t.message||"服务停止失败"),!1}finally{l.setLoading(!1)}},reloadServer:async d=>{if(!await r.warning({title:"确认重载",subtitle:"重载配置将应用最新的服务配置",content:`确定要重载静态服务 "${d.serverName}" 的配置吗？`,icon:_e,headerStyle:"gradient",positiveText:"确定重载",negativeText:"取消",width:500}))return!1;try{l.setLoading(!0);const t=await ze(d.tunnelStaticServerId);if(V(t)){o.success("服务配置重载成功");const e=M(t,null);return e?g(e.tunnelStaticServerId,e.tenantId,e):await m(),!0}else return o.error(A(t,"服务配置重载失败")),!1}catch(t){return console.error("服务配置重载失败:",t),o.error(t.message||"服务配置重载失败"),!1}finally{l.setLoading(!1)}}}}function Pt(i,o){const r=j(),l=_t(o),c=x(!1),g=x("create"),v=x(null),N=x(!1),m=x(null),k=async n=>{l.model.resetPagination(),await l.loadServerList(n)},S=async({currentPage:n,pageSize:u})=>{l.model.updatePagination({pageIndex:n,pageSize:u}),await l.loadServerList()},L=async(n,u)=>{switch(n){case"add":_();break;case"start":{if(!(i!=null&&i.value)){r.warning("Grid 引用未设置");return}const I=i.value.getCurrentRecord();if(!I){r.warning("请先点击选择要启动的服务");return}await t(I);break}case"stop":{if(!(i!=null&&i.value)){r.warning("Grid 引用未设置");return}const I=i.value.getCurrentRecord();if(!I){r.warning("请先点击选择要停止的服务");return}await e(I);break}case"reload":{if(!(i!=null&&i.value)){r.warning("Grid 引用未设置");return}const I=i.value.getCurrentRecord();if(!I){r.warning("请先点击选择要重载的服务");return}await a(I);break}case"delete":{if(!(i!=null&&i.value)){r.warning("Grid 引用未设置");return}const I=i.value.getCurrentRecord();if(!I){r.warning("请先点击选择要删除的服务");return}await f(I);break}case"search":{await k(u);break}default:console.warn("未知的工具栏按钮:",n)}},_=()=>{g.value="create",v.value=null,c.value=!0},P=async n=>{if(!n.tunnelStaticServerId){r.warning("服务ID不能为空");return}try{const u=await l.getServerDetail(n.tunnelStaticServerId);u?(g.value="edit",v.value=u,c.value=!0):(g.value="edit",v.value=n,c.value=!0)}catch{g.value="edit",v.value=n,c.value=!0}},F=async n=>{if(!n.tunnelStaticServerId){r.warning("服务ID不能为空");return}try{const u=await l.getServerDetail(n.tunnelStaticServerId);u?(g.value="view",v.value=u,c.value=!0):(g.value="view",v.value=n,c.value=!0)}catch{g.value="view",v.value=n,c.value=!0}},K=()=>{c.value=!1,v.value=null},y=n=>{m.value=n,N.value=!0},h=()=>{N.value=!1,m.value=null},d=async n=>{if(n){if(g.value==="view"){K();return}try{const u={tunnelStaticServerId:n.tunnelStaticServerId,serverName:n.serverName,serverDescription:n.serverDescription,listenAddress:n.listenAddress,listenPort:n.listenPort,serverType:n.serverType,maxConnections:n.maxConnections,connectionTimeout:n.connectionTimeout,readTimeout:n.readTimeout,writeTimeout:n.writeTimeout,tlsEnable:n.tlsEnable,tlsCertFile:n.tlsCertFile,tlsKeyFile:n.tlsKeyFile,tlsCaFile:n.tlsCaFile,logLevel:n.logLevel,healthCheckType:n.healthCheckType,healthCheckUrl:n.healthCheckUrl,healthCheckInterval:n.healthCheckInterval,healthCheckTimeout:n.healthCheckTimeout,healthCheckMaxFailures:n.healthCheckMaxFailures,loadBalanceType:n.loadBalanceType,activeFlag:n.activeFlag,noteText:n.noteText};let I=!1;g.value==="create"?I=await l.addServer(u):g.value==="edit"&&v.value&&(I=await l.editServer(v.value.tunnelStaticServerId,u)),I&&K()}catch(u){console.error("提交服务配置失败:",u),r.error(u.message||"提交失败，请重试")}}},p=async({menu:n,row:u})=>{const I=(n==null?void 0:n.code)||n;switch(I){case"view":await F(u);break;case"edit":await P(u);break;case"nodes":y(u);break;case"start":await t(u);break;case"stop":await e(u);break;case"reload":await a(u);break;case"toggle-status":await w(u);break;case"delete":await f(u);break;default:console.warn("未知的菜单项:",I)}},t=async n=>{await l.startServer(n)},e=async n=>{await l.stopServer(n)},a=async n=>{await l.reloadServer(n)},f=async n=>{await l.deleteServer(n)},w=async n=>{await l.toggleServerStatus(n)};return{service:l,formDialogVisible:c,formDialogMode:g,currentEditServer:v,nodeDialogVisible:N,currentNodeServer:m,handleSearch:k,handlePageChange:S,handleToolbarClick:L,handleMenuClick:p,openAddDialog:_,openEditDialog:P,openViewDialog:F,closeFormDialog:K,openNodeDialog:y,closeNodeDialog:h,handleFormSubmit:d,handleStart:t,handleStop:e,handleReload:a,handleDelete:f,handleToggleStatus:w}}const Kt={class:"bottom-section"},Ft={key:0,class:"stats-section"},Vt={class:"grid-section"},Ot={class:"text-primary font-mono"},Q="hub0061-static-server",Bt=te({name:"StaticMappingManagement",__name:"StaticMappingManagement",setup(i){const o=x(),r=x(),l=x(!0),c=x({totalServers:0,runningServers:0,stoppedServers:0,totalConnections:0,totalBytesReceived:0,totalBytesSent:0}),g=async()=>{try{const a=await Ue();if(a.oK){const f=M(a);f&&(c.value=f)}}catch(a){console.error("加载统计数据失败:",a)}},{service:v,formDialogVisible:N,formDialogMode:m,currentEditServer:k,nodeDialogVisible:S,currentNodeServer:L,handleFormSubmit:_,handleToolbarClick:P,handleMenuClick:F,handleSearch:K,handlePageChange:y,handleToggleStatus:h,openNodeDialog:d,closeNodeDialog:p}=Pt(r,o),t=async a=>{await K(a),await g()},e=async()=>{await v.loadServerList(),await g()};return(a,f)=>{var w,n;return G(),ee("div",{class:"static-server-management",id:Q},[b(s(ve),{direction:"vertical","default-size":.12,min:.1,max:.5},{1:C(()=>[b(pe,Y({ref_key:"searchFormRef",ref:o,"module-id":s(v).model.moduleId},s(v).model.searchFormConfig,{onSearch:t,onToolbarClick:s(P)}),null,16,["module-id","onToolbarClick"])]),2:C(()=>[T("div",Kt,[l.value?(G(),ee("div",Ft,[b(s(kt),{statistics:c.value},null,8,["statistics"])])):Ie("",!0),T("div",Vt,[b(s(ue),Y({ref_key:"gridRef",ref:r,"module-id":s(v).model.moduleId,data:s(v).model.serverList,loading:s(v).model.loading},s(v).model.gridConfig,{onPageChange:s(y),onMenuClick:f[0]||(f[0]=({code:u,row:I})=>s(F)({menu:{code:u},row:I}))}),{listenAddress:C(({row:u})=>[T("span",Ot,O(u.listenAddress)+":"+O(u.listenPort),1)]),serverType:C(({row:u})=>[b(s(q),{type:u.serverType==="tcp"?"primary":"info",size:"small"},{default:C(()=>[U(O(s(v).model.getServerTypeLabel(u.serverType)),1)]),_:2},1032,["type"])]),serverStatus:C(({row:u})=>[b(s(q),{type:s(v).model.getServerStatusTagType(u.serverStatus),size:"small"},{default:C(()=>[U(O(s(v).model.getServerStatusLabel(u.serverStatus)),1)]),_:2},1032,["type"])]),nodeCount:C(({row:u})=>[b(s(ke),{text:"",type:"primary",onClick:I=>s(d)(u)},{default:C(()=>[U(O(u.nodeCount||0)+" 个节点 ",1)]),_:2},1032,["onClick"])]),activeFlag:C(({row:u})=>[b(s(ge),{value:u.activeFlag==="Y","onUpdate:value":()=>s(h)(u),size:"small"},null,8,["value","onUpdate:value"])]),_:1},16,["module-id","data","loading","onPageChange"])])])]),_:1}),b(ce,{visible:s(N),"onUpdate:visible":f[1]||(f[1]=u=>Z(N)?N.value=u:null),mode:s(m),title:s(m)==="create"?"新增静态服务":s(m)==="edit"?"编辑静态服务":"查看静态服务详情",to:`#${Q}`,"form-fields":s(v).model.formFields,"form-tabs":s(v).model.formTabs,"initial-data":s(k)||void 0,"auto-close-on-confirm":!1,"confirm-loading":s(v).model.loading.value,onSubmit:s(_)},null,8,["visible","mode","title","to","form-fields","form-tabs","initial-data","confirm-loading","onSubmit"]),b(s(Ze),{visible:s(S),"onUpdate:visible":f[2]||(f[2]=u=>Z(S)?S.value=u:null),"tunnel-static-server-id":((w=s(L))==null?void 0:w.tunnelStaticServerId)||"","server-name":((n=s(L))==null?void 0:n.serverName)||"",to:`#${Q}`,onClose:s(p),onRefresh:e},null,8,["visible","tunnel-static-server-id","server-name","to","onClose"])])}}}),ca=ae(Bt,[["__scopeId","data-v-417e54f9"]]);export{ca as default};
