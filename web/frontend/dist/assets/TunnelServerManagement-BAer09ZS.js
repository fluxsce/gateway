import{G as J,c as ie,N as X,a as $,S as ce}from"./SearchForm-C0DQDEEE.js";import{af as de,d as D,q as B,a7 as re,c as z,o as A,b as l,e as t,am as E,T as k,aa as Y,r as y,w as d,aO as F,K as V,t as w,f as n,i as x,_ as R,m as ae,a9 as K,j as Z,h as ue,n as pe,cr as ve,z as fe,A as me,C as he,D as q}from"./index-DVVs4J_g.js";import{R as W}from"./ReloadOutline-CcOZbYUo.js";import"./GPagination.vue_vue_type_style_index_0_scoped_2c35df38_lang-rwsE82tp.js";import{G as ge}from"./GDataFormModal-B5dffEod.js";import{G as be}from"./GPane-w_mkAzRd.js";import{S as Se}from"./ServerOutline-BkLyZQ8B.js";import{P as se,R as ye}from"./RefreshCircleOutline-DnVi9X8G.js";import{S as j}from"./StopCircleOutline-Cm3D8hbW.js";import{A as we}from"./AlertCircleOutline-BhjEg-lv.js";import{b as ee}from"./Upload-KD8QX-hv.js";import{P as Te,S as _e}from"./ShieldCheckmarkOutline-CimyTsz-.js";import{L as Ce}from"./LinkOutline-BYR1ho2B.js";import{u as xe}from"./useGDialog-DWN8tM1R.js";import{A as Ie}from"./AddOutline-D7WMths6.js";import{C as ke}from"./CreateOutline-DNze2007.js";import{T as Me}from"./TrashOutline-dLMtYZFW.js";import{P as Pe}from"./PlayCircleOutline-CwNOIKX9.js";import{W as Oe}from"./WarningOutline-CPh7mSpG.js";import"./index-CkZRWLYS.js";import"./Select-DNy4pOft.js";import"./RefreshOutline-ZMKO-4DG.js";import"./GModal-xYfXS7HF.js";import"./ContractOutline-keSydpIS.js";import"./CloseOutline-CI2J8g02.js";import"./DownloadOutline-CFQ2kwN6.js";import"./DocumentOutline-CUl-N0py.js";import"./download-C2161hUv.js";import"./GDialog-0ZeiOrqn.js";const I=de("/gateway/hub0060"),Le=async s=>I.post("/queryTunnelServers",s),Ne=async s=>I.post("/getTunnelServer",{tunnelServerId:s}),$e=async s=>I.post("/createTunnelServer",s),Ke=async s=>I.post("/updateTunnelServer",s),ze=async s=>I.post("/deleteTunnelServer",{tunnelServerId:s}),Ae=async()=>I.post("/getTunnelServerStats",{}),Ye=async s=>I.post("/getRegisteredClients",{tunnelServerId:s}),De=async s=>I.post("/getRegisteredServices",{tunnelServerId:s}),Re=async s=>I.post("/startTunnelServer",{tunnelServerId:s}),He=async s=>I.post("/stopTunnelServer",{tunnelServerId:s}),Fe=async s=>I.post("/restartTunnelServer",{tunnelServerId:s}),Ve={class:"regist-client-list"},Ee={class:"font-bold"},Ge=D({__name:"RegistClientList",props:{tunnelServerId:{default:""}},setup(s,{expose:c}){const f=s,p=y(),u=y(!1),m=y([]),a={columns:[{field:"tunnelServerId",title:"服务器ID",width:180,showOverflow:"tooltip",filters:[{data:""}],filterRender:{name:"VxeInput"}},{field:"tunnelClientId",title:"客户端ID",width:200,showOverflow:"tooltip",filters:[{data:""}],filterRender:{name:"VxeInput"}},{field:"clientName",title:"客户端名称",width:180,showOverflow:"tooltip",slots:{default:"clientName"},filters:[{data:""}],filterRender:{name:"VxeInput"}},{field:"serverAddress",title:"服务器地址",width:200,showOverflow:"tooltip",formatter:({row:r})=>`${r.serverAddress}:${r.serverPort}`,filters:[{data:""}],filterRender:{name:"VxeInput"}},{field:"clientIpAddress",title:"客户端IP",width:150,showOverflow:"tooltip",filters:[{data:""}],filterRender:{name:"VxeInput"}},{field:"clientMacAddress",title:"客户端MAC",width:150,showOverflow:"tooltip"},{field:"clientVersion",title:"客户端版本",width:120,showOverflow:"tooltip"},{field:"operatingSystem",title:"操作系统",width:150,showOverflow:"tooltip"},{field:"connectionStatus",title:"连接状态",width:100,align:"center",formatter:({cellValue:r})=>r?{connected:"已连接",disconnected:"已断开",connecting:"连接中",error:"错误"}[r]||r:"-"},{field:"serviceCount",title:"服务数量",width:100,align:"center",slots:{default:"serviceCount"}},{field:"authenticated",title:"认证状态",width:100,align:"center",formatter:({cellValue:r})=>r?"已认证":"未认证"},{field:"lastHeartbeat",title:"最后心跳",width:160,showOverflow:!0,formatter:({cellValue:r})=>r?Y(r,"YYYY-MM-DD HH:mm:ss"):"-"}],showCheckbox:!1,menuConfig:{enabled:!0,showCopyRow:!0,showCopyCell:!0,customMenus:[{code:"refresh",name:"刷新",prefixIcon:()=>k(x,{size:14},{default:()=>k(W)})}]},height:"100%"},g=async()=>{u.value=!0;try{const r=f.tunnelServerId||"",b=await Ye(r);if(b.oK)if(b.bizData){const S=JSON.parse(b.bizData);m.value=Array.isArray(S)?S:[]}else m.value=[];else m.value=[]}catch(r){console.error("加载已注册客户端列表失败:",r),m.value=[]}finally{u.value=!1}},T=async({code:r})=>{r==="refresh"&&await g()};return B(()=>{g()}),re(()=>f.tunnelServerId,()=>{g()}),c({loadClientList:g,refresh:g}),(r,b)=>(A(),z("div",Ve,[l(t(J),E({ref_key:"gridRef",ref:p,"module-id":"hub0060:regist-client-list",data:m.value,loading:u.value},a,{onMenuClick:T}),{clientName:d(({row:S})=>[n("span",Ee,w(S.clientName||"-"),1)]),serviceCount:d(({row:S})=>[l(t(F),{type:"info",size:"small"},{default:d(()=>[V(w(S.serviceCount||0),1)]),_:2},1024)]),_:1},16,["data","loading"])]))}}),qe=R(Ge,[["__scopeId","data-v-91b75cba"]]),Je={class:"regist-service-list"},Be={class:"font-bold"},We=D({__name:"RegistServiceList",props:{tunnelServerId:{default:""}},setup(s,{expose:c}){const f=s,p=y(),u=y(!1),m=y([]),a={columns:[{field:"tunnelServerId",title:"服务器ID",width:180,showOverflow:"tooltip",filters:[{data:""}],filterRender:{name:"VxeInput"}},{field:"tunnelClientId",title:"客户端ID",width:200,showOverflow:"tooltip",filters:[{data:""}],filterRender:{name:"VxeInput"}},{field:"tunnelServiceId",title:"服务ID",width:200,showOverflow:"tooltip",filters:[{data:""}],filterRender:{name:"VxeInput"}},{field:"serviceName",title:"服务名称",width:180,showOverflow:"tooltip",slots:{default:"serviceName"},filters:[{data:""}],filterRender:{name:"VxeInput"}},{field:"serviceType",title:"服务类型",width:100,align:"center",showOverflow:"tooltip"},{field:"localAddress",title:"本地地址",width:200,showOverflow:"tooltip",formatter:({row:r})=>`${r.localAddress}:${r.localPort}`},{field:"remotePort",title:"远程端口",width:100,align:"center",showOverflow:"tooltip",formatter:({cellValue:r})=>r||"-"},{field:"serviceStatus",title:"服务状态",width:100,align:"center",formatter:({cellValue:r})=>r?{active:"活跃",inactive:"未活跃",error:"错误"}[r]||r:"-"},{field:"connectionCount",title:"连接数",width:100,align:"center",formatter:({cellValue:r})=>r||0},{field:"totalConnections",title:"总连接数",width:120,align:"center",formatter:({cellValue:r})=>r||0},{field:"registeredTime",title:"注册时间",width:160,showOverflow:!0,formatter:({cellValue:r})=>r?Y(r,"YYYY-MM-DD HH:mm:ss"):"-"},{field:"lastActiveTime",title:"最后活动时间",width:160,showOverflow:!0,formatter:({cellValue:r})=>r?Y(r,"YYYY-MM-DD HH:mm:ss"):"-"}],showCheckbox:!1,menuConfig:{enabled:!0,showCopyRow:!0,showCopyCell:!0,customMenus:[{code:"refresh",name:"刷新",prefixIcon:()=>k(x,{size:14},{default:()=>k(W)})}]},height:"100%"},g=async()=>{u.value=!0;try{const r=f.tunnelServerId||"",b=await De(r);if(b.oK)if(b.bizData){const S=JSON.parse(b.bizData);m.value=Array.isArray(S)?S:[]}else m.value=[];else m.value=[]}catch(r){console.error("加载已注册服务列表失败:",r),m.value=[]}finally{u.value=!1}},T=async({code:r})=>{r==="refresh"&&await g()};return B(()=>{g()}),re(()=>f.tunnelServerId,()=>{g()}),c({loadServiceList:g,refresh:g}),(r,b)=>(A(),z("div",Je,[l(t(J),E({ref_key:"gridRef",ref:p,"module-id":"hub0060:regist-service-list",data:m.value,loading:u.value},a,{onMenuClick:T}),{serviceName:d(({row:S})=>[n("span",Be,w(S.serviceName||"-"),1)]),_:1},16,["data","loading"])]))}}),je=R(We,[["__scopeId","data-v-0c8f3898"]]);function Ue(){const s="hub0060",c=y(!1),f=y([]),p=y();return{moduleId:s,loading:c,tunnelServerList:f,pageInfo:p,searchFormConfig:{fields:[{field:"serverName",label:"服务器名称",type:"input",placeholder:"请输入服务器名称",span:6,clearable:!0},{field:"serverStatus",label:"服务器状态",type:"select",placeholder:"请选择状态",span:6,clearable:!0,options:[{label:"全部",value:""},{label:"运行中",value:"running"},{label:"已停止",value:"stopped"},{label:"错误",value:"error"}]},{field:"controlAddress",label:"控制地址",type:"input",placeholder:"请输入控制地址",span:6,clearable:!0},{field:"activeFlag",label:"活动状态",type:"select",placeholder:"请选择状态",span:6,clearable:!0,options:[{label:"全部",value:""},{label:"活动",value:"Y"},{label:"非活动",value:"N"}]}],toolbarButtons:[{key:"add",label:"新增服务器",icon:Ie,type:"primary",tooltip:"新增隧道服务器"},{key:"edit",label:"编辑",icon:ke,tooltip:"编辑选中的服务器"},{key:"delete",label:"删除",icon:Me,type:"error",tooltip:"删除选中的服务器"}],showSearchButton:!0,showResetButton:!0},formTabs:[{key:"basic",label:"基础配置"},{key:"network",label:"网络配置"},{key:"security",label:"安全配置"},{key:"advanced",label:"高级配置"},{key:"other",label:"其他信息"}],formFields:[{field:"serverName",label:"服务器名称",type:"input",placeholder:"请输入服务器名称",span:12,tabKey:"basic",required:!0,primary:!0,props:{maxlength:100,showCount:!0},tips:"隧道路由服务器的唯一标识名称，用于区分不同的服务器实例"},{field:"serverDescription",label:"服务器描述",type:"textarea",placeholder:"请输入服务器描述",span:24,tabKey:"basic",props:{maxlength:500,showCount:!0,rows:3},tips:"服务器的详细描述信息，用于说明服务器的用途、部署位置等"},{field:"controlAddress",label:"控制地址",type:"input",placeholder:"请输入控制地址，如: 0.0.0.0",span:12,tabKey:"basic",required:!0,defaultValue:"0.0.0.0",tips:"控制端口监听的IP地址。0.0.0.0 表示监听所有网络接口，127.0.0.1 表示仅本地访问"},{field:"controlPort",label:"控制端口",type:"number",placeholder:"请输入控制端口",span:12,tabKey:"basic",required:!0,defaultValue:7e3,props:{min:1,max:65535},tips:"接受客户端连接的控制端口。客户端通过此端口与服务器建立控制连接，用于认证、心跳和服务注册"},{field:"dashboardPort",label:"管理面板端口",type:"number",placeholder:"请输入管理面板端口",span:12,tabKey:"basic",defaultValue:7500,props:{min:1,max:65535},tips:"管理面板的访问端口，用于查看服务器状态、连接统计和性能指标"},{field:"vhostHttpPort",label:"HTTP端口",type:"number",placeholder:"虚拟主机HTTP端口",span:12,tabKey:"network",defaultValue:80,props:{min:1,max:65535},tips:"虚拟主机HTTP服务的监听端口。用于处理基于域名的HTTP隧道请求"},{field:"vhostHttpsPort",label:"HTTPS端口",type:"number",placeholder:"虚拟主机HTTPS端口",span:12,tabKey:"network",defaultValue:443,props:{min:1,max:65535},tips:"虚拟主机HTTPS服务的监听端口。用于处理基于域名的HTTPS隧道请求，需要配置TLS证书"},{field:"maxClients",label:"最大客户端数",type:"number",placeholder:"请输入最大客户端数",span:12,tabKey:"network",required:!0,defaultValue:1e3,props:{min:1,max:1e4},tips:"允许同时连接到服务器的最大客户端数量。超过此限制的新连接将被拒绝"},{field:"maxPortsPerClient",label:"每客户端最大端口数",type:"number",placeholder:"请输入每客户端最大端口数",span:12,tabKey:"network",defaultValue:10,props:{min:1,max:1e3},tips:"单个客户端可以使用的最大端口数量。用于限制每个客户端可注册的服务数量"},{field:"allowPorts",label:"允许的端口范围",type:"input",placeholder:"例如: 10000-20000",span:24,tabKey:"network",tips:"格式: 10000-20000 或 10000,20000,30000"},{field:"tokenAuth",label:"Token认证",type:"select",span:12,tabKey:"security",defaultValue:"Y",options:[{label:"启用",value:"Y"},{label:"禁用",value:"N"}],tips:"启用Token认证后，客户端连接时必须提供正确的认证令牌，提高安全性"},{field:"authToken",label:"认证Token",type:"input",placeholder:"请输入认证Token",span:12,tabKey:"security",show:e=>(e==null?void 0:e.tokenAuth)==="Y",props:{type:"password",showPasswordOn:"click"},tips:"客户端连接时使用的认证令牌。如果为空，系统将自动生成一个32位随机字符串"},{field:"tlsEnable",label:"TLS加密",type:"select",span:12,tabKey:"security",defaultValue:"N",options:[{label:"启用",value:"Y"},{label:"禁用",value:"N"}],tips:"启用TLS加密后，客户端与服务器之间的通信将使用TLS协议加密，提高数据传输安全性"},{field:"tlsCertFile",label:"TLS证书文件",type:"input",placeholder:"请输入TLS证书文件路径",span:12,tabKey:"security",show:e=>(e==null?void 0:e.tlsEnable)==="Y",tips:"TLS证书文件的完整路径。证书文件必须是服务器可访问的，通常为 .crt 或 .pem 格式"},{field:"tlsKeyFile",label:"TLS密钥文件",type:"input",placeholder:"请输入TLS密钥文件路径",span:12,tabKey:"security",show:e=>(e==null?void 0:e.tlsEnable)==="Y",tips:"TLS私钥文件的完整路径。密钥文件必须是服务器可访问的，通常为 .key 格式，需要与证书文件匹配"},{field:"heartbeatInterval",label:"心跳间隔(秒)",type:"number",placeholder:"请输入心跳间隔",span:12,tabKey:"advanced",required:!0,defaultValue:30,props:{min:5,max:300},tips:"服务器与客户端之间的心跳检测间隔时间。客户端会定期发送心跳消息以保持连接活跃"},{field:"heartbeatTimeout",label:"心跳超时(秒)",type:"number",placeholder:"请输入心跳超时",span:12,tabKey:"advanced",required:!0,defaultValue:90,props:{min:10,max:600},tips:"心跳检测的超时时间。如果在此时间内未收到客户端心跳，服务器将认为客户端已断开连接"},{field:"logLevel",label:"日志级别",type:"select",placeholder:"请选择日志级别",span:12,tabKey:"advanced",defaultValue:"info",options:[{label:"Debug",value:"debug"},{label:"Info",value:"info"},{label:"Warn",value:"warn"},{label:"Error",value:"error"}],tips:"服务器日志记录的级别。Debug包含最详细的调试信息，Error仅记录错误信息"},{field:"noteText",label:"备注信息",type:"textarea",placeholder:"请输入备注信息",span:24,tabKey:"other",props:{maxlength:500,showCount:!0,rows:4}},{field:"addTime",label:"创建时间",type:"datetime",span:12,disabled:!0,tabKey:"other"},{field:"addWho",label:"创建人",type:"input",span:12,disabled:!0,tabKey:"other"},{field:"editTime",label:"修改时间",type:"datetime",span:12,disabled:!0,tabKey:"other"},{field:"editWho",label:"修改人",type:"input",span:12,disabled:!0,tabKey:"other"},{field:"activeFlag",label:"活动状态",type:"select",span:12,tabKey:"other",defaultValue:"Y",options:[{label:"活动",value:"Y"},{label:"非活动",value:"N"}]}],gridConfig:{columns:[{field:"serverName",title:"服务器名称",width:180,sortable:!0,showOverflow:!0,slots:{default:"serverName"}},{field:"controlAddress",title:"控制地址",width:140,showOverflow:!0,formatter:({row:e})=>`${e.controlAddress}:${e.controlPort}`},{field:"dashboardPort",title:"管理端口",width:90,align:"center",formatter:({cellValue:e})=>e||"-"},{field:"serverStatus",title:"状态",width:90,align:"center",slots:{default:"serverStatus"}},{field:"vhostHttpPort",title:"HTTP端口",width:90,align:"center",formatter:({cellValue:e})=>e||"-"},{field:"vhostHttpsPort",title:"HTTPS端口",width:100,align:"center",formatter:({cellValue:e})=>e||"-"},{field:"maxClients",title:"最大客户端",width:100,align:"center",slots:{default:"maxClients"}},{field:"tokenAuth",title:"Token认证",width:90,align:"center",slots:{default:"tokenAuth"}},{field:"tlsEnable",title:"TLS",width:70,align:"center",slots:{default:"tlsEnable"}},{field:"heartbeatInterval",title:"心跳间隔(秒)",width:110,align:"center",formatter:({cellValue:e})=>e?`${e}s`:"-"},{field:"heartbeatTimeout",title:"心跳超时(秒)",width:110,align:"center",formatter:({cellValue:e})=>e?`${e}s`:"-"},{field:"startTime",title:"启动时间",width:140,sortable:!0,showOverflow:!0,formatter:({cellValue:e})=>e?Y(e,"YYYY-MM-DD HH:mm"):"-"},{field:"addTime",title:"创建时间",width:140,sortable:!0,showOverflow:!0,formatter:({cellValue:e})=>e?Y(e,"YYYY-MM-DD HH:mm"):""},{field:"addWho",title:"创建人",width:100,showOverflow:!0},{field:"activeFlag",title:"活动状态",width:100,align:"center",formatter:({row:e})=>e.activeFlag==="Y"?"活动":"非活动"}],showCheckbox:!0,paginationConfig:{show:!0,pageInfo:p,align:"right"},menuConfig:{enabled:!0,showCopyRow:!0,showCopyCell:!0,customMenus:[{code:"view",name:"查看详情",prefixIcon:"vxe-icon-eye-fill"},{code:"edit",name:"编辑",prefixIcon:"vxe-icon-edit"},{code:"delete",name:"删除",prefixIcon:"vxe-icon-delete"},{code:"start",name:"启动服务器",prefixIcon:()=>k(x,{size:14},{default:()=>k(se)})},{code:"stop",name:"停止服务器",prefixIcon:()=>k(x,{size:14},{default:()=>k(j)})},{code:"restart",name:"重启服务器",prefixIcon:()=>k(x,{size:14},{default:()=>k(W)})}]},height:"100%"},resetPagination:()=>{p.value=void 0},updatePagination:e=>{p.value?Object.assign(p.value,e):p.value=e},setTunnelServerList:e=>{f.value=e},clearTunnelServerList:()=>{f.value=[]},addTunnelServerToList:e=>{f.value.unshift(e)},updateTunnelServerInList:(e,i,C)=>{const O=f.value.findIndex(G=>G.tunnelServerId===e&&G.tenantId===i);O!==-1&&Object.assign(f.value[O],C)},removeTunnelServerFromList:(e,i)=>{const C=f.value.findIndex(O=>O.tunnelServerId===e&&O.tenantId===i);C!==-1&&f.value.splice(C,1)}}}function Qe(s){const c=ae(),f=xe(),p=Ue(),{loading:u,tunnelServerList:m,pageInfo:a,setTunnelServerList:g,updatePagination:T,addTunnelServerToList:r,updateTunnelServerInList:b,removeTunnelServerFromList:S}=p,_=async h=>{var v,o,U;u.value=!0;try{let L=h;!L&&((v=s==null?void 0:s.value)!=null&&v.getFormData)&&(L=s.value.getFormData()||{});const ne=L?Object.fromEntries(Object.entries(L).filter(([,P])=>P!==""&&P!==null&&P!==void 0)):{},Q=ie((o=a.value)==null?void 0:o.pageIndex,(U=a.value)==null?void 0:U.pageSize),le={...ne,pageIndex:Q.pageIndex,pageSize:Q.pageSize},N=await Le(le);if(N.oK){if(N.bizData){const P=JSON.parse(N.bizData),oe=Array.isArray(P)?P:[];g(oe)}if(N.pageQueryData){const P=JSON.parse(N.pageQueryData);T(P)}}else c.error(N.errMsg||"查询隧道服务器列表失败")}catch(L){console.error("加载隧道服务器列表失败:",L),c.error("加载隧道服务器列表失败")}finally{u.value=!1}};return{model:p,loadTunnelServers:_,handleSearch:async h=>{await _(h)},handleReset:async()=>{p.resetPagination(),await _()},handlePageChange:async({currentPage:h,pageSize:v})=>{T({pageIndex:h,pageSize:v}),await _()},handleRefresh:async()=>{await _()},createTunnelServer:async h=>{u.value=!0;try{const v=await $e(h);if(v.oK&&v.state){if(c.success(v.popMsg||"创建隧道服务器成功"),v.bizData){const o=JSON.parse(v.bizData);r(o)}else await _();return!0}else return c.error(v.errMsg||v.popMsg||"创建隧道服务器失败"),!1}catch(v){return console.error("创建隧道服务器失败:",v),c.error("创建隧道服务器失败"),!1}finally{u.value=!1}},updateTunnelServer:async h=>{u.value=!0;try{const v=await Ke({...h,tunnelServerId:h.tunnelServerId});if(v.oK&&v.state){if(c.success(v.popMsg||"更新隧道服务器成功"),v.bizData){const o=JSON.parse(v.bizData);b(o.tunnelServerId,o.tenantId,o)}else b(h.tunnelServerId,h.tenantId,h);return!0}else return c.error(v.errMsg||v.popMsg||"更新隧道服务器失败"),!1}catch(v){return console.error("更新隧道服务器失败:",v),c.error("更新隧道服务器失败"),!1}finally{u.value=!1}},deleteTunnelServer:async h=>{if(!await f.warning({title:"确认删除",subtitle:"此操作不可恢复，请谨慎操作",content:`确定要删除隧道服务器 "${h.serverName}" 吗？`,icon:Oe,headerStyle:"gradient",positiveText:"确定删除",negativeText:"取消",width:500}))return!1;u.value=!0;try{const o=await ze(h.tunnelServerId);return o.oK&&o.state?(c.success(o.popMsg||"删除隧道服务器成功"),S(h.tunnelServerId,h.tenantId),m.value.length===0&&a.value&&a.value.pageIndex>1&&(T({pageIndex:a.value.pageIndex-1}),await _()),!0):(c.error(o.errMsg||o.popMsg||"删除隧道服务器失败"),!1)}catch(o){return console.error("删除隧道服务器失败:",o),c.error("删除隧道服务器失败"),!1}finally{u.value=!1}},startTunnelServer:async h=>{if(!await f.warning({title:"确认启动",subtitle:"启动后将开始监听客户端连接",content:`确定要启动隧道服务器 "${h.serverName}" 吗？`,icon:Pe,headerStyle:"gradient",positiveText:"确定启动",negativeText:"取消",width:500}))return!1;u.value=!0;try{const o=await Re(h.tunnelServerId);return o.oK&&o.state?(c.success(o.popMsg||"启动隧道服务器成功"),await _(),!0):(c.error(o.errMsg||o.popMsg||"启动隧道服务器失败"),!1)}catch(o){return console.error("启动隧道服务器失败:",o),c.error("启动隧道服务器失败"),!1}finally{u.value=!1}},stopTunnelServer:async h=>{if(!await f.warning({title:"确认停止",subtitle:"停止后将断开所有客户端连接",content:`确定要停止隧道服务器 "${h.serverName}" 吗？`,icon:j,headerStyle:"gradient",positiveText:"确定停止",negativeText:"取消",width:500}))return!1;u.value=!0;try{const o=await He(h.tunnelServerId);return o.oK&&o.state?(c.success(o.popMsg||"停止隧道服务器成功"),await _(),!0):(c.error(o.errMsg||o.popMsg||"停止隧道服务器失败"),!1)}catch(o){return console.error("停止隧道服务器失败:",o),c.error("停止隧道服务器失败"),!1}finally{u.value=!1}},restartTunnelServer:async h=>{if(!await f.warning({title:"确认重启",subtitle:"重启将先停止后启动服务器",content:`确定要重启隧道服务器 "${h.serverName}" 吗？`,icon:ye,headerStyle:"gradient",positiveText:"确定重启",negativeText:"取消",width:500}))return!1;u.value=!0;try{const o=await Fe(h.tunnelServerId);return o.oK&&o.state?(c.success(o.popMsg||"重启隧道服务器成功"),await _(),!0):(c.error(o.errMsg||o.popMsg||"重启隧道服务器失败"),!1)}catch(o){return console.error("重启隧道服务器失败:",o),c.error("重启隧道服务器失败"),!1}finally{u.value=!1}},viewTunnelServer:async h=>{try{const v=await Ne(h.tunnelServerId);return v.oK?JSON.parse(v.bizData):(c.error(v.errMsg||"获取隧道服务器详情失败"),null)}catch(v){return console.error("获取隧道服务器详情失败:",v),c.error("获取隧道服务器详情失败"),null}}}}function Xe(s,c){const f=ae(),p=Qe(c),u=y(!1),m=y("create"),a=y(null),g=async e=>{await p.handleSearch(e)},T=()=>{m.value="create",a.value=null,u.value=!0},r=async e=>{const i=await p.viewTunnelServer(e);i&&(m.value="edit",a.value=i,u.value=!0)},b=()=>{u.value=!1,a.value=null},S=e=>{m.value="view",a.value=e,u.value=!0};return{service:p,formDialogVisible:u,formDialogMode:m,currentEditServer:a,openAddDialog:T,openEditDialog:r,openViewDialog:S,handleFormSubmit:async e=>{if(e&&m.value!=="view"){if(m.value==="create")await p.createTunnelServer(e)&&b();else if(m.value==="edit"){if(!a.value)return;const i={...a.value,...e};await p.updateTunnelServer(i)&&b()}}},handleToolbarClick:async(e,i)=>{switch(e){case"add":T();break;case"edit":{if(!(s!=null&&s.value)){f.warning("Grid 引用未设置");return}const C=s.value.getCurrentRecord();if(!C){f.warning("请先点击选择要编辑的隧道服务器");return}await r(C);break}case"delete":{if(!(s!=null&&s.value)){f.warning("Grid 引用未设置");return}const C=s.value.getCurrentRecord();if(!C){f.warning("请先点击选择要删除的隧道服务器");return}await p.deleteTunnelServer(C);break}case"search":{await p.handleSearch(i);break}}},handleMenuClick:async({code:e,row:i})=>{if(i)switch(e){case"view":S(i);break;case"edit":await r(i);break;case"delete":await p.deleteTunnelServer(i);break;case"start":await p.startTunnelServer(i);break;case"stop":await p.stopTunnelServer(i);break;case"restart":await p.restartTunnelServer(i);break}},handleSearch:g}}const Ze={class:"tunnel-server-stats"},et={class:"stat-content"},tt={class:"stat-icon total"},rt={class:"stat-info"},at={class:"stat-value"},st={class:"stat-content"},nt={class:"stat-icon running"},lt={class:"stat-info"},ot={class:"stat-value"},it={class:"stat-content"},ct={class:"stat-icon stopped"},dt={class:"stat-info"},ut={class:"stat-value"},pt={class:"stat-content"},vt={class:"stat-icon error"},ft={class:"stat-info"},mt={class:"stat-value"},ht={class:"card-header"},gt={class:"detail-content"},bt={class:"detail-item"},St={class:"detail-value primary"},yt={class:"detail-progress"},wt={class:"progress-text"},Tt={class:"card-header"},_t={class:"detail-content"},Ct={class:"detail-item"},xt={class:"detail-value success"},It={class:"detail-progress"},kt={class:"progress-text"},Mt=D({__name:"TunnelServerStats",props:{statistics:{}},setup(s){const c=s,f=Z(()=>{const a=c.statistics.totalClients||0;return Math.min(Math.round(a/1e3*100),100)}),p=Z(()=>{const a=c.statistics.totalConnections||0;return Math.min(Math.round(a/5e3*100),100)}),u=m=>m<50?"#52c41a":m<80?"#faad14":"#ff4d4f";return(m,a)=>(A(),z("div",Ze,[l(t(X),{cols:4,"x-gap":8,"y-gap":8,responsive:"screen"},{default:d(()=>[l(t($),null,{default:d(()=>[l(t(K),{class:"stat-card",hoverable:""},{default:d(()=>[n("div",et,[n("div",tt,[l(t(x),{size:"18",component:t(Se)},null,8,["component"])]),n("div",rt,[n("div",at,w(s.statistics.totalServers||1),1),a[0]||(a[0]=n("div",{class:"stat-label"},"总服务器数",-1))])])]),_:1})]),_:1}),l(t($),null,{default:d(()=>[l(t(K),{class:"stat-card",hoverable:""},{default:d(()=>[n("div",st,[n("div",nt,[l(t(x),{size:"18",component:t(se)},null,8,["component"])]),n("div",lt,[n("div",ot,w(s.statistics.runningServers||0),1),a[1]||(a[1]=n("div",{class:"stat-label"},"运行中",-1))])])]),_:1})]),_:1}),l(t($),null,{default:d(()=>[l(t(K),{class:"stat-card",hoverable:""},{default:d(()=>[n("div",it,[n("div",ct,[l(t(x),{size:"18",component:t(j)},null,8,["component"])]),n("div",dt,[n("div",ut,w(s.statistics.stoppedServers||0),1),a[2]||(a[2]=n("div",{class:"stat-label"},"已停止",-1))])])]),_:1})]),_:1}),l(t($),null,{default:d(()=>[l(t(K),{class:"stat-card",hoverable:""},{default:d(()=>[n("div",pt,[n("div",vt,[l(t(x),{size:"18",component:t(we)},null,8,["component"])]),n("div",ft,[n("div",mt,w(s.statistics.errorServers||0),1),a[3]||(a[3]=n("div",{class:"stat-label"},"错误状态",-1))])])]),_:1})]),_:1})]),_:1}),l(t(X),{cols:2,"x-gap":8,"y-gap":8,style:{"margin-top":"8px"},responsive:"screen"},{default:d(()=>[l(t($),null,{default:d(()=>[l(t(K),{class:"detail-card",hoverable:""},{header:d(()=>[n("div",ht,[l(t(x),{size:"16",component:t(Te)},null,8,["component"]),a[4]||(a[4]=n("span",null,"客户端统计",-1))])]),default:d(()=>[n("div",gt,[n("div",bt,[a[5]||(a[5]=n("div",{class:"detail-label"},"总客户端数",-1)),n("div",St,w(s.statistics.totalClients||0),1)]),n("div",yt,[l(t(ee),{type:"line",percentage:f.value,"show-indicator":!1,height:6,color:u(f.value)},null,8,["percentage","color"]),n("div",wt,w(f.value)+"% 使用率 ",1)])])]),_:1})]),_:1}),l(t($),null,{default:d(()=>[l(t(K),{class:"detail-card",hoverable:""},{header:d(()=>[n("div",Tt,[l(t(x),{size:"16",component:t(Ce)},null,8,["component"]),a[6]||(a[6]=n("span",null,"连接统计",-1))])]),default:d(()=>[n("div",_t,[n("div",Ct,[a[7]||(a[7]=n("div",{class:"detail-label"},"总连接数",-1)),n("div",xt,w(s.statistics.totalConnections||0),1)]),n("div",It,[l(t(ee),{type:"line",percentage:p.value,"show-indicator":!1,height:6,color:u(p.value)},null,8,["percentage","color"]),n("div",kt,w(p.value)+"% 负载 ",1)])])]),_:1})]),_:1})]),_:1})]))}}),Pt=R(Mt,[["__scopeId","data-v-4983a7ed"]]),Ot={class:"bottom-section"},Lt={key:0,class:"stats-section"},Nt={class:"grid-section"},$t={class:"text-primary font-bold"},te="hub0060",Kt=D({name:"TunnelServerList",__name:"TunnelServerList",setup(s){const c=y(),f=y(),p=y(!0),u=y({totalServers:0,runningServers:0,stoppedServers:0,errorServers:0,totalClients:0,totalConnections:0}),m=async()=>{try{const M=await Ae();if(fe(M)){const e=me(M,{totalServers:0,runningServers:0,stoppedServers:0,errorServers:0,totalClients:0,totalConnections:0});u.value=e}}catch(M){console.error("获取统计信息失败:",M)}},{service:a,formDialogVisible:g,formDialogMode:T,currentEditServer:r,handleFormSubmit:b,handleToolbarClick:S,handleMenuClick:_,handleSearch:H}=Xe(f,c);return B(()=>{p.value&&m()}),(M,e)=>(A(),z("div",{class:"tunnel-server-management",id:te},[l(t(be),{direction:"vertical","default-size":"80px"},{1:d(()=>[l(ce,E({ref_key:"searchFormRef",ref:c,"module-id":t(a).model.moduleId},t(a).model.searchFormConfig,{onSearch:t(H),onToolbarClick:t(S)}),null,16,["module-id","onSearch","onToolbarClick"])]),2:d(()=>[n("div",Ot,[p.value?(A(),z("div",Lt,[l(Pt,{statistics:u.value},null,8,["statistics"])])):ue("",!0),n("div",Nt,[l(t(J),E({ref_key:"gridRef",ref:f,"module-id":t(a).model.moduleId,data:t(a).model.tunnelServerList,loading:t(a).model.loading},t(a).model.gridConfig,{onPageChange:t(a).handlePageChange,onMenuClick:t(_)}),{serverName:d(({row:i})=>[n("span",{class:pe(i.serverStatus==="running"?"text-success font-bold":"text-default")},w(i.serverName),3)]),maxClients:d(({row:i})=>[n("span",$t,w(i.maxClients||"-"),1)]),tokenAuth:d(({row:i})=>[l(t(F),{type:i.tokenAuth==="Y"?"success":"default",size:"small"},{icon:d(()=>[l(t(x),null,{default:d(()=>[l(t(_e))]),_:1})]),default:d(()=>[V(" "+w(i.tokenAuth==="Y"?"启用":"禁用"),1)]),_:2},1032,["type"])]),tlsEnable:d(({row:i})=>[l(t(F),{type:i.tlsEnable==="Y"?"success":"default",size:"small"},{default:d(()=>[V(w(i.tlsEnable==="Y"?"启用":"禁用"),1)]),_:2},1032,["type"])]),serverStatus:d(({row:i})=>[l(t(F),{type:i.serverStatus==="running"?"success":i.serverStatus==="stopped"?"warning":i.serverStatus==="error"?"error":"default",size:"small"},{default:d(()=>[V(w(i.serverStatus==="running"?"运行中":i.serverStatus==="stopped"?"已停止":i.serverStatus==="error"?"错误":"未知"),1)]),_:2},1032,["type"])]),_:1},16,["module-id","data","loading","onPageChange","onMenuClick"])])])]),_:1}),l(ge,{visible:t(g),"onUpdate:visible":e[0]||(e[0]=i=>ve(g)?g.value=i:null),mode:t(T),title:t(T)==="create"?"新增隧道服务器":t(T)==="edit"?"编辑隧道服务器":"查看隧道服务器详情",to:`#${te}`,"form-fields":t(a).model.formFields,"form-tabs":t(a).model.formTabs,"initial-data":t(r)||void 0,"auto-close-on-confirm":!1,"confirm-loading":t(a).model.loading.value,onSubmit:t(b)},null,8,["visible","mode","title","to","form-fields","form-tabs","initial-data","confirm-loading","onSubmit"])]))}}),zt=R(Kt,[["__scopeId","data-v-006ccbfe"]]),At="hub0060",Yt=D({name:"TunnelServerManagement",__name:"TunnelServerManagement",setup(s){const c=y("");return(f,p)=>(A(),z("div",{class:"tunnel-management",id:At},[l(t(he),{type:"line",placement:"left",class:"management-tabs"},{default:d(()=>[l(t(q),{name:"server",tab:"隧道服务器管理"},{default:d(()=>[l(t(zt))]),_:1}),l(t(q),{name:"clients",tab:"客户端注册列表"},{default:d(()=>[l(t(qe),{"tunnel-server-id":c.value||""},null,8,["tunnel-server-id"])]),_:1}),l(t(q),{name:"services",tab:"服务注册列表"},{default:d(()=>[l(t(je),{"tunnel-server-id":c.value||""},null,8,["tunnel-server-id"])]),_:1})]),_:1})]))}}),gr=R(Yt,[["__scopeId","data-v-8f5135c9"]]);export{gr as default};
