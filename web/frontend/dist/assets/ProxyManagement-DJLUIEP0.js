import{G as be}from"./GPane-BTUOh7ra.js";import{G as me}from"./GDataFormModal-jCrkrfPz.js";import{g as $e,c as Fe,G as Te,S as we}from"./SearchForm-DCaazdSn.js";import{G as Ue}from"./GTree-nBH05AaI.js";import{af as We,T as ee,j as ae,r as M,i as Z,m as Q,z as B,A as le,d2 as Ke,a7 as ie,av as ue,B as Y,aO as W,d as oe,q as De,c as te,o as J,f as V,h as Be,b as C,e as r,w as I,J as pe,G as Ge,cq as Le,I as qe,g as de,ab as je,_ as se,aa as re,am as fe,K as U,t as $,cr as ge,cF as Je}from"./index-DFGZIhYV.js";import{A as Se}from"./AddOutline-DgCmJB8N.js";import{S as he}from"./ServerOutline-DBS9lrKv.js";import{R as Ve}from"./RefreshOutline-Bblwr7zk.js";import{G as He}from"./GModal-BU-dfYjc.js";import"./GPagination.vue_vue_type_style_index_0_scoped_2c35df38_lang-DHrAwNdU.js";import{u as Ae}from"./useGDialog-Drbk1sbt.js";import{C as Xe}from"./CreateOutline-BRBQ9kgF.js";import{T as Ye}from"./TrashOutline-DQN-WA1t.js";import{W as ve}from"./WarningOutline-CMATMreo.js";import{u as Ze,g as Qe}from"./useServiceService-DLTmywRX.js";import{C as et}from"./CloseOutline-DXK2Avno.js";import{S as A,L as R}from"./types-BgPBDzuW.js";import"./index-DURQnJ_r.js";import"./Select-BxZMQlCt.js";import"./DownloadOutline-DDFeFH05.js";import"./Upload-B0GKjiF_.js";import"./download-C2161hUv.js";import"./DocumentOutline-B9-kJVq4.js";import"./CopyOutline-r53JwZwj.js";import"./Checkbox-LOr_BUn-.js";import"./ContractOutline-BOuVM6SO.js";import"./GDialog-CJ7WdD4F.js";const q=We("/gateway/hub0022");async function tt(o){return q.post("/queryAllGatewayInstances",o)}async function at(o){return q.post("/getProxyConfigsByInstance",{gatewayInstanceId:o})}async function rt(o){return q.post("/addProxyConfig",o)}async function lt(o){return q.post("/editProxyConfig",o)}async function it(o){return q.post("/queryServiceDefinitions",o)}async function _e(o,g){return q.post("/getServiceDefinition",{serviceDefinitionId:o,tenantId:g})}async function ot(o){return q.post("/addServiceDefinition",o)}async function ye(o){return q.post("/editServiceDefinition",o)}async function ke(o,g){return q.post("/deleteServiceDefinition",{serviceDefinitionId:o,tenantId:g})}async function st(o){return q.post("/queryServiceNodes",o)}async function Me(o,g){return q.post("/getServiceNode",{serviceNodeId:o,tenantId:g})}async function nt(o){return q.post("/addServiceNode",o)}async function ct(o){return q.post("/editServiceNode",o)}async function dt(o,g){return q.post("/deleteServiceNode",{serviceNodeId:o,tenantId:g})}async function ut(o){return q.post("/batchDeleteServiceNodes",{serviceNodeIds:o,tenantId:"default"})}var _=(o=>(o.HTTP="http",o.WEBSOCKET="websocket",o.TCP="tcp",o.UDP="udp",o))(_||{});function pt(){const o="hub0022",g=M(!1),i=M([]),h=M(1),c=M(20),l=M(0),m=M(""),u=ae(()=>i.value.map(e=>({key:e.gatewayInstanceId,label:S(e),instance:e})));function S(e){const s=e.tlsEnabled==="Y"?e.httpsPort:e.httpPort;return`${e.instanceName||"未命名"} (${e.bindAddress||"-"}:${s||"-"})`}function O(e){i.value=e}function P(e){g.value=e}function K(e){h.value=e}function H(e){c.value=e}function D(e){m.value=e}function t(e){l.value=e}function a(){h.value=1}function d(){m.value=""}const E={enabled:!0,showCopyNode:!0,customMenus:[{code:"addProxy",name:"代理配置",prefixIcon:()=>ee(Z,{size:14},{default:()=>ee(Se)})}]},n={tabs:[{key:"basic",label:"基本信息"},{key:"http",label:"HTTP配置",show:e=>e.proxyType===_.HTTP},{key:"websocket",label:"WebSocket配置",show:e=>e.proxyType===_.WEBSOCKET},{key:"tcp",label:"TCP配置",show:e=>e.proxyType===_.TCP},{key:"udp",label:"UDP配置",show:e=>e.proxyType===_.UDP},{key:"custom",label:"其它"}],fields:[{field:"proxyConfigId",label:"代理配置ID",type:"input",span:12,tabKey:"basic",primary:!0,show:!1},{field:"gatewayInstanceId",label:"网关实例ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"tenantId",label:"租户ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"proxyName",label:"代理名称",type:"input",placeholder:"请输入代理名称",span:12,tabKey:"basic",required:!0,tips:"代理配置的唯一标识名称，用于区分不同的代理配置",rules:[{required:!0,message:"请输入代理名称",trigger:["blur","input"]},{max:50,message:"代理名称不能超过50个字符",trigger:["blur","input"]}]},{field:"proxyType",label:"代理类型",type:"select",placeholder:"请选择代理类型",span:12,tabKey:"basic",required:!0,defaultValue:_.HTTP,tips:"选择代理协议类型：HTTP(支持HTTP/HTTPS协议)、WebSocket(支持WebSocket协议)、TCP(支持TCP协议)、UDP(支持UDP协议)",options:[{label:"HTTP",value:_.HTTP},{label:"WebSocket",value:_.WEBSOCKET},{label:"TCP",value:_.TCP},{label:"UDP",value:_.UDP}],rules:[{required:!0,message:"请选择代理类型",trigger:["blur","change"]}]},{field:"configPriority",label:"配置优先级",type:"number",placeholder:"请输入配置优先级",span:12,tabKey:"basic",required:!0,defaultValue:100,tips:"配置优先级，数值越小优先级越高。当存在多个代理配置时，优先级高的配置会优先匹配",props:{min:0,max:999},rules:[{required:!0,message:"请输入优先级",trigger:["blur","change"],validator:(e,s)=>{if(s==null||s==="")return new Error("请输入优先级");const k=Number(s);return isNaN(k)?new Error("优先级必须是数字"):k<0||k>999?new Error("优先级必须是0-999之间的数字"):!0}}]},{field:"activeFlag",label:"状态",type:"switch",span:12,tabKey:"basic",defaultValue:"Y",tips:"代理配置的启用状态。启用后配置才会生效，禁用后代理将不会处理请求",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"noteText",label:"备注",type:"textarea",placeholder:"请输入备注信息",span:24,tabKey:"basic",tips:"代理配置的备注说明，用于记录配置的用途、注意事项等信息",props:{rows:3}},{field:"proxyConfig.httpVersion",label:"HTTP版本",type:"select",placeholder:"请选择HTTP版本",span:12,tabKey:"http",show:e=>e.proxyType===_.HTTP,defaultValue:"1.1",tips:"HTTP协议版本，HTTP/1.0 或 HTTP/1.1。HTTP/1.1 支持连接复用、管道化等特性，性能更好",options:[{label:"HTTP/1.0",value:"1.0"},{label:"HTTP/1.1",value:"1.1"}]},{field:"proxyConfig.connectTimeout",label:"连接超时（秒）",type:"number",placeholder:"请输入连接超时",span:12,tabKey:"http",show:e=>e.proxyType===_.HTTP,defaultValue:30,tips:"建立TCP连接的超时时间，超过此时间未建立连接则请求失败",props:{min:1}},{field:"proxyConfig.keepAlive",label:"保持连接",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===_.HTTP,defaultValue:!0,tips:"是否启用HTTP Keep-Alive连接复用。启用后可以复用TCP连接，提高性能，减少连接建立开销"},{field:"proxyConfig.maxIdleConns",label:"最大空闲连接数",type:"number",placeholder:"请输入最大空闲连接数",span:12,tabKey:"http",show:e=>e.proxyType===_.HTTP,defaultValue:100,tips:"连接池中保持的最大空闲连接数。空闲连接可以被复用，提高性能，但会占用内存资源",props:{min:0}},{field:"proxyConfig.idleConnTimeout",label:"空闲连接超时（秒）",type:"number",placeholder:"请输入空闲连接超时",span:12,tabKey:"http",show:e=>e.proxyType===_.HTTP,required:!0,defaultValue:90,tips:"连接池中空闲连接的最大保持时间，超过此时间的空闲连接会被关闭释放资源",props:{min:1,max:7200},rules:[{required:!0,message:"请输入空闲连接超时时间",trigger:["blur","change"],type:"number",validator:(e,s)=>s==null?new Error("请输入空闲连接超时时间"):s<1?new Error("空闲连接超时时间必须大于0秒"):s>7200?new Error("空闲连接超时时间不能超过7200秒"):!0}]},{field:"proxyConfig.timeout",label:"总超时时间（秒）",type:"number",placeholder:"请输入超时时间",span:12,tabKey:"http",show:e=>e.proxyType===_.HTTP,required:!0,defaultValue:60,tips:"请求的总超时时间（包括连接、发送、读取），超过此时间未完成则请求失败",props:{min:1,max:3600},rules:[{required:!0,message:"请输入超时时间",trigger:["blur","change"],type:"number",validator:(e,s)=>s==null?new Error("请输入超时时间"):s<1?new Error("超时时间必须大于0秒"):s>3600?new Error("超时时间不能超过3600秒"):!0}]},{field:"proxyConfig.sendTimeout",label:"发送超时（秒）",type:"number",placeholder:"请输入发送超时",span:12,tabKey:"http",show:e=>e.proxyType===_.HTTP,defaultValue:60,tips:"发送请求数据的超时时间，超过此时间未发送完成则请求失败",props:{min:1}},{field:"proxyConfig.readTimeout",label:"读取超时（秒）",type:"number",placeholder:"请输入读取超时",span:12,tabKey:"http",show:e=>e.proxyType===_.HTTP,defaultValue:60,tips:"读取响应数据的超时时间，超过此时间未读取完成则请求失败",props:{min:1}},{field:"proxyConfig.retryCount",label:"重试次数",type:"number",placeholder:"请输入重试次数",span:12,tabKey:"http",show:e=>e.proxyType===_.HTTP,defaultValue:0,tips:"请求失败时的自动重试次数。设置为0表示不重试",props:{min:0}},{field:"proxyConfig.retryTimeout",label:"重试超时（秒）",type:"number",placeholder:"请输入重试超时",span:12,tabKey:"http",show:e=>e.proxyType===_.HTTP,required:!0,defaultValue:30,tips:"每次重试的超时时间，如果单次重试超过此时间则重试失败，继续下一次重试",props:{min:1,max:300},rules:[{required:!0,message:"请输入重试超时时间",trigger:["blur","change"],type:"number",validator:(e,s)=>s==null?new Error("请输入重试超时时间"):s<1?new Error("重试超时时间必须大于0秒"):s>300?new Error("重试超时时间不能超过300秒"):!0}]},{field:"proxyConfig.proxyBuffering",label:"代理缓冲",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===_.HTTP,defaultValue:!0,tips:"是否启用代理缓冲。启用后会在代理层缓冲请求和响应，可以优化传输性能"},{field:"proxyConfig.bufferSize",label:"缓冲区大小（字节）",type:"number",placeholder:"请输入缓冲区大小",span:12,tabKey:"http",show:e=>e.proxyType===_.HTTP,defaultValue:4096,tips:"默认缓冲区大小，用于临时存储请求和响应数据",props:{min:0}},{field:"proxyConfig.maxBufferSize",label:"最大缓冲区大小（字节）",type:"number",placeholder:"请输入最大缓冲区大小",span:12,tabKey:"http",show:e=>e.proxyType===_.HTTP,defaultValue:65536,tips:"缓冲区的最大大小限制，防止缓冲区无限增长导致内存溢出",props:{min:0}},{field:"proxyConfig.copyResponseBody",label:"复制响应体",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===_.HTTP,defaultValue:!1,tips:"是否复制完整的响应体到内存。启用后可以多次读取响应，但会占用更多内存"},{field:"proxyConfig.followRedirects",label:"跟随重定向",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===_.HTTP,defaultValue:!1,tips:"是否自动跟随HTTP重定向响应（3xx状态码）。启用后会自动跳转到重定向地址"},{field:"proxyConfig.preserveHost",label:"保留原始Host",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===_.HTTP,defaultValue:!1,tips:"是否保留客户端原始Host请求头。启用后目标服务器会看到原始Host，而不是代理服务器的地址"},{field:"proxyConfig.addXForwardedFor",label:"添加X-Forwarded-For",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===_.HTTP,defaultValue:!0,tips:"是否添加X-Forwarded-For请求头，用于标识客户端的真实IP地址，方便目标服务器获取客户端信息"},{field:"proxyConfig.addXRealIP",label:"添加X-Real-IP",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===_.HTTP,defaultValue:!0,tips:"是否添加X-Real-IP请求头，用于标识客户端的真实IP地址，是X-Forwarded-For的简化版本"},{field:"proxyConfig.addXForwardedProto",label:"添加X-Forwarded-Proto",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===_.HTTP,defaultValue:!0,tips:"是否添加X-Forwarded-Proto请求头，用于标识客户端使用的协议（http或https）"},{field:"proxyConfig.tlsInsecureSkipVerify",label:"跳过TLS证书验证",type:"switch",span:12,tabKey:"http",show:e=>e.proxyType===_.HTTP,defaultValue:!1,tips:"是否跳过TLS证书验证（仅用于测试环境）。生产环境建议关闭以确保安全性"},{field:"proxyConfig.tlsMinVersion",label:"最小TLS版本",type:"select",placeholder:"请选择最小TLS版本",span:12,tabKey:"http",show:e=>e.proxyType===_.HTTP,defaultValue:"1.2",tips:"支持的最小TLS协议版本。低于此版本的连接将被拒绝，建议使用TLS 1.2或更高版本",options:[{label:"TLS 1.0",value:"1.0"},{label:"TLS 1.1",value:"1.1"},{label:"TLS 1.2",value:"1.2"},{label:"TLS 1.3",value:"1.3"}]},{field:"proxyConfig.tlsMaxVersion",label:"最大TLS版本",type:"select",placeholder:"请选择最大TLS版本",span:12,tabKey:"http",show:e=>e.proxyType===_.HTTP,defaultValue:"1.3",tips:"支持的最大TLS协议版本。高于此版本的连接将降级到此版本",options:[{label:"TLS 1.0",value:"1.0"},{label:"TLS 1.1",value:"1.1"},{label:"TLS 1.2",value:"1.2"},{label:"TLS 1.3",value:"1.3"}]},{field:"proxyConfig.tlsServerName",label:"TLS服务器名称",type:"input",placeholder:"请输入TLS服务器名称（可选）",span:12,tabKey:"http",show:e=>e.proxyType===_.HTTP,tips:"TLS SNI（Server Name Indication）服务器名称，用于指定要连接的服务器主机名，通常与证书域名匹配"},{field:"proxyConfig.pingInterval",label:"Ping间隔（秒）",type:"number",placeholder:"请输入Ping间隔",span:12,tabKey:"websocket",show:e=>e.proxyType===_.WEBSOCKET,defaultValue:30,tips:"WebSocket连接心跳检测的Ping消息发送间隔，用于保持连接活跃并检测连接状态",props:{min:1}},{field:"proxyConfig.pongTimeout",label:"Pong超时（秒）",type:"number",placeholder:"请输入Pong超时",span:12,tabKey:"websocket",show:e=>e.proxyType===_.WEBSOCKET,defaultValue:10,tips:"发送Ping消息后等待Pong响应的超时时间，超过此时间未收到Pong则视为连接断开",props:{min:1}},{field:"proxyConfig.maxMessageSize",label:"最大消息大小（字节）",type:"number",placeholder:"请输入最大消息大小",span:12,tabKey:"websocket",show:e=>e.proxyType===_.WEBSOCKET,defaultValue:32768,tips:"WebSocket单条消息的最大大小限制，超过此大小的消息将被拒绝，防止内存溢出",props:{min:0}},{field:"proxyConfig.enableCompression",label:"启用压缩",type:"switch",span:12,tabKey:"websocket",show:e=>e.proxyType===_.WEBSOCKET,defaultValue:!1,tips:"是否启用WebSocket消息压缩（permessage-deflate）。启用后可以减少网络传输量，但会增加CPU开销"},{field:"proxyConfig.connectTimeout",label:"连接超时（秒）",type:"number",placeholder:"请输入连接超时",span:12,tabKey:"tcp",show:e=>e.proxyType===_.TCP,defaultValue:5,tips:"建立TCP连接的超时时间，超过此时间未建立连接则连接失败",props:{min:1}},{field:"proxyConfig.keepAlive",label:"保持连接",type:"switch",span:12,tabKey:"tcp",show:e=>e.proxyType===_.TCP,defaultValue:!0,tips:"是否启用TCP Keep-Alive机制。启用后会定期发送探测包保持TCP连接活跃，及时发现断开的连接"},{field:"proxyConfig.bufferSize",label:"缓冲区大小（字节）",type:"number",placeholder:"请输入缓冲区大小",span:12,tabKey:"udp",show:e=>e.proxyType===_.UDP,defaultValue:4096,tips:"UDP数据包接收缓冲区大小，影响可以接收的最大UDP数据包大小",props:{min:1}},{field:"customConfig",label:"自定义配置",type:"textarea",placeholder:"{}",span:24,tabKey:"custom",tips:"自定义配置项（JSON格式），用于存储额外的配置参数，可根据实际需求扩展使用",props:{rows:5}},{field:"addTime",label:"创建时间",type:"datetime",span:12,tabKey:"custom",disabled:!0},{field:"addWho",label:"创建人",type:"input",span:12,tabKey:"custom",disabled:!0},{field:"editTime",label:"修改时间",type:"datetime",span:12,tabKey:"custom",disabled:!0},{field:"editWho",label:"修改人",type:"input",span:12,tabKey:"custom",disabled:!0}]};return{moduleId:o,loading:g,instanceList:i,currentPage:h,pageSize:c,totalCount:l,filterKeyword:m,treeData:u,treeMenuConfig:E,proxyFormConfig:n,getInstanceLabel:S,setInstanceList:O,setLoading:P,setCurrentPage:K,setPageSize:H,setTotalCount:t,setFilterKeyword:D,resetPage:a,clearFilter:d}}function ft(o){const g=Q(),{loading:i,currentPage:h,pageSize:c,filterKeyword:l,setInstanceList:m,setTotalCount:u,setLoading:S,resetPage:O}=o;async function P(){try{S(!0);const K=await tt({activeFlag:"Y",instanceName:l.value.trim()||void 0,pageIndex:h.value,pageSize:c.value});if(B(K)){const H=le(K,[]);m(Array.isArray(H)?H:[]);try{const D=Ke(K);u(D.totalCount||0)}catch(D){console.warn("解析分页信息失败:",D),u(0)}}else g.error(K.errMsg||"获取网关实例列表失败"),m([]),u(0)}catch(K){console.error("加载网关实例失败:",K),g.error("加载网关实例失败"),m([]),u(0)}finally{S(!1)}}return{loadGatewayInstances:P}}function ht(){const o=Q(),g=pt(),i=ft(g),h=M(!1),c=M("create"),l=M(null),m=M(!1),u=M(""),S=ie(g.filterKeyword,()=>{g.resetPage(),i.loadGatewayInstances()});ue(()=>{S()});const O=p=>{const T=x=>{if(typeof x=="string"&&x)try{return JSON.parse(x)}catch{return x}return x},f={...p},v=T(p.proxyConfig);v&&typeof v=="object"&&!Array.isArray(v)&&(Object.keys(v).forEach(x=>{f[`proxyConfig.${x}`]=v[x]}),delete f.proxyConfig);const w=T(p.customConfig);if(w&&typeof w=="object")try{f.customConfig=JSON.stringify(w,null,2)}catch{f.customConfig="{}"}else f.customConfig="{}";return f},P=p=>{const T={};Object.keys(p).forEach(v=>{v.startsWith("proxyConfig.")||(T[v]=p[v])});const f={};if(Object.keys(p).forEach(v=>{if(v.startsWith("proxyConfig.")){const w=v.replace("proxyConfig.","");f[w]=p[v]}}),Object.keys(f).length>0?T.proxyConfig=JSON.stringify(f):T.proxyConfig="{}",p.customConfig)if(typeof p.customConfig=="string")try{JSON.parse(p.customConfig),T.customConfig=p.customConfig}catch{T.customConfig="{}"}else typeof p.customConfig=="object"?T.customConfig=JSON.stringify(p.customConfig):T.customConfig="{}";else T.customConfig="{}";return T},K=async()=>{const p=u.value;if(p)try{const T=await at(p);if(B(T)){const f=le(T,null);f?(l.value=f,c.value="edit"):(l.value=null,c.value="create")}else l.value=null,c.value="create"}catch{l.value=null,c.value="create"}},H=async p=>{u.value=p.gatewayInstanceId,await K(),h.value=!0},D=()=>{if(c.value==="create")return{gatewayInstanceId:u.value,proxyType:"http",configPriority:100,activeFlag:"Y"};if(l.value)return O(l.value)},t=async p=>{if(!p||c.value==="view")return!1;try{m.value=!0;const f={...P(p),tenantId:"default",gatewayInstanceId:u.value||p.gatewayInstanceId};let v=!1;if(c.value==="create"){const w=await rt(f);B(w)?(o.success(Y(w,"创建代理配置成功")),v=!0):o.error(Y(w,"创建代理配置失败"))}else if(c.value==="edit"&&l.value){const w=await lt({...f,proxyConfigId:l.value.proxyConfigId});B(w)?(o.success(Y(w,"更新代理配置成功")),v=!0):o.error(Y(w,"更新代理配置失败"))}return v&&await K(),v}catch{return o.error("操作失败"),!1}finally{m.value=!1}};function a({option:p}){return p.instance?ee(Z,{size:16,color:"var(--g-primary)",style:{marginRight:"6px",flexShrink:0}},{default:()=>ee(he)}):null}function d({option:p}){return ee("span",{class:"tree-node-label",style:{display:"inline-block",padding:"1px 4px",borderRadius:"4px",transition:"background-color 0.2s"}},p.label)}function E({option:p}){const T=p;return T.instance?ee(W,{type:T.instance.healthStatus==="Y"?"success":"warning",size:"small",style:{marginLeft:"8px",flexShrink:0}},{default:()=>T.instance.healthStatus==="Y"?"健康":"异常"}):null}function n(p,T,f){const v=T;v.instance&&f("select",v.instance.gatewayInstanceId,v.instance)}function e({currentPage:p,pageSize:T}){g.setCurrentPage(p),g.setPageSize(T),i.loadGatewayInstances()}function s(){i.loadGatewayInstances()}async function k({code:p,node:T}){if(!T)return;const f=T;if(!f.instance)return;const v=f.instance;switch(p){case"addProxy":await H(v);break}}return{model:g,service:i,proxyFormDialogVisible:h,proxyFormDialogMode:c,currentEditProxy:l,proxySubmitting:m,getProxyFormInitialData:D,renderNodePrefix:a,renderNodeLabel:d,renderNodeSuffix:E,handleTreeSelect:n,handlePageChange:e,handleRefresh:s,handleMenuClick:k,handleProxyFormSubmit:t}}const vt={class:"gateway-instance-tree"},yt={class:"instance-tree-header"},gt={class:"instance-header"},bt={class:"instance-filter"},mt={class:"instance-tree-container"},Tt={key:0,class:"instance-pagination"},wt=oe({name:"GatewayInstanceTree",__name:"GatewayInstanceTree",props:{parentModuleId:{default:"proxy-management"}},emits:["select"],setup(o,{expose:g,emit:i}){const h=o,c=i,l=ht();return De(()=>{l.service.loadGatewayInstances()}),g({refresh:l.service.loadGatewayInstances,resetPage:l.model.resetPage,clearFilter:l.model.clearFilter}),(m,u)=>(J(),te("div",vt,[V("div",yt,[V("div",gt,[C(r(Z),{size:"20",color:"var(--g-primary)"},{default:I(()=>[C(r(he))]),_:1}),u[3]||(u[3]=V("span",null,"网关实例列表",-1)),u[4]||(u[4]=V("div",{class:"flex-spacer"},null,-1)),C(r(pe),{text:"",size:"small",onClick:r(l).handleRefresh,disabled:r(l).model.loading.value,loading:r(l).model.loading.value},{icon:I(()=>[C(r(Z),{component:r(Ve)},null,8,["component"])]),_:1},8,["onClick","disabled","loading"])]),V("div",bt,[C(r(Ge),{value:r(l).model.filterKeyword.value,"onUpdate:value":u[0]||(u[0]=S=>r(l).model.filterKeyword.value=S),placeholder:"搜索实例名称、地址或端口",clearable:"",size:"small"},{prefix:I(()=>[C(r(Z),{component:r(Le)},null,8,["component"])]),_:1},8,["value"])])]),V("div",mt,[C(r(qe),{show:r(l).model.loading.value},{default:I(()=>[r(l).model.treeData.value.length>0?(J(),de(r(Ue),{key:0,data:r(l).model.treeData.value,"show-icon":!0,"block-line":!0,"node-height":32,"show-line":!0,ellipsis:!0,"ellipsis-line-clamp":1,"ellipsis-tooltip":!0,"module-id":r(l).model.moduleId,"menu-config":r(l).model.treeMenuConfig,"render-prefix":r(l).renderNodePrefix,"render-label":r(l).renderNodeLabel,"render-suffix":r(l).renderNodeSuffix,onSelect:u[1]||(u[1]=(S,O)=>r(l).handleTreeSelect(S,O,c)),onMenuClick:r(l).handleMenuClick},null,8,["data","module-id","menu-config","render-prefix","render-label","render-suffix","onMenuClick"])):(J(),de(r(je),{key:1,description:"暂无可用的网关实例",style:{padding:"40px 0"}},{icon:I(()=>[C(r(Z),{size:"40",color:"var(--g-primary)"},{default:I(()=>[C(r(he))]),_:1})]),_:1}))]),_:1},8,["show"])]),r(l).model.totalCount.value>0?(J(),te("div",Tt,[C(r($e),{"current-page":r(l).model.currentPage.value,"page-size":r(l).model.pageSize.value,total:r(l).model.totalCount.value,layouts:["PrevPage","NextPage"],align:"center",onPageChange:r(l).handlePageChange},null,8,["current-page","page-size","total","onPageChange"])])):Be("",!0),C(me,{visible:r(l).proxyFormDialogVisible.value,"onUpdate:visible":u[2]||(u[2]=S=>r(l).proxyFormDialogVisible.value=S),mode:r(l).proxyFormDialogMode.value,title:r(l).proxyFormDialogMode.value==="create"?"新增代理配置":r(l).proxyFormDialogMode.value==="edit"?"编辑代理配置":"查看代理配置详情",to:`#${h.parentModuleId}`,"form-fields":r(l).model.proxyFormConfig.fields,"form-tabs":r(l).model.proxyFormConfig.tabs,"initial-data":r(l).getProxyFormInitialData(),"auto-close-on-confirm":!1,"confirm-loading":r(l).proxySubmitting.value,onSubmit:r(l).handleProxyFormSubmit},null,8,["visible","mode","title","to","form-fields","form-tabs","initial-data","confirm-loading","onSubmit"])]))}}),St=se(wt,[["__scopeId","data-v-f8fbd456"]]);function Ct(){const o="hub0022:manageNodes",g=M(!1),i=M([]),h=M();return{moduleId:o,loading:g,nodeList:i,pageInfo:h,searchFormConfig:{fields:[{field:"nodeHost",label:"节点主机",type:"input",placeholder:"请输入节点主机地址",span:6,clearable:!0},{field:"healthStatus",label:"健康状态",type:"select",placeholder:"请选择健康状态",span:6,clearable:!0,options:[{label:"全部",value:""},{label:"健康",value:"Y"},{label:"不健康",value:"N"}]},{field:"activeFlag",label:"在线状态",type:"select",placeholder:"请选择在线状态",span:6,clearable:!0,options:[{label:"全部",value:""},{label:"在线",value:"Y"},{label:"离线",value:"N"}]}],toolbarButtons:[{key:"add",label:"新建节点",icon:Se,type:"primary",tooltip:"新建服务节点"},{key:"edit",label:"编辑",icon:Xe,type:"default",tooltip:"编辑选中的服务节点"},{key:"delete",label:"删除",icon:Ye,type:"error",tooltip:"批量删除选中的服务节点"}],showSearchButton:!0,showResetButton:!0},nodeFormConfig:{tabs:[{key:"basic",label:"基本信息"},{key:"metadata",label:"元数据配置"},{key:"other",label:"其他配置"}],fields:[{field:"serviceNodeId",label:"服务节点ID",type:"input",span:12,tabKey:"basic",primary:!0,show:!1},{field:"nodeId",label:"节点ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"serviceDefinitionId",label:"服务定义ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"tenantId",label:"租户ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"nodeProtocol",label:"节点协议",type:"select",placeholder:"请选择协议",span:12,tabKey:"basic",required:!0,defaultValue:"HTTP",props:{onUpdateValue:(t,a)=>{if(a&&a.nodeHost&&a.nodePort!==void 0&&t){const d=t.toLowerCase();a.nodeUrl=`${d}://${a.nodeHost}:${a.nodePort}`}}},options:[{label:"HTTP",value:"HTTP"},{label:"HTTPS",value:"HTTPS"}],rules:[{required:!0,message:"请选择节点协议",trigger:["blur","change"]}]},{field:"nodeHost",label:"节点主机",type:"input",placeholder:"请输入主机地址",span:12,tabKey:"basic",required:!0,props:{onUpdateValue:(t,a)=>{if(a&&t&&a.nodePort!==void 0&&a.nodeProtocol){const d=a.nodeProtocol.toLowerCase();a.nodeUrl=`${d}://${t}:${a.nodePort}`}}},rules:[{required:!0,message:"请输入节点主机地址",trigger:["blur","input"]},{pattern:/^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$|^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])$/,message:"请输入有效的IP地址或域名",trigger:["blur","input"]}]},{field:"nodePort",label:"节点端口",type:"number",placeholder:"请输入端口",span:12,tabKey:"basic",required:!0,props:{min:1,max:65535,onUpdateValue:(t,a)=>{if(a&&a.nodeHost&&t!==void 0&&a.nodeProtocol){const d=a.nodeProtocol.toLowerCase();a.nodeUrl=`${d}://${a.nodeHost}:${t}`}}},rules:[{required:!0,type:"number",message:"请输入节点端口",trigger:["blur","change"]}]},{field:"nodeWeight",label:"节点权重",type:"number",placeholder:"权重值",span:12,tabKey:"basic",required:!0,defaultValue:100,props:{min:1,max:1e3},rules:[{required:!0,type:"number",message:"请输入节点权重",trigger:["blur","change"]}]},{field:"nodeUrl",label:"节点URL",type:"input",placeholder:"输入完整URL或由上方字段自动生成",span:24,tabKey:"basic",required:!0,tips:"支持直接输入完整URL(如 https://www.example.com)，将自动解析为协议、主机和端口",props:{onUpdateValue:(t,a)=>{if(a&&t&&(t.startsWith("http://")||t.startsWith("https://")))try{const d=new URL(t);a.nodeProtocol=d.protocol==="https:"?"HTTPS":"HTTP",a.nodeHost=d.hostname,d.port?a.nodePort=parseInt(d.port,10):a.nodePort=d.protocol==="https:"?443:80}catch(d){console.warn("URL解析失败:",d)}}},rules:[{required:!0,message:"请输入节点URL",trigger:["blur","input"]},{validator:(t,a)=>{if(a&&(a.startsWith("http://")||a.startsWith("https://")))try{return new URL(a),!0}catch{return new Error("请输入有效的URL格式")}return!0},trigger:["blur","input"]}]},{field:"healthStatus",label:"健康状态",type:"switch",span:12,tabKey:"basic",defaultValue:"Y",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"activeFlag",label:"在线状态",type:"switch",span:12,tabKey:"basic",defaultValue:"Y",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"noteText",label:"备注信息",type:"textarea",placeholder:"请输入备注信息",span:24,tabKey:"basic",props:{rows:4}},{field:"nodeMetadata",label:"节点元数据",type:"textarea",placeholder:"{}",span:24,tabKey:"metadata",props:{rows:8},rules:[{validator:(t,a)=>{if(a&&typeof a=="string"&&a.trim())try{return JSON.parse(a),!0}catch{return new Error("请输入有效的JSON格式")}return!0},trigger:["blur"]}]},{field:"addTime",label:"创建时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"addWho",label:"创建人",type:"input",span:12,tabKey:"other",disabled:!0},{field:"editTime",label:"修改时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"editWho",label:"修改人",type:"input",span:12,tabKey:"other",disabled:!0}]},gridConfig:{columns:[{field:"serviceNodeId",title:"服务节点ID",visible:!1},{field:"tenantId",title:"租户ID",visible:!1},{field:"serviceDefinitionId",title:"服务定义ID",visible:!1},{field:"nodeId",title:"节点ID",sortable:!0,align:"center",showOverflow:!0,width:150},{field:"nodeUrl",title:"节点地址",sortable:!0,align:"left",showOverflow:!0,width:250},{field:"nodeHost",title:"节点主机",sortable:!0,align:"center",showOverflow:!0,width:150},{field:"nodePort",title:"节点端口",sortable:!0,align:"center",width:100},{field:"nodeProtocol",title:"协议",align:"center",width:80,slots:{default:"nodeProtocol"}},{field:"nodeWeight",title:"权重",align:"center",width:80},{field:"healthStatus",title:"健康状态",align:"center",width:100,slots:{default:"healthStatus"}},{field:"activeFlag",title:"在线状态",align:"center",width:100,slots:{default:"activeFlag"}},{field:"lastHealthCheckTime",title:"最后检查时间",align:"center",showOverflow:!0,formatter:({cellValue:t})=>t?re(t,"YYYY-MM-DD HH:mm:ss"):"-",width:180},{field:"noteText",title:"备注",align:"left",showOverflow:!0,width:150},{field:"addTime",title:"创建时间",sortable:!0,align:"center",showOverflow:!0,formatter:({cellValue:t})=>t?re(t,"YYYY-MM-DD HH:mm:ss"):"",width:180},{field:"addWho",title:"创建人",align:"center",showOverflow:!0,width:120},{field:"editTime",title:"修改时间",sortable:!0,align:"center",showOverflow:!0,formatter:({cellValue:t})=>t?re(t,"YYYY-MM-DD HH:mm:ss"):"",width:180},{field:"editWho",title:"修改人",align:"center",showOverflow:!0,width:120}],showCheckbox:!0,paginationConfig:{show:!0,pageInfo:h,align:"right"},menuConfig:{enabled:!0,showCopyRow:!0,showCopyCell:!0,customMenus:[{code:"edit",name:"编辑",prefixIcon:"vxe-icon-edit"},{code:"delete",name:"删除",prefixIcon:"vxe-icon-delete"}]},height:"100%",rowId:"serviceNodeId"},resetPagination:()=>{h.value=void 0},updatePagination:t=>{h.value?Object.assign(h.value,t):h.value=t},setNodeList:t=>{i.value=t},addNodeToList:t=>{i.value.push(t)},updateNodeInList:t=>{const a=i.value.findIndex(d=>d.serviceNodeId===t.serviceNodeId);a>=0&&(i.value[a]=t)},removeNodeFromList:t=>{const a=i.value.findIndex(d=>d.serviceNodeId===t);a>=0&&i.value.splice(a,1)},removeNodesFromList:t=>{i.value=i.value.filter(a=>!t.includes(a.serviceNodeId))}}}var ze=(o=>(o[o.OFFLINE=0]="OFFLINE",o[o.ONLINE=1]="ONLINE",o[o.MAINTENANCE=2]="MAINTENANCE",o))(ze||{});function It(o,g){const i=Q(),h=Ae(),c=Ct(),{loading:l,nodeList:m,pageInfo:u,setNodeList:S,updatePagination:O,addNodeToList:P,updateNodeInList:K,removeNodeFromList:H,removeNodesFromList:D}=c,t=async T=>{var f,v,w;l.value=!0;try{let x=T;!x&&((f=g==null?void 0:g.value)!=null&&f.getFormData)&&(x=g.value.getFormData()||{});const G=x?Object.fromEntries(Object.entries(x).filter(([,b])=>b!==""&&b!==null&&b!==void 0)):{},j=(o==null?void 0:o.value)||G.serviceDefinitionId;if(!j){i.error("serviceDefinitionId不能为空");return}const y={serviceDefinitionId:j,...G,...Fe((v=u.value)==null?void 0:v.pageIndex,(w=u.value)==null?void 0:w.pageSize)},N=await st(y);if(B(N)){const b=le(N,[]);S(Array.isArray(b)?b:[]);const L=Ke(N);L&&Object.keys(L).length>0&&O(L)}else i.error(Y(N,"查询服务节点列表失败"))}catch{i.error("加载服务节点列表失败")}finally{l.value=!1}};return{model:c,loadNodeList:t,handleSearch:async T=>{c.resetPagination(),await t(T)},handleReset:async()=>{c.resetPagination(),await t()},handlePageChange:async({currentPage:T,pageSize:f})=>{O({pageIndex:T,pageSize:f}),await t()},handleRefresh:async()=>{await t()},addNode:async T=>{l.value=!0;try{const f=await nt(T);return B(f)?(i.success(Y(f,"新增服务节点成功")),await t(),!0):(i.error(Y(f,"新增服务节点失败")),!1)}catch{return i.error("新增服务节点失败"),!1}finally{l.value=!1}},editNode:async T=>{l.value=!0;try{const f=await ct(T);return B(f)?(i.success(Y(f,"编辑服务节点成功")),await t(),!0):(i.error(Y(f,"编辑服务节点失败")),!1)}catch{return i.error("编辑服务节点失败"),!1}finally{l.value=!1}},deleteNode:async T=>{const f=m.value.find(w=>w.serviceNodeId===T);if(!f)return i.error("未找到要删除的服务节点"),!1;if(!await h.warning({title:"确认删除",subtitle:"此操作不可恢复，请谨慎操作",content:`确定要删除服务节点 "${f.nodeUrl||f.nodeHost||T}" 吗？`,icon:ve,headerStyle:"gradient",positiveText:"确定删除",negativeText:"取消",width:500}))return!1;l.value=!0;try{const w=await dt(T,"default");return B(w)?(i.success(Y(w,"删除服务节点成功")),H(T),m.value.length===0&&u.value&&u.value.pageIndex>1?(O({pageIndex:u.value.pageIndex-1}),await t()):await t(),!0):(i.error(Y(w,"删除服务节点失败")),!1)}catch{return i.error("删除服务节点失败"),!1}finally{l.value=!1}},batchDeleteNodes:async T=>{if(!await h.warning({title:"确认批量删除",subtitle:"此操作不可恢复，请谨慎操作",content:`确定要删除选中的 ${T.length} 个服务节点吗？`,icon:ve,headerStyle:"gradient",positiveText:"确定删除",negativeText:"取消",width:500}))return!1;l.value=!0;try{const v=await ut(T);return B(v)?(i.success(Y(v,"批量删除服务节点成功")),D(T),await t(),!0):(i.error(Y(v,"批量删除服务节点失败")),!1)}catch{return i.error("批量删除服务节点失败"),!1}finally{l.value=!1}}}}function xt(o,g,i){const h=Q(),c=It(g,i),l=M(!1),m=M("create"),u=M(null),S=e=>{const s=p=>{if(typeof p=="string"&&p)try{return JSON.parse(p)}catch{return p}return p},k={...e};if(e.nodeMetadata){const p=s(e.nodeMetadata);if(p&&typeof p=="object")try{k.nodeMetadata=JSON.stringify(p,null,2)}catch{k.nodeMetadata="{}"}else k.nodeMetadata=e.nodeMetadata||"{}"}else k.nodeMetadata="{}";return k},O=e=>{const s={...e};if(e.nodeMetadata)if(typeof e.nodeMetadata=="string")try{JSON.parse(e.nodeMetadata),s.nodeMetadata=e.nodeMetadata}catch{s.nodeMetadata="{}"}else typeof e.nodeMetadata=="object"?s.nodeMetadata=JSON.stringify(e.nodeMetadata):s.nodeMetadata="{}";else s.nodeMetadata="{}";return e.nodePort!==void 0&&(s.nodePort=Number(e.nodePort)),e.nodeWeight!==void 0&&(s.nodeWeight=Number(e.nodeWeight)),e.nodeStatus!==void 0&&(s.nodeStatus=Number(e.nodeStatus)),s},P=()=>{m.value="create",u.value=null,l.value=!0},K=async e=>{if(e.serviceNodeId)try{const s=await Me(e.serviceNodeId,"default");if(B(s)){const k=le(s,null);if(k){m.value="edit",u.value=S(k),l.value=!0;return}}}catch{}m.value="edit",u.value=S(e),l.value=!0},H=async e=>{if(e.serviceNodeId)try{const s=await Me(e.serviceNodeId,"default");if(B(s)){const k=le(s,null);if(k){m.value="view",u.value=S(k),l.value=!0;return}}}catch{}m.value="view",u.value=S(e),l.value=!0},D=()=>{l.value=!1,u.value=null},t=()=>{if(m.value==="create")return{serviceDefinitionId:(g==null?void 0:g.value)||"",nodeUrl:"http://192.168.1.0:8080",nodeHost:"192.168.1.0",nodePort:8080,nodeProtocol:"HTTP",nodeWeight:100,healthStatus:"Y",activeFlag:"Y",nodeStatus:ze.ONLINE,nodeMetadata:"{}",noteText:""};if(u.value)return u.value},a=async e=>{var s;if(!e||m.value==="view")return!1;try{const k=O(e);if(!k.serviceDefinitionId&&(g!=null&&g.value)&&(k.serviceDefinitionId=g.value),!k.serviceDefinitionId)return h.error("服务定义ID不能为空"),!1;let p=!1;return m.value==="create"?p=await c.addNode(k):m.value==="edit"&&((s=u.value)!=null&&s.serviceNodeId)&&(k.serviceNodeId=u.value.serviceNodeId,p=await c.editNode(k)),p&&D(),p}catch{return h.error("操作失败"),!1}},d=async(e,s)=>{var k,p,T,f;switch(e){case"add":P();break;case"edit":{if(!(o!=null&&o.value)){h.warning("Grid 引用未设置");return}const v=(p=(k=o.value).getCurrentRecord)==null?void 0:p.call(k);if(!v){h.warning("请先点击选择要编辑的服务节点");return}await K(v);break}case"delete":{if(!(o!=null&&o.value)){h.warning("Grid 引用未设置");return}const v=(f=(T=o.value).getCurrentRecord)==null?void 0:f.call(T);if(!v){h.warning("请先点击选择要删除的服务节点");return}await c.deleteNode(v.serviceNodeId);break}case"search":{await n(s);break}}},E=async({code:e,row:s})=>{if(s)switch(e){case"edit":await K(s);break;case"delete":await c.deleteNode(s.serviceNodeId);break}},n=async e=>{await c.handleSearch(e)};return{service:c,formDialogVisible:l,formDialogMode:m,currentEditNode:u,getFormInitialData:t,openAddDialog:P,openEditDialog:K,openViewDialog:H,closeFormDialog:D,handleFormSubmit:a,handleToolbarClick:d,handleMenuClick:E,handleSearch:n}}const Nt={class:"service-node-list-modal",id:"hub0022-service-node-list"},Pt=oe({name:"ServiceNodeListModal",__name:"ServiceNodeListModal",props:{visible:{type:Boolean,default:!1},title:{default:"服务节点管理"},width:{default:1200},to:{type:[String,Boolean],default:void 0},serviceDefinitionId:{default:void 0}},emits:["update:visible","close","refresh"],setup(o,{emit:g}){const i=o,h=g,c=M(),l=M(),m=M(i.visible),u=ie(()=>i.visible,s=>{m.value=s}),S=M(i.serviceDefinitionId),O=ie(()=>i.serviceDefinitionId,s=>{S.value=s,m.value&&s&&P.handleRefresh()});ue(()=>{u(),O()});const{service:P,formDialogVisible:K,formDialogMode:H,getFormInitialData:D,handleFormSubmit:t,handleToolbarClick:a,handleMenuClick:d,handleSearch:E}=xt(l,S,c),n=s=>{m.value=s,h("update:visible",s),s?(h("refresh"),S.value&&P.handleRefresh()):h("close")},e=()=>{m.value||(K.value=!1,H.value="create",P.model.nodeList.value=[],P.model.resetPagination())};return(s,k)=>(J(),de(r(He),{visible:m.value,title:i.title||"服务节点管理",width:i.width||1200,to:i.to,"show-footer":!1,"onUpdate:visible":n,onAfterLeave:e},{default:I(()=>[V("div",Nt,[C(r(be),{direction:"vertical","no-resize":!0},{1:I(()=>[C(we,fe({ref_key:"searchFormRef",ref:c,"module-id":r(P).model.moduleId},r(P).model.searchFormConfig,{onSearch:r(E),onToolbarClick:r(a)}),null,16,["module-id","onSearch","onToolbarClick"])]),2:I(()=>[C(r(Te),fe({ref_key:"gridRef",ref:l,"module-id":r(P).model.moduleId,data:r(P).model.nodeList,loading:r(P).model.loading},r(P).model.gridConfig,{onPageChange:r(P).handlePageChange,onMenuClick:r(d)}),{nodeProtocol:I(({row:p})=>[C(r(W),{type:p.nodeProtocol==="HTTPS"?"success":"info",size:"small"},{default:I(()=>[U($(p.nodeProtocol),1)]),_:2},1032,["type"])]),healthStatus:I(({row:p})=>[C(r(W),{type:p.healthStatus==="Y"?"success":"error",size:"small"},{default:I(()=>[U($(p.healthStatus==="Y"?"健康":"不健康"),1)]),_:2},1032,["type"])]),nodeStatus:I(({row:p})=>[C(r(W),{type:p.nodeStatus===1?"success":p.nodeStatus===0?"error":"warning",size:"small"},{default:I(()=>[U($(p.nodeStatus===1?"在线":p.nodeStatus===0?"下线":"维护"),1)]),_:2},1032,["type"])]),activeFlag:I(({row:p})=>[C(r(W),{type:p.activeFlag==="Y"?"success":"default",size:"small"},{default:I(()=>[U($(p.activeFlag==="Y"?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1},16,["module-id","data","loading","onPageChange","onMenuClick"])]),_:1}),C(me,{visible:r(K),"onUpdate:visible":k[0]||(k[0]=p=>ge(K)?K.value=p:null),mode:r(H),title:r(H)==="create"?"新增服务节点":r(H)==="edit"?"编辑服务节点":"查看服务节点详情",to:"#hub0022-service-node-list","form-fields":r(P).model.nodeFormConfig.fields,"form-tabs":r(P).model.nodeFormConfig.tabs,"initial-data":r(D)(),"auto-close-on-confirm":!1,"confirm-loading":r(P).model.loading.value,onSubmit:r(t)},null,8,["visible","mode","title","form-fields","form-tabs","initial-data","confirm-loading","onSubmit"])])]),_:1},8,["visible","title","width","to"]))}}),_t=se(Pt,[["__scopeId","data-v-f9b087ea"]]),kt={class:"service-selector-modal-content"},Mt={class:"search-section"},Ot={class:"grid-section"},Oe="hub0042-selector",Et=oe({__name:"ServiceSelectorModal",props:{visible:{type:Boolean},to:{default:"body"}},emits:["update:visible","select","close"],setup(o,{emit:g}){const i=o,h=g,c=Q(),l=M(),m=M(),u=M(null),S=Ze(l),O={fields:[{field:"serviceName",label:"服务名称",type:"input",placeholder:"请输入服务名称",span:6,clearable:!0},{field:"groupName",label:"分组名称",type:"input",placeholder:"请输入分组名称",span:6,clearable:!0},{field:"namespaceId",label:"命名空间",type:"input",placeholder:"请输入命名空间",span:6,clearable:!0},{field:"activeFlag",label:"状态",type:"select",placeholder:"请选择状态",span:6,clearable:!0,options:[{label:"全部",value:""},{label:"启用",value:"Y"},{label:"禁用",value:"N"}]}]},P={columns:[{type:"radio",width:50,fixed:"left"},{field:"serviceName",title:"服务名称",minWidth:180,sortable:!0},{field:"namespaceId",title:"命名空间",minWidth:120},{field:"groupName",title:"分组",minWidth:120},{field:"serviceType",title:"类型",minWidth:100},{field:"activeFlag",title:"状态",minWidth:80,slots:{default:"activeFlag"}},{field:"addTime",title:"创建时间",minWidth:160,formatter:({cellValue:n})=>re(n)}],rowConfig:{keyField:"serviceName",isHover:!0,isCurrent:!0},radioConfig:{highlight:!0,trigger:"row"},pagerConfig:{enabled:!0,pageSize:10,pageSizes:[10,20,50]}},K=ae({get:()=>i.visible,set:n=>h("update:visible",n)}),H=ie(()=>i.visible,n=>{var e;n?(u.value=null,S.loadServices({tenantId:"default"})):(u.value=null,(e=l.value)!=null&&e.resetForm&&l.value.resetForm())});ue(()=>{H()});function D(){S.handleSearch()}function t(n){S.handlePageChange(n.currentPage,n.pageSize)}function a({row:n}){var e;u.value=n,(e=m.value)!=null&&e.setRadioRow&&m.value.setRadioRow(n)}function d(){var s,k;const e=((k=(s=m.value)==null?void 0:s.getRadioRecord)==null?void 0:k.call(s))||u.value;if(!e){c.warning("请选择一个服务");return}h("select",e),E()}function E(){h("update:visible",!1),h("close")}return(n,e)=>(J(),de(r(He),{visible:K.value,"onUpdate:visible":e[0]||(e[0]=s=>K.value=s),title:"选择注册服务","header-icon":r(Le),width:1200,"mask-closable":!1,"show-fullscreen-toggle":!1,to:o.to,onClose:E,onCancel:E,onConfirm:d,"show-confirm":!0,"show-cancel":!0,"confirm-text":"确认选择","cancel-text":"取消"},{default:I(()=>[V("div",kt,[V("div",Mt,[C(we,{ref_key:"searchFormRef",ref:l,"module-id":Oe,fields:O.fields,"show-search-button":!0,"show-reset-button":!0,onSearch:D},null,8,["fields"])]),V("div",Ot,[C(r(Te),{ref_key:"gridRef",ref:m,"module-id":Oe,data:r(S).model.serviceList,loading:r(S).model.loading,columns:P.columns,height:400,"show-overflow":!0,stripe:!0,border:!0,"row-config":P.rowConfig,"radio-config":P.radioConfig,"pager-config":P.pagerConfig,"page-info":r(S).model.pageInfo,onPageChange:t,onRowClick:a},{activeFlag:I(({row:s})=>[C(r(W),{type:s.activeFlag==="Y"?"success":"default",size:"small"},{default:I(()=>[U($(s.activeFlag==="Y"?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1},8,["data","loading","columns","row-config","radio-config","pager-config","page-info"])])])]),_:1},8,["visible","header-icon","to"]))}}),Ft=se(Et,[["__scopeId","data-v-1b01a4eb"]]),Kt={class:"service-selector"},Dt={key:0,class:"selected-service-card"},Lt={class:"service-info"},Vt={class:"service-header"},Ht={class:"service-avatar"},At={class:"avatar-circle"},Yt={class:"service-main-info"},zt={class:"service-name"},Rt={class:"service-tags"},$t={class:"service-status"},Ut={class:"service-details"},Wt={class:"detail-row"},Bt={class:"detail-item"},Gt={class:"detail-value"},qt={class:"detail-item"},jt={class:"detail-value"},Jt={class:"detail-item"},Xt={class:"service-actions"},Zt={key:1,class:"empty-selector"},Qt=oe({__name:"ServiceSelector",props:{modelValue:{default:null},to:{default:"body"}},emits:["update:modelValue","change"],setup(o,{emit:g}){const i=o,h=g,c=Q(),l=M(!1),m=M(!1),u=M(null),S=ae(()=>{if(!i.modelValue)return null;if(typeof i.modelValue=="string")try{return JSON.parse(i.modelValue)}catch{return null}return i.modelValue}),O=ae(()=>u.value),P=ae(()=>{var n;return((n=S.value)==null?void 0:n.protocolType)||"http"}),K=n=>{if(!n)return"?";const e=n.charAt(0).toUpperCase();return/^[A-Z]$/.test(e)?e:n.charAt(0)},H=async n=>{if(!n||!n.namespaceId||!n.groupName||!n.serviceName){u.value=null;return}try{m.value=!0;const e=await Qe(n.namespaceId,n.groupName,n.serviceName);if(B(e)){const s=le(e,void 0);s?u.value=s:(console.warn("服务数据解析失败"),u.value=null)}else console.warn("获取服务失败:",Y(e,"获取服务失败")),u.value={tenantId:n.tenantId,namespaceId:n.namespaceId,groupName:n.groupName,serviceName:n.serviceName,activeFlag:"Y"}}catch(e){console.error("加载服务失败:",e),u.value=null}finally{m.value=!1}},D=ie(()=>i.modelValue,n=>{if(!n){u.value=null;return}const e=S.value;if(e){const s=u.value;(!s||s.namespaceId!==e.namespaceId||s.groupName!==e.groupName||s.serviceName!==e.serviceName)&&H(e)}},{immediate:!0});ue(()=>{D()});const t=()=>{l.value=!0},a=()=>{l.value=!1},d=()=>{u.value=null,h("update:modelValue",null),h("change",null),c.info("已清除服务选择")},E=n=>{u.value=n;const e={tenantId:n.tenantId||"default",namespaceId:n.namespaceId,groupName:n.groupName||"DEFAULT_GROUP",serviceName:n.serviceName,discoveryType:"servicecenter",protocolType:"http"};h("update:modelValue",e),h("change",e),c.success(`已选择服务：${n.serviceName}`),a()};return(n,e)=>(J(),te("div",Kt,[O.value?(J(),te("div",Dt,[V("div",Lt,[V("div",Vt,[V("div",Ht,[V("div",At,$(K(O.value.serviceName)),1)]),V("div",Yt,[V("div",zt,$(O.value.serviceName),1),V("div",Rt,[C(r(W),{type:"info",size:"small"},{default:I(()=>[U($(O.value.namespaceId),1)]),_:1}),C(r(W),{type:"primary",size:"small"},{default:I(()=>[U($(O.value.groupName),1)]),_:1})])]),V("div",$t,[C(r(W),{type:O.value.activeFlag==="Y"?"success":"error",size:"small"},{default:I(()=>[U($(O.value.activeFlag==="Y"?"启用":"禁用"),1)]),_:1},8,["type"])])]),V("div",Ut,[V("div",Wt,[V("div",Bt,[e[1]||(e[1]=V("span",{class:"detail-label"},"服务类型",-1)),V("span",Gt,$(O.value.serviceType||"internal"),1)]),V("div",qt,[e[2]||(e[2]=V("span",{class:"detail-label"},"节点数",-1)),V("span",jt,$(O.value.nodes?O.value.nodes.length:"0"),1)]),V("div",Jt,[e[3]||(e[3]=V("span",{class:"detail-label"},"协议",-1)),C(r(W),{type:"warning",size:"small"},{default:I(()=>[U($(P.value),1)]),_:1})])])]),V("div",Xt,[C(r(pe),{onClick:t,size:"small",secondary:""},{icon:I(()=>[C(r(Z),null,{default:I(()=>[C(r(Ve))]),_:1})]),default:I(()=>[e[4]||(e[4]=U(" 重新选择 ",-1))]),_:1}),C(r(pe),{onClick:d,size:"small",type:"error",secondary:""},{icon:I(()=>[C(r(Z),null,{default:I(()=>[C(r(et))]),_:1})]),default:I(()=>[e[5]||(e[5]=U(" 清除 ",-1))]),_:1})])])])):(J(),te("div",Zt,[C(r(pe),{onClick:t,dashed:"",block:"",size:"large",class:"select-btn"},{icon:I(()=>[C(r(Z),null,{default:I(()=>[C(r(he))]),_:1})]),default:I(()=>[e[6]||(e[6]=U(" 点击选择注册服务 ",-1))]),_:1})])),C(Ft,{visible:l.value,"onUpdate:visible":e[0]||(e[0]=s=>l.value=s),to:o.to,onSelect:E,onClose:a},null,8,["visible","to"])]))}}),ea=se(Qt,[["__scopeId","data-v-9d297009"]]);function ta(){const o="hub0022",g=M(!1),i=M([]),h=M(),c={fields:[{field:"serviceName",label:"服务名称",type:"input",placeholder:"请输入服务名称",span:6,clearable:!0},{field:"serviceType",label:"服务类型",type:"select",placeholder:"请选择服务类型",span:6,clearable:!0,options:[{label:"静态配置",value:A.STATIC},{label:"服务发现",value:A.DISCOVERY}]},{field:"loadBalanceStrategy",label:"负载均衡策略",type:"select",placeholder:"请选择负载均衡策略",span:6,clearable:!0,options:[{label:"轮询算法",value:R.ROUND_ROBIN},{label:"随机算法",value:R.RANDOM},{label:"IP哈希算法",value:R.IP_HASH},{label:"最少连接算法",value:R.LEAST_CONN},{label:"加权轮询算法",value:R.WEIGHTED_ROUND_ROBIN},{label:"一致性哈希算法",value:R.CONSISTENT_HASH}]},{field:"activeFlag",label:"状态",type:"select",placeholder:"请选择状态",span:6,options:[{label:"全部",value:""},{label:"启用",value:"Y"},{label:"禁用",value:"N"}]}],toolbarButtons:[{key:"add",label:"新增服务",icon:Se,type:"primary",tooltip:"新增服务定义"},{key:"delete",label:"删除",icon:Ye,type:"error",tooltip:"批量删除选中的服务定义"},{key:"manageNodes",label:"节点管理",icon:Je,type:"default",tooltip:"管理服务节点"}],showSearchButton:!0,showResetButton:!0},l={tabs:[{key:"basic",label:"基本信息"},{key:"loadbalance",label:"负载均衡",show:t=>t.serviceType===A.STATIC},{key:"health",label:"健康检查",show:t=>t.serviceType===A.STATIC},{key:"discovery",label:"服务发现",show:t=>t.serviceType===A.DISCOVERY},{key:"other",label:"其他配置"}],fields:[{field:"serviceDefinitionId",label:"服务定义ID",type:"input",span:12,tabKey:"basic",primary:!0,show:!1},{field:"tenantId",label:"租户ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"proxyConfigId",label:"代理配置ID",type:"input",span:12,tabKey:"basic",show:!1},{field:"serviceName",label:"服务名称",type:"input",placeholder:"请输入服务名称",span:12,tabKey:"basic",required:!0,tips:"服务的唯一标识名称，用于区分不同的后端服务，长度2-50个字符",rules:[{required:!0,message:"请输入服务名称",trigger:["blur","input"]},{min:2,max:50,message:"服务名称长度在2-50个字符",trigger:["blur","input"]}]},{field:"serviceType",label:"服务类型",type:"select",placeholder:"请选择服务类型",span:12,tabKey:"basic",required:!0,defaultValue:A.STATIC,tips:"静态配置：手动配置服务节点地址；服务发现：从服务注册中心自动发现服务实例",options:[{label:"静态配置",value:A.STATIC},{label:"服务发现",value:A.DISCOVERY}],rules:[{required:!0,message:"请选择服务类型",trigger:["blur","change"],validator:(t,a)=>a==null||a===""?new Error("请选择服务类型"):typeof a=="number"&&(a===0||a===1)?!0:new Error("请选择有效的服务类型")}]},{field:"serviceDesc",label:"服务描述",type:"textarea",placeholder:"请输入服务描述",span:24,tabKey:"basic",tips:"服务的详细描述信息，用于说明服务的用途和功能",props:{rows:3}},{field:"loadBalanceStrategy",label:"负载均衡策略",type:"select",placeholder:"请选择负载均衡策略",span:12,tabKey:"loadbalance",required:!0,show:t=>t.serviceType===A.STATIC,defaultValue:R.ROUND_ROBIN,tips:"轮询：按顺序依次分发请求；随机：随机选择节点；IP哈希：根据客户端IP哈希选择节点；最少连接：选择连接数最少的节点；加权轮询：根据节点权重轮询；一致性哈希：保证相同请求路由到同一节点",options:[{label:"轮询算法",value:R.ROUND_ROBIN},{label:"随机算法",value:R.RANDOM},{label:"IP哈希算法",value:R.IP_HASH},{label:"最少连接算法",value:R.LEAST_CONN},{label:"加权轮询算法",value:R.WEIGHTED_ROUND_ROBIN},{label:"一致性哈希算法",value:R.CONSISTENT_HASH}],rules:[{required:!0,message:"请选择负载均衡策略",trigger:["blur","change"],validator:(t,a,d)=>d.serviceType===A.STATIC&&(a==null||a==="")?new Error("请选择负载均衡策略"):!0}]},{field:"sessionAffinity",label:"会话亲和性",type:"switch",span:12,tabKey:"loadbalance",show:t=>t.serviceType===A.STATIC,defaultValue:"N",tips:"启用后，同一客户端的请求会尽量路由到同一个后端节点，保证会话状态的一致性",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"stickySession",label:"粘性会话",type:"switch",span:12,tabKey:"loadbalance",show:t=>t.serviceType===A.STATIC,defaultValue:"N",tips:"启用后，通过Cookie等方式强制将同一会话的请求路由到固定的后端节点",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"maxRetries",label:"最大重试次数",type:"number",placeholder:"3",span:12,tabKey:"loadbalance",show:t=>t.serviceType===A.STATIC,defaultValue:3,tips:"当请求失败时，最多重试的次数。范围0-10，0表示不重试",props:{min:0,max:10},rules:[{required:!0,message:"请输入最大重试次数",trigger:["blur","change"],validator:(t,a)=>{if(a==null||a==="")return new Error("请输入最大重试次数");const d=Number(a);return isNaN(d)||d<0||d>10?new Error("重试次数必须在0-10之间"):!0}}]},{field:"retryTimeoutMs",label:"重试超时时间(ms)",type:"number",placeholder:"5000",span:12,tabKey:"loadbalance",show:t=>t.serviceType===A.STATIC,defaultValue:5e3,tips:"每次重试请求的超时时间（毫秒）。范围100-60000ms",props:{min:100,max:6e4},rules:[{required:!0,message:"请输入重试超时时间",trigger:["blur","change"],validator:(t,a)=>{if(a==null||a==="")return new Error("请输入重试超时时间");const d=Number(a);return isNaN(d)||d<100||d>6e4?new Error("超时时间必须在100-60000毫秒之间"):!0}}]},{field:"enableCircuitBreaker",label:"启用熔断器",type:"switch",span:12,tabKey:"loadbalance",show:t=>t.serviceType===A.STATIC,defaultValue:"N",tips:"启用后，当服务节点故障率过高时自动熔断，避免大量请求打到故障节点",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"healthCheckEnabled",label:"启用健康检查",type:"switch",span:24,tabKey:"health",show:t=>t.serviceType===A.STATIC,defaultValue:"N",tips:"启用后，网关会定期检查后端节点的健康状态，自动剔除不健康的节点",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"healthCheckPath",label:"检查路径",type:"input",placeholder:"/health",span:12,tabKey:"health",show:t=>t.serviceType===A.STATIC&&t.healthCheckEnabled==="Y",defaultValue:"/health",tips:"健康检查请求的URL路径，通常是后端服务提供的健康检查接口",rules:[{required:!0,message:"请输入健康检查路径",trigger:["blur","input"],validator:(t,a,d)=>d.healthCheckEnabled==="Y"&&(!a||a.trim()==="")?new Error("请输入健康检查路径"):!0}]},{field:"healthCheckMethod",label:"检查方法",type:"select",placeholder:"请选择检查方法",span:12,tabKey:"health",show:t=>t.serviceType===A.STATIC&&t.healthCheckEnabled==="Y",defaultValue:"GET",tips:"健康检查使用的HTTP方法，通常使用GET或HEAD方法",options:[{label:"GET",value:"GET"},{label:"POST",value:"POST"},{label:"HEAD",value:"HEAD"}],rules:[{required:!0,message:"请选择健康检查方法",trigger:["blur","change"],validator:(t,a,d)=>d.healthCheckEnabled==="Y"&&(!a||a==="")?new Error("请选择健康检查方法"):!0}]},{field:"healthCheckIntervalSeconds",label:"检查间隔(秒)",type:"number",placeholder:"30",span:12,tabKey:"health",show:t=>t.serviceType===A.STATIC&&t.healthCheckEnabled==="Y",defaultValue:30,tips:"两次健康检查之间的时间间隔（秒）。范围1-300秒",props:{min:1,max:300},rules:[{required:!0,message:"请输入检查间隔",trigger:["blur","change"],validator:(t,a,d)=>d.healthCheckEnabled==="Y"&&(a==null||a==="")?new Error("请输入检查间隔"):!0}]},{field:"healthCheckTimeoutMs",label:"检查超时(ms)",type:"number",placeholder:"5000",span:12,tabKey:"health",show:t=>t.serviceType===A.STATIC&&t.healthCheckEnabled==="Y",defaultValue:5e3,tips:"健康检查请求的超时时间（毫秒），超时则视为检查失败。范围100-30000ms",props:{min:100,max:3e4},rules:[{required:!0,message:"请输入检查超时",trigger:["blur","change"],validator:(t,a,d)=>d.healthCheckEnabled==="Y"&&(a==null||a==="")?new Error("请输入检查超时"):!0}]},{field:"healthyThreshold",label:"健康阈值",type:"number",placeholder:"2",span:12,tabKey:"health",show:t=>t.serviceType===A.STATIC&&t.healthCheckEnabled==="Y",defaultValue:2,tips:"连续成功检查次数达到此值时，节点从 unhealthy 转为 healthy。范围1-10",props:{min:1,max:10},rules:[{required:!0,message:"请输入健康阈值",trigger:["blur","change"],validator:(t,a,d)=>d.healthCheckEnabled==="Y"&&(a==null||a==="")?new Error("请输入健康阈值"):!0}]},{field:"unhealthyThreshold",label:"不健康阈值",type:"number",placeholder:"3",span:12,tabKey:"health",show:t=>t.serviceType===A.STATIC&&t.healthCheckEnabled==="Y",defaultValue:3,tips:"连续失败检查次数达到此值时，节点从 healthy 转为 unhealthy。范围1-10",props:{min:1,max:10},rules:[{required:!0,message:"请输入不健康阈值",trigger:["blur","change"],validator:(t,a,d)=>d.healthCheckEnabled==="Y"&&(a==null||a==="")?new Error("请输入不健康阈值"):!0}]},{field:"expectedStatusCodes",label:"期望状态码",type:"input",placeholder:"200,201,204",span:24,tabKey:"health",show:t=>t.serviceType===A.STATIC&&t.healthCheckEnabled==="Y",defaultValue:"200",tips:"健康检查视为成功的HTTP状态码，支持逗号分隔多个值（如：200,201,204）或JSON数组格式",rules:[{required:!0,message:"请输入期望状态码",trigger:["blur","input"],validator:(t,a,d)=>d.healthCheckEnabled==="Y"&&(!a||a.trim()==="")?new Error("请输入期望状态码"):!0}]},{field:"discoveryType",label:"发现类型",type:"select",placeholder:"请选择服务发现类型",span:12,tabKey:"discovery",show:t=>t.serviceType===A.DISCOVERY,disabled:!0,defaultValue:"REGISTRY",tips:"服务发现类型，当前仅支持从服务注册中心发现服务实例",options:[{label:"服务注册",value:"REGISTRY"}]},{field:"protocolType",label:"服务协议",type:"select",placeholder:"请选择服务协议",span:12,tabKey:"discovery",show:t=>t.serviceType===A.DISCOVERY,required:!0,defaultValue:"http",tips:"访问后端服务使用的协议类型",options:[{label:"HTTP",value:"http"},{label:"HTTPS",value:"https"}],rules:[{required:!0,message:"请选择服务协议",trigger:["blur","change"],validator:(t,a,d)=>d.serviceType===A.DISCOVERY&&(!a||a==="")?new Error("请选择服务协议"):!0}]},{field:"serviceMetadata",label:"服务元数据",type:"textarea",placeholder:"{}",span:24,tabKey:"discovery",show:!1,props:{rows:5},tips:"服务元数据，包含从服务注册中心选择的服务信息（JSON格式）"},{field:"serviceSelection",label:"注册服务",type:"custom",span:24,tabKey:"discovery",show:t=>t.serviceType===A.DISCOVERY,tips:"从服务注册中心选择一个可用的服务，选择后会自动填充服务元数据",render:(t,a)=>{var e;const d=((e=a==null?void 0:a.selectedService)==null?void 0:e.value)||null,E=a==null?void 0:a.onServiceChange,n=(a==null?void 0:a.to)||"body";return ee(ea,{modelValue:d,to:n,"onUpdate:modelValue":s=>{E==null||E(s)},onChange:s=>{E==null||E(s)}})}},{field:"discoveryConfig",label:"发现配置",type:"textarea",placeholder:"{}",span:24,tabKey:"discovery",show:!1,props:{rows:5}},{field:"activeFlag",label:"启用状态",type:"switch",span:12,tabKey:"other",defaultValue:"Y",tips:"控制服务定义是否启用，禁用的服务不会被加载到网关",props:{checkedValue:"Y",uncheckedValue:"N"}},{field:"noteText",label:"备注信息",type:"textarea",placeholder:"请输入备注信息",span:24,tabKey:"other",tips:"服务的额外备注信息，用于记录配置说明或其他相关信息",props:{rows:4}},{field:"addTime",label:"创建时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"addWho",label:"创建人",type:"input",span:12,tabKey:"other",disabled:!0},{field:"editTime",label:"修改时间",type:"datetime",span:12,tabKey:"other",disabled:!0},{field:"editWho",label:"修改人",type:"input",span:12,tabKey:"other",disabled:!0}]};return{moduleId:o,loading:g,serviceList:i,pageInfo:h,searchFormConfig:c,serviceFormConfig:l,gridConfig:{columns:[{field:"serviceDefinitionId",title:"服务定义ID",visible:!1,width:0},{field:"serviceName",title:"服务名称",sortable:!0,align:"center",showOverflow:"tooltip",width:200},{field:"serviceDesc",title:"服务描述",align:"center",showOverflow:"tooltip",width:200},{field:"serviceType",title:"服务类型",align:"center",slots:{default:"serviceType"},width:120},{field:"loadBalanceStrategy",title:"负载均衡策略",align:"center",slots:{default:"loadBalanceStrategy"},width:150},{field:"nodeCount",title:"服务节点",align:"center",formatter:()=>"0",width:100},{field:"sessionAffinity",title:"会话亲和性",align:"center",slots:{default:"sessionAffinity"},width:120},{field:"maxRetries",title:"最大重试",align:"center",width:100},{field:"enableCircuitBreaker",title:"熔断器",align:"center",slots:{default:"enableCircuitBreaker"},width:100},{field:"healthCheckEnabled",title:"健康检查",align:"center",slots:{default:"healthCheckEnabled"},width:120},{field:"healthCheckPath",title:"检查路径",align:"center",showOverflow:"tooltip",width:150},{field:"activeFlag",title:"状态",align:"center",slots:{default:"activeFlag"},width:100},{field:"addTime",title:"创建时间",sortable:!0,align:"center",showOverflow:!0,formatter:({cellValue:t})=>t?re(t,"YYYY-MM-DD HH:mm:ss"):"",width:180},{field:"addWho",title:"创建人",align:"center",showOverflow:!0,width:120},{field:"editTime",title:"修改时间",sortable:!0,align:"center",showOverflow:!0,formatter:({cellValue:t})=>t?re(t,"YYYY-MM-DD HH:mm:ss"):"",width:180},{field:"editWho",title:"修改人",align:"center",showOverflow:!0,width:120}],showCheckbox:!0,paginationConfig:{show:!0,pageInfo:h,align:"right"},menuConfig:{enabled:!0,showCopyRow:!0,showCopyCell:!0,customMenus:[{code:"edit",name:"编辑",prefixIcon:"vxe-icon-edit"},{code:"manageNodes",name:"节点管理",prefixIcon:"vxe-icon-setting"},{code:"delete",name:"删除",prefixIcon:"vxe-icon-delete"}]},height:"100%",rowId:"serviceDefinitionId"},resetPagination:()=>{h.value=void 0},updatePagination:t=>{h.value?Object.assign(h.value,t):h.value=t},setServiceList:t=>{i.value=t},addServiceToList:t=>{i.value.push(t)},updateServiceInList:t=>{const a=i.value.findIndex(d=>d.serviceDefinitionId===t.serviceDefinitionId);a>=0&&Object.assign(i.value[a],t)},removeServiceFromList:t=>{const a=i.value.findIndex(d=>d.serviceDefinitionId===t);a>=0&&i.value.splice(a,1)},removeServicesFromList:t=>{i.value=i.value.filter(a=>!t.includes(a.serviceDefinitionId))}}}function aa(o,g){const i=Q(),h=Ae(),c=ta(),{loading:l,serviceList:m,pageInfo:u,setServiceList:S,updatePagination:O,addServiceToList:P,updateServiceInList:K,removeServiceFromList:H,removeServicesFromList:D}=c,t=async f=>{var v,w,x;l.value=!0;try{let G=f;!G&&((v=g==null?void 0:g.value)!=null&&v.getFormData)&&(G=g.value.getFormData()||{});const j=G?Object.fromEntries(Object.entries(G).filter(([,b])=>b!==""&&b!==null&&b!==void 0)):{},y={...j,...j.proxyConfigId===void 0&&o?{proxyConfigId:o}:{},...Fe((w=u.value)==null?void 0:w.pageIndex,(x=u.value)==null?void 0:x.pageSize)},N=await it(y);if(N.oK){if(N.bizData){const b=JSON.parse(N.bizData),L=Array.isArray(b)?b:[];S(L)}if(N.pageQueryData){const b=JSON.parse(N.pageQueryData);O(b)}}else i.error(N.errMsg||"查询服务定义列表失败")}catch{i.error("加载服务定义列表失败")}finally{l.value=!1}};return{model:c,loadServiceList:t,handleSearch:async f=>{await t(f)},handleReset:async()=>{c.resetPagination(),await t()},handlePageChange:async({currentPage:f,pageSize:v})=>{O({pageIndex:f,pageSize:v}),await t()},addService:async f=>{l.value=!0;try{const v=await ot(f);if(B(v)){const w=Y(v,"服务定义创建成功");if(i.success(w),v.bizData){const x=JSON.parse(v.bizData);P(x)}else await t();return!0}else{const w=Y(v,"新增服务定义失败");return i.error(w),!1}}catch{return i.error("新增服务定义失败"),!1}finally{l.value=!1}},editService:async(f,v)=>{l.value=!0;try{const w=await ye({...v,serviceDefinitionId:f});if(B(w)){const x=Y(w,"服务定义更新成功");if(i.success(x),w.bizData){const G=JSON.parse(w.bizData);K(G)}else await t();return!0}else{const x=Y(w,"更新服务定义失败");return i.error(x),!1}}catch{return i.error("更新服务定义失败"),!1}finally{l.value=!1}},deleteService:async f=>{const v=m.value.find(x=>x.serviceDefinitionId===f);if(!v)return i.error("未找到要删除的服务定义"),!1;if(!await h.warning({title:"确认删除",subtitle:"此操作不可恢复，请谨慎操作",content:`确定要删除服务定义 "${v.serviceName||v.serviceDefinitionId}" 吗？`,icon:ve,headerStyle:"gradient",positiveText:"确定删除",negativeText:"取消",width:500}))return!1;l.value=!0;try{const x=await ke(f,"default");return x.oK?(i.success(Y(x,"删除服务定义成功")),H(f),m.value.length===0&&u.value&&u.value.pageIndex>1?(O({pageIndex:u.value.pageIndex-1}),await t()):await t(),!0):(i.error(Y(x,"删除服务定义失败")),!1)}catch{return i.error("删除服务定义失败"),!1}finally{l.value=!1}},batchDeleteServices:async f=>{if(await h.warning({title:"确认批量删除",subtitle:"此操作不可恢复，请谨慎操作",content:`确定要删除选中的 ${f.length} 个服务定义吗？`,icon:ve,headerStyle:"gradient",positiveText:"确定删除",negativeText:"取消",width:500})){l.value=!0;try{let w=0,x=0;for(const G of f)try{(await ke(G,"default")).oK?w++:x++}catch{x++}w>0?(i.success(`成功删除 ${w} 个服务定义${x>0?`，失败 ${x} 个`:""}`),D(f.slice(0,w)),await t()):i.error(`删除失败，共 ${x} 个`)}catch{i.error("批量删除失败")}finally{l.value=!1}}},toggleServiceStatus:async f=>{const v=f.activeFlag==="Y"?"N":"Y",w=v==="Y"?"启用":"禁用";try{const x=await ye({serviceDefinitionId:f.serviceDefinitionId,tenantId:"default",activeFlag:v});x.oK?(i.success(`${w}成功`),K({...f,activeFlag:v}),await t()):i.error(x.errMsg||`${w}失败`)}catch{i.error(`${w}失败`)}},batchToggleServiceStatus:async(f,v)=>{const w=v==="Y"?"启用":"禁用";try{const x=f.map(y=>ye({serviceDefinitionId:y,tenantId:"default",activeFlag:v})),j=(await Promise.all(x)).filter(y=>y.oK).length;j===f.length?i.success(`成功${w} ${j} 个服务定义`):i.warning(`${w}了 ${j}/${f.length} 个服务定义`),await t()}catch{i.error(`批量${w}失败`)}}}}function ra(o,g,i){const h=Q(),c=M(null),l=aa(o,g),m=M(!1),u=M("create"),S=M(null),O=M(!1),P=M(""),K=y=>{const N=F=>{if(typeof F=="string"&&F)try{return JSON.parse(F)}catch{return F}return F},b={...y};if(["discoveryConfig","healthCheckHeaders","loadBalancerConfig"].forEach(F=>{const z=N(y[F]);z&&typeof z=="object"&&!Array.isArray(z)&&(Object.keys(z).forEach(X=>{b[`${F}.${X}`]=z[X]}),delete b[F])}),b.serviceMetadata&&typeof b.serviceMetadata=="string")try{const F=JSON.parse(b.serviceMetadata);F.protocolType&&(b.protocolType=F.protocolType)}catch{}else b.serviceMetadata&&typeof b.serviceMetadata=="object"?(b.serviceMetadata.protocolType&&(b.protocolType=b.serviceMetadata.protocolType),b.serviceMetadata=JSON.stringify(b.serviceMetadata)):b.serviceMetadata=void 0;return b.protocolType||(b.protocolType="http"),b},H=y=>{const N=["discoveryConfig","healthCheckHeaders","loadBalancerConfig"],b={};if(N.forEach(L=>{const F={};Object.keys(y).forEach(z=>{if(z.startsWith(`${L}.`)){const X=z.replace(`${L}.`,"");F[X]=y[z]}}),Object.keys(F).length>0&&(b[L]=JSON.stringify(F))}),y.serviceMetadata)if(typeof y.serviceMetadata=="string")try{JSON.parse(y.serviceMetadata),b.serviceMetadata=y.serviceMetadata}catch{b.serviceMetadata="{}"}else typeof y.serviceMetadata=="object"?b.serviceMetadata=JSON.stringify(y.serviceMetadata):b.serviceMetadata="{}";else b.serviceMetadata=void 0;return Object.keys(y).forEach(L=>{!N.some(F=>L.startsWith(`${F}.`))&&L!=="serviceMetadata"&&(b[L]=y[L])}),b},D=(y=!0)=>o?!0:(y&&h.warning("请先选择网关实例"),!1),t=()=>{D()&&(u.value="create",S.value=null,c.value=null,m.value=!0)},a=async y=>{if(D())try{const N=await _e(y.serviceDefinitionId,"default");if(B(N)){const b=JSON.parse(N.bizData),L=K(b);if(L.serviceType===1&&L.serviceMetadata)try{const F=typeof L.serviceMetadata=="string"?JSON.parse(L.serviceMetadata):L.serviceMetadata;c.value={tenantId:F.tenantId||"default",namespaceId:F.namespaceId,groupName:F.groupName||"DEFAULT_GROUP",serviceName:F.serviceName,discoveryType:"servicecenter",protocolType:F.protocolType||"http"}}catch{c.value=null}else c.value=null;u.value="edit",S.value=L,m.value=!0}else h.error(Y(N,"获取服务定义详情失败"))}catch{h.error("获取服务定义详情失败")}},d=async y=>{if(D())try{const N=await _e(y.serviceDefinitionId,"default");if(B(N)){const b=JSON.parse(N.bizData),F={...K(b),serviceDefinitionId:void 0,serviceName:`${b.serviceName}_copy`,activeFlag:"Y"};if(F.serviceType===1&&F.serviceMetadata)try{const z=typeof F.serviceMetadata=="string"?JSON.parse(F.serviceMetadata):F.serviceMetadata;c.value={tenantId:z.tenantId||"default",namespaceId:z.namespaceId,groupName:z.groupName||"DEFAULT_GROUP",serviceName:z.serviceName,discoveryType:"servicecenter",protocolType:z.protocolType||"http"}}catch{c.value=null}else c.value=null;u.value="create",S.value=F,m.value=!0}else h.error(Y(N,"获取服务定义详情失败"))}catch{h.error("获取服务定义详情失败")}},E=y=>{D()&&(P.value=y.serviceDefinitionId,O.value=!0)},n=()=>{m.value=!1,S.value=null,c.value=null},e=async y=>{if(y&&u.value!=="view"){if(!D())return!1;if(y.serviceType===1){if(c.value)k(y);else if(!y.serviceMetadata)return h.warning("请选择注册服务"),!1}try{const b={...H(y),tenantId:"default",proxyConfigId:o||y.proxyConfigId};let L=!1;u.value==="create"?L=await l.addService(b):u.value==="edit"&&S.value&&(L=await l.editService(S.value.serviceDefinitionId,b)),L&&n()}catch{h.error("操作失败")}}},s=y=>{c.value=y,y?console.log("已选择服务:",y.serviceName):console.log("已清除服务选择")},k=y=>{if(c.value){const N={tenantId:c.value.tenantId||"default",namespaceId:c.value.namespaceId,groupName:c.value.groupName||"DEFAULT_GROUP",serviceName:c.value.serviceName,discoveryType:"servicecenter",protocolType:(y==null?void 0:y.protocolType)||"http"},b=JSON.stringify(N);return y&&(y.serviceMetadata=b),console.log("已更新服务元数据（registry_utils.go 兼容格式）:",N),b}else{y&&(y.serviceMetadata=void 0);return}},p=async y=>{D()&&await l.deleteService(y.serviceDefinitionId)},T=async()=>{var b,L,F,z;if(!D())return;if(!(i!=null&&i.value)){h.warning("Grid 引用未设置");return}const y=((L=(b=i.value).getCheckboxRecords)==null?void 0:L.call(b))||((z=(F=i.value).getSelectRecords)==null?void 0:z.call(F))||[];if(y.length===0){h.warning("请选择要删除的服务定义");return}const N=y.map(X=>X.serviceDefinitionId);await l.batchDeleteServices(N)},f=async y=>{if(!D())return;const N=y?{...y,...o?{proxyConfigId:o}:{}}:o?{proxyConfigId:o}:void 0;await l.handleSearch(N)},v=async(y,N)=>{var b,L,F,z,X,Ce,Ie,xe,Ne,Pe;switch(y){case"add":t();break;case"delete":{if(!(i!=null&&i.value)){h.warning("Grid 引用未设置");return}const ne=((L=(b=i.value).getCheckboxRecords)==null?void 0:L.call(b))||((z=(F=i.value).getSelectRecords)==null?void 0:z.call(F))||[];if(ne.length===0){h.warning("请选择要删除的服务定义");return}const ce=ne.map(Re=>Re.serviceDefinitionId);await l.batchDeleteServices(ce);break}case"manageNodes":{if(!(i!=null&&i.value)){h.warning("Grid 引用未设置");return}const ne=(Ce=(X=i.value).getCurrentRecord)==null?void 0:Ce.call(X);if(ne){E(ne);return}const ce=((xe=(Ie=i.value).getCheckboxRecords)==null?void 0:xe.call(Ie))||((Pe=(Ne=i.value).getSelectRecords)==null?void 0:Pe.call(Ne))||[];if(ce.length===0){h.warning("请先点击选择要管理的服务定义");return}if(ce.length>1){h.warning("请选择单个服务定义进行节点管理");return}E(ce[0]);break}case"search":{await f(N);break}}},w=({code:y,row:N})=>{if(N)switch(y){case"edit":a(N);break;case"manageNodes":E(N);break;case"copy":d(N);break;case"delete":p(N);break}},x=()=>{l.loadServiceList()},G=async()=>{o?await l.loadServiceList({proxyConfigId:o}):await l.loadServiceList()};o&&De(()=>{l.loadServiceList({proxyConfigId:o})});const j=l.model.serviceFormConfig.fields.map(y=>{if(y.field==="serviceSelection"&&y.render){const N=y.render;return{...y,render:b=>N(b,{selectedService:c,onServiceChange:s,to:"#hub0022-service-definition-list"})}}return y});return{service:{...l,model:{...l.model,serviceFormConfig:{...l.model.serviceFormConfig,fields:j}}},formDialogVisible:m,formDialogMode:u,currentEditService:S,showNodeDialog:O,currentServiceId:P,selectedService:c,openAddDialog:t,openEditDialog:a,openCopyDialog:d,openNodeDialog:E,closeFormDialog:n,handleFormSubmit:e,handleDelete:p,handleBatchDelete:T,handleSearch:f,handleToolbarClick:v,handleMenuClick:w,refresh:x,loadServiceList:G,handleServiceChange:s,updateServiceMetadata:k}}const la={class:"service-definition-list",id:"hub0022-service-definition-list"},ia=oe({name:"ServiceDefinitionList",__name:"ServiceDefinitionList",props:{gatewayInstanceId:{default:void 0}},setup(o){const g=o,i=M(),h=M(),{service:c,formDialogVisible:l,formDialogMode:m,currentEditService:u,showNodeDialog:S,currentServiceId:O,handleFormSubmit:P,handleToolbarClick:K,handleMenuClick:H}=ra(g.gatewayInstanceId,i,h),D=ie(()=>g.gatewayInstanceId,(d,E)=>{d&&d!==E?c.loadServiceList({proxyConfigId:d}):!d&&E&&(c.model.serviceList.value=[])},{immediate:!1});ue(()=>{D()});function t(d){if(!g.gatewayInstanceId)return;const E=d?{...d,...g.gatewayInstanceId?{proxyConfigId:g.gatewayInstanceId}:{}}:g.gatewayInstanceId?{proxyConfigId:g.gatewayInstanceId}:void 0;c.handleSearch(E)}function a(d){return{[R.ROUND_ROBIN]:"轮询",[R.RANDOM]:"随机",[R.IP_HASH]:"IP哈希",[R.LEAST_CONN]:"最少连接",[R.WEIGHTED_ROUND_ROBIN]:"加权轮询",[R.CONSISTENT_HASH]:"一致性哈希"}[d]||d}return(d,E)=>(J(),te("div",la,[C(r(be),{direction:"vertical","default-size":"80px"},{1:I(()=>[C(we,fe({ref_key:"searchFormRef",ref:i,"module-id":r(c).model.moduleId},r(c).model.searchFormConfig,{onSearch:t,onToolbarClick:r(K)}),null,16,["module-id","onToolbarClick"])]),2:I(()=>[C(r(Te),fe({ref_key:"gridRef",ref:h,"module-id":r(c).model.moduleId,data:r(c).model.serviceList,loading:r(c).model.loading},r(c).model.gridConfig,{onPageChange:r(c).handlePageChange,onMenuClick:r(H)}),{serviceType:I(({row:n})=>[C(r(W),{type:n.serviceType===0?"info":"success",size:"small"},{default:I(()=>[U($(n.serviceType===0?"静态配置":"服务发现"),1)]),_:2},1032,["type"])]),loadBalanceStrategy:I(({row:n})=>[C(r(W),{type:"default",size:"small"},{default:I(()=>[U($(a(n.loadBalanceStrategy)),1)]),_:2},1024)]),sessionAffinity:I(({row:n})=>[C(r(W),{type:n.sessionAffinity==="Y"?"success":"default",size:"small"},{default:I(()=>[U($(n.sessionAffinity==="Y"?"启用":"未启用"),1)]),_:2},1032,["type"])]),enableCircuitBreaker:I(({row:n})=>[C(r(W),{type:n.enableCircuitBreaker==="Y"?"warning":"default",size:"small"},{default:I(()=>[U($(n.enableCircuitBreaker==="Y"?"启用":"未启用"),1)]),_:2},1032,["type"])]),healthCheckEnabled:I(({row:n})=>[C(r(W),{type:n.healthCheckEnabled==="Y"?"success":"default",size:"small"},{default:I(()=>[U($(n.healthCheckEnabled==="Y"?"已启用":"未启用"),1)]),_:2},1032,["type"])]),activeFlag:I(({row:n})=>[C(r(W),{type:n.activeFlag==="Y"?"success":"error",size:"small"},{default:I(()=>[U($(n.activeFlag==="Y"?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1},16,["module-id","data","loading","onPageChange","onMenuClick"])]),_:1}),C(me,{visible:r(l),"onUpdate:visible":E[0]||(E[0]=n=>ge(l)?l.value=n:null),mode:r(m),title:r(m)==="create"?"新增服务定义":r(m)==="edit"?"编辑服务定义":"查看服务定义详情",to:"#hub0022-service-definition-list","form-fields":r(c).model.serviceFormConfig.fields,"form-tabs":r(c).model.serviceFormConfig.tabs,"initial-data":r(u)||void 0,"auto-close-on-confirm":!1,"confirm-loading":r(c).model.loading.value,onSubmit:r(P)},null,8,["visible","mode","title","form-fields","form-tabs","initial-data","confirm-loading","onSubmit"]),C(r(_t),{visible:r(S),"onUpdate:visible":E[1]||(E[1]=n=>ge(S)?S.value=n:null),"service-definition-id":r(O),title:"服务节点管理",width:1200,to:"#hub0022-service-definition-list"},null,8,["visible","service-definition-id"])]))}}),oa=se(ia,[["__scopeId","data-v-ffee8dd0"]]),sa={class:"left-panel"},Ee="proxy-management",na=oe({name:"ProxyManagement",__name:"ProxyManagement",setup(o){const g=M(""),i=ae(()=>g.value||"");function h(c,l){g.value=c}return(c,l)=>(J(),te("div",{class:"proxy-management",id:Ee},[C(r(be),{direction:"horizontal","default-size":.25,max:.4},{1:I(()=>[V("div",sa,[C(r(St),{"parent-module-id":Ee,onSelect:h})])]),2:I(()=>[(J(),de(oa,{"gateway-instance-id":i.value,key:`service-${i.value}`},null,8,["gateway-instance-id"]))]),_:1})]))}}),La=se(na,[["__scopeId","data-v-adc92ac8"]]);export{La as default};
