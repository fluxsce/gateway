import{a as J,c as oe,b as ie,S as de}from"./SearchForm-B7rqpwYi.js";import{X as ce,d as D,r as y,v as B,P as te,b as z,o as A,e as l,f as e,a4 as E,a2 as k,T as Y,w as u,aG as F,K as V,t as w,g as n,j as I,_ as R,m as re,c as X,S as K,i as ue,n as pe,ci as ve,z as fe,A as me,D as q,L as he}from"./index-jHKRbIks.js";import{R as W}from"./ReloadOutline--ucEW8Z4.js";import{b as Z}from"./GDialog.vue_vue_type_style_index_0_scoped_82fcf09e_lang-ipra4ei3.js";/* empty css                                                                    */import{u as ge,G as be}from"./GDataFormModal-B9PoaKcn.js";import{A as Se,T as ye}from"./TrashOutline-DyDUTVAn.js";import{C as we}from"./CreateOutline-CGY5f7Sz.js";import{P as ae,R as _e}from"./RefreshCircleOutline-BN4a5hIv.js";import{S as j,P as Te}from"./StopCircleOutline-Dq9iXyT9.js";import{W as Ce}from"./WarningOutline-mxXhdHS1.js";import{S as Ie}from"./ServerOutline-KasG8iTq.js";import{A as xe}from"./AlertCircleOutline-B7jS4nfU.js";import{P as ke}from"./PeopleOutline-BqxlEVGY.js";import{L as Me}from"./LinkOutline-yfyqV1Vn.js";import{_ as ee,a as N}from"./Grid-qwIbHEjp.js";import{S as Pe}from"./ShieldCheckmarkOutline-C6bB6CWg.js";import"./index-DR_R-bYe.js";import"./RefreshOutline-BQY32ySA.js";import"./OptionsOutline-CAwLTA62.js";import"./DatePicker-yujoZiwS.js";import"./Select-CGsj-ZtY.js";import"./InputNumber-BwbhDD7_.js";import"./Switch-C69H-VEY.js";import"./download-C2161hUv.js";import"./Scrollbar-Cp6RabE0.js";import"./InformationCircleOutline-DNMSQWXj.js";const x=ce("/gateway/hub0060"),Oe=async s=>x.post("/queryTunnelServers",s),Le=async s=>x.post("/getTunnelServer",{tunnelServerId:s}),$e=async s=>x.post("/createTunnelServer",s),Ke=async s=>x.post("/updateTunnelServer",s),Ne=async s=>x.post("/deleteTunnelServer",{tunnelServerId:s}),ze=async()=>x.post("/getTunnelServerStats",{}),Ae=async s=>x.post("/getRegisteredClients",{tunnelServerId:s}),Ye=async s=>x.post("/getRegisteredServices",{tunnelServerId:s}),De=async s=>x.post("/startTunnelServer",{tunnelServerId:s}),Re=async s=>x.post("/stopTunnelServer",{tunnelServerId:s}),He=async s=>x.post("/restartTunnelServer",{tunnelServerId:s}),Fe={class:"regist-client-list"},Ve={class:"font-bold"},Ee=D({__name:"RegistClientList",props:{tunnelServerId:{default:""}},setup(s,{expose:d}){const m=s,v=y(),p=y(!1),c=y([]),a={columns:[{field:"tunnelServerId",title:"服务器ID",width:180,showOverflow:"tooltip",filters:[{data:""}],filterRender:{name:"VxeInput"}},{field:"tunnelClientId",title:"客户端ID",width:200,showOverflow:"tooltip",filters:[{data:""}],filterRender:{name:"VxeInput"}},{field:"clientName",title:"客户端名称",width:180,showOverflow:"tooltip",slots:{default:"clientName"},filters:[{data:""}],filterRender:{name:"VxeInput"}},{field:"serverAddress",title:"服务器地址",width:200,showOverflow:"tooltip",formatter:({row:r})=>`${r.serverAddress}:${r.serverPort}`,filters:[{data:""}],filterRender:{name:"VxeInput"}},{field:"clientIpAddress",title:"客户端IP",width:150,showOverflow:"tooltip",filters:[{data:""}],filterRender:{name:"VxeInput"}},{field:"clientMacAddress",title:"客户端MAC",width:150,showOverflow:"tooltip"},{field:"clientVersion",title:"客户端版本",width:120,showOverflow:"tooltip"},{field:"operatingSystem",title:"操作系统",width:150,showOverflow:"tooltip"},{field:"connectionStatus",title:"连接状态",width:100,align:"center",formatter:({cellValue:r})=>r?{connected:"已连接",disconnected:"已断开",connecting:"连接中",error:"错误"}[r]||r:"-"},{field:"serviceCount",title:"服务数量",width:100,align:"center",slots:{default:"serviceCount"}},{field:"authenticated",title:"认证状态",width:100,align:"center",formatter:({cellValue:r})=>r?"已认证":"未认证"},{field:"lastHeartbeat",title:"最后心跳",width:160,showOverflow:!0,formatter:({cellValue:r})=>r?Y(r,"YYYY-MM-DD HH:mm:ss"):"-"}],showCheckbox:!1,menuConfig:{enabled:!0,showCopyRow:!0,showCopyCell:!0,customMenus:[{code:"refresh",name:"刷新",prefixIcon:()=>k(I,{size:14},{default:()=>k(W)})}]},height:"100%"},g=async()=>{p.value=!0;try{const r=m.tunnelServerId||"",b=await Ae(r);if(b.oK)if(b.bizData){const S=JSON.parse(b.bizData);c.value=Array.isArray(S)?S:[]}else c.value=[];else c.value=[]}catch(r){console.error("加载已注册客户端列表失败:",r),c.value=[]}finally{p.value=!1}},_=async({code:r})=>{r==="refresh"&&await g()};return B(()=>{g()}),te(()=>m.tunnelServerId,()=>{g()}),d({loadClientList:g,refresh:g}),(r,b)=>(A(),z("div",Fe,[l(e(J),E({ref_key:"gridRef",ref:v,"module-id":"hub0060:regist-client-list",data:c.value,loading:p.value},a,{onMenuClick:_}),{clientName:u(({row:S})=>[n("span",Ve,w(S.clientName||"-"),1)]),serviceCount:u(({row:S})=>[l(e(F),{type:"info",size:"small"},{default:u(()=>[V(w(S.serviceCount||0),1)]),_:2},1024)]),_:1},16,["data","loading"])]))}}),Ge=R(Ee,[["__scopeId","data-v-91b75cba"]]),qe={class:"regist-service-list"},Je={class:"font-bold"},Be=D({__name:"RegistServiceList",props:{tunnelServerId:{default:""}},setup(s,{expose:d}){const m=s,v=y(),p=y(!1),c=y([]),a={columns:[{field:"tunnelServerId",title:"服务器ID",width:180,showOverflow:"tooltip",filters:[{data:""}],filterRender:{name:"VxeInput"}},{field:"tunnelClientId",title:"客户端ID",width:200,showOverflow:"tooltip",filters:[{data:""}],filterRender:{name:"VxeInput"}},{field:"tunnelServiceId",title:"服务ID",width:200,showOverflow:"tooltip",filters:[{data:""}],filterRender:{name:"VxeInput"}},{field:"serviceName",title:"服务名称",width:180,showOverflow:"tooltip",slots:{default:"serviceName"},filters:[{data:""}],filterRender:{name:"VxeInput"}},{field:"serviceType",title:"服务类型",width:100,align:"center",showOverflow:"tooltip"},{field:"localAddress",title:"本地地址",width:200,showOverflow:"tooltip",formatter:({row:r})=>`${r.localAddress}:${r.localPort}`},{field:"remotePort",title:"远程端口",width:100,align:"center",showOverflow:"tooltip",formatter:({cellValue:r})=>r||"-"},{field:"serviceStatus",title:"服务状态",width:100,align:"center",formatter:({cellValue:r})=>r?{active:"活跃",inactive:"未活跃",error:"错误"}[r]||r:"-"},{field:"connectionCount",title:"连接数",width:100,align:"center",formatter:({cellValue:r})=>r||0},{field:"totalConnections",title:"总连接数",width:120,align:"center",formatter:({cellValue:r})=>r||0},{field:"registeredTime",title:"注册时间",width:160,showOverflow:!0,formatter:({cellValue:r})=>r?Y(r,"YYYY-MM-DD HH:mm:ss"):"-"},{field:"lastActiveTime",title:"最后活动时间",width:160,showOverflow:!0,formatter:({cellValue:r})=>r?Y(r,"YYYY-MM-DD HH:mm:ss"):"-"}],showCheckbox:!1,menuConfig:{enabled:!0,showCopyRow:!0,showCopyCell:!0,customMenus:[{code:"refresh",name:"刷新",prefixIcon:()=>k(I,{size:14},{default:()=>k(W)})}]},height:"100%"},g=async()=>{p.value=!0;try{const r=m.tunnelServerId||"",b=await Ye(r);if(b.oK)if(b.bizData){const S=JSON.parse(b.bizData);c.value=Array.isArray(S)?S:[]}else c.value=[];else c.value=[]}catch(r){console.error("加载已注册服务列表失败:",r),c.value=[]}finally{p.value=!1}},_=async({code:r})=>{r==="refresh"&&await g()};return B(()=>{g()}),te(()=>m.tunnelServerId,()=>{g()}),d({loadServiceList:g,refresh:g}),(r,b)=>(A(),z("div",qe,[l(e(J),E({ref_key:"gridRef",ref:v,"module-id":"hub0060:regist-service-list",data:c.value,loading:p.value},a,{onMenuClick:_}),{serviceName:u(({row:S})=>[n("span",Je,w(S.serviceName||"-"),1)]),_:1},16,["data","loading"])]))}}),We=R(Be,[["__scopeId","data-v-0c8f3898"]]);function je(){const s="hub0060",d=y(!1),m=y([]),v=y();return{moduleId:s,loading:d,tunnelServerList:m,pageInfo:v,searchFormConfig:{fields:[{field:"serverName",label:"服务器名称",type:"input",placeholder:"请输入服务器名称",span:6,clearable:!0},{field:"serverStatus",label:"服务器状态",type:"select",placeholder:"请选择状态",span:6,clearable:!0,options:[{label:"全部",value:""},{label:"运行中",value:"running"},{label:"已停止",value:"stopped"},{label:"错误",value:"error"}]},{field:"controlAddress",label:"控制地址",type:"input",placeholder:"请输入控制地址",span:6,clearable:!0},{field:"activeFlag",label:"活动状态",type:"select",placeholder:"请选择状态",span:6,clearable:!0,options:[{label:"全部",value:""},{label:"活动",value:"Y"},{label:"非活动",value:"N"}]}],toolbarButtons:[{key:"add",label:"新增服务器",icon:Se,type:"primary",tooltip:"新增隧道服务器"},{key:"edit",label:"编辑",icon:we,tooltip:"编辑选中的服务器"},{key:"delete",label:"删除",icon:ye,type:"error",tooltip:"删除选中的服务器"}],showSearchButton:!0,showResetButton:!0},formTabs:[{key:"basic",label:"基础配置"},{key:"network",label:"网络配置"},{key:"security",label:"安全配置"},{key:"advanced",label:"高级配置"},{key:"other",label:"其他信息"}],formFields:[{field:"serverName",label:"服务器名称",type:"input",placeholder:"请输入服务器名称",span:12,tabKey:"basic",required:!0,primary:!0,props:{maxlength:100,showCount:!0},tips:"隧道路由服务器的唯一标识名称，用于区分不同的服务器实例"},{field:"serverDescription",label:"服务器描述",type:"textarea",placeholder:"请输入服务器描述",span:24,tabKey:"basic",props:{maxlength:500,showCount:!0,rows:3},tips:"服务器的详细描述信息，用于说明服务器的用途、部署位置等"},{field:"controlAddress",label:"控制地址",type:"input",placeholder:"请输入控制地址，如: 0.0.0.0",span:12,tabKey:"basic",required:!0,defaultValue:"0.0.0.0",tips:"控制端口监听的IP地址。0.0.0.0 表示监听所有网络接口，127.0.0.1 表示仅本地访问"},{field:"controlPort",label:"控制端口",type:"number",placeholder:"请输入控制端口",span:12,tabKey:"basic",required:!0,defaultValue:7e3,props:{min:1,max:65535},tips:"接受客户端连接的控制端口。客户端通过此端口与服务器建立控制连接，用于认证、心跳和服务注册"},{field:"dashboardPort",label:"管理面板端口",type:"number",placeholder:"请输入管理面板端口",span:12,tabKey:"basic",defaultValue:7500,props:{min:1,max:65535},tips:"管理面板的访问端口，用于查看服务器状态、连接统计和性能指标"},{field:"vhostHttpPort",label:"HTTP端口",type:"number",placeholder:"虚拟主机HTTP端口",span:12,tabKey:"network",defaultValue:80,props:{min:1,max:65535},tips:"虚拟主机HTTP服务的监听端口。用于处理基于域名的HTTP隧道请求"},{field:"vhostHttpsPort",label:"HTTPS端口",type:"number",placeholder:"虚拟主机HTTPS端口",span:12,tabKey:"network",defaultValue:443,props:{min:1,max:65535},tips:"虚拟主机HTTPS服务的监听端口。用于处理基于域名的HTTPS隧道请求，需要配置TLS证书"},{field:"maxClients",label:"最大客户端数",type:"number",placeholder:"请输入最大客户端数",span:12,tabKey:"network",required:!0,defaultValue:1e3,props:{min:1,max:1e4},tips:"允许同时连接到服务器的最大客户端数量。超过此限制的新连接将被拒绝"},{field:"maxPortsPerClient",label:"每客户端最大端口数",type:"number",placeholder:"请输入每客户端最大端口数",span:12,tabKey:"network",defaultValue:10,props:{min:1,max:1e3},tips:"单个客户端可以使用的最大端口数量。用于限制每个客户端可注册的服务数量"},{field:"allowPorts",label:"允许的端口范围",type:"input",placeholder:"例如: 10000-20000",span:24,tabKey:"network",tips:"格式: 10000-20000 或 10000,20000,30000"},{field:"tokenAuth",label:"Token认证",type:"select",span:12,tabKey:"security",defaultValue:"Y",options:[{label:"启用",value:"Y"},{label:"禁用",value:"N"}],tips:"启用Token认证后，客户端连接时必须提供正确的认证令牌，提高安全性"},{field:"authToken",label:"认证Token",type:"input",placeholder:"请输入认证Token",span:12,tabKey:"security",show:t=>(t==null?void 0:t.tokenAuth)==="Y",props:{type:"password",showPasswordOn:"click"},tips:"客户端连接时使用的认证令牌。如果为空，系统将自动生成一个32位随机字符串"},{field:"tlsEnable",label:"TLS加密",type:"select",span:12,tabKey:"security",defaultValue:"N",options:[{label:"启用",value:"Y"},{label:"禁用",value:"N"}],tips:"启用TLS加密后，客户端与服务器之间的通信将使用TLS协议加密，提高数据传输安全性"},{field:"tlsCertFile",label:"TLS证书文件",type:"input",placeholder:"请输入TLS证书文件路径",span:12,tabKey:"security",show:t=>(t==null?void 0:t.tlsEnable)==="Y",tips:"TLS证书文件的完整路径。证书文件必须是服务器可访问的，通常为 .crt 或 .pem 格式"},{field:"tlsKeyFile",label:"TLS密钥文件",type:"input",placeholder:"请输入TLS密钥文件路径",span:12,tabKey:"security",show:t=>(t==null?void 0:t.tlsEnable)==="Y",tips:"TLS私钥文件的完整路径。密钥文件必须是服务器可访问的，通常为 .key 格式，需要与证书文件匹配"},{field:"heartbeatInterval",label:"心跳间隔(秒)",type:"number",placeholder:"请输入心跳间隔",span:12,tabKey:"advanced",required:!0,defaultValue:30,props:{min:5,max:300},tips:"服务器与客户端之间的心跳检测间隔时间。客户端会定期发送心跳消息以保持连接活跃"},{field:"heartbeatTimeout",label:"心跳超时(秒)",type:"number",placeholder:"请输入心跳超时",span:12,tabKey:"advanced",required:!0,defaultValue:90,props:{min:10,max:600},tips:"心跳检测的超时时间。如果在此时间内未收到客户端心跳，服务器将认为客户端已断开连接"},{field:"logLevel",label:"日志级别",type:"select",placeholder:"请选择日志级别",span:12,tabKey:"advanced",defaultValue:"info",options:[{label:"Debug",value:"debug"},{label:"Info",value:"info"},{label:"Warn",value:"warn"},{label:"Error",value:"error"}],tips:"服务器日志记录的级别。Debug包含最详细的调试信息，Error仅记录错误信息"},{field:"noteText",label:"备注信息",type:"textarea",placeholder:"请输入备注信息",span:24,tabKey:"other",props:{maxlength:500,showCount:!0,rows:4}},{field:"addTime",label:"创建时间",type:"datetime",span:12,disabled:!0,tabKey:"other"},{field:"addWho",label:"创建人",type:"input",span:12,disabled:!0,tabKey:"other"},{field:"editTime",label:"修改时间",type:"datetime",span:12,disabled:!0,tabKey:"other"},{field:"editWho",label:"修改人",type:"input",span:12,disabled:!0,tabKey:"other"},{field:"activeFlag",label:"活动状态",type:"select",span:12,tabKey:"other",defaultValue:"Y",options:[{label:"活动",value:"Y"},{label:"非活动",value:"N"}]}],gridConfig:{columns:[{field:"serverName",title:"服务器名称",width:180,sortable:!0,showOverflow:!0,slots:{default:"serverName"}},{field:"controlAddress",title:"控制地址",width:140,showOverflow:!0,formatter:({row:t})=>`${t.controlAddress}:${t.controlPort}`},{field:"dashboardPort",title:"管理端口",width:90,align:"center",formatter:({cellValue:t})=>t||"-"},{field:"serverStatus",title:"状态",width:90,align:"center",slots:{default:"serverStatus"}},{field:"vhostHttpPort",title:"HTTP端口",width:90,align:"center",formatter:({cellValue:t})=>t||"-"},{field:"vhostHttpsPort",title:"HTTPS端口",width:100,align:"center",formatter:({cellValue:t})=>t||"-"},{field:"maxClients",title:"最大客户端",width:100,align:"center",slots:{default:"maxClients"}},{field:"tokenAuth",title:"Token认证",width:90,align:"center",slots:{default:"tokenAuth"}},{field:"tlsEnable",title:"TLS",width:70,align:"center",slots:{default:"tlsEnable"}},{field:"heartbeatInterval",title:"心跳间隔(秒)",width:110,align:"center",formatter:({cellValue:t})=>t?`${t}s`:"-"},{field:"heartbeatTimeout",title:"心跳超时(秒)",width:110,align:"center",formatter:({cellValue:t})=>t?`${t}s`:"-"},{field:"startTime",title:"启动时间",width:140,sortable:!0,showOverflow:!0,formatter:({cellValue:t})=>t?Y(t,"YYYY-MM-DD HH:mm"):"-"},{field:"addTime",title:"创建时间",width:140,sortable:!0,showOverflow:!0,formatter:({cellValue:t})=>t?Y(t,"YYYY-MM-DD HH:mm"):""},{field:"addWho",title:"创建人",width:100,showOverflow:!0},{field:"activeFlag",title:"活动状态",width:100,align:"center",formatter:({row:t})=>t.activeFlag==="Y"?"活动":"非活动"}],showCheckbox:!0,paginationConfig:{show:!0,pageInfo:v,align:"right"},menuConfig:{enabled:!0,showCopyRow:!0,showCopyCell:!0,customMenus:[{code:"view",name:"查看详情",prefixIcon:"vxe-icon-eye-fill"},{code:"edit",name:"编辑",prefixIcon:"vxe-icon-edit"},{code:"delete",name:"删除",prefixIcon:"vxe-icon-delete"},{code:"start",name:"启动服务器",prefixIcon:()=>k(I,{size:14},{default:()=>k(ae)})},{code:"stop",name:"停止服务器",prefixIcon:()=>k(I,{size:14},{default:()=>k(j)})},{code:"restart",name:"重启服务器",prefixIcon:()=>k(I,{size:14},{default:()=>k(W)})}]},height:"100%"},resetPagination:()=>{v.value=void 0},updatePagination:t=>{v.value?Object.assign(v.value,t):v.value=t},setTunnelServerList:t=>{m.value=t},clearTunnelServerList:()=>{m.value=[]},addTunnelServerToList:t=>{m.value.unshift(t)},updateTunnelServerInList:(t,i,C)=>{const O=m.value.findIndex(G=>G.tunnelServerId===t&&G.tenantId===i);O!==-1&&Object.assign(m.value[O],C)},removeTunnelServerFromList:(t,i)=>{const C=m.value.findIndex(O=>O.tunnelServerId===t&&O.tenantId===i);C!==-1&&m.value.splice(C,1)}}}function Ue(s){const d=re(),m=ge(),v=je(),{loading:p,tunnelServerList:c,pageInfo:a,setTunnelServerList:g,updatePagination:_,addTunnelServerToList:r,updateTunnelServerInList:b,removeTunnelServerFromList:S}=v,T=async h=>{var f,o,U;p.value=!0;try{let L=h;!L&&((f=s==null?void 0:s.value)!=null&&f.getFormData)&&(L=s.value.getFormData()||{});const se=L?Object.fromEntries(Object.entries(L).filter(([,P])=>P!==""&&P!==null&&P!==void 0)):{},Q=oe((o=a.value)==null?void 0:o.pageIndex,(U=a.value)==null?void 0:U.pageSize),ne={...se,pageIndex:Q.pageIndex,pageSize:Q.pageSize},$=await Oe(ne);if($.oK){if($.bizData){const P=JSON.parse($.bizData),le=Array.isArray(P)?P:[];g(le)}if($.pageQueryData){const P=JSON.parse($.pageQueryData);_(P)}}else d.error($.errMsg||"查询隧道服务器列表失败")}catch(L){console.error("加载隧道服务器列表失败:",L),d.error("加载隧道服务器列表失败")}finally{p.value=!1}};return{model:v,loadTunnelServers:T,handleSearch:async h=>{await T(h)},handleReset:async()=>{v.resetPagination(),await T()},handlePageChange:async({currentPage:h,pageSize:f})=>{_({pageIndex:h,pageSize:f}),await T()},handleRefresh:async()=>{await T()},createTunnelServer:async h=>{p.value=!0;try{const f=await $e(h);if(f.oK&&f.state){if(d.success(f.popMsg||"创建隧道服务器成功"),f.bizData){const o=JSON.parse(f.bizData);r(o)}else await T();return!0}else return d.error(f.errMsg||f.popMsg||"创建隧道服务器失败"),!1}catch(f){return console.error("创建隧道服务器失败:",f),d.error("创建隧道服务器失败"),!1}finally{p.value=!1}},updateTunnelServer:async h=>{p.value=!0;try{const f=await Ke({...h,tunnelServerId:h.tunnelServerId});if(f.oK&&f.state){if(d.success(f.popMsg||"更新隧道服务器成功"),f.bizData){const o=JSON.parse(f.bizData);b(o.tunnelServerId,o.tenantId,o)}else b(h.tunnelServerId,h.tenantId,h);return!0}else return d.error(f.errMsg||f.popMsg||"更新隧道服务器失败"),!1}catch(f){return console.error("更新隧道服务器失败:",f),d.error("更新隧道服务器失败"),!1}finally{p.value=!1}},deleteTunnelServer:async h=>{if(!await m.warning({title:"确认删除",subtitle:"此操作不可恢复，请谨慎操作",content:`确定要删除隧道服务器 "${h.serverName}" 吗？`,icon:Ce,headerStyle:"gradient",positiveText:"确定删除",negativeText:"取消",width:500}))return!1;p.value=!0;try{const o=await Ne(h.tunnelServerId);return o.oK&&o.state?(d.success(o.popMsg||"删除隧道服务器成功"),S(h.tunnelServerId,h.tenantId),c.value.length===0&&a.value&&a.value.pageIndex>1&&(_({pageIndex:a.value.pageIndex-1}),await T()),!0):(d.error(o.errMsg||o.popMsg||"删除隧道服务器失败"),!1)}catch(o){return console.error("删除隧道服务器失败:",o),d.error("删除隧道服务器失败"),!1}finally{p.value=!1}},startTunnelServer:async h=>{if(!await m.warning({title:"确认启动",subtitle:"启动后将开始监听客户端连接",content:`确定要启动隧道服务器 "${h.serverName}" 吗？`,icon:Te,headerStyle:"gradient",positiveText:"确定启动",negativeText:"取消",width:500}))return!1;p.value=!0;try{const o=await De(h.tunnelServerId);return o.oK&&o.state?(d.success(o.popMsg||"启动隧道服务器成功"),await T(),!0):(d.error(o.errMsg||o.popMsg||"启动隧道服务器失败"),!1)}catch(o){return console.error("启动隧道服务器失败:",o),d.error("启动隧道服务器失败"),!1}finally{p.value=!1}},stopTunnelServer:async h=>{if(!await m.warning({title:"确认停止",subtitle:"停止后将断开所有客户端连接",content:`确定要停止隧道服务器 "${h.serverName}" 吗？`,icon:j,headerStyle:"gradient",positiveText:"确定停止",negativeText:"取消",width:500}))return!1;p.value=!0;try{const o=await Re(h.tunnelServerId);return o.oK&&o.state?(d.success(o.popMsg||"停止隧道服务器成功"),await T(),!0):(d.error(o.errMsg||o.popMsg||"停止隧道服务器失败"),!1)}catch(o){return console.error("停止隧道服务器失败:",o),d.error("停止隧道服务器失败"),!1}finally{p.value=!1}},restartTunnelServer:async h=>{if(!await m.warning({title:"确认重启",subtitle:"重启将先停止后启动服务器",content:`确定要重启隧道服务器 "${h.serverName}" 吗？`,icon:_e,headerStyle:"gradient",positiveText:"确定重启",negativeText:"取消",width:500}))return!1;p.value=!0;try{const o=await He(h.tunnelServerId);return o.oK&&o.state?(d.success(o.popMsg||"重启隧道服务器成功"),await T(),!0):(d.error(o.errMsg||o.popMsg||"重启隧道服务器失败"),!1)}catch(o){return console.error("重启隧道服务器失败:",o),d.error("重启隧道服务器失败"),!1}finally{p.value=!1}},viewTunnelServer:async h=>{try{const f=await Le(h.tunnelServerId);return f.oK?JSON.parse(f.bizData):(d.error(f.errMsg||"获取隧道服务器详情失败"),null)}catch(f){return console.error("获取隧道服务器详情失败:",f),d.error("获取隧道服务器详情失败"),null}}}}function Qe(s,d){const m=re(),v=Ue(d),p=y(!1),c=y("create"),a=y(null),g=async t=>{await v.handleSearch(t)},_=()=>{c.value="create",a.value=null,p.value=!0},r=async t=>{const i=await v.viewTunnelServer(t);i&&(c.value="edit",a.value=i,p.value=!0)},b=()=>{p.value=!1,a.value=null},S=t=>{c.value="view",a.value=t,p.value=!0};return{service:v,formDialogVisible:p,formDialogMode:c,currentEditServer:a,openAddDialog:_,openEditDialog:r,openViewDialog:S,handleFormSubmit:async t=>{if(t&&c.value!=="view"){if(c.value==="create")await v.createTunnelServer(t)&&b();else if(c.value==="edit"){if(!a.value)return;const i={...a.value,...t};await v.updateTunnelServer(i)&&b()}}},handleToolbarClick:async(t,i)=>{switch(t){case"add":_();break;case"edit":{if(!(s!=null&&s.value)){m.warning("Grid 引用未设置");return}const C=s.value.getCurrentRecord();if(!C){m.warning("请先点击选择要编辑的隧道服务器");return}await r(C);break}case"delete":{if(!(s!=null&&s.value)){m.warning("Grid 引用未设置");return}const C=s.value.getCurrentRecord();if(!C){m.warning("请先点击选择要删除的隧道服务器");return}await v.deleteTunnelServer(C);break}case"search":{await v.handleSearch(i);break}}},handleMenuClick:async({code:t,row:i})=>{if(i)switch(t){case"view":S(i);break;case"edit":await r(i);break;case"delete":await v.deleteTunnelServer(i);break;case"start":await v.startTunnelServer(i);break;case"stop":await v.stopTunnelServer(i);break;case"restart":await v.restartTunnelServer(i);break}},handleSearch:g}}const Xe={class:"tunnel-server-stats"},Ze={class:"stat-content"},et={class:"stat-icon total"},tt={class:"stat-info"},rt={class:"stat-value"},at={class:"stat-content"},st={class:"stat-icon running"},nt={class:"stat-info"},lt={class:"stat-value"},ot={class:"stat-content"},it={class:"stat-icon stopped"},dt={class:"stat-info"},ct={class:"stat-value"},ut={class:"stat-content"},pt={class:"stat-icon error"},vt={class:"stat-info"},ft={class:"stat-value"},mt={class:"card-header"},ht={class:"detail-content"},gt={class:"detail-item"},bt={class:"detail-value primary"},St={class:"detail-progress"},yt={class:"progress-text"},wt={class:"card-header"},_t={class:"detail-content"},Tt={class:"detail-item"},Ct={class:"detail-value success"},It={class:"detail-progress"},xt={class:"progress-text"},kt=D({__name:"TunnelServerStats",props:{statistics:{}},setup(s){const d=s,m=X(()=>{const a=d.statistics.totalClients||0;return Math.min(Math.round(a/1e3*100),100)}),v=X(()=>{const a=d.statistics.totalConnections||0;return Math.min(Math.round(a/5e3*100),100)}),p=c=>c<50?"#52c41a":c<80?"#faad14":"#ff4d4f";return(c,a)=>(A(),z("div",Xe,[l(e(ee),{cols:4,"x-gap":8,"y-gap":8,responsive:"screen"},{default:u(()=>[l(e(N),null,{default:u(()=>[l(e(K),{class:"stat-card",hoverable:""},{default:u(()=>[n("div",Ze,[n("div",et,[l(e(I),{size:"18",component:e(Ie)},null,8,["component"])]),n("div",tt,[n("div",rt,w(c.statistics.totalServers||1),1),a[0]||(a[0]=n("div",{class:"stat-label"},"总服务器数",-1))])])]),_:1})]),_:1}),l(e(N),null,{default:u(()=>[l(e(K),{class:"stat-card",hoverable:""},{default:u(()=>[n("div",at,[n("div",st,[l(e(I),{size:"18",component:e(ae)},null,8,["component"])]),n("div",nt,[n("div",lt,w(c.statistics.runningServers||0),1),a[1]||(a[1]=n("div",{class:"stat-label"},"运行中",-1))])])]),_:1})]),_:1}),l(e(N),null,{default:u(()=>[l(e(K),{class:"stat-card",hoverable:""},{default:u(()=>[n("div",ot,[n("div",it,[l(e(I),{size:"18",component:e(j)},null,8,["component"])]),n("div",dt,[n("div",ct,w(c.statistics.stoppedServers||0),1),a[2]||(a[2]=n("div",{class:"stat-label"},"已停止",-1))])])]),_:1})]),_:1}),l(e(N),null,{default:u(()=>[l(e(K),{class:"stat-card",hoverable:""},{default:u(()=>[n("div",ut,[n("div",pt,[l(e(I),{size:"18",component:e(xe)},null,8,["component"])]),n("div",vt,[n("div",ft,w(c.statistics.errorServers||0),1),a[3]||(a[3]=n("div",{class:"stat-label"},"错误状态",-1))])])]),_:1})]),_:1})]),_:1}),l(e(ee),{cols:2,"x-gap":8,"y-gap":8,style:{"margin-top":"8px"},responsive:"screen"},{default:u(()=>[l(e(N),null,{default:u(()=>[l(e(K),{class:"detail-card",hoverable:""},{header:u(()=>[n("div",mt,[l(e(I),{size:"16",component:e(ke)},null,8,["component"]),a[4]||(a[4]=n("span",null,"客户端统计",-1))])]),default:u(()=>[n("div",ht,[n("div",gt,[a[5]||(a[5]=n("div",{class:"detail-label"},"总客户端数",-1)),n("div",bt,w(c.statistics.totalClients||0),1)]),n("div",St,[l(e(Z),{type:"line",percentage:m.value,"show-indicator":!1,height:6,color:p(m.value)},null,8,["percentage","color"]),n("div",yt,w(m.value)+"% 使用率 ",1)])])]),_:1})]),_:1}),l(e(N),null,{default:u(()=>[l(e(K),{class:"detail-card",hoverable:""},{header:u(()=>[n("div",wt,[l(e(I),{size:"16",component:e(Me)},null,8,["component"]),a[6]||(a[6]=n("span",null,"连接统计",-1))])]),default:u(()=>[n("div",_t,[n("div",Tt,[a[7]||(a[7]=n("div",{class:"detail-label"},"总连接数",-1)),n("div",Ct,w(c.statistics.totalConnections||0),1)]),n("div",It,[l(e(Z),{type:"line",percentage:v.value,"show-indicator":!1,height:6,color:p(v.value)},null,8,["percentage","color"]),n("div",xt,w(v.value)+"% 负载 ",1)])])]),_:1})]),_:1})]),_:1})]))}}),Mt=R(kt,[["__scopeId","data-v-4983a7ed"]]),Pt=["id"],Ot={class:"bottom-section"},Lt={key:0,class:"stats-section"},$t={class:"grid-section"},Kt={class:"text-primary font-bold"},Nt=D({name:"TunnelServerList",__name:"TunnelServerList",setup(s){const d=y(),m=y(),v=y(!0),p=y({totalServers:0,runningServers:0,stoppedServers:0,errorServers:0,totalClients:0,totalConnections:0}),c=async()=>{try{const M=await ze();if(fe(M)){const t=me(M,{totalServers:0,runningServers:0,stoppedServers:0,errorServers:0,totalClients:0,totalConnections:0});p.value=t}}catch(M){console.error("获取统计信息失败:",M)}},{service:a,formDialogVisible:g,formDialogMode:_,currentEditServer:r,handleFormSubmit:b,handleToolbarClick:S,handleMenuClick:T,handleSearch:H}=Qe(m,d);return B(()=>{v.value&&c()}),(M,t)=>(A(),z("div",{class:"tunnel-server-management",id:e(a).model.moduleId},[l(e(ie),{direction:"vertical","default-size":.1,min:.1,max:.5},{1:u(()=>[l(de,E({ref_key:"searchFormRef",ref:d,"module-id":e(a).model.moduleId},e(a).model.searchFormConfig,{onSearch:e(H),onToolbarClick:e(S)}),null,16,["module-id","onSearch","onToolbarClick"])]),2:u(()=>[n("div",Ot,[v.value?(A(),z("div",Lt,[l(Mt,{statistics:p.value},null,8,["statistics"])])):ue("",!0),n("div",$t,[l(e(J),E({ref_key:"gridRef",ref:m,"module-id":e(a).model.moduleId,data:e(a).model.tunnelServerList,loading:e(a).model.loading},e(a).model.gridConfig,{onPageChange:e(a).handlePageChange,onMenuClick:e(T)}),{serverName:u(({row:i})=>[n("span",{class:pe(i.serverStatus==="running"?"text-success font-bold":"text-default")},w(i.serverName),3)]),maxClients:u(({row:i})=>[n("span",Kt,w(i.maxClients||"-"),1)]),tokenAuth:u(({row:i})=>[l(e(F),{type:i.tokenAuth==="Y"?"success":"default",size:"small"},{icon:u(()=>[l(e(I),null,{default:u(()=>[l(e(Pe))]),_:1})]),default:u(()=>[V(" "+w(i.tokenAuth==="Y"?"启用":"禁用"),1)]),_:2},1032,["type"])]),tlsEnable:u(({row:i})=>[l(e(F),{type:i.tlsEnable==="Y"?"success":"default",size:"small"},{default:u(()=>[V(w(i.tlsEnable==="Y"?"启用":"禁用"),1)]),_:2},1032,["type"])]),serverStatus:u(({row:i})=>[l(e(F),{type:i.serverStatus==="running"?"success":i.serverStatus==="stopped"?"warning":i.serverStatus==="error"?"error":"default",size:"small"},{default:u(()=>[V(w(i.serverStatus==="running"?"运行中":i.serverStatus==="stopped"?"已停止":i.serverStatus==="error"?"错误":"未知"),1)]),_:2},1032,["type"])]),_:1},16,["module-id","data","loading","onPageChange","onMenuClick"])])])]),_:1}),l(be,{visible:e(g),"onUpdate:visible":t[0]||(t[0]=i=>ve(g)?g.value=i:null),mode:e(_),title:e(_)==="create"?"新增隧道服务器":e(_)==="edit"?"编辑隧道服务器":"查看隧道服务器详情",to:`#${e(a).model.moduleId}`,"form-fields":e(a).model.formFields,"form-tabs":e(a).model.formTabs,"initial-data":e(r)||void 0,"auto-close-on-confirm":!1,"confirm-loading":e(a).model.loading.value,onSubmit:e(b)},null,8,["visible","mode","title","to","form-fields","form-tabs","initial-data","confirm-loading","onSubmit"])],8,Pt))}}),zt=R(Nt,[["__scopeId","data-v-22aebb62"]]),At="hub0060",Yt=D({name:"TunnelServerManagement",__name:"TunnelServerManagement",setup(s){const d=y("");return(m,v)=>(A(),z("div",{class:"tunnel-management",id:At},[l(e(he),{type:"line",placement:"left",class:"management-tabs"},{default:u(()=>[l(e(q),{name:"server",tab:"隧道服务器管理"},{default:u(()=>[l(e(zt))]),_:1}),l(e(q),{name:"clients",tab:"客户端注册列表"},{default:u(()=>[l(e(Ge),{"tunnel-server-id":d.value||""},null,8,["tunnel-server-id"])]),_:1}),l(e(q),{name:"services",tab:"服务注册列表"},{default:u(()=>[l(e(We),{"tunnel-server-id":d.value||""},null,8,["tunnel-server-id"])]),_:1})]),_:1})]))}}),mr=R(Yt,[["__scopeId","data-v-8f5135c9"]]);export{mr as default};
