# Gohub

Gohub 是一个基于 Go 语言开发的微服务网关系统，提供高性能、可扩展的 API 网关服务。

## 项目结构

```
gohub/
├── cmd/                    # 主程序入口
│   ├── gateway/           # 网关服务入口
│   └── admin/             # 管理后台入口
├── internal/              # 内部包（去除database）
│   ├── gateway/          # 网关核心模块
│   │   ├── handler/      # 请求处理器
│   │   ├── middleware/   # 中间件
│   │   ├── router/       # 路由配置
│   │   └── service/      # 业务逻辑
│   ├── auth/             # 认证授权模块
│   ├── cache/            # 缓存模块（可考虑移至pkg）
│   ├── discovery/        # 服务发现模块
│   ├── metrics/          # 监控指标模块
│   └── storage/          # 存储模块
├── pkg/                   # 可导出的包
│   ├── config/           # 配置管理
│   ├── database/         # 数据库操作 (新位置)
│   │   ├── mysql/        # MySQL 驱动和操作
│   │   ├── postgresql/   # PostgreSQL 驱动和操作
│   │   ├── redis/        # Redis 驱动和操作
│   │   └── mongo/        # MongoDB 驱动和操作
│   ├── errors/           # 错误处理
│   ├── logger/           # 日志模块
│   ├── protocol/         # 协议定义
│   ├── plugin/           # 插件系统
│   └── utils/            # 通用工具
│       ├── http/         # HTTP 工具
│       ├── time/         # 时间工具
│       ├── crypto/       # 加密工具
│       └── validator/    # 验证工具
├── api/                   # API 定义
│   ├── proto/            # Protocol Buffers 定义
│   └── swagger/          # Swagger 文档
├── configs/              # 配置文件
│   ├── gateway/          # 网关配置
│   └── admin/            # 管理后台配置
├── deployments/          # 部署相关
│   ├── docker/          # Docker 配置
│   └── kubernetes/      # Kubernetes 配置
├── docs/                 # 文档
│   ├── api/             # API 文档
│   ├── design/          # 设计文档
│   └── guide/           # 使用指南
├── scripts/              # 脚本文件
│   ├── build/           # 构建脚本
│   ├── deploy/          # 部署脚本
│   └── test/            # 测试脚本
└── test/                 # 测试文件
    ├── e2e/             # 端到端测试
    └── integration/     # 集成测试
```

## 功能特性

- 高性能 API 网关
- 请求路由和转发
- 请求过滤和验证
- 日志记录和监控
- 跨域支持
- 健康检查
- 服务发现
- 负载均衡
- 限流功能
- 认证授权
- 监控指标
- 缓存支持
- 插件系统

## 架构设计

### 核心模块

1. **请求路由与转发**
   - 基于路径的路由匹配
   - 服务发现集成 (etcd/Consul/Nacos)
   - 动态路由配置（支持热更新）
   - 请求负载均衡（轮询/加权轮询/一致性哈希）

2. **请求处理与转换**
   - 请求/响应转换和格式化
   - 请求参数验证
   - 协议转换（HTTP/gRPC/WebSocket）
   - 响应缓存

3. **安全防护**
   - 多种认证方式（JWT/OAuth2.0/API Key）
   - 访问控制（RBAC/IP 白名单/黑名单）
   - 防 DDoS 和恶意攻击
   - HTTPS/TLS 支持
   - 数据加密传输

4. **流量控制**
   - 基于 IP/服务/路径的限流
   - 熔断器实现（基于错误率/超时率）
   - 服务降级策略
   - 请求重试机制

5. **可观察性**
   - 结构化日志记录（Zap）
   - 性能指标监控（Prometheus）
   - 分布式追踪（Jaeger/Zipkin）
   - 系统告警机制

6. **扩展机制**
   - 插件系统（动态加载）
   - 中间件扩展链
   - 自定义处理器
   - 钩子函数

### 请求处理链路

```
客户端请求 → 网关接收 → 前置中间件 → 认证授权 → 流量控制 → 路由匹配 → 
请求转换 → 负载均衡 → 请求转发 → 响应处理 → 后置中间件 → 返回客户端
```

详细流程：

1. **请求接收**
   - HTTP 服务器接收请求
   - 初始化请求上下文
   - 记录请求开始时间和基本信息

2. **前置处理**
   - 请求日志记录
   - CORS 处理
   - 请求内容验证
   - 基本安全检查

3. **认证授权**
   - Token 解析和验证
   - 用户/服务身份识别
   - 权限检查和授权决策
   - 角色和作用域验证

4. **流量控制**
   - 限流检查（令牌桶/漏桶算法）
   - 熔断器状态检查
   - 服务健康状态检查
   - 黑白名单过滤

5. **路由决策**
   - 路由规则匹配
   - 服务发现查询
   - 负载均衡选择目标实例
   - 请求参数处理

6. **请求转发**
   - 构造转发请求
   - 添加跟踪标识（Trace ID）
   - 设置超时控制
   - 发送到目标服务

7. **响应处理**
   - 接收后端服务响应
   - 错误处理和转换
   - 响应数据处理/格式化
   - 响应缓存处理

8. **后置处理**
   - 响应日志记录
   - 性能指标统计
   - 资源清理

### 技术实现

1. **核心框架**
   - 基于 Gin 框架实现高性能 HTTP 处理
   - 采用 Go 协程池处理并发请求
   - 使用 Viper 进行配置管理
   - Zap 进行日志记录

2. **高可用设计**
   - 多实例部署
   - 优雅启动与关闭
   - 健康检查和自愈
   - 熔断和降级机制

3. **高性能优化**
   - 连接池管理
   - 内存复用
   - 请求处理的异步化
   - 响应缓存

4. **可扩展性**
   - 插件化架构
   - 中间件链式处理
   - 事件驱动模型
   - 配置热更新

### 部署模式

1. **单实例模式**
   - 适用于开发测试环境
   - 配置文件本地存储

2. **集群模式**
   - 多实例负载均衡
   - 配置中心集中管理
   - 服务注册与发现

3. **Kubernetes 部署**
   - 容器化部署
   - Helm Charts 支持
   - 水平自动伸缩
   - 金丝雀/蓝绿部署

## 快速开始

1. 安装依赖
```bash
go mod tidy
```

2. 运行网关服务
```bash
go run cmd/gateway/main.go
```

## 配置说明

配置文件位于 `configs` 目录下，支持以下配置项：

- 服务器配置（端口、超时设置）
- CORS 配置（允许的源、方法、头部）
- 日志配置（级别、输出、格式）
- 数据库配置（连接信息、池大小）
- 缓存配置（类型、连接信息、TTL）
- 认证配置（认证方式、密钥、有效期）
- 监控配置（指标收集、导出地址）
- 服务发现配置（注册中心、刷新间隔）
- 限流配置（算法、阈值、窗口大小）

## 开发计划

- [x] 基础网关功能
- [ ] 服务发现集成
- [ ] 负载均衡
- [ ] 限流功能
- [ ] 监控指标
- [ ] 认证授权
- [ ] 缓存支持
- [ ] 插件系统
- [ ] 管理后台
- [ ] 分布式追踪
- [ ] 配置中心
- [ ] 服务治理 