# 指标采集初始化模块

## 概述

该模块提供了指标采集的初始化启动器，整合了`pkg/metric`的采集功能和数据库存储功能，实现了自动化的系统指标采集和持久化存储。

## 功能特性

### 🚀 核心功能
- **自动初始化**: 系统启动时自动初始化指标采集器
- **配置驱动**: 通过配置文件控制采集行为和参数
- **多指标支持**: 支持CPU、内存、磁盘、网络、进程等多种指标
- **批量存储**: 使用缓冲区和批量插入优化数据库性能
- **数据清理**: 自动清理过期数据，避免数据库膨胀
- **容错处理**: 完善的错误处理和重试机制

### 📊 支持的指标类型
1. **CPU指标**: 使用率、负载平均值、核心数等
2. **内存指标**: 总量、可用量、使用率、交换区等
3. **磁盘指标**: 分区信息、IO统计、使用率等
4. **网络指标**: 接口统计、流量、错误率等
5. **进程指标**: 进程详情、资源使用、统计信息等
6. **系统指标**: 主机信息、操作系统、内核版本等
7. **温度指标**: 硬件温度传感器数据（可选）

## 配置说明

### 配置文件位置
配置位于`configs/app.yaml`文件的`app.metrics`节点下。

### 完整配置示例
```yaml
app:
  metrics:
    enabled: true                    # 是否启用指标采集
    collect_interval: 30s            # 采集间隔时间
    auto_start: true                 # 是否自动启动采集
    tenant_id: "default"             # 租户ID
    server_id: ""                    # 服务器ID，为空时自动生成
    operator: "system"               # 操作人标识
    
    # 采集器启用配置
    collectors:
      cpu: true                      # CPU指标采集
      memory: true                   # 内存指标采集
      disk: true                     # 磁盘指标采集
      network: true                  # 网络指标采集
      process: true                  # 进程指标采集
      system: true                   # 系统指标采集
      temperature: false             # 温度指标采集
    
    # 数据存储配置
    storage:
      batch_size: 100                # 批量插入大小
      flush_interval: 60s            # 数据刷新间隔
      max_retry: 3                   # 最大重试次数
      
      # 数据保留策略
      retention:
        enabled: true                # 是否启用数据清理
        keep_days: 30                # 保留天数
        cleanup_interval: 24h        # 清理检查间隔
```

### 配置参数说明

#### 基础配置
- `enabled`: 是否启用指标采集功能
- `collect_interval`: 指标采集间隔，支持s(秒)、m(分钟)、h(小时)
- `auto_start`: 是否在系统启动时自动开始采集
- `tenant_id`: 多租户标识，用于数据隔离
- `server_id`: 服务器唯一标识，为空时自动生成
- `operator`: 操作人标识，记录在数据库中

#### 采集器配置
可以单独控制每种指标的采集开关：
- `cpu`: CPU相关指标
- `memory`: 内存和交换区指标
- `disk`: 磁盘分区和IO指标
- `network`: 网络接口指标
- `process`: 进程和进程统计指标
- `system`: 系统基本信息
- `temperature`: 温度传感器数据（部分系统不支持）

#### 存储配置
- `batch_size`: 批量插入的记录数，影响数据库性能
- `flush_interval`: 数据从缓冲区刷新到数据库的间隔
- `max_retry`: 数据库操作失败时的最大重试次数

#### 数据保留策略
- `retention.enabled`: 是否启用自动数据清理
- `retention.keep_days`: 数据保留天数，超过此时间的数据将被删除
- `retention.cleanup_interval`: 数据清理检查的间隔时间

## 使用方法

### 1. 系统集成
在系统启动时调用初始化函数：

```go
import (
    metricInit "gohub/internal/metric_collect/init"
    "gohub/pkg/database"
)

func main() {
    // 初始化数据库
    db, err := database.NewDatabase(...)
    if err != nil {
        log.Fatal("数据库初始化失败", err)
    }
    
    // 初始化指标采集器
    if err := metricInit.InitMetricCollector(db); err != nil {
        log.Error("指标采集器初始化失败", err)
        // 注意：这里不应该fatal，因为指标采集是可选功能
    }
    
    // 其他系统初始化...
}
```

### 2. 运行时控制
获取全局管理器进行运行时控制：

```go
import metricInit "gohub/internal/metric_collect/init"

// 获取全局管理器
manager := metricInit.GetGlobalManager()
if manager == nil {
    log.Warn("指标采集器未初始化或已禁用")
    return
}

// 检查运行状态
if manager.IsRunning() {
    log.Info("指标采集正在运行")
} else {
    log.Info("指标采集已停止")
}

// 手动启动采集
if err := manager.Start(); err != nil {
    log.Error("启动指标采集失败", err)
}

// 手动停止采集
if err := manager.Stop(); err != nil {
    log.Error("停止指标采集失败", err)
}
```

## 架构设计

### 组件架构
```
MetricCollectorManager
├── ConfigLoader          # 配置加载器
├── MetricCollector        # 指标采集器 (pkg/metric)
├── DataConverter          # 数据转换器
├── DataBuffer            # 数据缓冲区
├── DAOManager            # 数据访问层
└── LifecycleManager      # 生命周期管理
```

### 数据流程
```
1. 配置加载 → 2. 采集器初始化 → 3. 定时采集
                                      ↓
6. 数据清理 ← 5. 批量存储 ← 4. 数据转换和缓冲
```

### 工作流程

#### 初始化阶段
1. **配置加载**: 从`app.yaml`读取指标采集配置
2. **服务器信息初始化**: 采集系统信息并创建服务器记录
3. **DAO初始化**: 创建各种数据访问对象
4. **采集器配置**: 根据配置启用/禁用特定采集器
5. **自动启动**: 如果配置了`auto_start`，则自动开始采集

#### 运行阶段
1. **定时采集**: 按配置间隔调用`pkg/metric`采集所有指标
2. **数据转换**: 将metric类型转换为数据库实体类型
3. **数据缓冲**: 将转换后的数据存入内存缓冲区
4. **批量刷新**: 按配置间隔将缓冲区数据批量写入数据库
5. **数据清理**: 按配置间隔清理过期的历史数据

#### 停止阶段
1. **停止采集**: 停止定时采集任务
2. **最后刷新**: 将缓冲区剩余数据写入数据库
3. **资源清理**: 清理相关资源和连接

## 性能优化

### 1. 批量操作
- 使用内存缓冲区避免频繁数据库写入
- 批量插入减少数据库连接开销
- 可配置的批量大小和刷新间隔

### 2. 异步处理
- 采集、转换、存储使用独立的goroutine
- 避免阻塞主业务流程
- 使用channel进行协程间通信

### 3. 资源控制
- 限制进程详情采集数量（默认100个）
- 可配置的数据保留策略
- 自动清理过期数据

### 4. 错误处理
- 采集失败不影响系统运行
- 数据库操作失败有重试机制
- 详细的错误日志记录

## 监控和日志

### 日志级别
- **INFO**: 系统启动、停止、配置信息
- **DEBUG**: 数据插入成功的详细信息
- **WARN**: 配置缺失、非致命错误
- **ERROR**: 采集失败、数据库操作失败

### 关键监控指标
- 采集成功率
- 数据库写入成功率
- 缓冲区大小
- 数据清理效果

## 故障排查

### 常见问题

1. **采集器无法启动**
   - 检查配置文件中`app.metrics.enabled`是否为true
   - 检查数据库连接是否正常
   - 查看启动日志中的错误信息

2. **数据未写入数据库**
   - 检查缓冲区刷新间隔配置
   - 检查数据库表是否存在
   - 查看数据库操作相关的错误日志

3. **系统性能影响**
   - 调整采集间隔，减少采集频率
   - 增大批量插入大小，减少数据库操作频率
   - 禁用不需要的采集器

4. **数据库空间不足**
   - 启用数据保留策略
   - 调整保留天数
   - 手动清理历史数据

### 调试方法
1. 启用DEBUG日志级别查看详细信息
2. 检查`GetGlobalManager()`返回值是否为nil
3. 使用`IsRunning()`检查采集器运行状态
4. 查看数据库中的实际数据插入情况

## 扩展开发

### 添加新的指标类型
1. 在`pkg/metric`中添加新的采集器
2. 在`types`包中定义对应的数据库实体
3. 在`dao`包中实现对应的数据访问层
4. 在初始化器中添加转换和存储逻辑

### 自定义数据处理
可以通过修改转换方法来实现：
- 数据过滤和预处理
- 自定义ID生成策略
- 数据格式转换
- 业务逻辑集成

## 注意事项

1. **数据库性能**: 大量数据插入可能影响数据库性能，建议合理配置批量大小和间隔
2. **存储空间**: 指标数据会持续增长，务必配置数据保留策略
3. **系统资源**: 采集过程会消耗CPU和内存，建议在生产环境中适当调整采集间隔
4. **数据一致性**: 采集时间和数据库写入时间可能有延迟，这是正常现象
5. **容错性**: 采集失败不会影响系统正常运行，但会在日志中记录错误信息 